<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Deals</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <style>
    :root {
      --primary: #0f172a; --accent: #3b82f6; --accent-hover: #2563eb; --accent-light: #dbeafe;
      --success: #10b981; --success-light: #d1fae5;
      --warning: #f59e0b; --warning-light: #fef3c7;
      --danger: #ef4444; --danger-light: #fee2e2;
      --purple: #8b5cf6; --purple-light: #ede9fe;
      --text: #0f172a; --text-secondary: #64748b; --text-muted: #94a3b8;
      --border: #e2e8f0; --border-light: #f1f5f9;
      --bg: #f8fafc; --bg-card: #ffffff; --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0/0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0/0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0/0.1);
      --radius-sm: 6px; --radius: 8px; --radius-md: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 1.25rem; font-weight: 700; text-decoration: none; color: white; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #60a5fa); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
    .nav-section { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.4); padding: 16px 12px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius); color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: all 0.15s; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .sidebar-footer { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--success), #34d399); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; color: white; flex-shrink: 0; }
    .user-details { flex: 1; }
    .user-name { font-size: 0.9rem; font-weight: 600; }
    .user-role { font-size: 0.75rem; color: rgba(255,255,255,0.5); }
    .main { flex: 1; margin-left: 260px; min-height: 100vh; }
    .top-bar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .top-left { display: flex; align-items: center; gap: 16px; }
    .mobile-menu-btn { display: none; background: none; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 10px; cursor: pointer; }
    .page-title-bar h1 { font-size: 1.25rem; font-weight: 700; }
    .page-title-bar p { font-size: 0.8rem; color: var(--text-secondary); }
    .top-actions { display: flex; gap: 10px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; font-size: 0.875rem; font-weight: 600; border-radius: var(--radius); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; font-family: 'Inter', sans-serif; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border-light); }
    .content { padding: 32px; }
    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; display: flex; align-items: center; gap: 14px; }
    .stat-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .stat-icon.blue { background: var(--accent-light); color: var(--accent); }
    .stat-icon.green { background: var(--success-light); color: var(--success); }
    .stat-icon.amber { background: var(--warning-light); color: var(--warning); }
    .stat-icon.purple { background: var(--purple-light); color: var(--purple); }
    .stat-body .val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .stat-body .lbl { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
    /* Toolbar */
    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-wrap { position: relative; flex: 1; min-width: 200px; }
    .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.875rem; }
    .search-input { width: 100%; padding: 10px 12px 10px 36px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; background: var(--bg-card); color: var(--text); outline: none; transition: all 0.15s; font-family: 'Inter', sans-serif; }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    select { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; background: var(--bg-card); color: var(--text); outline: none; cursor: pointer; font-family: 'Inter', sans-serif; }
    /* Toggle: Table / Card view */
    .view-toggle { display: flex; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .view-btn { padding: 8px 12px; border: none; background: var(--bg-card); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; font-size: 0.85rem; }
    .view-btn.active { background: var(--accent); color: white; }
    /* Card */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--border-light); }
    th { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); padding: 12px 16px; text-align: left; white-space: nowrap; cursor: pointer; user-select: none; }
    th:hover { color: var(--accent); }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border-light); font-size: 0.875rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(59,130,246,0.02); }
    .deal-name { font-weight: 600; }
    .deal-location { font-size: 0.78rem; color: var(--text-muted); display: flex; align-items: center; gap: 3px; margin-top: 2px; }
    .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .badge-mf { background: var(--accent-light); color: var(--accent); }
    .badge-ind { background: var(--success-light); color: var(--success); }
    .badge-ret { background: var(--warning-light); color: var(--warning); }
    .badge-off { background: var(--purple-light); color: var(--purple); }
    .badge-other { background: var(--border-light); color: var(--text-secondary); }
    .badge-sourcing { background: var(--border-light); color: var(--text-secondary); }
    .badge-loi { background: var(--warning-light); color: var(--warning); }
    .badge-dd { background: var(--accent-light); color: var(--accent); }
    .badge-closed { background: var(--success-light); color: var(--success); }
    .badge-operating { background: var(--purple-light); color: var(--purple); }
    .irr-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--success); }
    .money { font-family: 'JetBrains Mono', monospace; }
    .em-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent); }
    .action-btns { display: flex; gap: 6px; }
    .btn-xs { padding: 5px 10px; font-size: 0.75rem; font-weight: 600; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px; font-family: 'Inter', sans-serif; text-decoration: none; }
    .btn-xs:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-xs.danger:hover { background: var(--danger); border-color: var(--danger); }
    .table-footer { padding: 14px 20px; border-top: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: var(--border-light); font-size: 0.8rem; color: var(--text-secondary); }
    /* Card grid view */
    .deals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .deal-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; transition: all 0.2s; }
    .deal-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); border-color: var(--accent); }
    .dc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .dc-title { font-weight: 700; font-size: 1rem; }
    .dc-location { font-size: 0.78rem; color: var(--text-muted); margin-top: 3px; }
    .dc-metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .dc-metric .val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .dc-metric .lbl { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
    .dc-metric .val.green { color: var(--success); }
    .dc-metric .val.blue { color: var(--accent); }
    .dc-actions { display: flex; gap: 8px; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state i { font-size: 2.5rem; margin-bottom: 16px; display: block; opacity: 0.3; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; }
    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg-card); border-radius: var(--radius-md); width: 100%; max-width: 540px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
    .modal-header { padding: 24px 28px 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.2rem; font-weight: 700; }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--border-light); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 0.9rem; }
    .modal-close:hover { background: var(--danger-light); color: var(--danger); }
    .modal-body { padding: 24px 28px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; color: var(--text); background: var(--bg-card); outline: none; transition: all 0.15s; font-family: 'Inter', sans-serif; }
    .form-group input:focus, .form-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .modal-footer { padding: 0 28px 24px; display: flex; justify-content: flex-end; gap: 10px; }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    .sidebar-overlay.visible { display: block; }
    @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0 !important; }
      .mobile-menu-btn { display: flex !important; }
      .top-bar { padding: 12px 16px; }
      .content { padding: 16px; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">◆</div><span>deeltrack</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <div class="page-title-bar"><h1>Deals</h1><p>Track and manage all your acquisitions</p></div>
      </div>
      <div class="top-actions">
        <a href="new-deal.html" class="btn btn-primary"><i class="fas fa-plus"></i> New Deal</a>
      </div>
    </header>

    <div class="content">
      <div class="stats-row">
        <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-building"></i></div><div class="stat-body"><div class="val" id="statTotal">0</div><div class="lbl">Total Deals</div></div></div>
        <div class="stat-card"><div class="stat-icon green"><i class="fas fa-stream"></i></div><div class="stat-body"><div class="val" id="statActive">0</div><div class="lbl">Active Deals</div></div></div>
        <div class="stat-card"><div class="stat-icon amber"><i class="fas fa-dollar-sign"></i></div><div class="stat-body"><div class="val" id="statRaise">$0</div><div class="lbl">Total Raise</div></div></div>
        <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-chart-line"></i></div><div class="stat-body"><div class="val" id="statIRR">0%</div><div class="lbl">Avg IRR</div></div></div>
      </div>

      <div class="toolbar">
        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" class="search-input" id="searchInput" placeholder="Search deals…" oninput="filterDeals()"></div>
        <select id="filterType" onchange="filterDeals()">
          <option value="">All Types</option>
          <option value="multifamily">Multifamily</option>
          <option value="industrial">Industrial</option>
          <option value="retail">Retail</option>
          <option value="office">Office</option>
          <option value="other">Other</option>
        </select>
        <select id="filterStatus" onchange="filterDeals()">
          <option value="">All Status</option>
          <option value="sourcing">Sourcing</option>
          <option value="loi">LOI</option>
          <option value="dd">Due Diligence</option>
          <option value="closed">Closed</option>
          <option value="operating">Operating</option>
        </select>
        <div class="view-toggle">
          <button class="view-btn active" id="tableViewBtn" onclick="setView('table')"><i class="fas fa-list"></i></button>
          <button class="view-btn" id="cardViewBtn" onclick="setView('card')"><i class="fas fa-th-large"></i></button>
        </div>
        <button class="btn btn-secondary" onclick="exportCSV()"><i class="fas fa-download"></i> Export</button>
      </div>

      <!-- Table View -->
      <div id="tableView" class="card">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th onclick="sortBy('name')">Deal <i class="fas fa-sort" style="font-size:0.65rem;opacity:0.5;"></i></th>
                <th>Type</th>
                <th onclick="sortBy('raise')">Raise <i class="fas fa-sort" style="font-size:0.65rem;opacity:0.5;"></i></th>
                <th onclick="sortBy('irr')">IRR <i class="fas fa-sort" style="font-size:0.65rem;opacity:0.5;"></i></th>
                <th>Equity Multiple</th>
                <th>Status</th>
                <th onclick="sortBy('added')">Added <i class="fas fa-sort" style="font-size:0.65rem;opacity:0.5;"></i></th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dealsTableBody"></tbody>
          </table>
        </div>
        <div class="table-footer">
          <span id="tableInfo">Loading…</span>
          <a href="new-deal.html" class="btn btn-secondary" style="padding:6px 14px;font-size:0.8rem;"><i class="fas fa-plus"></i> New Deal</a>
        </div>
      </div>

      <!-- Card View -->
      <div id="cardView" style="display:none;">
        <div class="deals-grid" id="dealsGrid"></div>
      </div>
    </div>
  </main>
</div>

<!-- Add Deal Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Add Deal</h2>
      <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group" style="grid-column:1/-1;"><label>Deal Name *</label><input type="text" id="fName" placeholder="Riverside Flats"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Property Type</label>
          <select id="fType">
            <option value="multifamily">Multifamily</option>
            <option value="industrial">Industrial</option>
            <option value="retail">Retail</option>
            <option value="office">Office</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group"><label>Status</label>
          <select id="fStatus">
            <option value="sourcing">Sourcing</option>
            <option value="loi">LOI</option>
            <option value="dd">Due Diligence</option>
            <option value="closed">Closed</option>
            <option value="operating">Operating</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label>Location</label><input type="text" id="fLocation" placeholder="Austin, TX"></div>
      <div class="form-row">
        <div class="form-group"><label>Raise Amount ($)</label><input type="number" id="fRaise" placeholder="5000000"></div>
        <div class="form-group"><label>Target IRR (%)</label><input type="number" id="fIRR" placeholder="18.5" step="0.1"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Equity Multiple</label><input type="number" id="fEM" placeholder="1.9" step="0.01"></div>
        <div class="form-group"><label>Units (0 if N/A)</label><input type="number" id="fUnits" placeholder="96"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveDeal()"><i class="fas fa-save"></i> Save Deal</button>
    </div>
  </div>
</div>

<script>
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('visible'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('visible'); }

const DEMO_DEALS = [
  { id:'d1', name:'Riverside Flats', type:'multifamily', raise:4200000, irr:18.5, equity:1.9, status:'operating', location:'Austin, TX', added:'2025-11-10', units:96, investors:[
    {investorId:'i1',committed:250000,status:'funded',ownership:5.95,date:'2025-11-15'},
    {investorId:'i2',committed:500000,status:'funded',ownership:11.9,date:'2025-11-20'},
    {investorId:'i4',committed:300000,status:'funded',ownership:7.14,date:'2025-12-01'},
    {investorId:'i7',committed:100000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d2', name:'Meridian Industrial', type:'industrial', raise:7500000, irr:21.2, equity:2.1, status:'closed', location:'Dallas, TX', added:'2025-12-01', units:0, investors:[
    {investorId:'i2',committed:750000,status:'funded',ownership:10,date:'2025-12-10'},
    {investorId:'i3',committed:250000,status:'funded',ownership:3.33,date:'2025-12-15'},
    {investorId:'i7',committed:150000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d3', name:'The Hudson Portfolio', type:'multifamily', raise:12000000, irr:16.8, equity:1.7, status:'operating', location:'Houston, TX', added:'2026-01-15', units:248, investors:[
    {investorId:'i1',committed:250000,status:'funded',ownership:2.08,date:'2026-01-20'},
    {investorId:'i2',committed:1000000,status:'funded',ownership:8.33,date:'2026-01-25'},
    {investorId:'i4',committed:700000,status:'funded',ownership:5.83,date:'2026-02-01'},
    {investorId:'i6',committed:350000,status:'funded',ownership:2.92,date:'2026-02-05'},
    {investorId:'i7',committed:200000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d4', name:'Parkview Commons', type:'multifamily', raise:3100000, irr:19.0, equity:1.95, status:'dd', location:'San Antonio, TX', added:'2026-02-01', units:72, investors:[
    {investorId:'i5',committed:150000,status:'committed',ownership:4.84,date:'2026-02-10'},
    {investorId:'i6',committed:200000,status:'committed',ownership:6.45,date:'2026-02-15'},
    {investorId:'i7',committed:75000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d5', name:'Westgate Retail Center', type:'retail', raise:5800000, irr:14.5, equity:1.6, status:'loi', location:'Fort Worth, TX', added:'2026-02-10', units:0, investors:[
    {investorId:'i7',committed:50000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d6', name:'Lone Star Self Storage', type:'self-storage', raise:2800000, irr:22.5, equity:2.4, status:'raising', location:'Corpus Christi, TX', added:'2026-02-20', units:450, investors:[
    {investorId:'i2',committed:400000,status:'committed',ownership:14.29,date:'2026-02-22'},
    {investorId:'i7',committed:125000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d7', name:'Brazos Hotel Group', type:'hospitality', raise:8500000, irr:17.2, equity:1.85, status:'loi', location:'Waco, TX', added:'2026-02-22', units:124, investors:[
    {investorId:'i3',committed:300000,status:'committed',ownership:3.53,date:'2026-02-24'},
    {investorId:'i4',committed:600000,status:'committed',ownership:7.06,date:'2026-02-24'},
    {investorId:'i7',committed:175000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d8', name:'Permian Basin Flex Industrial', type:'industrial', raise:5200000, irr:20.8, equity:2.0, status:'raising', location:'Midland, TX', added:'2026-02-24', units:0, investors:[
    {investorId:'i1',committed:350000,status:'committed',ownership:6.73,date:'2026-02-24'},
    {investorId:'i6',committed:275000,status:'committed',ownership:5.29,date:'2026-02-25'},
    {investorId:'i7',committed:200000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
];

SP.requireGP();

let deals = [];
let sortCol = 'added', sortDir = -1;
let currentView = 'table';

  // Sync from Firebase before reading localStorage
  async function _syncFromFirebase() {
    if (typeof SPFB === 'undefined' || !SPFB.isReady() || SPFB.isOffline()) return;
    try {
      const [deals, investors, dists] = await Promise.all([
        SPFB.getDeals().catch(() => []),
        SPFB.getInvestors().catch(() => []),
        SPFB.getDistributions().catch(() => []),
      ]);
      if (deals.length) SP.saveDeals(deals);
      if (investors.length) SP.saveInvestors(investors);
      if (dists.length) SP.save('distributions', dists);
    } catch(e) { console.warn('Firebase sync:', e.message); }
  }

  async function load() {
    await _syncFromFirebase();
  deals = SP.getDeals();
  if (!deals.length) { deals = [...DEMO_DEALS]; SP.saveDeals(deals); }
}

function save() { SP.saveDeals(deals); }

function fmt$(n) {
  if (!n) return '$0';
  if (n>=1e9) return '$'+(n/1e9).toFixed(1)+'B';
  if (n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
  if (n>=1e3) return '$'+(n/1e3).toFixed(0)+'K';
  return '$'+n;
}

function updateStats() {
  const active = deals.filter(d=>['sourcing','loi','dd','operating'].includes(d.status));
  const totalRaise = deals.reduce((s,d)=>s+(d.raise||0),0);
  const avgIRR = deals.length ? (deals.reduce((s,d)=>s+(d.irr||0),0)/deals.length).toFixed(1) : '0';
  document.getElementById('statTotal').textContent = deals.length;
  document.getElementById('statActive').textContent = active.length;
  document.getElementById('statRaise').textContent = fmt$(totalRaise);
  document.getElementById('statIRR').textContent = avgIRR + '%';
}

function setView(v) {
  currentView = v;
  document.getElementById('tableView').style.display = v==='table' ? 'block' : 'none';
  document.getElementById('cardView').style.display = v==='card' ? 'block' : 'none';
  document.getElementById('tableViewBtn').classList.toggle('active', v==='table');
  document.getElementById('cardViewBtn').classList.toggle('active', v==='card');
  filterDeals();
}

function sortBy(col) {
  if (sortCol===col) sortDir *= -1; else { sortCol=col; sortDir=1; }
  filterDeals();
}

const TYPE_BADGE = { multifamily:'badge-mf', industrial:'badge-ind', retail:'badge-ret', office:'badge-off', other:'badge-other' };
const TYPE_LABEL = { multifamily:'Multifamily', industrial:'Industrial', retail:'Retail', office:'Office', other:'Other' };
const STATUS_BADGE = { sourcing:'badge-sourcing', loi:'badge-loi', dd:'badge-dd', closed:'badge-closed', operating:'badge-operating' };
const STATUS_LABEL = { sourcing:'Sourcing', loi:'LOI', dd:'Due Diligence', closed:'Closed', operating:'Operating' };

function filterDeals() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const typeF = document.getElementById('filterType').value;
  const statusF = document.getElementById('filterStatus').value;
  let filtered = deals.filter(d => {
    const matchQ = !q || d.name.toLowerCase().includes(q) || (d.location||'').toLowerCase().includes(q);
    const matchType = !typeF || d.type===typeF;
    const matchStatus = !statusF || d.status===statusF;
    return matchQ && matchType && matchStatus;
  });
  // Sort
  filtered.sort((a,b) => {
    let av = a[sortCol]||'', bv = b[sortCol]||'';
    if (typeof av === 'number') return (av-bv)*sortDir;
    return String(av).localeCompare(String(bv))*sortDir;
  });
  if (currentView==='table') renderTable(filtered);
  else renderCards(filtered);
  document.getElementById('tableInfo').textContent = `Showing ${filtered.length} of ${deals.length} deal${deals.length!==1?'s':''}`;
}

function renderTable(list) {
  const tbody = document.getElementById('dealsTableBody');
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-building"></i><h3>No deals found</h3><p>Try adjusting your filters or <a href="new-deal.html" style="color:var(--accent);">add a new deal</a></p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(d => `
    <tr>
      <td><div class="deal-name">${d.name}</div><div class="deal-location"><i class="fas fa-map-marker-alt" style="font-size:0.7rem;"></i> ${d.location||'—'}</div></td>
      <td><span class="badge ${TYPE_BADGE[d.type]||'badge-other'}">${TYPE_LABEL[d.type]||d.type||'—'}</span></td>
      <td class="money">${fmt$(d.raise||0)}</td>
      <td class="irr-val">${d.irr?d.irr.toFixed(1)+'%':'—'}</td>
      <td class="em-val">${d.equity?d.equity.toFixed(2)+'x':'—'}</td>
      <td><span class="badge ${STATUS_BADGE[d.status]||'badge-sourcing'}">${STATUS_LABEL[d.status]||d.status||'—'}</span></td>
      <td style="color:var(--text-secondary);font-size:0.8rem;">${d.added?new Date(d.added).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'—'}</td>
      <td>
        <div class="action-btns">
          <a href="deal-detail.html?id=${d.id}" class="btn-xs"><i class="fas fa-eye"></i></a>
          <a href="new-deal.html?id=${d.id}" class="btn-xs"><i class="fas fa-calculator"></i> Model</a>
          <a href="pipeline.html" class="btn-xs"><i class="fas fa-stream"></i></a>
          <button class="btn-xs danger" onclick="deleteDeal('${d.id}')"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    </tr>`).join('');
}

function renderCards(list) {
  const grid = document.getElementById('dealsGrid');
  if (!list.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-building"></i><h3>No deals found</h3></div>`;
    return;
  }
  grid.innerHTML = list.map(d => `
    <div class="deal-card">
      <div class="dc-header">
        <div><div class="dc-title">${d.name}</div><div class="dc-location"><i class="fas fa-map-marker-alt" style="font-size:0.7rem;"></i> ${d.location||'—'}</div></div>
        <span class="badge ${STATUS_BADGE[d.status]||'badge-sourcing'}">${STATUS_LABEL[d.status]||'—'}</span>
      </div>
      <div class="dc-metrics">
        <div class="dc-metric"><div class="val">${fmt$(d.raise||0)}</div><div class="lbl">Raise</div></div>
        <div class="dc-metric"><div class="val green">${d.irr?d.irr.toFixed(1)+'%':'—'}</div><div class="lbl">IRR</div></div>
        <div class="dc-metric"><div class="val blue">${d.equity?d.equity.toFixed(2)+'x':'—'}</div><div class="lbl">Equity Mult.</div></div>
      </div>
      <div style="margin-bottom:12px;"><span class="badge ${TYPE_BADGE[d.type]||'badge-other'}">${TYPE_LABEL[d.type]||'—'}</span></div>
      <div class="dc-actions">
        <a href="deal-detail.html?id=${d.id}" class="btn-xs" style="flex:1;justify-content:center;"><i class="fas fa-eye"></i> View</a>
        <a href="new-deal.html?id=${d.id}" class="btn-xs" style="flex:1;justify-content:center;"><i class="fas fa-calculator"></i> Model</a>
        <button class="btn-xs danger" onclick="deleteDeal('${d.id}')"><i class="fas fa-trash"></i></button>
      </div>
    </div>`).join('');
}

function openModal() { document.getElementById('modalOverlay').classList.add('open'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
function handleOverlayClick(e) { if (e.target===document.getElementById('modalOverlay')) closeModal(); }

function saveDeal() {
  const name = document.getElementById('fName').value.trim();
  if (!name) { alert('Deal name is required.'); return; }
  const deal = {
    id: 'd'+Date.now(), name,
    type: document.getElementById('fType').value,
    status: document.getElementById('fStatus').value,
    location: document.getElementById('fLocation').value.trim(),
    raise: parseFloat(document.getElementById('fRaise').value)||0,
    irr: parseFloat(document.getElementById('fIRR').value)||0,
    equity: parseFloat(document.getElementById('fEM').value)||0,
    units: parseInt(document.getElementById('fUnits').value)||0,
    added: new Date().toISOString().split('T')[0],
  };
  deals.unshift(deal);
  save(); updateStats(); filterDeals(); closeModal();
}

function deleteDeal(id) {
  if (typeof SPFB !== 'undefined' && SPFB.isReady()) SPFB.deleteDeal(id).catch(()=>{});
  const d = deals.find(x=>x.id===id);
  if (!d) return;
  if (!confirm(`Delete "${d.name}"? This cannot be undone.`)) return;
  deals = deals.filter(x=>x.id!==id);
  save(); updateStats(); filterDeals();
}

function exportCSV() {
  const headers = ['Name','Type','Location','Raise','IRR','Equity Multiple','Status','Added'];
  const rows = deals.map(d=>[d.name,d.type,d.location||'',d.raise||0,d.irr||0,d.equity||0,d.status,d.added||'']);
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download = 'deals.csv';
  a.click();
}

load(); updateStats(); filterDeals();
</script>
</body>
</html>
