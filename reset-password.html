<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Reset Password</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="js/sp-theme.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="firebase-config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --accent: #3b82f6; --accent-hover: #2563eb; --success: #10b981; --danger: #ef4444; --border: #e2e8f0; --radius: 8px; --radius-md: 12px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Sora', sans-serif; background: #0d0f14; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; overflow: hidden; }
    body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(59,130,246,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(59,130,246,0.05) 1px, transparent 1px); background-size: 60px 60px; pointer-events: none; }
    body::after { content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(ellipse at center, rgba(59,130,246,0.08) 0%, transparent 60%); pointer-events: none; }
    .wrap { width: 100%; max-width: 420px; position: relative; z-index: 10; }
    .brand { text-align: center; margin-bottom: 32px; }
    .brand-logo { display: inline-flex; align-items: center; gap: 12px; text-decoration: none; }
    .brand-name { font-size: 1.6rem; font-weight: 700; color: white; }
    .brand-name span { color: #60a5fa; }
    .brand-tagline { color: rgba(255,255,255,0.4); font-size: 0.85rem; margin-top: 8px; }
    .card { background: #141720; border: 1px solid rgba(255,255,255,0.07); border-radius: 18px; padding: 36px; box-shadow: 0 32px 64px rgba(0,0,0,0.6), 0 0 0 1px rgba(99,102,241,0.08); }
    .card-icon { width: 56px; height: 56px; background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.2)); border: 1px solid rgba(99,102,241,0.3); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: #818cf8; margin: 0 auto 20px; }
    .card-title { font-size: 1.4rem; font-weight: 700; color: white; margin-bottom: 4px; text-align: center; }
    .card-sub { color: rgba(255,255,255,0.5); font-size: 0.875rem; margin-bottom: 28px; text-align: center; line-height: 1.5; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 0.8rem; font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 8px; letter-spacing: 0.02em; }
    .input-wrap { position: relative; }
    .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.3); font-size: 0.9rem; pointer-events: none; }
    input[type=password], input[type=text] { width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: var(--radius); padding: 12px 14px 12px 40px; font-size: 0.95rem; color: white; font-family: 'Sora', sans-serif; transition: all 0.2s; outline: none; }
    input::placeholder { color: rgba(255,255,255,0.25); }
    input:focus { border-color: var(--accent); background: rgba(59,130,246,0.08); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
    .toggle-pw { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.3); cursor: pointer; font-size: 0.9rem; border: none; background: none; }
    .toggle-pw:hover { color: rgba(255,255,255,0.6); }
    .strength-bar { margin-top: 8px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.08); overflow: hidden; }
    .strength-fill { height: 100%; border-radius: 2px; width: 0; transition: width 0.3s, background 0.3s; }
    .strength-label { font-size: 0.75rem; margin-top: 4px; color: rgba(255,255,255,0.4); }
    .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #6366f1, #818cf8); color: white; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'Sora', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(99,102,241,0.35); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .alert { padding: 12px 16px; border-radius: var(--radius); font-size: 0.875rem; margin-bottom: 20px; display: none; align-items: center; gap: 10px; }
    .alert.show { display: flex; }
    .alert-error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; }
    .alert-success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #6ee7b7; }
    .card-footer { text-align: center; margin-top: 24px; color: rgba(255,255,255,0.4); font-size: 0.875rem; }
    .card-footer a { color: var(--accent); text-decoration: none; font-weight: 500; }
    .card-footer a:hover { text-decoration: underline; }

    /* State panels */
    #stateLoading, #stateInvalid, #stateForm, #stateSuccess { display: none; }
    #stateLoading.active, #stateInvalid.active, #stateForm.active, #stateSuccess.active { display: block; }

    .loading-spinner { text-align: center; padding: 20px 0; color: rgba(255,255,255,0.5); }
    .loading-spinner i { font-size: 2rem; color: #6366f1; animation: spin 1s linear infinite; display: block; margin-bottom: 12px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .success-icon { width: 72px; height: 72px; background: rgba(16,185,129,0.15); border: 2px solid rgba(16,185,129,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #10b981; margin: 0 auto 20px; }
    .success-title { font-size: 1.3rem; font-weight: 700; color: white; text-align: center; margin-bottom: 8px; }
    .success-sub { color: rgba(255,255,255,0.5); font-size: 0.875rem; text-align: center; margin-bottom: 24px; line-height: 1.5; }
    .btn-outline { width: 100%; padding: 12px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.15); border-radius: var(--radius); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'Sora', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
    .btn-outline:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.25); }

    .invalid-icon { width: 72px; height: 72px; background: rgba(239,68,68,0.12); border: 2px solid rgba(239,68,68,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #f87171; margin: 0 auto 20px; }
    .invalid-title { font-size: 1.3rem; font-weight: 700; color: white; text-align: center; margin-bottom: 8px; }
    .invalid-sub { color: rgba(255,255,255,0.5); font-size: 0.875rem; text-align: center; margin-bottom: 24px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <a href="dashboard.html" class="brand-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44" width="44" height="44" style="box-shadow:0 0 30px rgba(59,130,246,0.4);border-radius:50%;">
          <circle cx="22" cy="22" r="22" fill="#1e3a5f"/>
          <rect x="10" y="7" width="5" height="30" rx="2.5" fill="#3b82f6"/>
          <path d="M 18 15 L 32 22 L 18 29" stroke="#3b82f6" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="brand-name">deel<span>track</span></div>
      </a>
      <p class="brand-tagline">Real Estate Syndication Platform</p>
    </div>

    <div class="card">

      <!-- Loading state: verifying link -->
      <div id="stateLoading">
        <div class="loading-spinner">
          <i class="fas fa-circle-notch"></i>
          Verifying your reset link…
        </div>
      </div>

      <!-- Invalid / expired link -->
      <div id="stateInvalid">
        <div class="invalid-icon"><i class="fas fa-link-slash"></i></div>
        <div class="invalid-title">Link expired or invalid</div>
        <div class="invalid-sub" id="invalidMsg">This password reset link has expired or has already been used. Reset links are valid for 1 hour.</div>
        <a href="login.html" class="btn-outline" style="margin-bottom:12px;">
          <i class="fas fa-arrow-left"></i> Back to Login
        </a>
        <button class="btn-primary" onclick="requestNewLink()">
          <i class="fas fa-paper-plane"></i> Request New Link
        </button>
      </div>

      <!-- Reset form -->
      <div id="stateForm">
        <div class="card-icon"><i class="fas fa-key"></i></div>
        <h1 class="card-title">Set new password</h1>
        <p class="card-sub" id="resetEmailLabel">Choose a strong password for your account.</p>

        <div class="alert alert-error" id="errorAlert"><i class="fas fa-exclamation-circle"></i><span id="errorMsg"></span></div>

        <form id="resetForm" onsubmit="handleReset(event)">
          <div class="form-group">
            <label>New Password</label>
            <div class="input-wrap">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="newPassword" placeholder="Min 8 characters" minlength="8" required autocomplete="new-password" oninput="checkStrength(this.value)">
              <button type="button" class="toggle-pw" onclick="togglePw('newPassword','pwIcon1')"><i class="fas fa-eye" id="pwIcon1"></i></button>
            </div>
            <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
            <div class="strength-label" id="strengthLabel">Enter a password</div>
          </div>
          <div class="form-group">
            <label>Confirm Password</label>
            <div class="input-wrap">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="confirmPassword" placeholder="Repeat password" required autocomplete="new-password">
              <button type="button" class="toggle-pw" onclick="togglePw('confirmPassword','pwIcon2')"><i class="fas fa-eye" id="pwIcon2"></i></button>
            </div>
          </div>
          <button type="submit" class="btn-primary" id="resetBtn">
            <i class="fas fa-shield-halved"></i> Update Password
          </button>
        </form>
      </div>

      <!-- Success state -->
      <div id="stateSuccess">
        <div class="success-icon"><i class="fas fa-check"></i></div>
        <div class="success-title">Password updated!</div>
        <div class="success-sub">Your password has been changed successfully. You can now sign in with your new password.</div>
        <a href="login.html" class="btn-primary" style="text-decoration:none;margin-bottom:0;">
          <i class="fas fa-sign-in-alt"></i> Sign In
        </a>
      </div>

    </div>

    <div class="card-footer" id="cardFooter">
      Remember your password? <a href="login.html">Sign in</a>
    </div>
  </div>

<script>
  // ─── Parse URL params ────────────────────────────────────────────────────────
  const params = new URLSearchParams(window.location.search);
  const mode   = params.get('mode');       // Firebase sets: resetPassword | verifyEmail | recoverEmail
  const oobCode = params.get('oobCode');   // Firebase action code
  const apiKey  = params.get('apiKey');    // Optional (Firebase includes it)

  let _verifiedEmail = '';

  // ─── State switcher ──────────────────────────────────────────────────────────
  function showState(id) {
    ['stateLoading','stateInvalid','stateForm','stateSuccess'].forEach(s => {
      document.getElementById(s).classList.remove('active');
    });
    document.getElementById(id).classList.add('active');
    if (id === 'stateSuccess') document.getElementById('cardFooter').style.display = 'none';
  }

  // ─── Init ────────────────────────────────────────────────────────────────────
  window.addEventListener('DOMContentLoaded', async () => {
    // Not a Firebase reset link — show invalid immediately
    if (mode !== 'resetPassword' || !oobCode) {
      showState('stateInvalid');
      document.getElementById('invalidMsg').textContent =
        'No valid reset code found in this link. Please request a new password reset from the login page.';
      return;
    }

    showState('stateLoading');

    // Wait for Firebase to be ready (firebase-config.js initializes it)
    await waitForFirebase();

    // Verify the action code
    try {
      const info = await firebase.auth().checkActionCode(oobCode);
      _verifiedEmail = info.data.email || '';
      if (_verifiedEmail) {
        document.getElementById('resetEmailLabel').textContent =
          `Resetting password for ${_verifiedEmail}`;
      }
      showState('stateForm');
      document.getElementById('newPassword').focus();
    } catch (err) {
      showState('stateInvalid');
      if (err.code === 'auth/expired-action-code') {
        document.getElementById('invalidMsg').textContent =
          'This reset link has expired. Reset links are valid for 1 hour. Please request a new one.';
      } else if (err.code === 'auth/invalid-action-code') {
        document.getElementById('invalidMsg').textContent =
          'This reset link has already been used or is invalid. Please request a new one.';
      } else {
        document.getElementById('invalidMsg').textContent =
          'Could not verify this link: ' + err.message;
      }
    }
  });

  function waitForFirebase() {
    return new Promise((resolve) => {
      if (typeof firebase !== 'undefined' && firebase.auth) { resolve(); return; }
      let attempts = 0;
      const t = setInterval(() => {
        attempts++;
        if (typeof firebase !== 'undefined' && firebase.auth) { clearInterval(t); resolve(); }
        if (attempts > 30) { clearInterval(t); resolve(); } // give up after 3s, let it fail naturally
      }, 100);
    });
  }

  // ─── Strength meter ──────────────────────────────────────────────────────────
  function checkStrength(val) {
    const fill = document.getElementById('strengthFill');
    const label = document.getElementById('strengthLabel');
    if (!val) { fill.style.width = '0'; label.textContent = 'Enter a password'; return; }

    let score = 0;
    if (val.length >= 8)  score++;
    if (val.length >= 12) score++;
    if (/[A-Z]/.test(val)) score++;
    if (/[0-9]/.test(val)) score++;
    if (/[^A-Za-z0-9]/.test(val)) score++;

    const levels = [
      { pct: '20%', color: '#ef4444', text: 'Very weak' },
      { pct: '40%', color: '#f97316', text: 'Weak' },
      { pct: '60%', color: '#eab308', text: 'Fair' },
      { pct: '80%', color: '#22c55e', text: 'Strong' },
      { pct: '100%', color: '#10b981', text: 'Very strong' },
    ];
    const lvl = levels[Math.min(score - 1, 4)] || levels[0];
    fill.style.width = lvl.pct;
    fill.style.background = lvl.color;
    label.textContent = lvl.text;
    label.style.color = lvl.color;
  }

  // ─── Toggle password visibility ──────────────────────────────────────────────
  function togglePw(inputId, iconId) {
    const inp = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    inp.type = inp.type === 'password' ? 'text' : 'password';
    icon.className = inp.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
  }

  // ─── Handle reset submit ─────────────────────────────────────────────────────
  async function handleReset(e) {
    e.preventDefault();
    const newPw  = document.getElementById('newPassword').value;
    const confPw = document.getElementById('confirmPassword').value;
    const btn    = document.getElementById('resetBtn');
    const errEl  = document.getElementById('errorAlert');
    const errMsg = document.getElementById('errorMsg');
    errEl.classList.remove('show');

    if (newPw !== confPw) {
      errMsg.textContent = 'Passwords do not match.';
      errEl.classList.add('show');
      return;
    }
    if (newPw.length < 8) {
      errMsg.textContent = 'Password must be at least 8 characters.';
      errEl.classList.add('show');
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating…';

    try {
      await firebase.auth().confirmPasswordReset(oobCode, newPw);
      showState('stateSuccess');
    } catch (err) {
      errEl.classList.add('show');
      if (err.code === 'auth/expired-action-code') {
        errMsg.textContent = 'This link has expired. Please request a new password reset.';
        setTimeout(() => showState('stateInvalid'), 2000);
      } else if (err.code === 'auth/weak-password') {
        errMsg.textContent = 'Password is too weak. Use at least 8 characters with a mix of letters and numbers.';
      } else {
        errMsg.textContent = 'Could not update password: ' + err.message;
      }
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-shield-halved"></i> Update Password';
    }
  }

  // ─── Request new link ────────────────────────────────────────────────────────
  function requestNewLink() {
    // Redirect to login with a hint
    if (_verifiedEmail) {
      window.location.href = `login.html?reset_hint=${encodeURIComponent(_verifiedEmail)}`;
    } else {
      window.location.href = 'login.html';
    }
  }
</script>
</body>
</html>
