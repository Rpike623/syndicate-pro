<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Investors</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="js/sp-email.js"></script>
  <style>
    :root {
      --primary: #0f172a; --accent: #3b82f6; --accent-hover: #2563eb; --accent-light: #dbeafe;
      --success: #10b981; --success-light: #d1fae5;
      --warning: #f59e0b; --warning-light: #fef3c7;
      --danger: #ef4444; --danger-light: #fee2e2;
      --purple: #8b5cf6; --purple-light: #ede9fe;
      --text: #0f172a; --text-secondary: #64748b; --text-muted: #94a3b8;
      --border: #e2e8f0; --border-light: #f1f5f9;
      --bg: #f8fafc; --bg-card: #ffffff; --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0/0.05); --shadow: 0 1px 3px 0 rgb(0 0 0/0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0/0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0/0.1);
      --radius-sm: 6px; --radius: 8px; --radius-md: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 1.25rem; font-weight: 700; text-decoration: none; color: white; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #60a5fa); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
    .nav-section { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.4); padding: 16px 12px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius); color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: all 0.15s; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .sidebar-footer { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--success), #34d399); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; color: white; flex-shrink: 0; }
    .user-details { flex: 1; }
    .user-name { font-size: 0.9rem; font-weight: 600; }
    .user-role { font-size: 0.75rem; color: rgba(255,255,255,0.5); }
    .main { flex: 1; margin-left: 260px; min-height: 100vh; }
    .top-bar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .top-left { display: flex; align-items: center; gap: 16px; }
    .mobile-menu-btn { display: none; background: none; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 10px; cursor: pointer; }
    .page-title-bar h1 { font-size: 1.25rem; font-weight: 700; }
    .page-title-bar p { font-size: 0.8rem; color: var(--text-secondary); }
    .top-actions { display: flex; gap: 10px; align-items: center; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; font-size: 0.875rem; font-weight: 600; border-radius: var(--radius); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; font-family: 'Inter', sans-serif; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border-light); }
    .content { padding: 32px; }
    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; display: flex; align-items: center; gap: 14px; }
    .stat-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .stat-icon.blue { background: var(--accent-light); color: var(--accent); }
    .stat-icon.green { background: var(--success-light); color: var(--success); }
    .stat-icon.amber { background: var(--warning-light); color: var(--warning); }
    .stat-icon.purple { background: var(--purple-light); color: var(--purple); }
    .stat-body .val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .stat-body .lbl { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
    /* Toolbar */
    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .search-wrap { position: relative; flex: 1; min-width: 200px; }
    .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.875rem; }
    .search-input { width: 100%; padding: 10px 12px 10px 36px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; background: var(--bg-card); color: var(--text); outline: none; transition: all 0.15s; font-family: 'Inter', sans-serif; }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    select { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; background: var(--bg-card); color: var(--text); outline: none; cursor: pointer; font-family: 'Inter', sans-serif; }
    /* Table */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--border-light); }
    th { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); padding: 12px 16px; text-align: left; white-space: nowrap; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border-light); font-size: 0.875rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(59,130,246,0.02); }
    .investor-name { font-weight: 600; }
    .investor-email { font-size: 0.8rem; color: var(--text-secondary); }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .badge-verified { background: var(--success-light); color: var(--success); }
    .badge-pending { background: var(--warning-light); color: var(--warning); }
    .badge-expired { background: var(--danger-light); color: var(--danger); }
    .badge-active { background: var(--success-light); color: var(--success); }
    .badge-inactive { background: var(--border-light); color: var(--text-secondary); }
    .money { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
    .action-btns { display: flex; gap: 6px; }
    .btn-xs { padding: 5px 10px; font-size: 0.75rem; font-weight: 600; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px; font-family: 'Inter', sans-serif; }
    .btn-xs:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-xs.danger:hover { background: var(--danger); border-color: var(--danger); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state i { font-size: 2.5rem; margin-bottom: 16px; display: block; opacity: 0.3; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-state p { font-size: 0.875rem; }
    .table-footer { padding: 14px 20px; border-top: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: var(--border-light); }
    .table-footer-info { font-size: 0.8rem; color: var(--text-secondary); }
    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg-card); border-radius: var(--radius-md); width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
    .modal-header { padding: 24px 28px 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.2rem; font-weight: 700; }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--border-light); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 0.9rem; }
    .modal-close:hover { background: var(--danger-light); color: var(--danger); }
    .modal-body { padding: 24px 28px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; color: var(--text); background: var(--bg-card); outline: none; transition: all 0.15s; font-family: 'Inter', sans-serif; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .modal-footer { padding: 0 28px 24px; display: flex; justify-content: flex-end; gap: 10px; }
    /* Avatar colors */
    .investor-av { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: white; flex-shrink: 0; }
    .av-0 { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
    .av-1 { background: linear-gradient(135deg, #10b981, #34d399); }
    .av-2 { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
    .av-3 { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
    .av-4 { background: linear-gradient(135deg, #ef4444, #f87171); }
    .av-5 { background: linear-gradient(135deg, #06b6d4, #22d3ee); }
    .investor-cell { display: flex; align-items: center; gap: 10px; }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    .sidebar-overlay.visible { display: block; }
    @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0 !important; }
      .mobile-menu-btn { display: flex !important; }
      .top-bar { padding: 12px 16px; }
      .content { padding: 16px; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">◆</div><span>deeltrack</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item active"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <div class="page-title-bar"><h1>Investors</h1><p>Manage your limited partners and track commitments</p></div>
      </div>
      <div class="top-actions">
        <button class="btn btn-secondary" onclick="openCSVModal()"><i class="fas fa-file-csv"></i> Import CSV</button>
        <button class="btn btn-primary" onclick="openModal()"><i class="fas fa-user-plus"></i> Add Investor</button>
      </div>
    </header>

    <div class="content">
      <div class="stats-row">
        <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-users"></i></div><div class="stat-body"><div class="val" id="statTotal">0</div><div class="lbl">Total Investors</div></div></div>
        <div class="stat-card"><div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div><div class="stat-body"><div class="val" id="statCapital">$0</div><div class="lbl">Total Committed</div></div></div>
        <div class="stat-card"><div class="stat-icon amber"><i class="fas fa-shield-alt"></i></div><div class="stat-body"><div class="val" id="statAccredited">0%</div><div class="lbl">Accredited</div></div></div>
        <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-chart-line"></i></div><div class="stat-body"><div class="val" id="statAvg">$0</div><div class="lbl">Avg Investment</div></div></div>
      </div>

      <div class="toolbar">
        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" class="search-input" id="searchInput" placeholder="Search investors…" oninput="filterTable()"></div>
        <select id="filterAccreditation" onchange="filterTable()">
          <option value="">All Accreditation</option>
          <option value="verified">Verified</option>
          <option value="pending">Pending</option>
          <option value="expired">Expired</option>
        </select>
        <select id="filterStatus" onchange="filterTable()">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <button class="btn btn-secondary" onclick="exportCSV()"><i class="fas fa-download"></i> Export</button>
      </div>

      <div class="card">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Investor</th>
                <th>Phone</th>
                <th>Accreditation</th>
                <th>Total Invested</th>
                <th># Deals</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="investorTableBody"></tbody>
          </table>
        </div>
        <div class="table-footer">
          <div class="table-footer-info" id="tableInfo">Showing 0 investors</div>
          <button class="btn btn-secondary" style="padding:6px 14px;font-size:0.8rem;" onclick="openModal()"><i class="fas fa-plus"></i> Add Investor</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Add Investor</h2>
      <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      <div class="form-row">
        <div class="form-group"><label>First Name *</label><input type="text" id="fFirstName" placeholder="James"></div>
        <div class="form-group"><label>Last Name *</label><input type="text" id="fLastName" placeholder="Hartwell"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Email *</label><input type="email" id="fEmail" placeholder="james@email.com"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="fPhone" placeholder="(555) 000-0000"></div>
      </div>
      <div class="form-group"><label>Address</label><input type="text" id="fAddress" placeholder="123 Main St, City, State 00000"></div>
      <div class="form-row">
        <div class="form-group"><label>Accreditation Method</label>
          <select id="fAccredMethod">
            <option value="">Select method</option>
            <option value="cpa">CPA Letter</option>
            <option value="attorney">Attorney Letter</option>
            <option value="broker">Licensed Broker Verification</option>
            <option value="self">Self-Certification</option>
            <option value="entity">Entity Accreditation</option>
          </select>
        </div>
        <div class="form-group"><label>Accreditation Status</label>
          <select id="fAccredStatus">
            <option value="verified">Verified</option>
            <option value="pending">Pending</option>
            <option value="expired">Expired</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Verification Date</label><input type="date" id="fAccredDate" placeholder="Date verified"></div>
        <div class="form-group"><label>Expiry Date</label><input type="date" id="fAccredExpiry" placeholder="Expiry (usually +2 years)"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Min Investment ($)</label><input type="number" id="fMinInvest" placeholder="50000"></div>
        <div class="form-group"><label>Max Investment ($)</label><input type="number" id="fMaxInvest" placeholder="500000"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Total Invested ($)</label><input type="number" id="fTotalInvested" placeholder="0"></div>
        <div class="form-group"><label>Status</label>
          <select id="fStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select>
        </div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fNotes" placeholder="Investment preferences, communication history, etc."></textarea></div>
      <div class="form-group">
        <label><i class="fas fa-paperclip" style="margin-right:4px;color:var(--accent);"></i>Accreditation Document</label>
        <div id="accredDocZone" style="border:2px dashed var(--border);border-radius:var(--radius);padding:14px;text-align:center;cursor:pointer;transition:all .2s;position:relative;" onclick="document.getElementById('accredDocFile').click()">
          <div id="accredDocLabel" style="font-size:.82rem;color:var(--text-muted);"><i class="fas fa-cloud-upload-alt" style="margin-right:6px;"></i>Click to upload CPA letter, attorney letter, or verification doc (PDF/JPG, max 5MB)</div>
          <input type="file" id="accredDocFile" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="handleAccredDoc(event)">
        </div>
        <input type="hidden" id="fAccredDoc" value="">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveInvestor()"><i class="fas fa-save"></i> Save Investor</button>
    </div>
  </div>
</div>

<!-- CSV Import Modal -->
<div class="modal-overlay" id="csvModal" onclick="handleCSVOverlay(event)">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <h2 class="modal-title"><i class="fas fa-file-csv" style="color:var(--success);margin-right:8px;"></i>Import Investors from CSV</h2>
      <button class="modal-close" onclick="closeCSVModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div style="background:var(--border-light);border-radius:var(--radius);padding:14px 16px;margin-bottom:16px;font-size:.82rem;color:var(--text-secondary);">
        <div style="font-weight:600;margin-bottom:6px;">Expected CSV columns (any order):</div>
        <code style="font-size:.78rem;">first_name, last_name, email, phone, address, accredited, invested, notes</code>
        <div style="margin-top:6px;">Or use: <code>name, email</code> as a minimal format. Duplicates (same email) are skipped.</div>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">Upload CSV File</label>
        <input type="file" id="csvFile" accept=".csv,text/csv" onchange="handleCSVFile(event)" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:var(--radius);font-family:'Inter',sans-serif;font-size:.875rem;">
      </div>
      <div id="csvPreviewArea"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
      <a href="data:text/csv;charset=utf-8,first_name%2Clast_name%2Cemail%2Cphone%2Caddress%2Caccredited%2Cinvested%2Cnotes%0AJohn%2CSmith%2Cjohn%40email.com%2C5550001%2C123+Main+St%2Cverified%2C100000%2CNotes+here" download="investor-import-template.csv" class="btn btn-secondary"><i class="fas fa-download"></i> Download Template</a>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal-overlay" id="inviteOverlay" onclick="handleInviteOverlayClick(event)">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <h2 class="modal-title"><i class="fas fa-paper-plane" style="color:var(--accent);margin-right:8px;"></i>Invite Investor to Portal</h2>
      <button class="modal-close" onclick="closeInviteModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <!-- Success banner -->
      <div style="background:var(--success-light);border:1px solid var(--success);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:10px;margin-bottom:20px;">
        <i class="fas fa-check-circle" style="color:var(--success);font-size:1.1rem;"></i>
        <div>
          <div style="font-weight:600;color:#065f46;">Investor added successfully!</div>
          <div style="font-size:0.8rem;color:#047857;margin-top:2px;">Send them an invite to create their investor portal account.</div>
        </div>
      </div>

      <!-- Invite link -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:0.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">
          <i class="fas fa-link" style="margin-right:4px;"></i>Personal Invite Link
        </label>
        <div style="display:flex;gap:8px;">
          <input type="text" id="inviteLinkInput" readonly style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:0.8rem;background:var(--border-light);color:var(--text-secondary);font-family:monospace;">
          <button class="btn btn-secondary" onclick="copyInviteLink()" id="copyBtn" style="padding:10px 14px;white-space:nowrap;">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:6px;"><i class="fas fa-info-circle"></i> Link pre-fills their name and email on the signup page</div>
      </div>

      <!-- Email preview -->
      <div style="margin-bottom:4px;">
        <label style="display:block;font-size:0.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">
          <i class="fas fa-envelope" style="margin-right:4px;"></i>Email Preview
        </label>
        <div style="border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
          <div style="background:var(--border-light);padding:10px 14px;border-bottom:1px solid var(--border);font-size:0.8rem;color:var(--text-secondary);">
            <div><strong>To:</strong> <span id="inviteToLine">—</span></div>
            <div style="margin-top:3px;"><strong>Subject:</strong> <span id="inviteSubjectLine">You've been invited to deeltrack</span></div>
          </div>
          <div id="inviteEmailBody" style="padding:16px;font-size:0.85rem;line-height:1.7;color:var(--text);background:white;white-space:pre-wrap;max-height:220px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="gap:10px;flex-wrap:wrap;">
      <button class="btn btn-secondary" onclick="closeInviteModal()">Skip for Now</button>
      <button class="btn btn-secondary" onclick="copyEmailText()" style="gap:6px;"><i class="fas fa-copy"></i> Copy Email</button>
      <button class="btn btn-secondary" onclick="sendInviteEmail()" style="gap:6px;"><i class="fas fa-envelope-open"></i> Open in Email Client</button>
      <button class="btn btn-primary" onclick="sendInviteViaDeeltrack()" style="gap:6px;background:linear-gradient(135deg,#6366f1,#818cf8);"><i class="fas fa-paper-plane"></i> Send via deeltrack</button>
    </div>
  </div>
</div>

<!-- Link to Deal Modal -->
<div class="modal-overlay" id="dealLinkOverlay" onclick="handleDealLinkOverlayClick(event)">
  <div class="modal" style="max-width:520px;">
    <div class="modal-header">
      <h2 class="modal-title"><i class="fas fa-link" style="color:var(--accent);margin-right:8px;"></i>Link Investor to Deal</h2>
      <button class="modal-close" onclick="closeDealLinkModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div style="background:var(--border-light);border-radius:var(--radius);padding:12px 14px;margin-bottom:20px;font-size:0.875rem;color:var(--text-secondary);">
        <i class="fas fa-user" style="color:var(--accent);margin-right:6px;"></i>
        Linking: <strong id="dlInvestorName" style="color:var(--text);">—</strong>
      </div>
      <div class="form-group">
        <label>Select Deal *</label>
        <select id="dlDealSelect" onchange="updateOwnership()">
          <option value="">— Choose a deal —</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Committed Amount ($) *</label>
          <input type="number" id="dlCommitted" placeholder="250000" oninput="updateOwnership()">
        </div>
        <div class="form-group">
          <label>Ownership %</label>
          <input type="text" id="dlOwnership" placeholder="Auto-calculated" readonly style="background:var(--border-light);color:var(--text-secondary);">
        </div>
      </div>
      <div class="form-group">
        <label>Investment Status</label>
        <select id="dlStatus">
          <option value="committed">Committed</option>
          <option value="funded">Funded</option>
          <option value="active">Active</option>
          <option value="exited">Exited</option>
        </select>
      </div>
      <div id="dlAlreadyLinked" style="display:none;background:var(--warning-light);border:1px solid var(--warning);border-radius:var(--radius);padding:10px 14px;font-size:0.82rem;color:#92400e;margin-top:-8px;">
        <i class="fas fa-exclamation-triangle"></i> This investor is already linked to this deal. Saving will update their existing entry.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDealLinkModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveDealLink()"><i class="fas fa-link"></i> Link to Deal</button>
    </div>
  </div>
</div>

<script>
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('visible');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('visible');
}

const DEMO_INVESTORS = [
  { id:'i1', firstName:'James', lastName:'Hartwell', email:'j.hartwell@email.com', phone:'(214) 555-0101', address:'4521 Oak Blvd, Dallas, TX 75201', accredMethod:'cpa', accredStatus:'verified', minInvest:100000, maxInvest:500000, totalInvested:500000, deals:2, status:'active', notes:'High net worth individual. Prefers multifamily in Texas markets.' },
  { id:'i2', firstName:'Sarah', lastName:'Chen', email:'s.chen@capitalgroup.com', phone:'(713) 555-0202', address:'1800 Post Oak Blvd, Houston, TX 77056', accredMethod:'entity', accredStatus:'verified', minInvest:250000, maxInvest:1000000, totalInvested:750000, deals:3, status:'active', notes:'Represents a family office. Very responsive.' },
  { id:'i3', firstName:'Marcus', lastName:'Williams', email:'mwilliams@invest.com', phone:'(512) 555-0303', address:'200 W Cesar Chavez, Austin, TX 78701', accredMethod:'attorney', accredStatus:'verified', minInvest:50000, maxInvest:250000, totalInvested:250000, deals:1, status:'active', notes:'First-time syndication investor. Prefers conservative deals.' },
  { id:'i4', firstName:'Priya', lastName:'Patel', email:'ppatel@wealth.com', phone:'(469) 555-0404', address:'5000 Granite Pkwy, Plano, TX 75024', accredMethod:'cpa', accredStatus:'verified', minInvest:500000, maxInvest:2000000, totalInvested:1000000, deals:2, status:'active', notes:'Prefers industrial and multifamily. Long-term hold strategy.' },
  { id:'i5', firstName:'Robert', lastName:'Thompson', email:'r.thompson@gmail.com', phone:'(817) 555-0505', address:'3500 Camp Bowie, Fort Worth, TX 76107', accredMethod:'self', accredStatus:'pending', minInvest:25000, maxInvest:100000, totalInvested:150000, deals:1, status:'active', notes:'Accreditation renewal pending. Follow up end of Q1.' },
  { id:'i6', firstName:'Elena', lastName:'Vasquez', email:'evasquez@invest.net', phone:'(210) 555-0606', address:'115 E Travis, San Antonio, TX 78205', accredMethod:'broker', accredStatus:'verified', minInvest:100000, maxInvest:500000, totalInvested:350000, deals:2, status:'active', notes:'Interested in deals near San Antonio.' },
  { id:'i7', firstName:'Phil', lastName:'Chapman', email:'philip@jchapmancpa.com', phone:'', address:'', accredMethod:'cpa', accredStatus:'verified', minInvest:50000, maxInvest:500000, totalInvested:1075000, deals:8, status:'invited', notes:'CPA invited to test investor portal flow. Committed to 8 deals totaling $1.075M across multifamily, industrial, retail, self-storage, and hospitality. Portal access pending signup.', invitedAt: new Date().toISOString() },
];

// Auth guard — GP only
SP.requireGP();

let investors = [];
let editingId = null;

function load() {
  investors = SP.getInvestors();
  if (!investors.length) {
    investors = DEMO_INVESTORS.map(i => ({...i}));
    SP.saveInvestors(investors);
  }
}

function save() { SP.saveInvestors(investors); }

function fmt$(n) {
  if (!n) return '$0';
  if (n >= 1e6) return '$'+(n/1e6).toFixed(1)+'M';
  if (n >= 1e3) return '$'+(n/1e3).toFixed(0)+'K';
  return '$'+n.toFixed(0);
}

function initials(inv) { return (inv.firstName[0]||'') + (inv.lastName[0]||''); }

function updateStats() {
  const total = investors.length;
  const capital = investors.reduce((s,i)=>s+(i.totalInvested||0),0);
  const accredited = investors.filter(i=>i.accredStatus==='verified').length;
  const avg = total ? Math.round(capital/total) : 0;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statCapital').textContent = fmt$(capital);
  document.getElementById('statAccredited').textContent = total ? Math.round(accredited/total*100)+'%' : '0%';
  document.getElementById('statAvg').textContent = fmt$(avg);
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const accFilter = document.getElementById('filterAccreditation').value;
  const statusFilter = document.getElementById('filterStatus').value;
  let filtered = investors.filter(inv => {
    const name = `${inv.firstName} ${inv.lastName}`.toLowerCase();
    const matchQ = !q || name.includes(q) || (inv.email||'').toLowerCase().includes(q) || (inv.phone||'').includes(q);
    const matchAcc = !accFilter || inv.accredStatus === accFilter;
    const matchStatus = !statusFilter || inv.status === statusFilter;
    return matchQ && matchAcc && matchStatus;
  });
  renderTable(filtered);
}

function renderTable(list) {
  const tbody = document.getElementById('investorTableBody');
  document.getElementById('tableInfo').textContent = `Showing ${list.length} of ${investors.length} investor${investors.length!==1?'s':''}`;
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-users"></i><h3>No investors found</h3><p>Try adjusting your search or <button onclick="openModal()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:inherit;font-family:inherit;font-weight:600;">add a new investor</button></p></div></td></tr>`;
    return;
  }
  const today = new Date();
  // Auto-expire investors whose expiry date has passed
  list.forEach(inv => {
    if (inv.accredExpiry && inv.accredStatus === 'verified') {
      const exp = new Date(inv.accredExpiry);
      if (exp < today) {
        inv.accredStatus = 'expired';
        const idx = investors.findIndex(i => i.id === inv.id);
        if (idx >= 0) { investors[idx].accredStatus = 'expired'; save(); }
      }
    }
  });
  const accBadge = {
    verified: (inv) => {
      if (!inv.accredExpiry) return '<span class="badge badge-verified"><i class="fas fa-check-circle"></i> Verified</span>';
      const daysLeft = Math.ceil((new Date(inv.accredExpiry) - today) / 86400000);
      if (daysLeft <= 30 && daysLeft > 0) return `<span class="badge" style="background:#fef3c7;color:#b45309;"><i class="fas fa-exclamation-triangle"></i> Expires in ${daysLeft}d</span>`;
      return '<span class="badge badge-verified"><i class="fas fa-check-circle"></i> Verified</span>';
    },
    pending: () => '<span class="badge badge-pending"><i class="fas fa-clock"></i> Pending</span>',
    expired: () => '<span class="badge badge-expired"><i class="fas fa-times-circle"></i> Expired</span>',
  };
  const statusBadge = { active:'<span class="badge badge-active">Active</span>', inactive:'<span class="badge badge-inactive">Inactive</span>' };
  const allDeals = SP.getDeals();
  tbody.innerHTML = list.map((inv, idx) => {
    // Count deals this investor is actually linked to
    const linkedDeals = allDeals.filter(d => Array.isArray(d.investors) && d.investors.some(i => i.investorId === inv.id));
    return `
    <tr>
      <td>
        <div class="investor-cell">
          <div class="investor-av av-${idx%6}">${initials(inv)}</div>
          <div><div class="investor-name"><a href="investor-detail.html?id=${inv.id}" style="color:inherit;text-decoration:none;">${inv.firstName} ${inv.lastName}</a></div><div class="investor-email">${inv.email}</div></div>
        </div>
      </td>
      <td style="color:var(--text-secondary);font-size:0.85rem;">${inv.phone||'—'}</td>
      <td>${(accBadge[inv.accredStatus]||accBadge.pending)(inv)}</td>
      <td class="money">${fmt$(inv.totalInvested||0)}</td>
      <td style="text-align:center;">
        <span style="font-weight:600;">${linkedDeals.length}</span>
        ${linkedDeals.length ? `<div style="font-size:0.7rem;color:var(--text-muted);">${linkedDeals.map(d=>d.name).slice(0,2).join(', ')}${linkedDeals.length>2?' +more':''}</div>` : ''}
      </td>
      <td>${statusBadge[inv.status]||'—'}</td>
      <td>
        <div class="action-btns">
          <button class="btn-xs" onclick="editInvestor('${inv.id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="btn-xs" onclick="openDealLinkModal('${inv.id}')" title="Link to Deal" style="color:var(--accent);"><i class="fas fa-link"></i></button>
          ${inv.accredDoc?`<button class="btn-xs" onclick="viewAccredDoc('${inv.id}')" title="View Accred Doc" style="color:var(--success);"><i class="fas fa-file-shield"></i></button>`:''}
          ${(inv.accredStatus==='expired'||daysUntilExpiry(inv)<=30)?`<button class="btn-xs" onclick="sendRenewalReminder('${inv.id}')" title="Send Renewal Reminder" style="color:var(--warning);"><i class="fas fa-bell"></i></button>`:''}
          <button class="btn-xs" onclick="emailInvestor('${inv.id}')" title="Email"><i class="fas fa-envelope"></i></button>
          <button class="btn-xs danger" onclick="deleteInvestor('${inv.id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function openModal(id) {
  editingId = id || null;
  document.getElementById('modalTitle').textContent = id ? 'Edit Investor' : 'Add Investor';
  const fields = ['editId','fFirstName','fLastName','fEmail','fPhone','fAddress','fAccredMethod','fAccredStatus','fMinInvest','fMaxInvest','fTotalInvested','fStatus','fNotes'];
  if (id) {
    const inv = investors.find(i=>i.id===id);
    if (inv) {
      document.getElementById('editId').value = id;
      document.getElementById('fFirstName').value = inv.firstName||'';
      document.getElementById('fLastName').value = inv.lastName||'';
      document.getElementById('fEmail').value = inv.email||'';
      document.getElementById('fPhone').value = inv.phone||'';
      document.getElementById('fAddress').value = inv.address||'';
      document.getElementById('fAccredMethod').value = inv.accredMethod||'';
      document.getElementById('fAccredStatus').value = inv.accredStatus||'pending';
      document.getElementById('fAccredDate').value = inv.accredDate||'';
      document.getElementById('fAccredExpiry').value = inv.accredExpiry||'';
      document.getElementById('fAccredDoc').value = inv.accredDoc||'';
      const docLabel = document.getElementById('accredDocLabel');
      const docZone = document.getElementById('accredDocZone');
      if (inv.accredDoc) {
        docZone.style.borderColor='var(--success)';docZone.style.background='var(--success-light)';
        docLabel.innerHTML='<i class="fas fa-check-circle" style="color:var(--success);margin-right:6px;"></i><strong>Document on file</strong> — upload new to replace';
      } else {
        docZone.style.borderColor='';docZone.style.background='';
        docLabel.innerHTML='<i class="fas fa-cloud-upload-alt" style="margin-right:6px;"></i>Click to upload CPA letter, attorney letter, or verification doc (PDF/JPG, max 5MB)';
      }
      document.getElementById('fMinInvest').value = inv.minInvest||'';
      document.getElementById('fMaxInvest').value = inv.maxInvest||'';
      document.getElementById('fTotalInvested').value = inv.totalInvested||'';
      document.getElementById('fStatus').value = inv.status||'active';
      document.getElementById('fNotes').value = inv.notes||'';
    }
  } else {
    fields.forEach(f => { const el = document.getElementById(f); if (el) el.value = f==='fAccredStatus'?'pending':f==='fStatus'?'active':''; });
    document.getElementById('fAccredDoc').value='';
    const dz=document.getElementById('accredDocZone');const dl=document.getElementById('accredDocLabel');
    if(dz){dz.style.borderColor='';dz.style.background='';}
    if(dl) dl.innerHTML='<i class="fas fa-cloud-upload-alt" style="margin-right:6px;"></i>Click to upload CPA letter, attorney letter, or verification doc (PDF/JPG, max 5MB)';
  }
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function saveInvestor() {
  const firstName = document.getElementById('fFirstName').value.trim();
  const lastName = document.getElementById('fLastName').value.trim();
  const email = document.getElementById('fEmail').value.trim();
  if (!firstName || !lastName || !email) { alert('First name, last name, and email are required.'); return; }
  const data = {
    firstName, lastName, email,
    phone: document.getElementById('fPhone').value.trim(),
    address: document.getElementById('fAddress').value.trim(),
    accredMethod: document.getElementById('fAccredMethod').value,
    accredStatus: document.getElementById('fAccredStatus').value,
    accredDate: document.getElementById('fAccredDate').value || '',
    accredExpiry: document.getElementById('fAccredExpiry').value || '',
    accredDoc: document.getElementById('fAccredDoc').value || '',
    minInvest: parseFloat(document.getElementById('fMinInvest').value)||0,
    maxInvest: parseFloat(document.getElementById('fMaxInvest').value)||0,
    totalInvested: parseFloat(document.getElementById('fTotalInvested').value)||0,
    deals: 0,
    status: document.getElementById('fStatus').value,
    notes: document.getElementById('fNotes').value.trim(),
  };
  const isNew = !editingId;
  if (editingId) {
    const idx = investors.findIndex(i=>i.id===editingId);
    if (idx>=0) { data.id=editingId; data.deals=investors[idx].deals||0; investors[idx]={...investors[idx],...data}; }
  } else {
    data.id = 'i' + Date.now();
    investors.unshift(data);
    logActivity('fa-user-plus','green',`<strong>${firstName} ${lastName}</strong> added as new investor`);
  }
  save(); updateStats(); filterTable(); closeModal();
  // Show invite modal only for new investors
  if (isNew) openInviteModal(firstName, lastName, email);
}

function editInvestor(id) { openModal(id); }

function deleteInvestor(id) {
  SP.deleteInvestor(id); // Remove from Firestore + cache
  const inv = investors.find(i=>i.id===id);
  if (!inv) return;
  if (!confirm(`Delete ${inv.firstName} ${inv.lastName}? This cannot be undone.`)) return;
  investors = investors.filter(i=>i.id!==id);
  save(); updateStats(); filterTable();
}

function emailInvestor(id) {
  const inv = investors.find(i=>i.id===id);
  if (inv) window.location.href = `email-templates.html?to=${encodeURIComponent(inv.email)}&name=${encodeURIComponent(inv.firstName+' '+inv.lastName)}`;
}

function daysUntilExpiry(inv) {
  if (!inv.accredExpiry) return 999;
  return Math.ceil((new Date(inv.accredExpiry) - new Date()) / 86400000);
}

function viewAccredDoc(id) {
  const inv = investors.find(i=>i.id===id);
  if (!inv?.accredDoc) return;
  const w = window.open();
  w.document.write(`<html><body style="margin:0;background:#000;"><img src="${inv.accredDoc}" style="max-width:100%;height:auto;"><iframe src="${inv.accredDoc}" style="width:100%;height:100vh;border:none;"></iframe></body></html>`);
}

function sendRenewalReminder(id) {
  const inv = investors.find(i=>i.id===id);
  if (!inv) return;
  const settings = SP.load('settings', {});
  const gpName = settings.gpFullName || SP.getSession()?.name || 'Your Sponsor';
  const subject = `Accreditation Renewal Required — Action Needed`;
  const body = `Hi ${inv.firstName},

Your accredited investor status${inv.accredExpiry?' (verified '+(inv.accredDate||'previously')+', expiring '+inv.accredExpiry+')':''} requires renewal to continue participating in syndication offerings.

To renew your accreditation, please provide one of the following:
  • A letter from your CPA confirming accredited status
  • A letter from your licensed attorney
  • Verification through a registered broker-dealer

Please reply to this email or contact us directly to arrange verification.

Best regards,
${gpName}`;
  window.open(`mailto:${inv.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
  SP.logActivity('fa-bell','amber',`Renewal reminder sent to <strong>${inv.firstName} ${inv.lastName}</strong>`);
}

function exportCSV() {
  const headers = ['First Name','Last Name','Email','Phone','Accreditation','Total Invested','Deals','Status'];
  const rows = investors.map(i => [i.firstName,i.lastName,i.email,i.phone||'',i.accredStatus,i.totalInvested||0,i.deals||0,i.status]);
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'investors.csv';
  a.click();
}

function logActivity(icon, color, text) {
  SP.logActivity(icon.replace('fa-','fas fa-').replace('fas fa-fas fa-','fas fa-'), color, text);
}

// ── Deal-link modal ───────────────────────────────────────────────────────────
let _dlInvestorId = null;

function openDealLinkModal(investorId) {
  _dlInvestorId = investorId;
  const inv = investors.find(i => i.id === investorId);
  if (!inv) return;
  document.getElementById('dlInvestorName').textContent = `${inv.firstName} ${inv.lastName}`;
  document.getElementById('dlCommitted').value = '';
  document.getElementById('dlOwnership').value = '';
  document.getElementById('dlAlreadyLinked').style.display = 'none';

  // Populate deals dropdown
  const deals = SP.getDeals().filter(d => !['closed','exited'].includes(d.status));
  const sel = document.getElementById('dlDealSelect');
  sel.innerHTML = '<option value="">— Choose a deal —</option>' +
    deals.map(d => `<option value="${d.id}" data-raise="${d.raise||0}">${d.name}${d.location?' · '+d.location:''} (${fmtStatus(d.status)})</option>`).join('');

  document.getElementById('dealLinkOverlay').classList.add('open');
}

function fmtStatus(s) {
  return {sourcing:'Sourcing',loi:'LOI',dd:'Due Diligence',closed:'Closed',operating:'Operating'}[s]||s||'—';
}

function closeDealLinkModal() { document.getElementById('dealLinkOverlay').classList.remove('open'); }
function handleDealLinkOverlayClick(e) { if(e.target===document.getElementById('dealLinkOverlay')) closeDealLinkModal(); }

function updateOwnership() {
  const sel = document.getElementById('dlDealSelect');
  const opt = sel.options[sel.selectedIndex];
  const raise = parseFloat(opt?.dataset?.raise || 0);
  const committed = parseFloat(document.getElementById('dlCommitted').value) || 0;
  if (raise > 0 && committed > 0) {
    document.getElementById('dlOwnership').value = (committed / raise * 100).toFixed(2) + '%';
  } else {
    document.getElementById('dlOwnership').value = '';
  }
  // Check if already linked
  if (_dlInvestorId && sel.value) {
    const deal = SP.getDealById(sel.value);
    const already = deal && Array.isArray(deal.investors) && deal.investors.some(i => i.investorId === _dlInvestorId);
    document.getElementById('dlAlreadyLinked').style.display = already ? 'block' : 'none';
  }
}

function saveDealLink() {
  const dealId = document.getElementById('dlDealSelect').value;
  const committed = parseFloat(document.getElementById('dlCommitted').value) || 0;
  const status = document.getElementById('dlStatus').value;
  if (!dealId) { alert('Please select a deal.'); return; }
  if (!committed) { alert('Please enter a committed amount.'); return; }
  const sel = document.getElementById('dlDealSelect');
  const raise = parseFloat(sel.options[sel.selectedIndex]?.dataset?.raise || 0);
  const ownership = raise > 0 ? parseFloat((committed / raise * 100).toFixed(4)) : 0;
  SP.addInvestorToDeal(dealId, { investorId: _dlInvestorId, committed, ownership, status, linkedAt: new Date().toISOString() });
  // Update investor's total invested
  const inv = investors.find(i => i.id === _dlInvestorId);
  if (inv) {
    const allLinked = SP.getDeals().filter(d => Array.isArray(d.investors) && d.investors.some(i => i.investorId === _dlInvestorId));
    inv.totalInvested = allLinked.reduce((s,d) => {
      const entry = d.investors.find(i => i.investorId === _dlInvestorId);
      return s + (entry?.committed || 0);
    }, 0);
    inv.deals = allLinked.length;
    save();
  }
  const deal = SP.getDealById(dealId);
  SP.logActivity('fa-link', 'blue', `<strong>${inv?.firstName} ${inv?.lastName}</strong> linked to <strong>${deal?.name}</strong>`);
  closeDealLinkModal(); updateStats(); filterTable();
  showToast(`Linked to ${deal?.name} ✓`, 'success');
}

function showToast(msg, type) {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:0.875rem;font-weight:600;font-family:'Inter',sans-serif;box-shadow:0 8px 24px rgba(0,0,0,0.15);transition:all 0.3s;${type==='success'?'background:#10b981;color:white;':'background:#ef4444;color:white;'}`;
  t.innerHTML = `<i class="fas fa-check-circle" style="margin-right:8px;"></i>${msg}`;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 2500);
}

// ── Invite modal ──────────────────────────────────────────────────────────────
let _inviteEmail = '', _inviteSubject = '', _inviteBody = '';

function openInviteModal(firstName, lastName, email) {
  // Always use Firebase orgId so investors land in the right Firestore collection
  const orgId = (typeof SPFB !== 'undefined' && SPFB.isReady()) ? SPFB.getOrgId() : SP.getOrgId();
  const token = SP.createInviteToken(email, orgId);
  const base = window.location.href.replace(/investors\.html.*$/, '');
  const inviteUrl = `${base}signup.html?invite=${token}&email=${encodeURIComponent(email)}&name=${encodeURIComponent(firstName+' '+lastName)}`;

  // Get GP name from session
  const session = JSON.parse(localStorage.getItem('sp_session')||'{}');
  const gpName = session.name || 'Your Sponsor';

  _inviteEmail = email;
  _inviteSubject = `You've been invited to deeltrack — ${gpName}`;
  _inviteBody = `Hi ${firstName},

${gpName} has added you as an investor on deeltrack, a real estate syndication platform.

Your investor portal gives you access to:
  • Deal documents and updates
  • Distribution history and statements
  • K-1 tax documents
  • Capital call notices

Click the link below to create your account and get started:

${inviteUrl}

This link is personalized for you — it will pre-fill your name and email so setup takes less than 60 seconds.

If you have any questions, reply to this email or contact ${gpName} directly.

Best regards,
${gpName}
Powered by deeltrack`;

  document.getElementById('inviteLinkInput').value = inviteUrl;
  document.getElementById('inviteToLine').textContent = `${firstName} ${lastName} <${email}>`;
  document.getElementById('inviteSubjectLine').textContent = _inviteSubject;
  document.getElementById('inviteEmailBody').textContent = _inviteBody;

  document.getElementById('inviteOverlay').classList.add('open');
}

function closeInviteModal() {
  document.getElementById('inviteOverlay').classList.remove('open');
}

function handleInviteOverlayClick(e) {
  if (e.target === document.getElementById('inviteOverlay')) closeInviteModal();
}

function copyInviteLink() {
  const input = document.getElementById('inviteLinkInput');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    btn.style.background = 'var(--success-light)';
    btn.style.borderColor = 'var(--success)';
    btn.style.color = 'var(--success)';
    setTimeout(() => {
      btn.innerHTML = '<i class="fas fa-copy"></i> Copy';
      btn.style = '';
    }, 2000);
  }).catch(() => {
    input.select();
    document.execCommand('copy');
  });
}

function copyEmailText() {
  navigator.clipboard.writeText(_inviteBody).then(() => {
    const btns = document.querySelectorAll('#inviteOverlay .modal-footer .btn');
    btns[1].innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => { btns[1].innerHTML = '<i class="fas fa-copy"></i> Copy Email'; }, 2000);
  });
}

async function sendInviteEmail() {
  const btn = document.querySelector('#inviteOverlay .btn-primary');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending…'; }

  let sent = false;

  // Try Firebase Cloud Function first (sends from admin@deeltrack.com)
  if (typeof firebase !== 'undefined' && typeof SPFB !== 'undefined' && SPFB.isReady()) {
    try {
      const fn = firebase.functions().httpsCallable('sendEmail');
      const result = await fn({
        to: _inviteEmail,
        subject: _inviteSubject,
        html: `<div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;">
          <div style="background:#6366f1;padding:24px;border-radius:8px 8px 0 0;text-align:center;">
            <h1 style="color:white;margin:0;">You're invited to deeltrack</h1>
          </div>
          <div style="background:#f8fafc;padding:32px;border-radius:0 0 8px 8px;border:1px solid #e2e8f0;">
            <p style="white-space:pre-line;color:#475569;">${_inviteBody}</p>
          </div>
        </div>`,
        text: _inviteBody,
        type: 'investor_invite',
      });
      if (result.data.success) {
        sent = true;
        SP.logActivity('fa-paper-plane', 'blue', `Invite sent to <strong>${_inviteEmail}</strong>`);
        showToast(`Invite sent to ${_inviteEmail}`);
      }
    } catch (e) {
      console.warn('Cloud Function invite failed, using mailto:', e.message);
    }
  }

  // Fallback: mailto
  if (!sent) {
    const mailto = `mailto:${encodeURIComponent(_inviteEmail)}?subject=${encodeURIComponent(_inviteSubject)}&body=${encodeURIComponent(_inviteBody)}`;
    window.open(mailto, '_blank');
    SP.logActivity('fa-paper-plane', 'blue', `Invite opened for <strong>${_inviteEmail}</strong>`);
  }

  if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Invite'; }
  closeInviteModal();
}

async function sendInviteViaDeeltrack() {
  const btn = document.querySelector('#inviteOverlay .btn-primary');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending…'; }

  // Build professional HTML email
  const htmlBody = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>You're invited to deeltrack</title>
</head>
<body style="margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:#f8fafc;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
    <tr>
      <td align="center" style="padding:40px 20px;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" border="0" style="max-width:600px;width:100%;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);">
          <!-- Header -->
          <tr>
            <td style="background:linear-gradient(135deg,#6366f1,#818cf8);padding:32px 40px;text-align:center;">
              <h1 style="color:#ffffff;margin:0;font-size:28px;font-weight:700;">deeltrack</h1>
              <p style="color:rgba(255,255,255,0.9);margin:8px 0 0;font-size:16px;">Real Estate Syndication Platform</p>
            </td>
          </tr>
          <!-- Content -->
          <tr>
            <td style="padding:40px;">
              <h2 style="color:#1e293b;margin:0 0 20px;font-size:24px;font-weight:600;">You're invited!</h2>
              <p style="color:#475569;font-size:16px;line-height:1.6;margin:0 0 20px;">Hi ${_inviteEmail.split('@')[0].replace(/\./g,' ').replace(/\b\w/g,l=>l.toUpperCase())},</p>
              <p style="color:#475569;font-size:16px;line-height:1.6;margin:0 0 24px;"><strong>${document.getElementById('inviteSubjectLine').textContent.replace(/.*—\s*/,'')}</strong> has added you as an investor on deeltrack.</p>
              
              <div style="background:#f8fafc;border-radius:8px;padding:24px;margin:24px 0;">
                <h3 style="color:#1e293b;margin:0 0 16px;font-size:18px;font-weight:600;">Your investor portal includes:</h3>
                <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">
                  <tr>
                    <td style="padding:8px 0;color:#475569;font-size:15px;"><span style="color:#6366f1;margin-right:8px;">✓</span> Deal documents and updates</td>
                  </tr>
                  <tr>
                    <td style="padding:8px 0;color:#475569;font-size:15px;"><span style="color:#6366f1;margin-right:8px;">✓</span> Distribution history and statements</td>
                  </tr>
                  <tr>
                    <td style="padding:8px 0;color:#475569;font-size:15px;"><span style="color:#6366f1;margin-right:8px;">✓</span> K-1 tax documents</td>
                  </tr>
                  <tr>
                    <td style="padding:8px 0;color:#475569;font-size:15px;"><span style="color:#6366f1;margin-right:8px;">✓</span> Capital call notices</td>
                  </tr>
                </table>
              </div>
              
              <div style="text-align:center;margin:32px 0;">
                <a href="${document.getElementById('inviteLinkInput').value}" style="display:inline-block;background:linear-gradient(135deg,#6366f1,#818cf8);color:#ffffff;text-decoration:none;padding:16px 32px;border-radius:8px;font-weight:600;font-size:16px;box-shadow:0 4px 6px -1px rgba(99,102,241,0.3);">Create Your Account</a>
              </div>
              
              <p style="color:#64748b;font-size:14px;line-height:1.5;margin:24px 0 0;padding-top:24px;border-top:1px solid #e2e8f0;">This link is personalized for you and will pre-fill your information. If you have any questions, simply reply to this email.</p>
            </td>
          </tr>
          <!-- Footer -->
          <tr>
            <td style="background:#f1f5f9;padding:24px 40px;text-align:center;">
              <p style="color:#94a3b8;font-size:13px;margin:0;">Powered by deeltrack · Real Estate Syndication Platform</p>
              <p style="color:#cbd5e1;font-size:12px;margin:8px 0 0;">This invitation was sent on behalf of your sponsor</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

  let sent = false;
  let errorMsg = '';

  // Try Microsoft Graph API first
  if (typeof SPFB !== 'undefined' && SPFB.isReady()) {
    try {
      // Use the existing sendEmail infrastructure if available
      const result = await SPFB.sendEmail({
        to: _inviteEmail,
        subject: _inviteSubject,
        html: htmlBody,
        text: _inviteBody,
        type: 'investor_invite'
      });
      if (result.success) {
        sent = true;
      }
    } catch (e) {
      console.warn('SPFB send failed:', e.message);
    }
  }

  // Fallback: Try Cloud Function
  if (!sent && typeof firebase !== 'undefined') {
    try {
      const fn = firebase.functions().httpsCallable('sendEmail');
      const result = await fn({
        to: _inviteEmail,
        subject: _inviteSubject,
        html: htmlBody,
        text: _inviteBody,
        type: 'investor_invite'
      });
      if (result.data && result.data.success) {
        sent = true;
      }
    } catch (e) {
      console.warn('Cloud Function send failed:', e.message);
      errorMsg = e.message;
    }
  }

  if (sent) {
    SP.logActivity('fa-paper-plane', 'blue', `Invite sent via deeltrack to <strong>${_inviteEmail}</strong>`);
    showToast(`Invite sent to ${_inviteEmail} via deeltrack`);
    
    // Update investor record to show invite was sent
    const inv = investors.find(i => i.email === _inviteEmail);
    if (inv) {
      inv.invited = true;
      inv.inviteSentAt = new Date().toISOString();
      save();
      render();
    }
    
    closeInviteModal();
  } else {
    showToast('Could not send via deeltrack. Try "Open in Email Client" instead.', 'error');
    console.error('Send via deeltrack failed:', errorMsg);
  }

  if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send via deeltrack'; }
}

// ── CSV Import ────────────────────────────────────────────────────────────────
function openCSVModal() { document.getElementById('csvModal').classList.add('open'); }
function closeCSVModal() { document.getElementById('csvModal').classList.remove('open'); document.getElementById('csvPreviewArea').innerHTML = ''; document.getElementById('csvFile').value=''; }
function handleCSVOverlay(e) { if(e.target===document.getElementById('csvModal')) closeCSVModal(); }

function parseCSV(text) {
  const lines = text.trim().split('\n').map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g,'')));
  if (lines.length < 2) return [];
  const headers = lines[0].map(h => h.toLowerCase().replace(/\s+/g,'_'));
  return lines.slice(1).map(row => {
    const obj = {};
    headers.forEach((h,i) => obj[h] = row[i]||'');
    return obj;
  }).filter(r => r.first_name||r.firstname||r.name||r.email);
}

function normalizeRow(r) {
  const name = (r.name||'').trim();
  const parts = name.split(' ');
  return {
    id: 'csv_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
    firstName: r.first_name||r.firstname||parts[0]||'',
    lastName: r.last_name||r.lastname||parts.slice(1).join(' ')||'',
    email: r.email||r.email_address||'',
    phone: r.phone||r.phone_number||r.mobile||'',
    address: r.address||r.street||'',
    accredStatus: (r.accredited||r.accreditation||'').toLowerCase().includes('verif') ? 'verified' : 'pending',
    totalInvested: parseFloat((r.invested||r.total_invested||r.amount||'').replace(/[$,]/g,''))||0,
    deals: 0,
    status: 'active',
    notes: r.notes||r.note||'',
  };
}

function handleCSVFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const rows = parseCSV(ev.target.result);
    if (!rows.length) { document.getElementById('csvPreviewArea').innerHTML = '<p style="color:var(--danger);padding:12px;">No valid rows found. Check your CSV format.</p>'; return; }
    const normalized = rows.map(normalizeRow).filter(r => r.email);
    const dupes = normalized.filter(r => investors.some(i => i.email.toLowerCase() === r.email.toLowerCase()));
    const news = normalized.filter(r => !investors.some(i => i.email.toLowerCase() === r.email.toLowerCase()));
    document.getElementById('csvPreviewArea').innerHTML = `
      <div style="margin-bottom:12px;padding:12px;background:var(--success-light);border:1px solid var(--success);border-radius:var(--radius);font-size:.85rem;">
        <strong>${news.length} new investors</strong> will be added &nbsp;·&nbsp; ${dupes.length} duplicates skipped
      </div>
      <div style="max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);">
        <table style="width:100%;border-collapse:collapse;font-size:.82rem;">
          <thead><tr style="background:var(--border-light);">
            <th style="padding:8px 12px;text-align:left;">Name</th>
            <th style="padding:8px 12px;text-align:left;">Email</th>
            <th style="padding:8px 12px;text-align:left;">Status</th>
          </tr></thead>
          <tbody>${normalized.map(r => {
            const isDupe = investors.some(i => i.email.toLowerCase() === r.email.toLowerCase());
            return `<tr style="border-bottom:1px solid var(--border-light);${isDupe?'opacity:.4;':''}">
              <td style="padding:8px 12px;">${r.firstName} ${r.lastName}</td>
              <td style="padding:8px 12px;">${r.email}</td>
              <td style="padding:8px 12px;">${isDupe?'<span style="color:var(--warning);">Duplicate</span>':'<span style="color:var(--success);">New</span>'}</td>
            </tr>`;
          }).join('')}</tbody>
        </table>
      </div>
      <button onclick="confirmCSVImport()" style="margin-top:14px;width:100%;padding:12px;background:var(--accent);color:white;border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;">
        <i class="fas fa-file-import"></i> Import ${news.length} Investor${news.length!==1?'s':''}
      </button>`;
    document.getElementById('csvPreviewArea').dataset.rows = JSON.stringify(normalized);
  };
  reader.readAsText(file);
}

function confirmCSVImport() {
  const rows = JSON.parse(document.getElementById('csvPreviewArea').dataset.rows || '[]');
  const news = rows.filter(r => r.email && !investors.some(i => i.email.toLowerCase() === r.email.toLowerCase()));
  investors = [...news, ...investors];
  save(); updateStats(); filterTable(); closeCSVModal();
  SP.logActivity('fa-file-import','green',`<strong>${news.length} investors</strong> imported via CSV`);
  showToast(`${news.length} investor${news.length!==1?'s':''} imported ✓`, 'success');
}

function handleAccredDoc(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('File must be under 5MB'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('fAccredDoc').value = ev.target.result;
    const zone = document.getElementById('accredDocZone');
    const label = document.getElementById('accredDocLabel');
    zone.style.borderColor = 'var(--success)';
    zone.style.background = 'var(--success-light)';
    label.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success);margin-right:6px;"></i><strong>${file.name}</strong> — ready to save`;
  };
  reader.readAsDataURL(file);
}

// Auto-fill expiry date when verification date is entered
document.getElementById('fAccredDate')?.addEventListener('change', function() {
  const expEl = document.getElementById('fAccredExpiry');
  if (this.value && !expEl.value) {
    const d = new Date(this.value);
    d.setFullYear(d.getFullYear() + 2);
    expEl.value = d.toISOString().split('T')[0];
  }
});

load(); updateStats(); filterTable();
window.addEventListener('spdata-ready', function() { load(); updateStats(); filterTable(); });
</script>
</body>
</html>
