<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Deal Comparison</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="js/sp-core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--primary:#0f172a;--accent:#3b82f6;--accent-light:#dbeafe;--success:#10b981;--success-light:#d1fae5;
      --warning:#f59e0b;--warning-light:#fef3c7;--danger:#ef4444;--purple:#8b5cf6;
      --text:#0f172a;--text-secondary:#64748b;--text-muted:#94a3b8;
      --border:#e2e8f0;--border-light:#f1f5f9;--bg:#f8fafc;--bg-card:#fff;--bg-sidebar:#0f172a;
      --radius:8px;--radius-md:12px;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:var(--bg-sidebar);color:white;position:fixed;height:100vh;z-index:100;}
    .main{flex:1;margin-left:260px;}
    .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;}
    .content{padding:32px;}
    /* Deal selector row */
    .selector-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px;}
    .deal-slot{background:var(--bg-card);border:2px dashed var(--border);border-radius:var(--radius-md);padding:20px;text-align:center;}
    .deal-slot.filled{border-style:solid;border-color:var(--accent);}
    .deal-slot select{width:100%;padding:10px;border:1px solid var(--border);border-radius:var(--radius);font-size:.9rem;margin-top:10px;outline:none;}
    /* Comparison table */
    .compare-table{width:100%;border-collapse:collapse;background:var(--bg-card);border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border);}
    .compare-table th{padding:14px 20px;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);}
    .compare-table td{padding:14px 20px;border-top:1px solid var(--border-light);font-size:.9rem;vertical-align:middle;}
    .compare-table tr:hover td{background:rgba(59,130,246,.02);}
    .metric-label{font-weight:600;color:var(--text-secondary);font-size:.82rem;text-transform:uppercase;letter-spacing:.04em;}
    .metric-value{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:1rem;}
    .best{color:var(--success);position:relative;}
    .best::after{content:'‚òÖ';font-size:.7rem;margin-left:4px;color:var(--success);}
    .chart-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px;}
    .chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;}
    .chart-title{font-size:.9rem;font-weight:700;margin-bottom:14px;}
    .deal-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:.78rem;font-weight:600;}
    .chip-0{background:var(--accent-light);color:var(--accent);}
    .chip-1{background:var(--success-light);color:var(--success);}
    .chip-2{background:var(--warning-light);color:var(--warning);}
    .summary-winner{background:linear-gradient(135deg,#0f172a,#1e293b);color:white;border-radius:var(--radius-md);padding:24px;margin-bottom:24px;display:flex;align-items:center;gap:16px;}
    .btn{padding:10px 18px;border-radius:var(--radius);font-weight:600;cursor:pointer;border:none;font-size:.875rem;display:inline-flex;align-items:center;gap:8px;}
    .btn-primary{background:var(--accent);color:white;}
    @media(max-width:768px){.selector-row{grid-template-columns:1fr;}.chart-row{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div style="padding:24px;border-bottom:1px solid rgba(255,255,255,.1);">
      <a href="dashboard.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;color:white;font-size:1.25rem;font-weight:700;">
        <div style="width:36px;height:36px;background:linear-gradient(135deg,#3b82f6,#60a5fa);border-radius:8px;display:flex;align-items:center;justify-content:center;">‚óÜ</div>
        deeltrack
      </a>
    </div>
    <nav style="padding:16px 12px;">
      <a href="dashboard.html" style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;"><i class="fas fa-th-large" style="width:20px;"></i> Dashboard</a>
      <a href="pipeline.html" style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;"><i class="fas fa-stream" style="width:20px;"></i> Pipeline</a>
      <a href="deal-compare.html" style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;background:#3b82f6;color:white;text-decoration:none;font-size:.9rem;"><i class="fas fa-balance-scale" style="width:20px;"></i> Deal Compare</a>
      <a href="reports.html" style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;"><i class="fas fa-chart-bar" style="width:20px;"></i> Reports</a>
    </nav>
  </aside>

  <main class="main">
    <header class="top-bar">
      <div><h1 style="font-size:1.25rem;font-weight:700;">Deal Comparison</h1><p style="font-size:.8rem;color:var(--text-secondary);">Compare up to 3 deals side by side</p></div>
      <button class="btn btn-primary" onclick="exportComparison()"><i class="fas fa-download"></i> Export</button>
    </header>
    <div class="content">
      <!-- Deal selectors -->
      <div class="selector-row" id="selectorRow">
        ${[0,1,2].map(i=>`
          <div class="deal-slot" id="slot-${i}">
            <div class="deal-chip chip-${i}"><i class="fas fa-building"></i> Deal ${i+1}</div>
            <select id="dealSel-${i}" onchange="refreshComparison()">
              <option value="">‚Äî Select deal ‚Äî</option>
            </select>
          </div>`).join('')}
      </div>

      <!-- Summary winner -->
      <div id="winnerBanner" style="display:none;" class="summary-winner">
        <div style="font-size:2rem;">üèÜ</div>
        <div><div style="font-size:1.1rem;font-weight:700;" id="winnerText">Best Deal</div><div style="font-size:.85rem;color:rgba(255,255,255,.6);" id="winnerSub"></div></div>
      </div>

      <!-- Comparison table -->
      <div id="comparisonTable" style="margin-bottom:24px;"></div>

      <!-- Charts -->
      <div class="chart-row" id="chartRow" style="display:none;">
        <div class="chart-card"><div class="chart-title">IRR Comparison</div><canvas id="irrCompare" height="200"></canvas></div>
        <div class="chart-card"><div class="chart-title">Capital Raise vs Committed</div><canvas id="raiseCompare" height="200"></canvas></div>
      </div>
    </div>
  </main>
</div>
<script>
SP.requireGP();
let compareCharts = {};

function init() {
  const deals = SP.getDeals();
  [0,1,2].forEach(i => {
    const sel = document.getElementById(`dealSel-${i}`);
    deals.forEach(d => sel.add(new Option(d.name, d.id)));
  });
  // Pre-select first 2
  if (deals[0]) document.getElementById('dealSel-0').value = deals[0].id;
  if (deals[1]) document.getElementById('dealSel-1').value = deals[1].id;
  refreshComparison();
}

function getSelected() {
  return [0,1,2].map(i => {
    const id = document.getElementById(`dealSel-${i}`).value;
    return id ? SP.getDealById(id) : null;
  }).filter(Boolean);
}

function fmt$(n){if(!n)return'‚Äî';if(n>=1e6)return'$'+(n/1e6).toFixed(1)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(0)+'K';return'$'+n;}

function refreshComparison() {
  const deals = getSelected();
  if (!deals.length) { document.getElementById('comparisonTable').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);"><i class="fas fa-balance-scale" style="font-size:2rem;opacity:.3;display:block;margin-bottom:12px;"></i>Select at least one deal to compare</div>'; return; }

  // Mark slots
  [0,1,2].forEach(i => {
    const id = document.getElementById(`dealSel-${i}`).value;
    document.getElementById(`slot-${i}`).className = id ? 'deal-slot filled' : 'deal-slot';
  });

  const metrics = [
    { label:'Property Type', key:'type', format: v=>v||'‚Äî', highlight:false },
    { label:'Location', key:'location', format:v=>v||'‚Äî', highlight:false },
    { label:'Status', key:'status', format:v=>({sourcing:'Sourcing',loi:'LOI',dd:'Due Diligence',operating:'Operating',closed:'Closed'}[v]||v||'‚Äî'), highlight:false },
    { label:'Target Raise', key:'raise', format:fmt$, highlight:'max' },
    { label:'Target IRR', key:'irr', format:v=>v?v.toFixed(1)+'%':'‚Äî', highlight:'max' },
    { label:'Equity Multiple', key:'equity', format:v=>v?v.toFixed(2)+'x':'‚Äî', highlight:'max' },
    { label:'# Investors', key:'investors', format:v=>(v||[]).length, highlight:'max' },
    { label:'Capital Committed', key:'_committed', format:fmt$, highlight:'max' },
    { label:'% Raised', key:'_pctRaised', format:v=>v?v+'%':'‚Äî', highlight:'max' },
    { label:'Units', key:'units', format:v=>v||'‚Äî', highlight:false },
    { label:'Pref Return', key:'prefReturn', format:v=>v?v+'%':'‚Äî', highlight:'max' },
    { label:'GP Promote', key:'gpPromote', format:v=>v?v+'%':'‚Äî', highlight:false },
  ];

  // Compute derived values
  const enriched = deals.map(d => ({
    ...d,
    _committed: (d.investors||[]).reduce((s,i)=>s+(i.committed||0),0),
    _pctRaised: d.raise > 0 ? Math.round((d.investors||[]).reduce((s,i)=>s+(i.committed||0),0)/d.raise*100) : 0,
  }));

  // Find best deal (highest IRR)
  const bestIdx = enriched.reduce((bi, d, i) => (d.irr||0) > (enriched[bi]?.irr||0) ? i : bi, 0);
  const winner = enriched[bestIdx];
  const wb = document.getElementById('winnerBanner');
  wb.style.display = deals.length > 1 ? 'flex' : 'none';
  document.getElementById('winnerText').textContent = `${winner.name} ‚Äî Best Deal`;
  document.getElementById('winnerSub').textContent = `Highest projected IRR: ${winner.irr?.toFixed(1)||'‚Äî'}% ¬∑ ${fmt$(winner.raise)} raise ¬∑ ${winner.equity?.toFixed(2)||'‚Äî'}x equity multiple`;

  // Build table
  const CHIP_COLORS = ['#dbeafe,#3b82f6','#d1fae5,#10b981','#fef3c7,#f59e0b'];
  const thead = `<thead style="background:var(--border-light);"><tr>
    <th style="text-align:left;">Metric</th>
    ${enriched.map((d,i)=>`<th><span style="background:${CHIP_COLORS[i].split(',')[0]};color:${CHIP_COLORS[i].split(',')[1]};padding:4px 12px;border-radius:20px;font-size:.78rem;font-weight:600;">${d.name}</span></th>`).join('')}
  </tr></thead>`;

  const rows = metrics.map(m => {
    const vals = enriched.map(d => {
      const raw = m.key.startsWith('_') ? d[m.key] : d[m.key];
      return { raw, display: m.format(raw) };
    });
    // Find best if applicable
    let bestVal = null;
    if (m.highlight === 'max') bestVal = Math.max(...vals.map(v=>parseFloat(v.raw)||0));
    return `<tr>
      <td class="metric-label">${m.label}</td>
      ${vals.map(v => {
        const isBest = m.highlight === 'max' && deals.length > 1 && parseFloat(v.raw) === bestVal && bestVal > 0;
        return `<td class="metric-value ${isBest?'best':''}">${v.display}</td>`;
      }).join('')}
    </tr>`;
  }).join('');

  document.getElementById('comparisonTable').innerHTML = `<table class="compare-table">${thead}<tbody>${rows}</tbody></table>`;

  // Charts
  buildCompareCharts(enriched);
}

function buildCompareCharts(deals) {
  document.getElementById('chartRow').style.display = deals.length > 1 ? 'grid' : 'none';
  const colors = ['#3b82f6','#10b981','#f59e0b'];
  const labels = deals.map(d=>d.name.length>14?d.name.substring(0,12)+'‚Ä¶':d.name);

  if (compareCharts.irr) compareCharts.irr.destroy();
  compareCharts.irr = new Chart(document.getElementById('irrCompare').getContext('2d'),{
    type:'bar', data:{ labels, datasets:[{ label:'IRR %', data:deals.map(d=>d.irr||0), backgroundColor:colors.slice(0,deals.length), borderRadius:6, borderSkipped:false }] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, ticks:{callback:v=>v+'%'} }, x:{grid:{display:false}} } }
  });

  if (compareCharts.raise) compareCharts.raise.destroy();
  compareCharts.raise = new Chart(document.getElementById('raiseCompare').getContext('2d'),{
    type:'bar', data:{ labels, datasets:[
      { label:'Target Raise', data:deals.map(d=>d.raise||0), backgroundColor:'rgba(59,130,246,0.3)', borderRadius:4 },
      { label:'Committed', data:deals.map(d=>d._committed||0), backgroundColor:colors.slice(0,deals.length), borderRadius:4 }
    ]},
    options:{ responsive:true, plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:12}}}, scales:{ y:{ beginAtZero:true, ticks:{callback:v=>v>=1e6?'$'+(v/1e6).toFixed(1)+'M':v>=1e3?'$'+(v/1e3).toFixed(0)+'K':'$'+v} }, x:{grid:{display:false}} } }
  });
}

function exportComparison() {
  const deals = getSelected();
  if (!deals.length) return;
  const headers = ['Metric', ...deals.map(d=>d.name)];
  const rows = [
    ['Type', ...deals.map(d=>d.type||'‚Äî')],
    ['Location', ...deals.map(d=>d.location||'‚Äî')],
    ['Raise', ...deals.map(d=>d.raise||0)],
    ['IRR', ...deals.map(d=>d.irr?d.irr.toFixed(1)+'%':'‚Äî')],
    ['Equity Multiple', ...deals.map(d=>d.equity?d.equity.toFixed(2)+'x':'‚Äî')],
    ['Investors', ...deals.map(d=>(d.investors||[]).length)],
  ];
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='deal-comparison.csv'; a.click();
}

init();
</script>
</body>
</html>
