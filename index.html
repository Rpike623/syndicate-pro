<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyndicatePro - Real Estate Syndication Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a1a2e;
      --secondary: #16213e;
      --accent: #0f3460;
      --highlight: #e94560;
      --success: #00d9a3;
      --warning: #f39c12;
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --border: #2a2a4a;
      --card: #1e1e3a;
      --input: #252545;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--primary);
      color: var(--text);
      min-height: 100vh;
    }
    
    .header {
      background: var(--secondary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--highlight);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .logo::before {
      content: "â—†";
      color: var(--success);
    }
    
    .nav {
      display: flex;
      gap: 1.5rem;
    }
    
    .nav a {
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    
    .nav a:hover, .nav a.active {
      color: var(--text);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    @media (max-width: 1024px) {
      .grid { grid-template-columns: 1fr; }
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    input, select {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--highlight);
    }
    
    input[type="number"] {
      font-family: 'JetBrains Mono', monospace;
    }
    
    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .input-addon {
      position: relative;
    }
    
    .input-addon input {
      padding-right: 2.5rem;
    }
    
    .input-addon::after {
      content: "%";
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }
    
    .input-addon.dollar::after {
      content: "$";
    }
    
    .btn {
      background: var(--highlight);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.875rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn:hover {
      background: #d63d56;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--accent);
    }
    
    .btn-secondary:hover {
      background: #1a4a7a;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    .btn-outline:hover {
      background: var(--input);
    }
    
    .waterfall-type {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .waterfall-option {
      background: var(--input);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .waterfall-option:hover {
      border-color: var(--accent);
    }
    
    .waterfall-option.selected {
      border-color: var(--highlight);
      background: rgba(233, 69, 96, 0.1);
    }
    
    .waterfall-option .icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    .waterfall-option .label {
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .results-panel {
      background: var(--secondary);
      border-radius: 8px;
      padding: 1.5rem;
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .metric-row:last-child {
      border-bottom: none;
    }
    
    .metric-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .metric-value.positive {
      color: var(--success);
    }
    
    .waterfall-viz {
      margin-top: 1.5rem;
    }
    
    .tier {
      background: var(--input);
      border-left: 4px solid var(--highlight);
      border-radius: 0 8px 8px 0;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .tier-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .tier-name {
      font-weight: 600;
    }
    
    .tier-amount {
      font-family: 'JetBrains Mono', monospace;
      color: var(--success);
      font-weight: 600;
    }
    
    .tier-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .tier-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      margin-top: 0.75rem;
      overflow: hidden;
    }
    
    .tier-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--highlight), var(--success));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .tab:hover {
      background: var(--input);
    }
    
    .tab.active {
      background: var(--highlight);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .investor-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .investor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--input);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .investor-name {
      font-weight: 500;
    }
    
    .investor-amount {
      font-family: 'JetBrains Mono', monospace;
      color: var(--success);
    }
    
    .add-investor {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .add-investor input {
      flex: 1;
    }
    
    .distribution-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .distribution-table th,
    .distribution-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .distribution-table th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .distribution-table td {
      font-family: 'JetBrains Mono', monospace;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-gp {
      background: rgba(233, 69, 96, 0.2);
      color: var(--highlight);
    }
    
    .badge-lp {
      background: rgba(0, 217, 163, 0.2);
      color: var(--success);
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 1024px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
    }
    
    .summary-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    
    .summary-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .summary-value.highlight {
      color: var(--highlight);
    }
    
    .summary-value.success {
      color: var(--success);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">SyndicatePro</div>
    <nav class="nav">
      <a href="#" class="active">Deal Modeling</a>
      <a href="#">Investors</a>
      <a href="#">Documents</a>
      <a href="#">Reports</a>
    </nav>
  </header>

  <div class="container">
    <h1 class="page-title">Waterfall Distribution Calculator</h1>
    <p class="page-subtitle">Model your real estate syndication returns with standardized deal terms</p>
    
    <div class="summary-cards" id="summaryCards" style="display: none;">
      <div class="summary-card">
        <div class="summary-label">Total Equity</div>
        <div class="summary-value" id="summaryEquity">$0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">LP Investment</div>
        <div class="summary-value" id="summaryLP">$0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">GP Investment</div>
        <div class="summary-value highlight" id="summaryGP">$0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Projected IRR</div>
        <div class="summary-value success" id="summaryIRR">0%</div>
      </div>
    </div>

    <div class="grid">
      <div class="left-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ðŸ“Š Deal Parameters</div>
          </div>
          
          <div class="tabs">
            <div class="tab active" data-tab="structure">Structure</div>
            <div class="tab" data-tab="returns">Returns</div>
            <div class="tab" data-tab="investors">Investors</div>
          </div>
          
          <div class="tab-content active" id="tab-structure">
            <div class="form-group">
              <label>Deal Name</label>
              <input type="text" id="dealName" placeholder="e.g., Main Street Apartments">
            </div>
            
            <div class="input-row">
              <div class="form-group">
                <label>Total Project Cost</label>
                <div class="input-addon dollar">
                  <input type="number" id="totalCost" placeholder="5000000">
                </div>
              </div>
              <div class="form-group">
                <label>Loan Amount</label>
                <div class="input-addon dollar">
                  <input type="number" id="loanAmount" placeholder="3500000">
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Waterfall Structure Type</label>
              <div class="waterfall-type">
                <div class="waterfall-option selected" data-type="simple">
                  <div class="icon">ðŸ“ˆ</div>
                  <div class="label">Simple Split</div>
                </div>
                <div class="waterfall-option" data-type="pref">
                  <div class="icon">ðŸ’°</div>
                  <div class="label">Pref + Split</div>
                </div>
                <div class="waterfall-option" data-type="catchup">
                  <div class="icon">âš¡</div>
                  <div class="label">Catch-Up</div>
                </div>
              </div>
            </div>
            
            <div class="input-row">
              <div class="form-group">
                <label>GP Equity %</label>
                <div class="input-addon">
                  <input type="number" id="gpEquity" value="10" min="0" max="100">
                </div>
              </div>
              <div class="form-group">
                <label>LP Equity %</label>
                <div class="input-addon">
                  <input type="number" id="lpEquity" value="90" min="0" max="100" readonly>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="tab-returns">
            <div class="form-group">
              <label>Preferred Return (Hurdle)</label>
              <div class="input-addon">
                <input type="number" id="prefReturn" value="8" step="0.5">
              </div>
            </div>
            
            <div class="form-group">
              <label>Catch-Up Rate (to GP)</label>
              <div class="input-addon">
                <input type="number" id="catchupRate" value="50" step="5">
              </div>
            </div>
            
            <div class="form-group">
              <label>Promote Split (After Catch-Up)</label>
              <div class="input-row">
                <div class="form-group">
                  <label>GP %</label>
                  <div class="input-addon">
                    <input type="number" id="gpPromote" value="30" min="0" max="100">
                  </div>
                </div>
                <div class="form-group">
                  <label>LP %</label>
                  <div class="input-addon">
                    <input type="number" id="lpPromote" value="70" min="0" max="100" readonly>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Hold Period (Years)</label>
              <input type="number" id="holdPeriod" value="5" min="1" max="20">
            </div>
            
            <div class="form-group">
              <label>Exit Cap Rate</label>
              <div class="input-addon">
                <input type="number" id="exitCap" value="5.5" step="0.25">
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="tab-investors">
            <div class="form-group">
              <label>Investor List</label>
              <div class="investor-list" id="investorList">
                <div class="investor-item">
                  <span class="investor-name">GP Entity</span>
                  <span class="investor-amount" id="gpInvestmentAmount">$0</span>
                </div>
              </div>
              <div class="add-investor">
                <input type="text" id="newInvestorName" placeholder="Investor name">
                <div class="input-addon dollar" style="flex: 0 0 120px;">
                  <input type="number" id="newInvestorAmount" placeholder="Amount">
                </div>
                <button class="btn btn-secondary" onclick="addInvestor()">Add</button>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
            <button class="btn" onclick="calculateWaterfall()" style="flex: 1;">
              Calculate
            </button>
            <button class="btn btn-secondary" onclick="saveDeal()" style="flex: 1;">
              ðŸ’¾ Save Deal
            </button>
          </div>
          
          <div style="margin-top: 1rem;">
            <select id="loadDealSelect" onchange="loadDeal(this.value)" style="width: 100%;">
              <option value="">-- Load saved deal --</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="right-panel">
        <div class="card" id="resultsCard">
          <div class="empty-state" id="emptyState">
            <div class="icon">ðŸ“Š</div>
            <h3>Enter deal terms to see waterfall</h3>
            <p>Fill in the deal parameters and click Calculate</p>
          </div>
          
          <div id="resultsContent" style="display: none;">
            <div class="card-header">
              <div class="card-title">ðŸ’µ Distribution Waterfall</div>
            </div>
            
            <div class="results-panel">
              <div class="metric-row">
                <span class="metric-label">Total Cash to Distribute</span>
                <span class="metric-value" id="totalCash">$0</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Return of Capital</span>
                <span class="metric-value" id="rocAmount">$0</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Preferred Return</span>
                <span class="metric-value" id="prefAmount">$0</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Catch-Up to GP</span>
                <span class="metric-value" id="catchupAmount">$0</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Residual Split (Promote)</span>
                <span class="metric-value" id="residualAmount">$0</span>
              </div>
            </div>
            
            <div class="waterfall-viz" id="waterfallViz"></div>
            
            <div style="margin-top: 2rem;">
              <div class="card-header">
                <div class="card-title">ðŸ“‹ Distribution Summary</div>
              </div>
              <table class="distribution-table">
                <thead>
                  <tr>
                    <th>Party</th>
                    <th>Type</th>
                    <th>Total Return</th>
                    <th>Multiple</th>
                  </tr>
                </thead>
                <tbody id="distributionBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script>
    // State
    let dealState = {
      id: null,
      name: '',
      type: 'simple',
      investors: [],
      totalEquity: 0,
      lpEquity: 0,
      gpEquity: 0
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // Waterfall type selection
    document.querySelectorAll('.waterfall-option').forEach(opt => {
      opt.addEventListener('click', () => {
        document.querySelectorAll('.waterfall-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        dealState.type = opt.dataset.type;
        updateFormVisibility();
      });
    });

    // Auto-calculate LP equity
    document.getElementById('gpEquity').addEventListener('input', (e) => {
      const gp = parseFloat(e.target.value) || 0;
      document.getElementById('lpEquity').value = Math.max(0, 100 - gp);
    });

    // Auto-calculate LP promote
    document.getElementById('gpPromote').addEventListener('input', (e) => {
      const gp = parseFloat(e.target.value) || 0;
      document.getElementById('lpPromote').value = Math.max(0, 100 - gp);
    });

    function updateFormVisibility() {
      const prefInput = document.getElementById('prefReturn').parentElement.parentElement;
      const catchupInput = document.getElementById('catchupRate').parentElement.parentElement;
      
      if (dealState.type === 'simple') {
        prefInput.style.opacity = '0.5';
        catchupInput.style.opacity = '0.5';
      } else if (dealState.type === 'pref') {
        prefInput.style.opacity = '1';
        catchupInput.style.opacity = '0.5';
      } else {
        prefInput.style.opacity = '1';
        catchupInput.style.opacity = '1';
      }
    }

    function formatCurrency(num) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    function formatPercent(num) {
      return num.toFixed(2) + '%';
    }

    function addInvestor() {
      const name = document.getElementById('newInvestorName').value;
      const amount = parseFloat(document.getElementById('newInvestorAmount').value) || 0;
      
      if (!name || amount <= 0) return;
      
      dealState.investors.push({ name, amount });
      
      const list = document.getElementById('investorList');
      const item = document.createElement('div');
      item.className = 'investor-item';
      item.innerHTML = `
        <span class="investor-name">${name}</span>
        <span class="investor-amount">${formatCurrency(amount)}</span>
      `;
      list.appendChild(item);
      
      document.getElementById('newInvestorName').value = '';
      document.getElementById('newInvestorAmount').value = '';
    }

    function calculateWaterfall() {
      // Get inputs
      const totalCost = parseFloat(document.getElementById('totalCost').value) || 0;
      const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
      const gpEquityPct = parseFloat(document.getElementById('gpEquity').value) || 0;
      const prefRate = parseFloat(document.getElementById('prefReturn').value) || 0;
      const catchupRate = parseFloat(document.getElementById('catchupRate').value) || 0;
      const gpPromotePct = parseFloat(document.getElementById('gpPromote').value) || 0;
      const lpPromotePct = parseFloat(document.getElementById('lpPromote').value) || 0;
      const holdPeriod = parseFloat(document.getElementById('holdPeriod').value) || 5;
      
      // Calculate equity
      const totalEquity = totalCost - loanAmount;
      const gpEquity = totalEquity * (gpEquityPct / 100);
      const lpEquity = totalEquity - gpEquity;
      
      dealState.totalEquity = totalEquity;
      dealState.gpEquity = gpEquity;
      dealState.lpEquity = lpEquity;
      
      // Update investor amounts
      document.getElementById('gpInvestmentAmount').textContent = formatCurrency(gpEquity);
      
      // Calculate exit proceeds (simplified: assume sale at exit cap)
      // In reality, this would use NOI and exit cap, but we'll simulate returns
      const exitMultiple = 1.8; // Simplified assumption
      const totalProceeds = totalEquity * exitMultiple;
      const profit = totalProceeds - totalEquity;
      
      // Waterfall calculation
      let remainingCash = totalProceeds;
      let rocAmount = 0;
      let prefAmount = 0;
      let catchupAmount = 0;
      let residualAmount = 0;
      
      // Tier 1: Return of Capital
      rocAmount = Math.min(remainingCash, totalEquity);
      remainingCash -= rocAmount;
      
      const rocToGP = rocAmount * (gpEquityPct / 100);
      const rocToLP = rocAmount - rocToGP;
      
      // Tier 2: Preferred Return (if applicable)
      if (dealState.type !== 'simple') {
        const prefPool = lpEquity * Math.pow(1 + prefRate/100, holdPeriod) - lpEquity;
        prefAmount = Math.min(remainingCash, prefPool);
        remainingCash -= prefAmount;
      }
      
      // Tier 3: GP Catch-Up (if applicable)
      if (dealState.type === 'catchup' && remainingCash > 0) {
        // GP catches up to their promote share of total profit
        const targetGPShare = profit * (gpPromotePct / 100);
        const currentGPProfit = rocToGP; // Only ROC so far
        const gpShortfall = Math.max(0, targetGPShare - currentGPProfit);
        
        // LP gets (100 - catchupRate), GP gets catchupRate until GP reaches target
        const catchupPool = gpShortfall / (catchupRate / 100);
        catchupAmount = Math.min(remainingCash, catchupPool);
        remainingCash -= catchupAmount;
      }
      
      // Tier 4: Residual Split
      if (remainingCash > 0) {
        residualAmount = remainingCash;
        remainingCash = 0;
      }
      
      // Calculate totals
      const gpTotal = rocToGP + 
                     (dealState.type !== 'simple' ? 0 : 0) + // Pref goes to LP
                     (catchupAmount * (catchupRate / 100)) +
                     (residualAmount * (gpPromotePct / 100));
      
      const lpTotal = totalProceeds - gpTotal;
      
      const gpMultiple = gpEquity > 0 ? gpTotal / gpEquity : 0;
      const lpMultiple = lpEquity > 0 ? lpTotal / lpEquity : 0;
      
      // Calculate IRR (simplified)
      const gpIRR = (Math.pow(gpMultiple, 1/holdPeriod) - 1) * 100;
      const lpIRR = (Math.pow(lpMultiple, 1/holdPeriod) - 1) * 100;
      
      // Update summary cards
      document.getElementById('summaryCards').style.display = 'grid';
      document.getElementById('summaryEquity').textContent = formatCurrency(totalEquity);
      document.getElementById('summaryLP').textContent = formatCurrency(lpEquity);
      document.getElementById('summaryGP').textContent = formatCurrency(gpEquity);
      document.getElementById('summaryIRR').textContent = formatPercent(lpIRR);
      
      // Show results
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('resultsContent').style.display = 'block';
      
      // Update metrics
      document.getElementById('totalCash').textContent = formatCurrency(totalProceeds);
      document.getElementById('rocAmount').textContent = formatCurrency(rocAmount);
      document.getElementById('prefAmount').textContent = formatCurrency(prefAmount);
      document.getElementById('catchupAmount').textContent = formatCurrency(catchupAmount * (catchupRate / 100));
      document.getElementById('residualAmount').textContent = formatCurrency(residualAmount);
      
      // Build waterfall visualization
      const viz = document.getElementById('waterfallViz');
      viz.innerHTML = '';
      
      const tiers = [
        { name: '1. Return of Capital', desc: 'Initial investment returned pro-rata', amount: rocAmount, color: '#4a4a6a' },
        { name: '2. Preferred Return', desc: `${prefRate}% hurdle to LPs`, amount: prefAmount, color: '#0f3460' },
        { name: '3. GP Catch-Up', desc: `${catchupRate}% to GP`, amount: catchupAmount * (catchupRate/100), color: '#e94560' },
        { name: '4. Residual Split', desc: `${gpPromotePct}/${lpPromotePct} GP/LP split`, amount: residualAmount, color: '#00d9a3' }
      ];
      
      tiers.forEach(tier => {
        if (tier.amount <= 0) return;
        const pct = (tier.amount / totalProceeds * 100).toFixed(1);
        const tierEl = document.createElement('div');
        tierEl.className = 'tier';
        tierEl.style.borderLeftColor = tier.color;
        tierEl.innerHTML = `
          <div class="tier-header">
            <span class="tier-name">${tier.name}</span>
            <span class="tier-amount">${formatCurrency(tier.amount)}</span>
          </div>
          <div class="tier-desc">${tier.desc} (${pct}%)</div>
          <div class="tier-bar">
            <div class="tier-fill" style="width: ${pct}%; background: ${tier.color};"></div>
          </div>
        `;
        viz.appendChild(tierEl);
      });
      
      // Update distribution table
      const tbody = document.getElementById('distributionBody');
      tbody.innerHTML = `
        <tr>
          <td>GP Entity</td>
          <td><span class="badge badge-gp">GP</span></td>
          <td>${formatCurrency(gpTotal)}</td>
          <td>${gpMultiple.toFixed(2)}x</td>
        </tr>
        <tr>
          <td>LP Investors</td>
          <td><span class="badge badge-lp">LP</span></td>
          <td>${formatCurrency(lpTotal)}</td>
          <td>${lpMultiple.toFixed(2)}x</td>
        </tr>
      `;
      
      // Add individual investors if any
      dealState.investors.forEach(inv => {
        const invShare = inv.amount / lpEquity;
        const invReturn = lpTotal * invShare;
        const invMultiple = invReturn / inv.amount;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${inv.name}</td>
          <td><span class="badge badge-lp">LP</span></td>
          <td>${formatCurrency(invReturn)}</td>
          <td>${invMultiple.toFixed(2)}x</td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Save deal to storage
    function saveDeal() {
      const deal = {
        id: dealState.id || Date.now().toString(),
        name: document.getElementById('dealName').value || 'Unnamed Deal',
        totalCost: parseFloat(document.getElementById('totalCost').value) || 0,
        loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
        gpEquity: parseFloat(document.getElementById('gpEquity').value) || 0,
        lpEquity: parseFloat(document.getElementById('lpEquity').value) || 0,
        prefReturn: parseFloat(document.getElementById('prefReturn').value) || 0,
        gpPromote: parseFloat(document.getElementById('gpPromote').value) || 0,
        catchupRate: parseFloat(document.getElementById('catchupRate').value) || 0,
        holdPeriod: parseFloat(document.getElementById('holdPeriod').value) || 5,
        waterfallType: dealState.type,
        investors: dealState.investors,
        status: 'active'
      };
      
      deal.totalEquity = deal.totalCost - deal.loanAmount;
      
      Storage.saveDeal(deal);
      dealState.id = deal.id;
      
      updateDealSelect();
      alert('Deal saved successfully!');
    }
    
    // Load deal from storage
    function loadDeal(dealId) {
      if (!dealId) return;
      
      const deal = Storage.getDeal(dealId);
      if (!deal) return;
      
      dealState.id = deal.id;
      dealState.type = deal.waterfallType || 'simple';
      dealState.investors = deal.investors || [];
      
      document.getElementById('dealName').value = deal.name || '';
      document.getElementById('totalCost').value = deal.totalCost || '';
      document.getElementById('loanAmount').value = deal.loanAmount || '';
      document.getElementById('gpEquity').value = deal.gpEquity || '';
      document.getElementById('lpEquity').value = deal.lpEquity || '';
      document.getElementById('prefReturn').value = deal.prefReturn || '';
      document.getElementById('gpPromote').value = deal.gpPromote || '';
      document.getElementById('catchupRate').value = deal.catchupRate || '';
      document.getElementById('holdPeriod').value = deal.holdPeriod || '';
      
      // Update waterfall type selection
      document.querySelectorAll('.waterfall-option').forEach(o => {
        o.classList.remove('selected');
        if (o.dataset.type === dealState.type) o.classList.add('selected');
      });
      
      // Update investor list
      const list = document.getElementById('investorList');
      list.innerHTML = `
        <div class="investor-item">
          <span class="investor-name">GP Entity</span>
          <span class="investor-amount" id="gpInvestmentAmount">${formatCurrency(deal.totalEquity * (deal.gpEquity / 100))}</span>
        </div>
      `;
      
      (deal.investors || []).forEach(inv => {
        const item = document.createElement('div');
        item.className = 'investor-item';
        item.innerHTML = `
          <span class="investor-name">${inv.name}</span>
          <span class="investor-amount">${formatCurrency(inv.amount)}</span>
        `;
        list.appendChild(item);
      });
      
      calculateWaterfall();
    }
    
    // Update the load deal dropdown
    function updateDealSelect() {
      const select = document.getElementById('loadDealSelect');
      const deals = Storage.getDeals();
      
      select.innerHTML = '<option value="">-- Load saved deal --</option>';
      deals.forEach(deal => {
        const option = document.createElement('option');
        option.value = deal.id;
        option.textContent = deal.name;
        if (deal.id === dealState.id) option.selected = true;
        select.appendChild(option);
      });
    }
    
    // Initialize
    updateFormVisibility();
    updateDealSelect();
  </script>
</body>
</html>