<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Capital Calls</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --secondary: #334155;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #dbeafe;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --text: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 1.25rem; font-weight: 700; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #60a5fa); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-section { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.4); padding: 16px 12px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius); color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: all 0.15s; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .sidebar-footer { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--success), #34d399); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
    .user-details { flex: 1; }
    .user-name { font-size: 0.9rem; font-weight: 600; }
    .user-role { font-size: 0.75rem; color: rgba(255,255,255,0.5); }
    .main { flex: 1; margin-left: 260px; min-height: 100vh; }
    .top-bar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; color: var(--text-secondary); }
    .breadcrumb a { color: var(--text-secondary); text-decoration: none; }
    .breadcrumb a:hover { color: var(--accent); }
    .breadcrumb-separator { color: var(--text-muted); }
    .breadcrumb-current { color: var(--text); font-weight: 500; }
    .top-actions { display: flex; gap: 12px; align-items: center; }
    .btn-icon { width: 40px; height: 40px; border: 1px solid var(--border); background: var(--bg-card); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
    .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
    .content { padding: 32px; max-width: 1600px; }
    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 1.875rem; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .page-description { color: var(--text-secondary); font-size: 1rem; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
    .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1rem; font-weight: 600; color: var(--text); }
    .card-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px; }
    .card-body { padding: 24px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; font-size: 0.9rem; font-weight: 600; border-radius: var(--radius); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border-light); border-color: var(--text-muted); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; }
    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text); margin-bottom: 8px; }
    input, select, textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; font-family: inherit; background: var(--bg-card); color: var(--text); transition: all 0.15s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .input-group { position: relative; }
    .input-prefix { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .input-group input { padding-left: 32px; }
    .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
    .notice-preview { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 32px; font-family: 'Times New Roman', serif; line-height: 1.6; }
    .notice-preview h2 { font-size: 1.25rem; text-align: center; margin-bottom: 24px; border-bottom: 2px solid var(--border); padding-bottom: 16px; }
    .notice-preview .section { margin-bottom: 20px; }
    .notice-preview .label { font-weight: 600; display: block; margin-bottom: 4px; }
    .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
    .empty-state .icon { width: 60px; height: 60px; background: var(--border-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 1.5rem; color: var(--text-muted); }
    @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main { margin-left: 0; } .form-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header"><div class="logo"><div class="logo-icon">◆</div><span>deeltrack</span></div></div>
      <nav class="nav">
        <div class="nav-section">Main</div>
        <a href="index.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
        <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
        <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
        <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
        <div class="nav-section">Tools</div>
        <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
        <a href="capital-calls.html" class="nav-item active"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
        <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
        <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
        <a href="pipeline.html" class="nav-item"><i class="fas fa-layer-group"></i><span>Pipeline</span></a>
      </nav>
      <div class="sidebar-footer"><div class="user-info"><div class="user-avatar">GP</div><div class="user-details"><div class="user-name">General Partner</div><div class="user-role">Administrator</div></div></div></div>
    </aside>
    
    <main class="main">
      <header class="top-bar">
        <div class="breadcrumb"><a href="index.html">Home</a><span class="breadcrumb-separator">/</span><span class="breadcrumb-current">Capital Calls</span></div>
        <div class="top-actions"><button class="btn-icon" title="Help"><i class="fas fa-question-circle"></i></button><button class="btn-icon" title="Notifications"><i class="fas fa-bell"></i></button></div>
      </header>
      
      <div class="content">
        <div class="page-header">
          <h1 class="page-title">Capital Call Generator</h1>
          <p class="page-description">Generate and send capital call notices to investors</p>
        </div>
        
        <!-- History stats bar -->
        <div id="callStatsBar" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;"></div>

        <div class="content-grid">
          <div class="left-panel">
            <div class="card">
              <div class="card-header"><div><h2 class="card-title">Call Details</h2><p class="card-subtitle">Configure the capital call</p></div></div>
              <div class="card-body">
                <div class="form-group"><label>Deal</label><select id="callDeal" onchange="updatePreview()"><option value="">Select a deal...</option></select></div>
                <div class="form-row">
                  <div class="form-group"><label>Call Number</label><select id="callNumber"><option value="Initial">Initial</option><option value="1">First</option><option value="2">Second</option><option value="3">Third</option><option value="Final">Final</option></select></div>
                  <div class="form-group"><label>Due Date</label><input type="date" id="dueDate" onchange="updatePreview()"></div>
                </div>
                <div class="form-group">
                  <label>Total Call Amount</label>
                  <div class="input-group"><span class="input-prefix">$</span><input type="number" id="callAmount" placeholder="500000" oninput="updatePreview()"></div>
                </div>
                <div class="form-group"><label>Purpose</label><textarea id="callPurpose" rows="3" placeholder="Describe the use of funds (e.g., Property acquisition, closing costs, reserves...)" oninput="updatePreview()"></textarea></div>
                <div class="form-group"><label>Wire Instructions</label><textarea id="wireInstructions" rows="4" placeholder="Bank Name:&#10;Account Name:&#10;Account Number:&#10;Routing Number:" oninput="updatePreview()"></textarea></div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                  <button class="btn btn-primary" onclick="generateNotice()" style="flex: 1;"><i class="fas fa-file-alt"></i> Generate Notice</button>
                  <button class="btn btn-success" onclick="exportPDF()"><i class="fas fa-download"></i> PDF</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="right-panel">
            <div class="card">
              <div class="card-header"><div><h2 class="card-title">Notice Preview</h2><p class="card-subtitle">What investors will receive</p></div></div>
              <div class="card-body" id="previewContainer">
                <div class="empty-state">
                  <div class="icon"><i class="fas fa-file-invoice"></i></div>
                  <p>Fill in the call details to generate a preview</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Capital Call History -->
        <div class="card" style="margin-top:24px;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <div><h2 class="card-title">Capital Call History</h2><p class="card-subtitle">All recorded capital calls and their status</p></div>
          </div>
          <div id="callHistoryBody" style="padding:0;">
            <!-- Rendered by JS -->
          </div>
        </div>

        <!-- Hidden right-panel closing tag moved up -->
        <div style="display:none">
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="js/sp-core.js"></script>
  <script>
    SP.requireGP();

    function formatCurrency(num) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num || 0); }

    function loadDeals() {
      const deals = SP.getDeals();
      const select = document.getElementById('callDeal');
      select.innerHTML = '<option value="">Select a deal...</option>' + deals.map(d => {
        const committed = (d.investors||[]).reduce((s,i)=>s+(i.committed||0),0);
        return `<option value="${d.id}" data-name="${d.name}" data-equity="${committed}" data-raise="${d.raise||0}">${d.name || 'Unnamed Deal'} — ${formatCurrency(d.raise||0)} raise</option>`;
      }).join('');
    }
    
    function updatePreview() {
      const dealSelect = document.getElementById('callDeal');
      const dealOption = dealSelect.options[dealSelect.selectedIndex];
      const dealName = dealOption.dataset.name || '[DEAL NAME]';
      const totalEquity = parseFloat(dealOption.dataset.equity) || 0;
      const callAmount = parseFloat(document.getElementById('callAmount').value) || 0;
      const callNumber = document.getElementById('callNumber').value;
      const dueDate = document.getElementById('dueDate').value || '[DUE DATE]';
      const purpose = document.getElementById('callPurpose').value || '[PURPOSE OF CALL]';
      const wire = document.getElementById('wireInstructions').value || '[WIRE INSTRUCTIONS]';
      
      const pctOfEquity = totalEquity > 0 ? ((callAmount / totalEquity) * 100).toFixed(2) : 0;
      
      const preview = document.getElementById('previewContainer');
      preview.innerHTML = `
        <div class="notice-preview" id="noticeContent">
          <h2>NOTICE OF CAPITAL CALL</h2>
          <div class="section"><span class="label">To:</span> Members of ${dealName}</div>
          <div class="section"><span class="label">Date:</span> ${new Date().toLocaleDateString()}</div>
          <div class="section"><span class="label">Re:</span> ${callNumber} Capital Call</div>
          <div class="section" style="margin-top: 24px;">
            <p>Dear Member,</p>
            <p>This notice constitutes a capital call for ${formatCurrency(callAmount)} (${pctOfEquity}% of total equity commitment) per the terms of the Operating Agreement.</p>
            <p><span class="label">Purpose:</span> ${purpose}</p>
            <p><span class="label">Payment Due Date:</span> ${dueDate}</p>
            <p><span class="label">Wire Instructions:</span><br>${wire.replace(/\n/g, '<br>')}</p>
          </div>
          <div class="section" style="margin-top: 32px;">
            <p>Please remit funds by the due date. Failure to contribute may result in dilution or other remedies per the Operating Agreement.</p>
            <p style="margin-top: 24px;">Sincerely,<br>Managing Member</p>
          </div>
        </div>
      `;
    }
    
    function generateNotice() { updatePreview(); }
    
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const dealSelect = document.getElementById('callDeal');
      const dealOption = dealSelect.options[dealSelect.selectedIndex];
      const dealName = dealOption.dataset.name || 'Capital-Call';
      
      doc.setFontSize(16);
      doc.text('NOTICE OF CAPITAL CALL', 105, 30, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Deal: ${dealName}`, 20, 50);
      doc.text(`Amount: ${formatCurrency(document.getElementById('callAmount').value)}`, 20, 60);
      doc.text(`Due Date: ${document.getElementById('dueDate').value}`, 20, 70);
      doc.save(`${dealName}-Capital-Call.pdf`);
    }
    
    function saveCall() {
      const dealSel = document.getElementById('callDeal');
      const dealOpt = dealSel.options[dealSel.selectedIndex];
      const dealId = dealSel.value;
      if (!dealId) { alert('Select a deal first.'); return; }
      const amount = parseFloat(document.getElementById('callAmount').value) || 0;
      if (!amount) { alert('Enter a call amount.'); return; }
      const call = {
        id: 'cc' + Date.now(),
        dealId,
        dealName: dealOpt.dataset.name || 'Unknown Deal',
        callNumber: document.getElementById('callNumber').value,
        amount,
        dueDate: document.getElementById('dueDate').value,
        purpose: document.getElementById('callPurpose').value,
        wireInstructions: document.getElementById('wireInstructions').value,
        status: 'sent',
        sentAt: new Date().toISOString(),
        receivedAmount: 0,
      };
      const calls = SP.load('capitalCalls', []);
      calls.unshift(call);
      SP.save('capitalCalls', calls);
      SP.logActivity('fa-hand-holding-usd', 'amber', `Capital call of <strong>${formatCurrency(amount)}</strong> issued for <strong>${call.dealName}</strong>`);
      renderHistory();
      renderStats();
      showToast('Capital call saved!');
    }

    function updateCallStatus(id, status) {
      const calls = SP.load('capitalCalls', []);
      const idx = calls.findIndex(c => c.id === id);
      if (idx < 0) return;
      calls[idx].status = status;
      if (status === 'received') calls[idx].receivedAt = new Date().toISOString();
      SP.save('capitalCalls', calls);
      renderHistory();
      renderStats();
    }

    function deleteCall(id) {
      if (!confirm('Delete this capital call record?')) return;
      const calls = SP.load('capitalCalls', []).filter(c => c.id !== id);
      SP.save('capitalCalls', calls);
      renderHistory();
      renderStats();
    }

    function renderStats() {
      const calls = SP.load('capitalCalls', []);
      const total = calls.reduce((s,c)=>s+(c.amount||0),0);
      const received = calls.filter(c=>c.status==='received').reduce((s,c)=>s+(c.amount||0),0);
      const pending = calls.filter(c=>['sent','pending'].includes(c.status)).length;
      const overdue = calls.filter(c=>c.dueDate && new Date(c.dueDate)<new Date() && c.status!=='received').length;
      const bar = document.getElementById('callStatsBar');
      if (!bar) return;
      const kpi = (label, val, color) => `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;"><div style="font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:6px;">${label}</div><div style="font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:${color};">${val}</div></div>`;
      bar.innerHTML =
        kpi('Total Issued', formatCurrency(total), 'var(--text)') +
        kpi('Received', formatCurrency(received), 'var(--success)') +
        kpi('Pending', pending, 'var(--warning)') +
        kpi('Overdue', overdue, overdue ? 'var(--danger)' : 'var(--text-muted)');
    }

    function renderHistory() {
      const calls = SP.load('capitalCalls', []);
      const el = document.getElementById('callHistoryBody');
      if (!el) return;
      if (!calls.length) {
        el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);font-size:.875rem;"><i class="fas fa-history" style="font-size:2rem;opacity:.3;display:block;margin-bottom:12px;"></i>No capital calls recorded yet. Generate and save a notice above.</div>';
        return;
      }
      const STATUS_BADGE = {
        sent: '<span style="background:#dbeafe;color:#1d4ed8;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;">Sent</span>',
        received: '<span style="background:#d1fae5;color:#065f46;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;">Received</span>',
        overdue: '<span style="background:#fee2e2;color:#991b1b;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;">Overdue</span>',
        pending: '<span style="background:#fef3c7;color:#92400e;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;">Pending</span>',
      };
      el.innerHTML = `<table style="width:100%;border-collapse:collapse;">
        <thead style="background:var(--border-light);">
          <tr>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Deal</th>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Call #</th>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Amount</th>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Due Date</th>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Status</th>
            <th style="padding:10px 16px;text-align:left;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Actions</th>
          </tr>
        </thead>
        <tbody>${calls.map(c => {
          const isOverdue = c.dueDate && new Date(c.dueDate) < new Date() && c.status !== 'received';
          const statusKey = isOverdue ? 'overdue' : c.status;
          return `<tr style="border-bottom:1px solid var(--border-light);">
            <td style="padding:12px 16px;font-weight:600;">${c.dealName}</td>
            <td style="padding:12px 16px;color:var(--text-secondary);">${c.callNumber}</td>
            <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;font-weight:600;">${formatCurrency(c.amount)}</td>
            <td style="padding:12px 16px;color:${isOverdue?'var(--danger)':'var(--text-secondary)'};">${c.dueDate||'—'}</td>
            <td style="padding:12px 16px;">${STATUS_BADGE[statusKey]||STATUS_BADGE.sent}</td>
            <td style="padding:12px 16px;">
              <div style="display:flex;gap:6px;">
                ${c.status!=='received'?`<button onclick="updateCallStatus('${c.id}','received')" style="padding:4px 10px;background:var(--success-light);color:var(--success);border:none;border-radius:6px;cursor:pointer;font-size:.75rem;font-weight:600;font-family:'Inter',sans-serif;">✓ Mark Received</button>`:''}
                <button onclick="deleteCall('${c.id}')" style="padding:4px 8px;background:var(--danger-light);color:var(--danger);border:none;border-radius:6px;cursor:pointer;font-size:.75rem;font-family:'Inter',sans-serif;">✕</button>
              </div>
            </td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
    }

    function showToast(msg) {
      const t = document.createElement('div');
      t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:.875rem;font-weight:600;background:var(--success);color:white;box-shadow:0 8px 24px rgba(0,0,0,.15);display:flex;align-items:center;gap:8px;font-family:Inter,sans-serif;';
      t.innerHTML = `<i class="fas fa-check-circle"></i>${msg}`;
      document.body.appendChild(t);
      setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300);},2000);
    }

    loadDeals();
    document.getElementById('dueDate').valueAsDate = new Date(Date.now() + 10 * 24 * 60 * 60 * 1000);

    // Add Save & Send button next to Generate
    const genBtn = document.querySelector('button[onclick="generateNotice()"]');
    if (genBtn) {
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-secondary';
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Record';
      saveBtn.onclick = saveCall;
      genBtn.parentElement.insertBefore(saveBtn, genBtn.nextSibling);

      const batchBtn = document.createElement('button');
      batchBtn.className = 'btn btn-secondary';
      batchBtn.innerHTML = '<i class="fas fa-mail-bulk"></i> Send to All';
      batchBtn.onclick = sendBatchCalls;
      genBtn.parentElement.insertBefore(batchBtn, saveBtn.nextSibling);
    }

    function sendBatchCalls() {
      const dealId = document.getElementById('callDeal').value;
      const deal = SP.getDealById(dealId);
      if(!deal || !deal.investors?.length) { alert('No investors linked to this deal.'); return; }
      const subj = `Capital Call Notice - ${deal.name}`;
      const emails = deal.investors.map(i=>SP.getInvestorById(i.investorId)?.email).filter(Boolean);
      const body = document.getElementById('noticeContent')?.innerText || 'Please find your capital call notice attached.';
      window.open(`mailto:${emails.join(',')}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, '_blank');
      SP.logActivity('fa-mail-bulk','blue',`Batch capital call email sent to ${emails.length} investors for <strong>${deal.name}</strong>`);
    }

    renderStats();
    renderHistory();
  </script>
</body>
</html>