<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - New Deal Wizard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="js/sp-documents.js"></script>
  <style>
    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --secondary: #334155;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #dbeafe;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --text: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    .app { display: flex; min-height: 100vh; }
    
    /* Sidebar - Simplified for Wizard */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }
    
    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.25rem;
      font-weight: 700;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    
    .wizard-progress {
      padding: 24px;
      flex: 1;
    }
    
    .progress-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.5);
      margin-bottom: 20px;
    }
    
    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      opacity: 0.5;
      transition: all 0.3s;
    }
    
    .step-item.active { opacity: 1; }
    .step-item.completed { opacity: 0.7; }
    .step-item.completed .step-number {
      background: var(--success);
      border-color: var(--success);
    }
    
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .step-item.active .step-number {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-label {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    
    .step-desc {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
    }
    
    /* Main Content */
    .main {
      flex: 1;
      margin-left: 260px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .top-bar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .breadcrumb a { color: var(--text-secondary); text-decoration: none; }
    .breadcrumb a:hover { color: var(--accent); }
    .breadcrumb-current { color: var(--text); font-weight: 600; }
    
    .wizard-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg); }
    
    .content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }
    
    .wizard-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .step-panel {
      display: none;
    }
    .step-panel.active { display: block; }
    
    .step-header {
      margin-bottom: 32px;
    }
    
    .step-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .step-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    /* Form Styles */
    .form-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
    }
    
    .required::after {
      content: ' *';
      color: var(--danger);
    }
    
    input, select, textarea {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface-2, #1f2333);
      color: var(--text, #e8eaf0);
      caret-color: var(--text, #e8eaf0);
      transition: all 0.15s;
      -webkit-text-fill-color: var(--text, #e8eaf0);
    }
    input::placeholder, textarea::placeholder {
      color: var(--text-muted, #4e5a72);
      opacity: 1;
      -webkit-text-fill-color: var(--text-muted, #4e5a72);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
      background: var(--surface-3, #252a3a);
    }
    select option {
      background: var(--surface-2, #1f2333);
      color: var(--text, #e8eaf0);
    }
    
    .input-prefix {
      position: relative;
    }
    
    .input-prefix input {
      padding-left: 36px;
    }
    
    .input-prefix .prefix {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .help-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* Waterfall Builder */
    .waterfall-preview {
      background: var(--bg);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 24px;
    }
    
    .waterfall-title {
      font-weight: 600;
      margin-bottom: 16px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    
    .tier-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: var(--radius);
      margin-bottom: 8px;
      border-left: 4px solid var(--accent);
    }
    
    .tier-row.return { border-left-color: var(--text-muted); }
    .tier-row.pref { border-left-color: var(--warning); }
    .tier-row.catchup { border-left-color: var(--accent); }
    .tier-row.split { border-left-color: var(--success); }
    
    .tier-number {
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 16px;
    }
    
    .tier-content {
      flex: 1;
    }
    
    .tier-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .tier-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .tier-amount {
      font-weight: 600;
      color: var(--accent);
    }
    
    /* Document Selection */
    .doc-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .doc-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .doc-option:hover {
      border-color: var(--accent-light);
    }
    
    .doc-option.selected {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    
    .doc-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
    }
    
    .doc-icon {
      width: 40px;
      height: 40px;
      background: var(--bg);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: var(--accent);
    }
    
    .doc-content {
      flex: 1;
    }
    
    .doc-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .doc-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    /* Summary Review */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    
    .summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 24px;
    }
    
    .summary-card h4 {
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .summary-card h4 button {
      font-size: 0.75rem;
      color: var(--accent);
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-light);
    }
    
    .summary-row:last-child { border-bottom: none; }
    
    .summary-label { color: var(--text-secondary); }
    .summary-value { font-weight: 600; }
    
    /* Success Panel */
    .success-panel {
      text-align: center;
      padding: 60px 20px;
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: var(--success-light);
      color: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin: 0 auto 24px;
    }
    
    .success-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .success-desc {
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .success-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    /* Live Preview */
    .preview-sidebar {
      position: fixed;
      right: 0;
      top: 0;
      width: 360px;
      height: 100vh;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      padding: 24px;
      overflow-y: auto;
      z-index: 50;
      transform: translateX(100%);
      transition: transform 0.3s;
    }
    
    .preview-sidebar.active {
      transform: translateX(0);
    }
    
    .preview-toggle {
      position: fixed;
      right: 24px;
      bottom: 24px;
      padding: 16px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      z-index: 100;
    }
    
    @media (max-width: 1200px) {
      .preview-sidebar { display: none; }
      .preview-toggle { display: none; }
    }
    
    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .summary-grid { grid-template-columns: 1fr; }
      .doc-options { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar with Progress -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="logo" style="text-decoration:none;color:white;">
          <div class="logo-icon">◆</div>
          <span>deeltrack</span>
        </a>
      </div>
      
      <div class="wizard-progress">
        <div class="progress-title">Deal Setup Progress</div>
        
        <div class="step-item active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-label">Deal Basics</div>
            <div class="step-desc">Property & entity info</div>
          </div>
        </div>
        
        <div class="step-item" data-step="2">
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-label">Capital Structure</div>
            <div class="step-desc">Equity & financing</div>
          </div>
        </div>
        
        <div class="step-item" data-step="3">
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-label">Waterfall</div>
            <div class="step-desc">Returns structure</div>
          </div>
        </div>
        
        <div class="step-item" data-step="4">
          <div class="step-number">4</div>
          <div class="step-content">
            <div class="step-label">Documents</div>
            <div class="step-desc">Generate legal docs</div>
          </div>
        </div>
        
        <div class="step-item" data-step="5">
          <div class="step-number">5</div>
          <div class="step-content">
            <div class="step-label">Review</div>
            <div class="step-desc">Finalize & save</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Top Bar -->
      <header class="top-bar">
        <div class="breadcrumb">
          <a href="deals.html">All Deals</a>
          <span>/</span>
          <span class="breadcrumb-current">New Deal Wizard</span>
        </div>
        <div class="wizard-actions">
          <button class="btn btn-secondary" onclick="saveDraft()">
            <i class="fas fa-save"></i> Save Draft
          </button>
          <button class="btn btn-secondary" onclick="window.location.href='deals.html'">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </header>

      <!-- Wizard Content -->
      <div class="content">
        <div class="wizard-container">
          
          <!-- Step 1: Deal Basics -->
          <div class="step-panel active" id="step-1">
            <div class="step-header">
              <h2 class="step-title">Deal Basics</h2>
              <p class="step-subtitle">Let's start with the fundamental information about your investment opportunity.</p>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-building"></i> Property Information</h3>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label class="required">Deal Name</label>
                  <input type="text" id="dealName" placeholder="e.g., Highland Park Apartments" onchange="updatePreview()">
                  <span class="help-text">This is how the deal will appear to investors</span>
                </div>
                
                <div class="form-group full-width">
                  <label class="required">Property Address</label>
                  <input type="text" id="propertyAddress" placeholder="Full street address" onchange="updatePreview()">
                </div>
                
                <div class="form-group">
                  <label class="required">Property Type</label>
                  <select id="propertyType" onchange="updatePreview()">
                    <option value="">Select type...</option>
                    <option value="multifamily">Multifamily</option>
                    <option value="office">Office</option>
                    <option value="retail">Retail</option>
                    <option value="industrial">Industrial</option>
                    <option value="self-storage">Self-Storage</option>
                    <option value="hotel">Hotel</option>
                    <option value="mixed-use">Mixed-Use</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>Number of Units / SF</label>
                  <input type="number" id="propertySize" placeholder="e.g., 120" onchange="updatePreview()">
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-balance-scale"></i> Entity Information</h3>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label class="required">Company Name</label>
                  <input type="text" id="companyName" placeholder="e.g., Highland Park Capital, LLC" onchange="updatePreview()">
                </div>
                
                <div class="form-group">
                  <label class="required">State of Formation</label>
                  <select id="state" onchange="updatePreview()">
                    <option value="DE">Delaware</option>
                    <option value="TX">Texas</option>
                    <option value="CA">California</option>
                    <option value="NY">New York</option>
                    <option value="FL">Florida</option>
                    <option value="NV">Nevada</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>Principal Office</label>
                  <input type="text" id="principalOffice" placeholder="City, State">
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 32px;">
              <button class="btn btn-primary" onclick="nextStep()">
                Continue <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Step 2: Capital Structure -->
          <div class="step-panel" id="step-2">
            <div class="step-header">
              <h2 class="step-title">Capital Structure</h2>
              <p class="step-subtitle">Define the purchase price, financing, and equity requirements.</p>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-dollar-sign"></i> Acquisition Details</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label class="required">Purchase Price</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="number" id="purchasePrice" placeholder="5,000,000" onchange="calculateCapital()">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Closing Costs</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="number" id="closingCosts" placeholder="150,000" onchange="calculateCapital()">
                  </div>
                  <span class="help-text">Legal, title, inspection, etc.</span>
                </div>
                
                <div class="form-group">
                  <label>Capex Reserve</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="number" id="capexReserve" placeholder="200,000" onchange="calculateCapital()">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Total Capital Required</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="text" id="totalCapital" readonly style="background: var(--bg); font-weight: 600;">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-university"></i> Financing</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Loan Amount</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="number" id="loanAmount" placeholder="3,500,000" onchange="calculateCapital()">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Interest Rate</label>
                  <input type="number" id="interestRate" placeholder="5.5" step="0.1">
                  <span class="prefix" style="right: 14px; left: auto;">%</span>
                </div>
                
                <div class="form-group">
                  <label>Loan Term</label>
                  <select id="loanTerm">
                    <option value="5">5 Years</option>
                    <option value="7">7 Years</option>
                    <option value="10" selected>10 Years</option>
                    <option value="30">30 Years</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>LTV</label>
                  <input type="text" id="ltv" readonly style="background: var(--bg);">
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-users"></i> Equity Structure</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label class="required">Total Equity</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="text" id="totalEquity" readonly style="background: var(--bg); font-weight: 600;">
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="required">GP Equity %</label>
                  <input type="number" id="gpEquity" value="10" min="0" max="100" onchange="updateLP()">
                </div>
                
                <div class="form-group">
                  <label>LP Equity %</label>
                  <input type="text" id="lpEquity" value="90" readonly style="background: var(--bg);">
                </div>
                
                <div class="form-group">
                  <label>Minimum Investment</label>
                  <div class="input-prefix">
                    <span class="prefix">$</span>
                    <input type="number" id="minInvestment" placeholder="50,000">
                  </div>
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 32px;">
              <button class="btn btn-secondary" onclick="prevStep()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="nextStep()">
                Continue <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Step 3: Waterfall -->
          <div class="step-panel" id="step-3">
            <div class="step-header">
              <h2 class="step-title">Waterfall Structure</h2>
              <p class="step-subtitle">Configure how profits will be distributed between GP and LPs.</p>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-chart-pie"></i> Returns Structure</h3>
              
              <div class="form-grid" style="margin-bottom: 24px;">
                <div class="form-group">
                  <label class="required">Waterfall Type</label>
                  <select id="waterfallType" onchange="updateWaterfallPreview()">
                    <option value="simple">Simple Split</option>
                    <option value="pref">Preferred Return</option>
                    <option value="catchup" selected>Pref + GP Catch-Up</option>
                    <option value="tiered">Tiered Promote</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>Preferred Return %</label>
                  <input type="number" id="prefReturn" value="8" step="0.5" onchange="updateWaterfallPreview()">
                </div>
                
                <div class="form-group">
                  <label>GP Promote %</label>
                  <input type="number" id="gpPromote" value="30" onchange="updateWaterfallPreview()">
                </div>
                
                <div class="form-group">
                  <label>Catch-Up Rate</label>
                  <input type="number" id="catchupRate" value="50" onchange="updateWaterfallPreview()">
                  <span class="help-text">GP share during catch-up period</span>
                </div>
              </div>
              
              <div class="waterfall-preview">
                <div class="waterfall-title">Distribution Waterfall Preview</div>
                <div id="waterfallTiers">
                  <!-- Dynamically populated -->
                </div>
              </div>

              <!-- Cash Flow Waterfall Chart -->
              <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-top:20px;">
                <div style="font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;"><i class="fas fa-chart-bar" style="color:var(--accent);"></i>Projected Cash Flow Waterfall (Hold Period)</div>
                <div id="cashFlowChart" style="height:200px;display:flex;align-items:flex-end;justify-content:space-between;gap:8px;padding:10px 0;border-bottom:2px solid var(--border);border-left:2px solid var(--border);"></div>
                <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:.7rem;color:var(--text-muted);">
                  <span>Year 1</span><span>Year 2</span><span>Year 3</span><span>Year 4</span><span>Year 5</span>
                </div>
                <div style="display:flex;gap:16px;margin-top:12px;font-size:.75rem;">
                  <div style="display:flex;align-items:center;gap:6px;"><div style="width:12px;height:12px;background:#3b82f6;border-radius:2px;"></div>LP Distribution</div>
                  <div style="display:flex;align-items:center;gap:6px;"><div style="width:12px;height:12px;background:#10b981;border-radius:2px;"></div>GP Distribution</div>
                  <div style="display:flex;align-items:center;gap:6px;"><div style="width:12px;height:12px;background:#f59e0b;border-radius:2px;"></div>Pref Return</div>
                </div>
              </div>

              <script>
                (function initCashFlowChart() {
                  function updateChart() {
                    const equity = parseFloat(document.getElementById('totalEquity')?.value?.replace(/,/g,'')) || 1000000;
                    const pref = parseFloat(document.getElementById('prefReturn')?.value) || 8;
                    const gpPct = parseFloat(document.getElementById('gpPromote')?.value) || 20;
                    const chart = document.getElementById('cashFlowChart');
                    if (!chart) return;
                    const annualPref = equity * (pref/100);
                    const exitValue = equity * 1.5;
                    const totalProfit = exitValue - equity;
                    const gpPromote = totalProfit * (gpPct/100);
                    const lpProceeds = totalProfit - gpPromote;
                    const bars = [];
                    for (let y=1; y<=5; y++) {
                      const isExit = y === 5;
                      const lpAmount = isExit ? (annualPref + lpProceeds) : annualPref;
                      const gpAmount = isExit ? gpPromote : 0;
                      const prefAmount = isExit ? 0 : annualPref;
                      const maxVal = Math.max(lpAmount + gpAmount + prefAmount, equity * 0.15);
                      const lpH = Math.round((lpAmount/maxVal)*180);
                      const gpH = Math.round((gpAmount/maxVal)*180);
                      const prefH = Math.round((prefAmount/maxVal)*180);
                      bars.push(`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;"><div style="width:100%;display:flex;flex-direction:column-reverse;gap:1px;">${prefH?`<div style="height:${prefH}px;background:#f59e0b;border-radius:2px 2px 0 0;" title="Pref: $${Math.round(prefAmount).toLocaleString()}"></div>`:''}${gpH?`<div style="height:${gpH}px;background:#10b981;border-radius:2px;" title="GP: $${Math.round(gpAmount).toLocaleString()}"></div>`:''}${lpH?`<div style="height:${lpH}px;background:#3b82f6;border-radius:2px;" title="LP: $${Math.round(lpAmount).toLocaleString()}"></div>`:''}</div></div>`);
                    }
                    chart.innerHTML = bars.join('');
                  }
                  ['prefReturn','gpPromote','totalEquity'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', updateChart);
                  });
                  setTimeout(updateChart, 500);
                })();
              </script>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-hand-holding-usd"></i> GP Fees</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Acquisition Fee</label>
                  <input type="number" id="acqFee" value="3" step="0.5">
                  <span class="prefix" style="right: 14px; left: auto;">%</span>
                </div>
                
                <div class="form-group">
                  <label>Asset Management Fee</label>
                  <input type="number" id="assetMgmtFee" value="2" step="0.5">
                  <span class="prefix" style="right: 14px; left: auto;">%</span>
                  <span class="help-text">Of gross revenue</span>
                </div>
                
                <div class="form-group">
                  <label>Disposition Fee</label>
                  <input type="number" id="dispFee" value="2" step="0.5">
                  <span class="prefix" style="right: 14px; left: auto;">%</span>
                  <span class="help-text">Of sale price</span>
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 32px;">
              <button class="btn btn-secondary" onclick="prevStep()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="nextStep()">
                Continue <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Step 4: Documents -->
          <div class="step-panel" id="step-4">
            <div class="step-header">
              <h2 class="step-title">Generate Documents</h2>
              <p class="step-subtitle">Select which legal documents to generate for this deal.</p>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-file-contract"></i> Select Documents</h3>
              
              <div class="doc-options">
                <label class="doc-option selected">
                  <input type="checkbox" checked onchange="this.closest('.doc-option').classList.toggle('selected')">
                  <div class="doc-icon"><i class="fas fa-balance-scale"></i></div>
                  <div class="doc-content">
                    <div class="doc-name">Operating Agreement</div>
                    <div class="doc-desc">LLC operating agreement with waterfall provisions</div>
                  </div>
                </label>
                
                <label class="doc-option selected">
                  <input type="checkbox" checked onchange="this.closest('.doc-option').classList.toggle('selected')">
                  <div class="doc-icon"><i class="fas fa-handshake"></i></div>
                  <div class="doc-content">
                    <div class="doc-name">LP Agreement</div>
                    <div class="doc-desc">Limited partnership agreement for investors</div>
                  </div>
                </label>
                
                <label class="doc-option selected">
                  <input type="checkbox" checked onchange="this.closest('.doc-option').classList.toggle('selected')">
                  <div class="doc-icon"><i class="fas fa-file-alt"></i></div>
                  <div class="doc-content">
                    <div class="doc-name">Private Placement Memo</div>
                    <div class="doc-desc">PPM with risk factors and offering terms</div>
                  </div>
                </label>
                
                <label class="doc-option selected">
                  <input type="checkbox" checked onchange="this.closest('.doc-option').classList.toggle('selected')">
                  <div class="doc-icon"><i class="fas fa-pen-fancy"></i></div>
                  <div class="doc-content">
                    <div class="doc-name">Subscription Agreement</div>
                    <div class="doc-desc">Investor subscription and accreditation docs</div>
                  </div>
                </label>
              </div>
            </div>
            
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-user-tie"></i> General Partner Info</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>GP Entity Name</label>
                  <input type="text" id="gpName" placeholder="e.g., ABC Capital GP, LLC">
                </div>
                
                <div class="form-group">
                  <label>Managing Member</label>
                  <input type="text" id="gpRep" placeholder="Full name">
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 32px;">
              <button class="btn btn-secondary" onclick="prevStep()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="nextStep()">
                Continue <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Step 5: Review -->
          <div class="step-panel" id="step-5">
            <div class="step-header">
              <h2 class="step-title">Review & Finalize</h2>
              <p class="step-subtitle">Review your deal details before saving and generating documents.</p>
            </div>
            
            <div class="summary-grid">
              <div class="summary-card">
                <h4>Deal Basics <button onclick="goToStep(1)">Edit</button></h4>
                <div class="summary-row">
                  <span class="summary-label">Deal Name</span>
                  <span class="summary-value" id="reviewName">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Property</span>
                  <span class="summary-value" id="reviewProperty">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Type</span>
                  <span class="summary-value" id="reviewType">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Entity</span>
                  <span class="summary-value" id="reviewEntity">-</span>
                </div>
              </div>
              
              <div class="summary-card">
                <h4>Capital Structure <button onclick="goToStep(2)">Edit</button></h4>
                <div class="summary-row">
                  <span class="summary-label">Purchase Price</span>
                  <span class="summary-value" id="reviewPrice">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Loan Amount</span>
                  <span class="summary-value" id="reviewLoan">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Total Equity</span>
                  <span class="summary-value" id="reviewEquity">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">GP/LP Split</span>
                  <span class="summary-value" id="reviewSplit">-</span>
                </div>
              </div>
              
              <div class="summary-card">
                <h4>Waterfall <button onclick="goToStep(3)">Edit</button></h4>
                <div class="summary-row">
                  <span class="summary-label">Structure</span>
                  <span class="summary-value" id="reviewWaterfall">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Preferred Return</span>
                  <span class="summary-value" id="reviewPref">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">GP Promote</span>
                  <span class="summary-value" id="reviewPromote">-</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Acq Fee</span>
                  <span class="summary-value" id="reviewAcqFee">-</span>
                </div>
              </div>
              
              <div class="summary-card">
                <h4>Documents <button onclick="goToStep(4)">Edit</button></h4>
                <div class="summary-row">
                  <span class="summary-label">Operating Agreement</span>
                  <span class="summary-value"><i class="fas fa-check" style="color: var(--success);"></i></span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">LP Agreement</span>
                  <span class="summary-value"><i class="fas fa-check" style="color: var(--success);"></i></span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">PPM</span>
                  <span class="summary-value"><i class="fas fa-check" style="color: var(--success);"></i></span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Subscription</span>
                  <span class="summary-value"><i class="fas fa-check" style="color: var(--success);"></i></span>
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 32px;">
              <button class="btn btn-secondary" onclick="prevStep()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="createDeal()" style="padding: 12px 32px;">
                <i class="fas fa-check-circle"></i> Create Deal & Generate Documents
              </button>
            </div>
          </div>
          
          <!-- Success State -->
          <div class="step-panel" id="step-success">
            <div class="success-panel">
              <div class="success-icon"><i class="fas fa-check"></i></div>
              <h2 class="success-title">Deal Created!</h2>
              <p class="success-desc" id="successDealName" style="font-weight:700;font-size:1.15rem;color:var(--text);margin-bottom:6px;"></p>
              <p class="success-desc" id="successOAStatus" style="color:var(--success);font-size:.9rem;"></p>
            </div>

            <!-- OA inline preview on success screen -->
            <div id="successOASection" style="display:none;margin:24px 0;border:1px solid var(--border);border-radius:12px;overflow:hidden;">
              <div style="background:var(--surface-2);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);">
                <div>
                  <div style="font-weight:700;font-size:.95rem;">Operating Agreement</div>
                  <div style="font-size:.78rem;color:var(--text-secondary);">Auto-generated from your deal terms — review before use</div>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="btn btn-secondary" style="padding:7px 12px;font-size:.8rem;" onclick="toggleSuccessOA()"><i class="fas fa-eye"></i> <span id="successOAToggleLabel">View</span></button>
                  <button class="btn btn-secondary" style="padding:7px 12px;font-size:.8rem;" onclick="printSuccessOA()"><i class="fas fa-print"></i> Print</button>
                  <button class="btn btn-secondary" style="padding:7px 12px;font-size:.8rem;" onclick="downloadSuccessOA()"><i class="fas fa-download"></i> Word</button>
                </div>
              </div>
              <div id="successOAContent" style="display:none;max-height:500px;overflow-y:auto;background:white;padding:0;"></div>
            </div>

            <div class="success-actions" style="margin-top:16px;">
              <button class="btn btn-primary" onclick="viewDeal()"><i class="fas fa-eye"></i> View Deal Detail</button>
              <button class="btn btn-secondary" onclick="window.location.href='investors.html'"><i class="fas fa-users"></i> Add Investors</button>
              <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'"><i class="fas fa-th-large"></i> Dashboard</button>
            </div>
          </div>
          
        </div>
      </div>
    </main>
  </div>

  <script>
    SP.requireGP();
    let currentStep = 1;

    // On page load: pre-fill from settings, then restore any draft
    document.addEventListener('DOMContentLoaded', function() {
      // Pre-fill from GP settings (Sprint 1 item 5)
      const s = SP.load('settings', {});
      const set = (id, val) => { const el = document.getElementById(id); if (el && val && !el.value) el.value = val; };
      set('companyName', s.firmName || '');
      const stateEl = document.getElementById('state');
      if (stateEl && (s.defState || s.firmState) && !stateEl.value) stateEl.value = s.defState || s.firmState;
      set('prefReturn', s.defPref || '8');
      set('gpPromote', s.defPromote || '20');
      set('gpEquity', s.defGPEquity || '10');
      if (document.getElementById('lpEquity')) updateLP();

      // Restore draft if exists
      const urlId = new URLSearchParams(window.location.search).get('id');
      if (!urlId) loadDraft(); // don't overwrite when editing existing deal

      // Auto-save on any input change
      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('change', saveDraftAuto);
        el.addEventListener('input', saveDraftAuto);
      });

      // Clear draft on successful creation
    });

    const totalSteps = 5;
    
    function updateStepIndicators() {
      document.querySelectorAll('.step-item').forEach((item, index) => {
        const step = index + 1;
        item.classList.remove('active', 'completed');
        
        if (step === currentStep) {
          item.classList.add('active');
        } else if (step < currentStep) {
          item.classList.add('completed');
          item.querySelector('.step-number').innerHTML = '<i class="fas fa-check"></i>';
        } else {
          item.querySelector('.step-number').textContent = step;
        }
      });
    }
    
    // Auto-save draft to localStorage so fields survive refresh
    function saveDraftAuto() {
      const fields = ['dealName','propertyAddress','propertyType','companyName','state','propertySize',
        'purchasePrice','closingCosts','capexReserve','loanAmount','interestRate','loanTerm',
        'gpEquity','lpEquity','prefReturn','gpPromote','waterfallType','acqFee','assetMgmtFee','minInvestment'];
      const data = {};
      fields.forEach(id => { const el = document.getElementById(id); if (el) data[id] = el.value; });
      localStorage.setItem('dt_wizard_draft', JSON.stringify(data));
    }

    function loadDraft() {
      const saved = localStorage.getItem('dt_wizard_draft');
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        Object.entries(data).forEach(([id, val]) => {
          const el = document.getElementById(id);
          if (el && val) { el.value = val; }
        });
        calculateCapital();
        updateWaterfallPreview();
        updateLP();
      } catch(e) {}
    }

    function clearDraft() {
      localStorage.removeItem('dt_wizard_draft');
    }

    function showStep(step) {
      document.querySelectorAll('.step-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      if (step === 'success') {
        document.getElementById('step-success').classList.add('active');
      } else {
        document.getElementById('step-' + step).classList.add('active');
      }
      
      currentStep = step === 'success' ? totalSteps + 1 : step;
      updateStepIndicators();
    }
    
    function nextStep() {
      if (currentStep < totalSteps) {
        // Validate current step
        if (!validateStep(currentStep)) return;
        
        if (currentStep === 4) {
          populateReview();
        }
        
        showStep(currentStep + 1);
      }
    }
    
    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }
    
    function goToStep(step) {
      showStep(step);
    }
    
    function validateStep(step) {
      let valid = true;
      
      if (step === 1) {
        const required = ['dealName', 'propertyAddress', 'propertyType', 'companyName'];
        required.forEach(id => {
          const el = document.getElementById(id);
          if (!el.value) {
            el.style.borderColor = 'var(--danger)';
            valid = false;
          } else {
            el.style.borderColor = '';
          }
        });
      }
      
      if (step === 2) {
        if (!document.getElementById('purchasePrice').value) {
          document.getElementById('purchasePrice').style.borderColor = 'var(--danger)';
          valid = false;
        }
      }
      
      return valid;
    }
    
    function calculateCapital() {
      const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
      const closing = parseFloat(document.getElementById('closingCosts').value) || 0;
      const capex = parseFloat(document.getElementById('capexReserve').value) || 0;
      const loan = parseFloat(document.getElementById('loanAmount').value) || 0;
      
      const total = price + closing + capex;
      const equity = total - loan;
      const ltv = price > 0 ? (loan / price * 100).toFixed(1) : 0;
      
      document.getElementById('totalCapital').value = total.toLocaleString();
      document.getElementById('totalEquity').value = equity.toLocaleString();
      document.getElementById('ltv').value = ltv + '%';
    }
    
    function updateLP() {
      const gp = parseFloat(document.getElementById('gpEquity').value) || 0;
      document.getElementById('lpEquity').value = (100 - gp);
    }
    
    function updateWaterfallPreview() {
      const type = document.getElementById('waterfallType').value;
      const pref = document.getElementById('prefReturn').value;
      const promote = document.getElementById('gpPromote').value;
      
      let tiers = '';
      
      if (type === 'simple') {
        tiers = `
          <div class="tier-row split">
            <div class="tier-number">1</div>
            <div class="tier-content">
              <div class="tier-name">Pro-Rata Split</div>
              <div class="tier-desc">All distributions split ${promote}% GP / ${100-promote}% LP</div>
            </div>
          </div>
        `;
      } else if (type === 'pref') {
        tiers = `
          <div class="tier-row return">
            <div class="tier-number">1</div>
            <div class="tier-content">
              <div class="tier-name">Return of Capital</div>
              <div class="tier-desc">100% to investors until capital returned</div>
            </div>
          </div>
          <div class="tier-row pref">
            <div class="tier-number">2</div>
            <div class="tier-content">
              <div class="tier-name">Preferred Return</div>
              <div class="tier-desc">${pref}% to LPs</div>
            </div>
          </div>
          <div class="tier-row split">
            <div class="tier-number">3</div>
            <div class="tier-content">
              <div class="tier-name">Residual Split</div>
              <div class="tier-desc">${promote}% GP / ${100-promote}% LP</div>
            </div>
          </div>
        `;
      } else if (type === 'catchup') {
        tiers = `
          <div class="tier-row return">
            <div class="tier-number">1</div>
            <div class="tier-content">
              <div class="tier-name">Return of Capital</div>
              <div class="tier-desc">100% to investors until capital returned</div>
            </div>
          </div>
          <div class="tier-row pref">
            <div class="tier-number">2</div>
            <div class="tier-content">
              <div class="tier-name">Preferred Return</div>
              <div class="tier-desc">${pref}% to LPs</div>
            </div>
          </div>
          <div class="tier-row catchup">
            <div class="tier-number">3</div>
            <div class="tier-content">
              <div class="tier-name">GP Catch-Up</div>
              <div class="tier-desc">GP receives promote share to catch up</div>
            </div>
          </div>
          <div class="tier-row split">
            <div class="tier-number">4</div>
            <div class="tier-content">
              <div class="tier-name">Residual Split</div>
              <div class="tier-desc">${promote}% GP / ${100-promote}% LP</div>
            </div>
          </div>
        `;
      }
      
      document.getElementById('waterfallTiers').innerHTML = tiers;
    }
    
    function populateReview() {
      document.getElementById('reviewName').textContent = document.getElementById('dealName').value || '-';
      document.getElementById('reviewProperty').textContent = document.getElementById('propertyAddress').value || '-';
      document.getElementById('reviewType').textContent = document.getElementById('propertyType').value || '-';
      document.getElementById('reviewEntity').textContent = document.getElementById('companyName').value || '-';
      
      const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
      const loan = parseFloat(document.getElementById('loanAmount').value) || 0;
      const equity = parseFloat(document.getElementById('totalEquity').value.replace(/,/g, '')) || 0;
      const gp = document.getElementById('gpEquity').value;
      const lp = document.getElementById('lpEquity').value;
      
      document.getElementById('reviewPrice').textContent = '$' + price.toLocaleString();
      document.getElementById('reviewLoan').textContent = '$' + loan.toLocaleString();
      document.getElementById('reviewEquity').textContent = '$' + equity.toLocaleString();
      document.getElementById('reviewSplit').textContent = gp + '% / ' + lp + '%';
      
      const wfTypes = { simple: 'Simple Split', pref: 'Preferred Return', catchup: 'Pref + GP Catch-Up', tiered: 'Tiered Promote' };
      document.getElementById('reviewWaterfall').textContent = wfTypes[document.getElementById('waterfallType').value];
      document.getElementById('reviewPref').textContent = document.getElementById('prefReturn').value + '%';
      document.getElementById('reviewPromote').textContent = document.getElementById('gpPromote').value + '%';
      document.getElementById('reviewAcqFee').textContent = document.getElementById('acqFee').value + '%';
    }
    
    function createDeal() {
      const deal = {
        id: Date.now().toString(),
        name: document.getElementById('dealName').value,
        propertyAddress: document.getElementById('propertyAddress').value,
        propertyType: document.getElementById('propertyType').value,
        companyName: document.getElementById('companyName').value,
        state: document.getElementById('state').value,
        purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
        loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
        totalEquity: parseFloat(document.getElementById('totalEquity').value.replace(/,/g, '')) || 0,
        gpEquity: parseFloat(document.getElementById('gpEquity').value) || 10,
        lpEquity: parseFloat(document.getElementById('lpEquity').value) || 90,
        prefReturn: parseFloat(document.getElementById('prefReturn').value) || 8,
        gpPromote: parseFloat(document.getElementById('gpPromote').value) || 30,
        waterfallType: document.getElementById('waterfallType').value,
        acqFee: parseFloat(document.getElementById('acqFee').value) || 3,
        assetMgmtFee: parseFloat(document.getElementById('assetMgmtFee').value) || 2,
        createdAt: new Date().toISOString(),
        status: 'sourcing'
      };
      
      // Save to sp-core unified deal store
      const urlId = new URLSearchParams(window.location.search).get('id');
      const spDeals = SP.getDeals();

      // Estimate IRR from pref return + promote (rough proxy until full model)
      const pref = deal.prefReturn || 8;
      const promote = deal.gpPromote || 20;
      const estimatedIRR = parseFloat((pref * 1.5 + (promote * 0.1)).toFixed(1));
      const estimatedEM = parseFloat((1 + (pref / 100) * 5).toFixed(2)); // 5-year hold estimate

      const spDeal = {
        id: urlId || deal.id,
        name: deal.name,
        type: (deal.propertyType || 'other').toLowerCase(),
        location: deal.propertyAddress || deal.principalOffice || deal.state || '',
        raise: deal.totalEquity || 0,
        irr: estimatedIRR,
        equity: estimatedEM,
        units: parseInt(document.getElementById('propertySize')?.value) || 0,
        status: 'sourcing',
        added: deal.createdAt ? deal.createdAt.split('T')[0] : new Date().toISOString().split('T')[0],
        investors: [],
        documents: [],
        notes: '',
        // Full wizard data for documents/proforma
        wizardData: deal,
        prefReturn: deal.prefReturn || 8,
        gpPromote: deal.gpPromote || 20,
        gpEquity: deal.gpEquity || 10,
        lpEquity: deal.lpEquity || 90,
        waterfallType: deal.waterfallType || 'simple',
        purchasePrice: deal.purchasePrice || 0,
        loanAmount: deal.loanAmount || 0,
        totalEquity: deal.totalEquity || 0,
        acqFee: deal.acqFee || 3,
        assetMgmtFee: deal.assetMgmtFee || 2,
        companyName: deal.companyName || '',
        state: deal.state || '',
        interestRate: parseFloat(document.getElementById('interestRate')?.value) || 0,
        minInvestment: parseFloat(document.getElementById('minInvestment')?.value) || 50000,
      };
      if (urlId) {
        const idx = spDeals.findIndex(d => d.id === urlId);
        if (idx >= 0) { spDeals[idx] = { ...spDeals[idx], ...spDeal }; }
        else { spDeals.unshift(spDeal); }
      } else {
        spDeals.unshift(spDeal);
      }
      // Auto-generate Operating Agreement and store on the deal
      // Generate OA using professional template from sp-documents.js
      const _settings = SP.load('settings', {});
      const _gpName = _settings.firmName || spDeal.companyName || spDeal.name + ' GP, LLC';
      const _gpRep = _settings.gpFullName || SP.getSession()?.name || 'Managing Member';
      const _state = spDeal.state || _settings.defState || _settings.firmState || 'DE';
      const _minInv = spDeal.minInvestment || 50000;
      if (typeof SPDocs !== 'undefined') {
        spDeal.generatedOA = SPDocs.generateOA(spDeal, _gpName, _gpRep, _settings.firmAddress || '', _state, _minInv, []);
      } else {
        spDeal.generatedOA = autoGenerateOA(spDeal);
      }
      spDeal.oaGeneratedAt = new Date().toISOString();

      SP.saveDeals(spDeals);
      // Also push to Firebase if ready
      if (typeof SPFB !== 'undefined' && SPFB.isReady() && !SPFB.isOffline()) {
        const savedDeal = spDeals.find(d => d.id === id);
        if (savedDeal) SPFB.saveDeal(savedDeal).catch(e => console.warn('SPFB.saveDeal:', e.message));
      }
      SP.logActivity('fa-file-contract', 'green', `Operating Agreement auto-generated for <strong>${deal.name}</strong>`);

      // Store current deal id for viewDeal()
      localStorage.setItem('currentDeal', JSON.stringify({ id: spDeal.id, name: deal.name }));
      window._savedDealId = spDeal.id;

      // Populate success screen
      const nameEl = document.getElementById('successDealName');
      if (nameEl) nameEl.textContent = deal.name;

      const statusEl = document.getElementById('successOAStatus');
      if (statusEl) statusEl.innerHTML = '<i class="fas fa-file-contract"></i> Operating Agreement generated and ready';

      // Show OA inline on success screen
      const oaSection = document.getElementById('successOASection');
      const oaContent = document.getElementById('successOAContent');
      if (oaSection && oaContent && spDeal.generatedOA) {
        oaSection.style.display = 'block';
        oaContent.innerHTML = spDeal.generatedOA;
      }

      clearDraft(); // Remove wizard draft after successful save
      showStep('success');
    }
    
    function autoGenerateOA(d) {
      const settings = SP.load('settings', {});
      const gpName = settings.firmName || d.companyName || d.name + ' GP, LLC';
      const gpRep = settings.gpFullName || SP.getSession()?.name || 'Managing Member';
      const state = d.state || settings.defState || settings.firmState || 'DE';
      const address = d.location || settings.firmAddress || '';

      const stateProvisions = {
        'TX': `<p><strong>Tax Treatment.</strong> The Company elects to be taxed as a partnership under Texas Tax Code § 171.0002.</p><p><strong>Franchise Tax.</strong> The Company acknowledges potential franchise tax obligations under Texas Tax Code Chapter 171.</p><p><strong>Community Property.</strong> If any member is married, their spouse consents per Texas Family Code § 3.104.</p>`,
        'DE': `<p><strong>Series LLC.</strong> The Company may establish separate series pursuant to Section 18-215 of the Delaware LLC Act.</p><p><strong>Charging Order.</strong> A member's interest is subject to charging order as sole remedy under Section 18-703.</p>`,
        'FL': `<p><strong>Registered Agent.</strong> The Company maintains a Florida registered agent as required by § 605.0113, Florida Statutes.</p><p><strong>Annual Report.</strong> The Company shall file annual reports with the Florida Division of Corporations.</p>`,
        'CA': `<p><strong>Franchise Tax.</strong> The Company shall pay the annual $800 minimum franchise tax under California Revenue and Taxation Code § 17941.</p><p><strong>Securities.</strong> Interests are offered pursuant to California Corporations Code § 25102(f) exemption.</p>`,
        'NV': `<p><strong>Charging Order.</strong> A judgment creditor's exclusive remedy is a charging order per NRS 86.401.</p><p><strong>Asset Protection.</strong> Nevada law provides strong asset protection for LLC members under NRS Chapter 86.</p>`,
        'WY': `<p><strong>Asset Protection.</strong> Wyoming provides charging order protection as sole remedy per W.S. 17-29-503.</p><p><strong>Privacy.</strong> Member information is not publicly filed with the Wyoming Secretary of State.</p>`,
        'NY': `<p><strong>Publication.</strong> The Company has satisfied NY LLC Law § 206 publication requirements.</p><p><strong>Member Liability.</strong> Members are not liable for company debts per NY LLC Law § 609.</p>`,
      };
      const stateClause = stateProvisions[state] || stateProvisions['DE'];
      const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      const gpPct = d.gpEquity || 10;
      const lpPct = d.lpEquity || 90;
      const pref = d.prefReturn || 8;
      const promote = d.gpPromote || 20;
      const residualLP = 100 - promote;
      const equity = d.totalEquity || d.raise || 0;

      return `<div style="font-family:Georgia,serif;line-height:1.8;max-width:800px;margin:0 auto;">
        <div style="text-align:center;border-bottom:3px double #0f172a;padding-bottom:20px;margin-bottom:28px;">
          <div style="font-size:.75rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:#64748b;margin-bottom:8px;">Operating Agreement</div>
          <h1 style="font-size:1.5rem;font-weight:700;margin-bottom:4px;">${gpName}</h1>
          <div style="font-size:.9rem;color:#64748b;">A ${state} Limited Liability Company</div>
        </div>
        <div style="background:#fef9c3;border:1px solid #fbbf24;border-radius:6px;padding:12px 16px;margin-bottom:24px;font-size:.8rem;font-family:sans-serif;color:#78350f;">
          <strong>⚠ PLACEHOLDER DOCUMENT:</strong> This Operating Agreement was auto-generated from your deal inputs for reference purposes. Have your attorney review and finalize before use with actual investors.
        </div>
        <p>THIS OPERATING AGREEMENT ("<strong>Agreement</strong>") is entered into as of ${today}, by and among the Members listed on Schedule A attached hereto.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE I — FORMATION</h2>
        <p><strong>1.1 Formation.</strong> The Members hereby form a limited liability company pursuant to the ${state} Limited Liability Company Act.</p>
        <p><strong>1.2 Name.</strong> The name of the Company shall be <strong>${gpName}</strong>.</p>
        <p><strong>1.3 Principal Office.</strong> The principal office shall be at ${address || '[ADDRESS ON FILE]'}.</p>
        <p><strong>1.4 Purpose.</strong> To acquire, own, operate, and dispose of real property known as <strong>${d.name}</strong>, located at ${d.location || '[PROPERTY ADDRESS]'}, and all activities necessary or incidental thereto.</p>
        <p><strong>1.5 Duration.</strong> The Company shall have perpetual existence unless dissolved in accordance with Article VIII.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE II — CAPITAL CONTRIBUTIONS</h2>
        <p><strong>2.1 Total Capitalization.</strong> The total equity raise shall be <strong>$${equity.toLocaleString()}</strong>.</p>
        <p><strong>2.2 General Partner.</strong> ${gpName} shall contribute <strong>${gpPct}%</strong> of total equity ($${Math.round(equity * gpPct / 100).toLocaleString()}).</p>
        <p><strong>2.3 Limited Partners.</strong> Limited Partners shall collectively contribute <strong>${lpPct}%</strong> of total equity ($${Math.round(equity * lpPct / 100).toLocaleString()}).</p>
        <p><strong>2.4 Minimum Investment.</strong> The minimum investment per Limited Partner is $${(d.minInvestment || 50000).toLocaleString()}.</p>
        <p><strong>2.5 Capital Accounts.</strong> A separate Capital Account shall be maintained for each Member in accordance with Treasury Regulations § 1.704-1(b)(2)(iv).</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE III — DISTRIBUTIONS AND WATERFALL</h2>
        <p><strong>3.1 Distribution Priority.</strong> Distributable Cash shall be distributed in the following order:</p>
        <blockquote style="border-left:3px solid #3b82f6;padding:8px 16px;margin:12px 0;background:#f0f9ff;">
          <p><strong>(a) Return of Capital:</strong> 100% to Members pro-rata until each Member has received a full return of their capital contribution;</p>
          <p><strong>(b) Preferred Return:</strong> 100% to Limited Partners until they have received a cumulative preferred return of <strong>${pref}% per annum</strong> on invested capital;</p>
          <p><strong>(c) GP Catch-Up:</strong> 100% to the General Partner until the GP has received <strong>${promote}%</strong> of all distributions made under (b) and (c) combined;</p>
          <p><strong>(d) Residual Split:</strong> <strong>${promote}% to GP</strong> and <strong>${residualLP}% to Limited Partners</strong> on all remaining Distributable Cash.</p>
        </blockquote>
        <p><strong>3.2 Timing.</strong> The GP shall distribute Distributable Cash within 60 days after each fiscal quarter end.</p>
        <p><strong>3.3 Tax Distributions.</strong> The GP may make tax distributions to Members sufficient to cover federal and state income tax liabilities on allocated income.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE IV — MANAGEMENT</h2>
        <p><strong>4.1 Managing Member.</strong> <strong>${gpName}</strong>, acting through ${gpRep}, shall serve as the sole Managing Member with full authority to manage the Company.</p>
        <p><strong>4.2 LP Restrictions.</strong> Limited Partners shall have no right to participate in management and no authority to bind the Company.</p>
        <p><strong>4.3 GP Fees.</strong> The GP shall receive: (a) Acquisition Fee of <strong>${d.acqFee || 3}%</strong> of purchase price at closing; (b) Asset Management Fee of <strong>${d.assetMgmtFee || 2}%</strong> of gross revenues annually.</p>
        <p><strong>4.4 Major Decisions.</strong> The following require approval of a majority-in-interest of Limited Partners: (a) sale or refinancing of the Property; (b) material alteration of the business plan; (c) incurring debt in excess of 125% of budgeted amounts.</p>
        <p><strong>4.5 GP Removal.</strong> The GP may be removed for Cause (fraud, gross negligence, willful misconduct, or material breach not cured within 30 days) by vote of 66.7% in interest of Limited Partners.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE V — TRANSFERS</h2>
        <p><strong>5.1 Restrictions.</strong> No Member may transfer their interest without prior written consent of the GP, which may be withheld in the GP's sole discretion.</p>
        <p><strong>5.2 Right of First Refusal.</strong> Before any permitted transfer, the Company shall have a 30-day right of first refusal at the proposed transfer price.</p>
        <p><strong>5.3 No Withdrawal.</strong> No Member has the right to withdraw or demand return of their capital contribution prior to dissolution.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE VI — ACCOUNTING AND TAX</h2>
        <p><strong>6.1 Fiscal Year.</strong> The fiscal year of the Company shall be the calendar year.</p>
        <p><strong>6.2 Reporting.</strong> The GP shall provide quarterly updates and annual financial statements to all Members.</p>
        <p><strong>6.3 K-1s.</strong> The Company shall file IRS Form 1065 and provide Schedule K-1s to all Members by March 15 of each year.</p>
        <p><strong>6.4 Tax Matters Partner.</strong> The GP shall serve as the Tax Matters Partner / Partnership Representative.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE VII — STATE-SPECIFIC PROVISIONS</h2>
        ${stateClause}
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE VIII — DISSOLUTION</h2>
        <p><strong>8.1 Events.</strong> The Company dissolves upon: (a) sale of the Property; (b) unanimous consent; (c) judicial dissolution; (d) entry of decree of dissolution.</p>
        <p><strong>8.2 Winding Up.</strong> Upon dissolution, the GP (or a liquidating trustee) shall wind up the Company's affairs and distribute assets: first to creditors, then to Members per Article III.</p>
        <h2 style="font-size:1.1rem;margin:24px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">ARTICLE IX — GENERAL PROVISIONS</h2>
        <p><strong>9.1 Governing Law.</strong> This Agreement is governed by the laws of ${state}.</p>
        <p><strong>9.2 Amendments.</strong> This Agreement may be amended by the GP with approval of a majority-in-interest of Limited Partners.</p>
        <p><strong>9.3 Entire Agreement.</strong> This Agreement constitutes the entire agreement and supersedes all prior understandings.</p>
        <p><strong>9.4 Counterparts.</strong> This Agreement may be executed in one or more counterparts, including electronic signatures.</p>
        <div style="margin-top:48px;border-top:2px solid #0f172a;padding-top:20px;">
          <h2 style="font-size:1rem;margin-bottom:20px;">SIGNATURES</h2>
          <p>IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:32px;">
            <div>
              <div style="border-top:1px solid #333;padding-top:8px;margin-top:48px;"></div>
              <div><strong>GENERAL PARTNER:</strong></div>
              <div>${gpName}</div>
              <div>By: ${gpRep}, Managing Member</div>
              <div style="margin-top:8px;color:#64748b;font-size:.85rem;">Date: _______________</div>
            </div>
            <div>
              <div style="border-top:1px solid #333;padding-top:8px;margin-top:48px;"></div>
              <div><strong>LIMITED PARTNERS:</strong></div>
              <div>See Schedule A</div>
              <div style="margin-top:8px;color:#64748b;font-size:.85rem;">Date: _______________</div>
            </div>
          </div>
        </div>
        <div style="margin-top:40px;border-top:1px solid #e2e8f0;padding-top:20px;">
          <h3 style="font-size:.9rem;">SCHEDULE A — MEMBERS</h3>
          <table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:.85rem;">
            <thead><tr style="background:#f8fafc;"><th style="padding:8px;border:1px solid #e2e8f0;text-align:left;">Member Name</th><th style="padding:8px;border:1px solid #e2e8f0;">Capital Contribution</th><th style="padding:8px;border:1px solid #e2e8f0;">Ownership %</th><th style="padding:8px;border:1px solid #e2e8f0;">Role</th></tr></thead>
            <tbody>
              <tr><td style="padding:8px;border:1px solid #e2e8f0;">${gpName}</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">$${Math.round(equity * gpPct / 100).toLocaleString()}</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${gpPct}%</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">General Partner</td></tr>
              <tr><td style="padding:8px;border:1px solid #e2e8f0;color:#64748b;font-style:italic;">[Limited Partners — added on investment]</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">$${Math.round(equity * lpPct / 100).toLocaleString()}</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${lpPct}%</td><td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">Limited Partners</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function saveDraft() {
      alert('Draft saved! You can continue later.');
    }
    
    function viewDeal() {
      const id = window._savedDealId || JSON.parse(localStorage.getItem('currentDeal') || '{}').id;
      window.location.href = id ? `deal-detail.html?id=${id}` : 'pipeline.html';
    }

    function toggleSuccessOA() {
      const content = document.getElementById('successOAContent');
      const label = document.getElementById('successOAToggleLabel');
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      if (label) label.textContent = isHidden ? 'Hide' : 'View';
    }

    function printSuccessOA() {
      const id = window._savedDealId;
      const deal = id ? SP.getDealById(id) : null;
      const oa = deal?.generatedOA || document.getElementById('successOAContent')?.innerHTML;
      if (!oa) return;
      const w = window.open('', '_blank');
      w.document.write(`<!DOCTYPE html><html><head><title>Operating Agreement</title><style>body{font-family:Georgia,serif;margin:40px;}</style></head><body>${oa}</body></html>`);
      w.document.close();
      setTimeout(() => w.print(), 500);
    }

    function downloadSuccessOA() {
      const id = window._savedDealId;
      const deal = id ? SP.getDealById(id) : null;
      const oa = deal?.generatedOA || document.getElementById('successOAContent')?.innerHTML;
      if (!oa) return;
      const blob = new Blob([`<html><body>${oa}</body></html>`], {type:'application/msword'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${deal?.name || 'Operating-Agreement'}.doc`;
      a.click();
    }
    
    function updatePreview() {
      // Live preview updates would go here
    }
    
    // Initialize
    updateWaterfallPreview();
  </script>
</body>
</html>