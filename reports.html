<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Reports</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--primary:#0f172a;--accent:#3b82f6;--accent-hover:#2563eb;--accent-light:#dbeafe;
      --success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;
      --danger:#ef4444;--purple:#8b5cf6;--purple-light:#ede9fe;
      --text:#0f172a;--text-secondary:#64748b;--text-muted:#94a3b8;
      --border:#e2e8f0;--border-light:#f1f5f9;--bg:#f8fafc;--bg-card:#fff;--bg-sidebar:#0f172a;
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1);--radius-sm:6px;--radius:8px;--radius-md:12px;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:var(--bg-sidebar);color:white;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s;}
    .sidebar-header{padding:24px;border-bottom:1px solid rgba(255,255,255,.1);}
    .logo{display:flex;align-items:center;gap:12px;font-size:1.25rem;font-weight:700;text-decoration:none;color:white;}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#60a5fa);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px;overflow-y:auto;}
    .nav-section{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:rgba(255,255,255,.4);padding:16px 12px 8px;}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--radius);color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;font-weight:500;transition:all .15s;}
    .nav-item:hover{background:rgba(255,255,255,.05);color:white;}
    .nav-item.active{background:var(--accent);color:white;}
    .nav-item i{width:20px;text-align:center;}
    .sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.1);}
    .user-info{display:flex;align-items:center;gap:12px;}
    .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--success),#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem;color:white;flex-shrink:0;}
    .user-name{font-size:.9rem;font-weight:600;}.user-role{font-size:.75rem;color:rgba(255,255,255,.5);}
    .main{flex:1;margin-left:260px;min-height:100vh;}
    .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;}
    .top-left{display:flex;align-items:center;gap:16px;}
    .mobile-menu-btn{display:none;background:none;border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;cursor:pointer;}
    .page-title-bar h1{font-size:1.25rem;font-weight:700;}
    .page-title-bar p{font-size:.8rem;color:var(--text-secondary);}
    .top-actions{display:flex;gap:10px;}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;font-size:.875rem;font-weight:600;border-radius:var(--radius);border:none;cursor:pointer;transition:all .15s;text-decoration:none;font-family:'Inter',sans-serif;}
    .btn-primary{background:var(--accent);color:white;}.btn-primary:hover{background:var(--accent-hover);}
    .btn-secondary{background:var(--bg-card);color:var(--text);border:1px solid var(--border);}.btn-secondary:hover{background:var(--border-light);}
    .content{padding:32px;}
    /* KPI row */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:28px;}
    .kpi{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;}
    .kpi-label{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:8px;}
    .kpi-val{font-size:1.6rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
    .kpi-sub{font-size:.75rem;color:var(--text-secondary);margin-top:4px;}
    .kpi-sub.green{color:var(--success);}
    /* Chart grid */
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px;}
    .chart-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:28px;}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);}
    .card-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:center;}
    .card-title{font-size:.95rem;font-weight:700;}
    .card-sub{font-size:.78rem;color:var(--text-secondary);margin-top:2px;}
    .card-body{padding:20px 24px 24px;}
    /* Table */
    .table-scroll{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;}
    thead{background:var(--border-light);}
    th{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);padding:10px 14px;text-align:left;white-space:nowrap;}
    td{padding:12px 14px;border-bottom:1px solid var(--border-light);font-size:.875rem;vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(59,130,246,.02);}
    .money{font-family:'JetBrains Mono',monospace;font-weight:600;}
    .irr{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--success);}
    .badge{display:inline-flex;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;}
    .badge-op{background:var(--success-light);color:var(--success);}
    .badge-dd{background:var(--accent-light);color:var(--accent);}
    .badge-loi{background:var(--warning-light);color:var(--warning);}
    .badge-src{background:var(--border-light);color:var(--text-secondary);}
    .badge-cl{background:var(--purple-light);color:var(--purple);}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}
    .sidebar-overlay.visible{display:block;}
    @media(max-width:1200px){.kpi-row{grid-template-columns:repeat(3,1fr);}.chart-grid-3{grid-template-columns:1fr 1fr;}}
    @media(max-width:900px){.chart-grid{grid-template-columns:1fr;}.chart-grid-3{grid-template-columns:1fr;}}
    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);}
      .sidebar.open{transform:translateX(0);}
      .main{margin-left:0!important;}
      .mobile-menu-btn{display:flex!important;}
      .top-bar,.content{padding:12px 16px;}
      .kpi-row{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">◆</div><span>deeltrack</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item active"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name" id="gpName">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <div class="page-title-bar"><h1>Reports & Analytics</h1><p>Portfolio performance at a glance</p></div>
      </div>
      <div class="top-actions">
        <button class="btn btn-secondary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        <button class="btn btn-primary" onclick="exportCSV()"><i class="fas fa-download"></i> Export CSV</button>
      </div>
    </header>

    <div class="content">
      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi"><div class="kpi-label">Total AUM</div><div class="kpi-val" id="kpiAUM">—</div><div class="kpi-sub green" id="kpiAUMSub"></div></div>
        <div class="kpi"><div class="kpi-label">Total Investors</div><div class="kpi-val" id="kpiInv">—</div><div class="kpi-sub" id="kpiInvSub"></div></div>
        <div class="kpi"><div class="kpi-label">Avg Portfolio IRR</div><div class="kpi-val" id="kpiIRR">—</div><div class="kpi-sub green">Projected</div></div>
        <div class="kpi"><div class="kpi-label">Distributions Paid</div><div class="kpi-val" id="kpiDist">—</div><div class="kpi-sub" id="kpiDistSub"></div></div>
        <div class="kpi"><div class="kpi-label">Capital Deployed</div><div class="kpi-val" id="kpiDeployed">—</div><div class="kpi-sub" id="kpiDeployedSub"></div></div>
      </div>

      <!-- Charts row 1: IRR by deal + Portfolio mix -->
      <div class="chart-grid">
        <div class="card">
          <div class="card-header"><div><div class="card-title">IRR by Deal</div><div class="card-sub">Projected returns across portfolio</div></div></div>
          <div class="card-body"><div style="height:260px;position:relative;"><canvas id="irrChart"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div><div class="card-title">Portfolio Mix</div><div class="card-sub">Capital by property type</div></div></div>
          <div class="card-body">
            <div style="height:200px;position:relative;"><canvas id="mixChart"></canvas></div>
            <div id="mixLegend" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;"></div>
          </div>
        </div>
      </div>

      <!-- Charts row 2: Capital raise + Investor capital -->
      <div class="chart-grid">
        <div class="card">
          <div class="card-header"><div><div class="card-title">Capital Raise by Deal</div><div class="card-sub">Target vs. committed</div></div></div>
          <div class="card-body"><div style="height:260px;position:relative;"><canvas id="raiseChart"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div><div class="card-title">Investor Capital</div><div class="card-sub">Top investors by committed amount</div></div></div>
          <div class="card-body"><div style="height:260px;position:relative;"><canvas id="investorChart"></canvas></div></div>
        </div>
      </div>

      <!-- Deal table -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><div class="card-title">Deal Performance Summary</div></div>
        <div class="card-body" style="padding-top:12px;">
          <div class="table-scroll">
            <table>
              <thead><tr><th>Deal</th><th>Type</th><th>Status</th><th>Raise Target</th><th>Committed</th><th>% Raised</th><th>Investors</th><th>IRR</th><th>Equity Mult</th></tr></thead>
              <tbody id="dealTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- GP Performance Summary -->
      <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,#0f172a,#1e293b);border:none;">
        <div class="card-header" style="border-color:rgba(255,255,255,.1);">
          <div><div class="card-title" style="color:white;">My Performance Summary</div><div class="card-sub" style="color:rgba(255,255,255,.5);">Overall portfolio health</div></div>
        </div>
        <div class="card-body" id="gpPerfBody" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;"></div>
      </div>

      <!-- LTV Sensitivity Section -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header">
          <div>
            <div class="card-title">LTV Sensitivity Analysis</div>
            <div class="card-sub">IRR impact at different leverage levels</div>
          </div>
          <select id="ltvDealSelect" onchange="buildLTVChart()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:.85rem;outline:none;">
            <option value="">— Select deal —</option>
          </select>
        </div>
        <div class="card-body">
          <div style="height:240px;position:relative;"><canvas id="ltvChart"></canvas></div>
          <div id="ltvRiskMatrix" style="margin-top:20px;display:grid;grid-template-columns:repeat(5,1fr);gap:10px;"></div>
        </div>
      </div>

      <!-- Cap Rate Risk Matrix -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header">
          <div>
            <div class="card-title">Cap Rate Risk Matrix</div>
            <div class="card-sub">Entry vs exit cap rate scenario analysis</div>
          </div>
          <select id="capRateDealSelect" onchange="buildCapRateMatrix()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:.85rem;outline:none;">
            <option value="">— Select deal —</option>
          </select>
        </div>
        <div class="card-body">
          <div id="capRateMatrix"></div>
        </div>
      </div>

      <!-- Investor table -->
      <div class="card">
        <div class="card-header"><div class="card-title">Investor Summary</div></div>
        <div class="card-body" style="padding-top:12px;">
          <div class="table-scroll">
            <table>
              <thead><tr><th>Investor</th><th>Total Committed</th><th># Deals</th><th>Accreditation</th><th>Status</th></tr></thead>
              <tbody id="investorTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
SP.requireGP();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('visible');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('visible');}
const session=SP.getSession();
if(session?.name){document.getElementById('gpName').textContent=session.name;}

function fmt$(n){if(!n)return'$0';if(n>=1e9)return'$'+(n/1e9).toFixed(1)+'B';if(n>=1e6)return'$'+(n/1e6).toFixed(1)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(0)+'K';return'$'+n;}
function fmtFull$(n){return'$'+Number(n||0).toLocaleString();}

const COLORS=['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ef4444','#06b6d4','#ec4899','#84cc16'];
const STATUS_BADGE={operating:'badge-op',closed:'badge-cl',dd:'badge-dd',loi:'badge-loi',sourcing:'badge-src'};
const STATUS_LABEL={operating:'Operating',closed:'Closed',dd:'Due Diligence',loi:'LOI',sourcing:'Sourcing'};


function _syncFromFirebase(cb) {
  if (typeof SPFB === 'undefined' || !SPFB.isReady() || SPFB.isOffline()) { cb(); return; }
  Promise.all([SPFB.getDeals().catch(()=>[]), SPFB.getInvestors().catch(()=>[])]).then(([d,i]) => {
    if (d.length) SP.saveDeals(d);
    if (i.length) SP.saveInvestors(i);
    cb();
  }).catch(() => cb());
}

function _syncFromFirebase(cb) {
  if (typeof SPFB === 'undefined' || !SPFB.isReady() || SPFB.isOffline()) { cb && cb(); return; }
  Promise.all([SPFB.getDeals().catch(()=>[]), SPFB.getInvestors().catch(()=>[])]).then(([d,i]) => {
    if (d.length) SP.saveDeals(d);
    if (i.length) SP.saveInvestors(i);
    cb && cb();
  }).catch(() => { cb && cb(); });
}
function init(){ _syncFromFirebase(_runInit); } function _runInit(){
  const deals=SP.getDeals();
  const investors=SP.getInvestors();
  const dists=SP.getDistributions();

  // KPIs
  const aum=deals.reduce((s,d)=>s+(d.raise||0),0);
  const committed=deals.reduce((s,d)=>s+(d.investors||[]).reduce((ss,i)=>ss+(i.committed||0),0),0);
  const avgIRR=deals.length?(deals.reduce((s,d)=>s+(d.irr||0),0)/deals.length).toFixed(1):'0';
  const totalDist=dists.reduce((s,d)=>s+(d.totalAmount||0),0);
  const accPct=investors.length?Math.round(investors.filter(i=>i.accredStatus==='verified').length/investors.length*100):0;

  document.getElementById('kpiAUM').textContent=fmt$(aum);
  document.getElementById('kpiAUMSub').textContent=deals.length+' deals';
  document.getElementById('kpiInv').textContent=investors.length;
  document.getElementById('kpiInvSub').textContent=accPct+'% accredited';
  document.getElementById('kpiIRR').textContent=avgIRR+'%';
  document.getElementById('kpiDist').textContent=fmt$(totalDist);
  document.getElementById('kpiDistSub').textContent=dists.length+' distributions';
  document.getElementById('kpiDeployed').textContent=fmt$(committed);
  const pct=aum>0?(committed/aum*100).toFixed(0):0;
  document.getElementById('kpiDeployedSub').textContent=pct+'% of target raised';

  buildIRRChart(deals);
  buildMixChart(deals);
  buildRaiseChart(deals);
  buildInvestorChart(investors,deals);
  buildDealTable(deals);
  buildInvestorTable(investors,deals);
  populateDealSelects(deals);
  buildGPPerformance(deals, investors);
}

function buildIRRChart(deals){
  const filtered=deals.filter(d=>d.irr).sort((a,b)=>b.irr-a.irr);
  new Chart(document.getElementById('irrChart').getContext('2d'),{
    type:'bar',
    data:{labels:filtered.map(d=>d.name.length>14?d.name.substring(0,12)+'…':d.name),
      datasets:[{label:'IRR %',data:filtered.map(d=>d.irr),
        backgroundColor:filtered.map(d=>d.irr>=20?'#10b981':d.irr>=15?'#3b82f6':'#f59e0b'),
        borderRadius:6,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.parsed.y.toFixed(1)}% IRR`}}},
      scales:{y:{beginAtZero:true,max:Math.max(30,...filtered.map(d=>d.irr))+5,
        ticks:{callback:v=>v+'%',color:'#94a3b8',font:{size:11}},grid:{color:'#f1f5f9'}},
        x:{grid:{display:false},ticks:{color:'#64748b',font:{size:11}}}}}});
}

function buildMixChart(deals){
  const types={multifamily:0,industrial:0,retail:0,office:0,other:0};
  deals.forEach(d=>{const k=types.hasOwnProperty(d.type)?d.type:'other';types[k]+=(d.raise||0);});
  const labels=['Multifamily','Industrial','Retail','Office','Other'];
  const keys=['multifamily','industrial','retail','office','other'];
  const data=keys.map(k=>types[k]);
  const total=data.reduce((a,b)=>a+b,0);
  new Chart(document.getElementById('mixChart').getContext('2d'),{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:COLORS.slice(0,5),borderWidth:2,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'68%',
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt$(c.parsed)}`}}}}});
  const leg=document.getElementById('mixLegend');
  leg.innerHTML=keys.map((k,i)=>types[k]>0?`<div style="display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--text-secondary);"><div style="width:10px;height:10px;border-radius:50%;background:${COLORS[i]};flex-shrink:0;"></div>${labels[i]}: ${fmt$(types[k])}</div>`:'').join('');
}

function buildRaiseChart(deals){
  const d=deals.slice(0,8);
  const committed=d.map(deal=>(deal.investors||[]).reduce((s,i)=>s+(i.committed||0),0));
  new Chart(document.getElementById('raiseChart').getContext('2d'),{
    type:'bar',
    data:{labels:d.map(x=>x.name.length>12?x.name.substring(0,10)+'…':x.name),
      datasets:[
        {label:'Target Raise',data:d.map(x=>x.raise||0),backgroundColor:'#dbeafe',borderRadius:4,borderSkipped:false},
        {label:'Committed',data:committed,backgroundColor:'#3b82f6',borderRadius:4,borderSkipped:false}
      ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:12}}},
      scales:{y:{beginAtZero:true,ticks:{callback:v=>fmt$(v),color:'#94a3b8',font:{size:10}},grid:{color:'#f1f5f9'}},
        x:{grid:{display:false},ticks:{color:'#64748b',font:{size:10}}}}}});
}

function buildInvestorChart(investors,deals){
  // Calculate each investor's total committed across all deals
  const totals=investors.map(inv=>{
    const total=deals.reduce((s,d)=>{
      const entry=(d.investors||[]).find(i=>i.investorId===inv.id);
      return s+(entry?.committed||0);
    },0);
    return{name:`${inv.firstName} ${inv.lastName}`,total};
  }).filter(x=>x.total>0).sort((a,b)=>b.total-a.total).slice(0,8);

  if(!totals.length){
    document.getElementById('investorChart').parentElement.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted);font-size:.875rem;"><i class="fas fa-users" style="font-size:2rem;opacity:.3;display:block;margin-bottom:8px;"></i>Link investors to deals to see this chart</div>';
    return;
  }
  new Chart(document.getElementById('investorChart').getContext('2d'),{
    type:'bar',
    data:{labels:totals.map(x=>x.name.split(' ')[0]+' '+x.name.split(' ').pop()),
      datasets:[{label:'Committed',data:totals.map(x=>x.total),
        backgroundColor:COLORS,borderRadius:6,borderSkipped:false}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fmtFull$(c.parsed.x)}`}}},
      scales:{x:{beginAtZero:true,ticks:{callback:v=>fmt$(v),color:'#94a3b8',font:{size:10}},grid:{color:'#f1f5f9'}},
        y:{grid:{display:false},ticks:{color:'#64748b',font:{size:11}}}}}});
}

function buildDealTable(deals){
  const tbody=document.getElementById('dealTableBody');
  if(!deals.length){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text-muted);">No deals yet</td></tr>';return;}
  tbody.innerHTML=deals.map(d=>{
    const committed=(d.investors||[]).reduce((s,i)=>s+(i.committed||0),0);
    const pct=d.raise>0?((committed/d.raise)*100).toFixed(0):0;
    return`<tr style="cursor:pointer;" onclick="openDealDrilldown('${d.id}')" title="Click for deal analytics">
      <td style="font-weight:600;">${d.name}<div style="font-size:.75rem;color:var(--text-muted);">${d.location||'—'}</div></td>
      <td style="text-transform:capitalize;">${d.type||'—'}</td>
      <td><span class="badge ${STATUS_BADGE[d.status]||'badge-src'}">${STATUS_LABEL[d.status]||d.status}</span></td>
      <td class="money">${fmtFull$(d.raise||0)}</td>
      <td class="money">${fmtFull$(committed)}</td>
      <td><div style="display:flex;align-items:center;gap:8px;"><div style="flex:1;height:6px;background:var(--border-light);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${Math.min(100,pct)}%;background:var(--accent);border-radius:4px;"></div></div><span style="font-size:.75rem;font-family:'JetBrains Mono',monospace;">${pct}%</span></div></td>
      <td style="text-align:center;font-weight:600;">${(d.investors||[]).length}</td>
      <td class="irr">${d.irr?d.irr.toFixed(1)+'%':'—'}</td>
      <td style="font-family:'JetBrains Mono',monospace;color:var(--purple);">${d.equity?d.equity.toFixed(2)+'x':'—'} <span style="font-size:.7rem;color:var(--accent);margin-left:4px;">→</span></td>
    </tr>`;
  }).join('');
}

function buildInvestorTable(investors,deals){
  const tbody=document.getElementById('investorTableBody');
  if(!investors.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted);">No investors yet</td></tr>';return;}
  const rows=investors.map(inv=>{
    const linked=deals.filter(d=>(d.investors||[]).some(i=>i.investorId===inv.id));
    const total=linked.reduce((s,d)=>{const e=(d.investors||[]).find(i=>i.investorId===inv.id);return s+(e?.committed||0);},0);
    return{inv,linked,total};
  }).sort((a,b)=>b.total-a.total);
  tbody.innerHTML=rows.map(({inv,linked,total})=>`<tr>
    <td><div style="font-weight:600;">${inv.firstName} ${inv.lastName}</div><div style="font-size:.75rem;color:var(--text-muted);">${inv.email}</div></td>
    <td class="money">${fmtFull$(total)}</td>
    <td style="text-align:center;font-weight:600;">${linked.length}</td>
    <td>${inv.accredStatus==='verified'?'<span class="badge" style="background:var(--success-light);color:var(--success);"><i class="fas fa-check-circle"></i> Verified</span>':inv.accredStatus==='pending'?'<span class="badge" style="background:var(--warning-light);color:var(--warning);">Pending</span>':'<span class="badge" style="background:var(--danger-light);color:var(--danger);">Expired</span>'}</td>
    <td><span class="badge ${inv.status==='active'?'badge-op':'badge-src'}">${inv.status||'active'}</span></td>
  </tr>`).join('');
}

function exportCSV(){
  const deals=SP.getDeals();
  const headers=['Deal Name','Type','Status','Raise Target','IRR','Equity Multiple','Investors'];
  const rows=deals.map(d=>[d.name,d.type,d.status,d.raise||0,d.irr||0,d.equity||0,(d.investors||[]).length]);
  const csv=[headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='deeltrack-report.csv';
  a.click();
}

// ── GP Performance ────────────────────────────────────────────────────────────
function buildGPPerformance(deals, investors) {
  const el = document.getElementById('gpPerfBody');
  if (!el) return;
  const closed = deals.filter(d=>d.status==='closed');
  const active = deals.filter(d=>['operating','dd','loi','sourcing'].includes(d.status));
  const avgIRR = closed.length ? (closed.reduce((s,d)=>s+(d.irr||0),0)/closed.length).toFixed(1) : '—';
  const targetAvg = deals.length ? (deals.reduce((s,d)=>s+(d.irr||0),0)/deals.length).toFixed(1) : '—';
  const totalDist = SP.getDistributions().reduce((s,d)=>s+(d.totalAmount||0),0);
  const totalAUM = deals.reduce((s,d)=>s+(d.raise||0),0);
  const committed = deals.reduce((s,d)=>s+(d.investors||[]).reduce((ss,i)=>ss+(i.committed||0),ss),0);

  const kpi = (label, value, sub, color) => `
    <div style="background:rgba(255,255,255,.07);border-radius:10px;padding:16px;">
      <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:rgba(255,255,255,.4);margin-bottom:8px;">${label}</div>
      <div style="font-size:1.3rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:${color};">${value}</div>
      <div style="font-size:.72rem;color:rgba(255,255,255,.4);margin-top:4px;">${sub}</div>
    </div>`;

  el.innerHTML =
    kpi('Total AUM', fmt$(totalAUM), deals.length+' deals', 'white') +
    kpi('Capital Committed', fmt$(committed), Math.round(committed/Math.max(totalAUM,1)*100)+'% of target', '#60a5fa') +
    kpi('Avg Target IRR', targetAvg+'%', closed.length+' deals closed', '#34d399') +
    kpi('Total Distributions', fmt$(totalDist), 'Paid to LPs', '#fbbf24') +
    kpi('Active Investors', investors.filter(i=>i.status==='active').length, investors.filter(i=>i.accredStatus==='verified').length+' accredited', '#a78bfa');
}

// ── LTV Sensitivity Chart ─────────────────────────────────────────────────────
let ltvChartInst = null;
function populateDealSelects(deals) {
  ['ltvDealSelect','capRateDealSelect'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    deals.forEach(d => { const o = new Option(d.name, d.id); sel.appendChild(o); });
  });
}

function buildLTVChart() {
  const dealId = document.getElementById('ltvDealSelect').value;
  if (!dealId) return;
  const deal = SP.getDealById(dealId);
  if (!deal) return;
  const baseIRR = deal.irr || 15;
  const baseEquity = deal.raise || 2000000;
  const purchasePrice = deal.purchasePrice || baseEquity * 5;
  const ltvLevels = [0.55, 0.60, 0.65, 0.70, 0.75, 0.80];

  // IRR improves with leverage (simplified model)
  const irrs = ltvLevels.map(ltv => {
    const debt = purchasePrice * ltv;
    const equity = purchasePrice - debt;
    const leverageFactor = baseEquity / equity;
    return Math.min(35, parseFloat((baseIRR * Math.sqrt(leverageFactor)).toFixed(1)));
  });
  const equityMults = ltvLevels.map(ltv => {
    const debt = purchasePrice * ltv;
    const equity = purchasePrice - debt;
    const em = deal.equity || 1.8;
    return parseFloat((em * (baseEquity / equity) * 0.85).toFixed(2));
  });

  // Risk matrix cards
  const matrix = document.getElementById('ltvRiskMatrix');
  matrix.innerHTML = ltvLevels.map((ltv, i) => {
    const risk = ltv <= 0.60 ? { label:'Conservative', color:'var(--success)', bg:'var(--success-light)' }
               : ltv <= 0.70 ? { label:'Moderate', color:'var(--warning)', bg:'var(--warning-light)' }
               : { label:'Aggressive', color:'var(--danger)', bg:'var(--danger-light)' };
    return `<div style="background:${risk.bg};border-radius:var(--radius);padding:14px;text-align:center;">
      <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;color:${risk.color};margin-bottom:6px;">${Math.round(ltv*100)}% LTV</div>
      <div style="font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono',monospace;">${irrs[i]}%</div>
      <div style="font-size:.7rem;color:${risk.color};">${equityMults[i]}x EM</div>
      <div style="font-size:.68rem;margin-top:4px;font-weight:600;color:${risk.color};">${risk.label}</div>
    </div>`;
  }).join('');

  // Chart
  if (ltvChartInst) ltvChartInst.destroy();
  const ctx = document.getElementById('ltvChart').getContext('2d');
  ltvChartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ltvLevels.map(l => Math.round(l*100) + '%'),
      datasets: [
        { label:'Projected IRR', data: irrs, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', tension:0.4, fill:true, pointBackgroundColor:'#3b82f6', pointRadius:5 },
        { label:'Equity Multiple', data: equityMults, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.05)', tension:0.4, fill:false, pointBackgroundColor:'#10b981', pointRadius:5, yAxisID:'y1' },
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:'top', labels:{ font:{ size:11 }, boxWidth:12 } } },
      scales:{
        y:{ beginAtZero:true, ticks:{ callback:v=>v+'%', color:'#94a3b8', font:{size:11} }, grid:{ color:'#f1f5f9' }, title:{ display:true, text:'IRR', color:'#3b82f6' } },
        y1:{ position:'right', beginAtZero:true, ticks:{ callback:v=>v+'x', color:'#10b981', font:{size:11} }, grid:{ drawOnChartArea:false } },
        x:{ grid:{ display:false }, ticks:{ color:'#64748b', font:{size:11} } }
      }
    }
  });
}

// ── Cap Rate Risk Matrix ───────────────────────────────────────────────────────
function buildCapRateMatrix() {
  const dealId = document.getElementById('capRateDealSelect').value;
  if (!dealId) return;
  const deal = SP.getDealById(dealId);
  if (!deal) return;
  const baseIRR = deal.irr || 15;
  const entryCaps = [4.0, 4.5, 5.0, 5.5, 6.0];
  const exitCaps  = [4.0, 4.5, 5.0, 5.5, 6.0];
  const container = document.getElementById('capRateMatrix');

  // Color scale: green = high IRR, red = low
  function cellColor(irr) {
    if (irr >= baseIRR + 3) return { bg:'#d1fae5', text:'#065f46' };
    if (irr >= baseIRR)     return { bg:'#dbeafe', text:'#1e40af' };
    if (irr >= baseIRR - 3) return { bg:'#fef3c7', text:'#92400e' };
    return { bg:'#fee2e2', text:'#991b1b' };
  }

  let html = `<div style="margin-bottom:10px;font-size:.82rem;color:var(--text-secondary);">
    <strong>How to read:</strong> Rows = Entry cap rate. Columns = Exit cap rate. 
    Higher entry + lower exit = cap compression (value creation). Green = target IRR met.
  </div>
  <div style="overflow-x:auto;">
  <table style="border-collapse:collapse;width:100%;font-size:.8rem;">
    <thead><tr>
      <th style="padding:8px 12px;background:var(--border-light);border:1px solid var(--border);">Entry ↓ / Exit →</th>
      ${exitCaps.map(e=>`<th style="padding:8px 12px;background:var(--border-light);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;">${e.toFixed(1)}% exit</th>`).join('')}
    </tr></thead>
    <tbody>`;

  entryCaps.forEach(entry => {
    html += `<tr>
      <td style="padding:8px 12px;background:var(--border-light);border:1px solid var(--border);font-weight:700;font-family:'JetBrains Mono',monospace;">${entry.toFixed(1)}% entry</td>`;
    exitCaps.forEach(exit => {
      // Cap compression = exit < entry = value creation
      const spread = entry - exit;
      const irr = parseFloat((baseIRR + spread * 4).toFixed(1));
      const { bg, text } = cellColor(irr);
      const isDiag = entry === exit;
      html += `<td style="padding:10px 12px;border:1px solid var(--border);background:${bg};color:${text};text-align:center;font-weight:600;font-family:'JetBrains Mono',monospace;${isDiag?'border:2px solid #94a3b8;':''}">${irr}%</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

// ── Deal Drilldown Modal ──────────────────────────────────────────────────────
function openDealDrilldown(dealId) {
  const deal = SP.getDealById(dealId);
  if (!deal) return;
  const dists = SP.getDistributions().filter(d=>d.dealId===dealId);
  const committed = (deal.investors||[]).reduce((s,i)=>s+(i.committed||0),0);
  const pct = deal.raise>0?Math.round(committed/deal.raise*100):0;
  const totalDist = dists.reduce((s,d)=>s+(d.totalAmount||0),0);

  // IRR sensitivity table: ±1% cap rate, ±5% rent
  const baseIRR = deal.irr || 0;
  const sensitivityRows = [-2,-1,0,1,2].map(delta => {
    const irr = Math.max(0, baseIRR + delta * 1.5).toFixed(1);
    const em = Math.max(1, (deal.equity||1.8) + delta * 0.1).toFixed(2);
    return `<tr style="background:${delta===0?'var(--accent-light)':''};">
      <td style="padding:8px 12px;font-size:.82rem;">${delta>0?'+':''}${delta}% cap rate</td>
      <td style="padding:8px 12px;font-family:'JetBrains Mono',monospace;font-weight:600;color:${irr>baseIRR?'var(--success)':irr<baseIRR?'var(--danger)':'var(--accent)'};">${irr}%</td>
      <td style="padding:8px 12px;font-family:'JetBrains Mono',monospace;color:var(--purple);">${em}x</td>
    </tr>`;
  }).join('');

  // Create modal
  let modal = document.getElementById('dealDrilldownModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'dealDrilldownModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;';
    modal.onclick = e => { if(e.target===modal) modal.remove(); };
    document.body.appendChild(modal);
  }
  modal.innerHTML = `
    <div style="background:white;border-radius:12px;width:100%;max-width:680px;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.25);">
      <div style="background:linear-gradient(135deg,#0f172a,#1e293b);color:white;padding:24px 28px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:4px;">${deal.name}</h2>
          <div style="color:rgba(255,255,255,.6);font-size:.875rem;"><i class="fas fa-map-marker-alt" style="margin-right:4px;"></i>${deal.location||'—'}</div>
        </div>
        <button onclick="document.getElementById('dealDrilldownModal').remove()" style="background:rgba(255,255,255,.1);border:none;color:white;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:.85rem;">✕ Close</button>
      </div>
      <div style="padding:24px 28px;">
        <!-- KPIs -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
          ${[['Target Raise',fmtFull$(deal.raise||0),'#dbeafe','#3b82f6'],
             ['Committed',fmtFull$(committed),'#d1fae5','#10b981'],
             ['Target IRR',baseIRR?baseIRR.toFixed(1)+'%':'—','#ede9fe','#8b5cf6'],
             ['Total Dist.',fmtFull$(totalDist),'#fef3c7','#f59e0b']].map(([l,v,bg,c])=>
            `<div style="background:${bg};border-radius:8px;padding:14px;"><div style="font-size:.7rem;font-weight:600;color:${c};text-transform:uppercase;letter-spacing:.05em;">${l}</div><div style="font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:#0f172a;margin-top:4px;">${v}</div></div>`).join('')}
        </div>

        <!-- Capital raise progress -->
        <div style="margin-bottom:24px;">
          <div style="display:flex;justify-content:space-between;font-size:.82rem;color:#64748b;margin-bottom:6px;"><span>Capital Raise Progress</span><span style="font-weight:600;">${pct}%</span></div>
          <div style="height:8px;background:#f1f5f9;border-radius:8px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:${pct>=75?'#10b981':pct>=40?'#3b82f6':'#f59e0b'};border-radius:8px;transition:width .6s;"></div></div>
          <div style="font-size:.75rem;color:#94a3b8;margin-top:4px;">${fmtFull$(committed)} of ${fmtFull$(deal.raise||0)} target</div>
        </div>

        <!-- Sensitivity table -->
        <div style="margin-bottom:24px;">
          <div style="font-size:.85rem;font-weight:700;margin-bottom:10px;"><i class="fas fa-sliders-h" style="color:#3b82f6;margin-right:6px;"></i>IRR Sensitivity Analysis</div>
          <table style="width:100%;border-collapse:collapse;font-family:'Inter',sans-serif;">
            <thead><tr style="background:#f1f5f9;">
              <th style="padding:8px 12px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#64748b;">Scenario</th>
              <th style="padding:8px 12px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#64748b;">IRR</th>
              <th style="padding:8px 12px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#64748b;">Equity Mult.</th>
            </tr></thead>
            <tbody>${sensitivityRows}</tbody>
          </table>
        </div>

        <!-- Investors -->
        <div style="margin-bottom:20px;">
          <div style="font-size:.85rem;font-weight:700;margin-bottom:10px;"><i class="fas fa-users" style="color:#10b981;margin-right:6px;"></i>Linked Investors (${(deal.investors||[]).length})</div>
          ${(deal.investors||[]).length ? (deal.investors||[]).map(entry=>{
            const inv=SP.getInvestorById(entry.investorId)||{firstName:'?',lastName:'',email:''};
            return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:.875rem;">
              <span style="font-weight:600;">${inv.firstName} ${inv.lastName}</span>
              <span style="font-family:'JetBrains Mono',monospace;color:#10b981;">${fmtFull$(entry.committed||0)} (${entry.ownership?entry.ownership.toFixed(2)+'%':'—'})</span>
            </div>`;
          }).join('') : '<div style="color:#94a3b8;font-size:.875rem;padding:12px 0;">No investors linked yet.</div>'}
        </div>

        <div style="display:flex;gap:10px;">
          <a href="deal-detail.html?id=${deal.id}" style="flex:1;padding:10px;background:#3b82f6;color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:.875rem;text-align:center;"><i class="fas fa-eye"></i> Full Deal Detail</a>
          <a href="new-deal.html?id=${deal.id}" style="flex:1;padding:10px;background:#f1f5f9;color:#0f172a;border-radius:8px;text-decoration:none;font-weight:600;font-size:.875rem;text-align:center;"><i class="fas fa-calculator"></i> Model Deal</a>
        </div>
      </div>
    </div>`;
  modal.style.display = 'flex';
}

init();
</script>
</body>
</html>
