<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Document Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --secondary: #334155;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #dbeafe;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --text: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    .app { display: flex; min-height: 100vh; }
    
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }
    
    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.25rem;
      font-weight: 700;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    
    .nav {
      flex: 1;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .nav-section {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.6);
      padding: 16px 12px 8px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius);
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.15s;
    }
    
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    
    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--success), #34d399);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .user-details { flex: 1; }
    .user-name { font-size: 0.9rem; font-weight: 600; }
    .user-role { font-size: 0.75rem; color: rgba(255,255,255,0.65); }
    
    .main { flex: 1; margin-left: 260px; min-height: 100vh; }
    
    .top-bar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .breadcrumb a { color: var(--text-secondary); text-decoration: none; }
    .breadcrumb a:hover { color: var(--accent); }
    .breadcrumb-separator { color: var(--text-muted); }
    .breadcrumb-current { color: var(--text); font-weight: 500; }
    
    .top-actions { display: flex; gap: 12px; align-items: center; }
    
    .btn-icon {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
    
    .content { padding: 32px; max-width: 1600px; }
    
    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 1.875rem; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .page-description { color: var(--text-secondary); font-size: 1rem; }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title { font-size: 1rem; font-weight: 600; color: var(--text); }
    .card-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px; }
    .card-body { padding: 24px; }
    
    .content-grid { display: grid; grid-template-columns: 360px 1fr; gap: 24px; }
    @media (max-width: 1200px) { .content-grid { grid-template-columns: 1fr; } }
    
    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    
    label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text); margin-bottom: 8px; }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--bg-card);
      color: var(--text);
      transition: all 0.15s;
    }
    
    input:hover, select:hover, textarea:hover { border-color: var(--text-muted); }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
    }
    
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border-light); border-color: var(--text-muted); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; }
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { background: var(--border-light); color: var(--text); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    
    .doc-type-list { display: flex; flex-direction: column; gap: 12px; }
    
    .doc-type {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .doc-type:hover { border-color: var(--accent); }
    .doc-type.selected { border-color: var(--accent); background: var(--accent-light); }
    
    .doc-type .icon {
      width: 44px;
      height: 44px;
      background: var(--border-light);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: var(--accent);
    }
    
    .doc-type.selected .icon { background: var(--accent); color: white; }
    .doc-type .info { flex: 1; }
    .doc-type .name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
    .doc-type .desc { font-size: 0.8rem; color: var(--text-secondary); }
    
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
    .tab {
      padding: 12px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .variable-tag {
      display: inline-flex;
      align-items: center;
      background: var(--accent-light);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .preview-panel {
      background: white;
      color: #1a1a1a;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Times New Roman', serif;
      line-height: 1.6;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .preview-panel h1 { font-size: 1.5rem; text-align: center; margin-bottom: 24px; font-weight: 700; }
    .preview-panel h2 { font-size: 1.1rem; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid #ccc; padding-bottom: 8px; font-weight: 600; }
    .preview-panel p { margin-bottom: 12px; text-align: justify; }
    .preview-panel table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .preview-panel td, .preview-panel th { padding: 8px 12px; border: 1px solid #ccc; }
    .preview-panel th { background: #f5f5f5; font-weight: 600; }
    
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: var(--text-secondary);
    }
    .empty-state .icon {
      width: 80px;
      height: 80px;
      background: var(--border-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 2rem;
      color: var(--text-muted);
    }
    
    .input-group { position: relative; }
    .input-prefix {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    .input-group input { padding-left: 32px; }
    
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .main { margin-left: 0; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">◆</div>
          <span>deeltrack</span>
        </div>
      </div>
      <nav class="nav">
        <div class="nav-section">Main</div>
        <a href="index.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
        <a href="documents.html" class="nav-item active"><i class="fas fa-file-contract"></i><span>Documents</span></a>
        <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="inbox.html" class="nav-item"><i class="fas fa-inbox"></i><span>Inbox</span></a>
        <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
        
        <div class="nav-section">Tools</div>
        <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
        <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
        <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
        <a href="pipeline.html" class="nav-item"><i class="fas fa-layer-group"></i><span>Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">GP</div>
          <div class="user-details">
            <div class="user-name">General Partner</div>
            <div class="user-role">Administrator</div>
          </div>
        </div>
      </div>
    </aside>
    
    <main class="main">
      <header class="top-bar">
        <div class="breadcrumb">
          <a href="index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Document Generator</span>
        </div>
        <div class="top-actions">
          <button class="btn-icon" title="Help"><i class="fas fa-question-circle"></i></button>
          <button class="btn-icon" title="Notifications"><i class="fas fa-bell"></i></button>
        </div>
      </header>
      
      <div class="content">
        <div class="page-header">
          <h1 class="page-title">Document Generator</h1>
          <p class="page-description">Generate syndication documents from your deal terms</p>
        </div>
        
        <div class="content-grid">
          <div class="left-panel">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-header">
                <div>
                  <h2 class="card-title">Document Type</h2>
                  <p class="card-subtitle">Select template to generate</p>
                </div>
              </div>
              <div class="card-body">
                <div class="doc-type-list">
                  <div class="doc-type selected" data-type="operating-agreement">
                    <div class="icon"><i class="fas fa-balance-scale"></i></div>
                    <div class="info">
                      <div class="name">Operating Agreement</div>
                      <div class="desc">LLC structure with waterfall</div>
                    </div>
                  </div>
                  <div class="doc-type" data-type="lp-agreement">
                    <div class="icon"><i class="fas fa-handshake"></i></div>
                    <div class="info">
                      <div class="name">LP Agreement</div>
                      <div class="desc">Limited Partnership terms</div>
                    </div>
                  </div>
                  <div class="doc-type" data-type="ppm">
                    <div class="icon"><i class="fas fa-file-alt"></i></div>
                    <div class="info">
                      <div class="name">PPM</div>
                      <div class="desc">Private Placement Memorandum</div>
                    </div>
                  </div>
                  <div class="doc-type" data-type="subscription">
                    <div class="icon"><i class="fas fa-pen-fancy"></i></div>
                    <div class="info">
                      <div class="name">Subscription</div>
                      <div class="desc">Investor subscription docs</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div>
                  <h2 class="card-title">Import Deal</h2>
                  <p class="card-subtitle">Auto-populate from saved deals</p>
                </div>
              </div>
              <div class="card-body">
                <div class="form-group" style="margin-bottom: 16px;">
                  <select id="dealSelect" style="width: 100%;">
                    <option value="">Select a deal...</option>
                  </select>
                </div>
                <button class="btn btn-secondary" onclick="importDealData()" style="width: 100%;">
                  <i class="fas fa-download"></i> Import Deal Variables
                </button>
              </div>
            </div>
          </div>
          
          <div class="right-panel">
            <div class="card">
              <div class="card-header">
                <div>
                  <h2 class="card-title">Document Details</h2>
                  <p class="card-subtitle">Fill in the variables</p>
                </div>
              </div>
              <div class="card-body">
                <div class="tabs">
                  <div class="tab active" data-tab="entity">Entity</div>
                  <div class="tab" data-tab="terms">Terms</div>
                  <div class="tab" data-tab="parties">Parties</div>
                  <div class="tab" data-tab="preview">Preview</div>
                </div>
                
                <div class="tab-content active" id="tab-entity">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Company Name <span class="variable-tag">{{COMPANY_NAME}}</span></label>
                      <input type="text" id="companyName" placeholder="ABC Capital, LLC">
                    </div>
                    <div class="form-group">
                      <label>State <span class="variable-tag">{{STATE}}</span></label>
                      <select id="state">
                        <optgroup label="★ Full Clauses">
                          <option value="DE">Delaware ★</option>
                          <option value="TX">Texas ★</option>
                          <option value="CA">California ★</option>
                          <option value="NY">New York ★</option>
                          <option value="FL">Florida ★</option>
                          <option value="NV">Nevada ★</option>
                          <option value="WY">Wyoming ★</option>
                        </optgroup>
                        <optgroup label="Standard Clauses">
                          <option value="AZ">Arizona</option>
                          <option value="CO">Colorado</option>
                          <option value="GA">Georgia</option>
                          <option value="IL">Illinois</option>
                          <option value="MD">Maryland</option>
                          <option value="MN">Minnesota</option>
                          <option value="NC">North Carolina</option>
                          <option value="OH">Ohio</option>
                          <option value="OR">Oregon</option>
                          <option value="PA">Pennsylvania</option>
                          <option value="SC">South Carolina</option>
                          <option value="TN">Tennessee</option>
                          <option value="UT">Utah</option>
                          <option value="VA">Virginia</option>
                          <option value="WA">Washington</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Principal Address <span class="variable-tag">{{ADDRESS}}</span></label>
                    <input type="text" id="address" placeholder="123 Main St, City, State 12345">
                  </div>
                  <div class="form-group">
                    <label>Property Address <span class="variable-tag">{{PROPERTY_ADDRESS}}</span></label>
                    <input type="text" id="propertyAddress" placeholder="456 Oak Avenue, Austin, TX 78701">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Property Type</label>
                      <select id="propertyType">
                        <option value="multifamily">Multifamily</option>
                        <option value="office">Office</option>
                        <option value="retail">Retail</option>
                        <option value="industrial">Industrial</option>
                        <option value="self-storage">Self-Storage</option>
                        <option value="hotel">Hotel</option>
                        <option value="mixed-use">Mixed-Use</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Number of Units</label>
                      <input type="number" id="units" placeholder="100">
                    </div>
                  </div>
                </div>
                
                <div class="tab-content" id="tab-terms">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Total Equity <span class="variable-tag">{{TOTAL_EQUITY}}</span></label>
                      <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="number" id="totalEquity" placeholder="5000000">
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Minimum Investment</label>
                      <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="number" id="minInvestment" placeholder="50000">
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Preferred Return <span class="variable-tag">{{PREF_RETURN}}</span></label>
                      <div class="input-group">
                        <input type="number" id="prefReturn" placeholder="8" step="0.5">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>GP Promote <span class="variable-tag">{{GP_PROMOTE}}</span></label>
                      <div class="input-group">
                        <input type="number" id="gpPromote" placeholder="30">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>GP Equity <span class="variable-tag">{{GP_EQUITY}}</span></label>
                      <div class="input-group">
                        <input type="number" id="gpEquity" placeholder="10">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>LP Equity <span class="variable-tag">{{LP_EQUITY}}</span></label>
                      <div class="input-group">
                        <input type="number" id="lpEquity" placeholder="90" readonly style="background: var(--border-light);">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Acquisition Fee</label>
                      <div class="input-group">
                        <input type="number" id="acqFee" placeholder="3" step="0.5">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Asset Mgmt Fee</label>
                      <div class="input-group">
                        <input type="number" id="assetMgmtFee" placeholder="2" step="0.5">
                        <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="tab-content" id="tab-parties">
                  <div class="form-row">
                    <div class="form-group">
                      <label>GP Entity <span class="variable-tag">{{GP_NAME}}</span></label>
                      <input type="text" id="gpName" placeholder="ABC Capital GP, LLC">
                    </div>
                    <div class="form-group">
                      <label>GP Representative</label>
                      <input type="text" id="gpRep" placeholder="John Smith">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>GP Address</label>
                    <input type="text" id="gpAddress" placeholder="GP mailing address">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Asset Manager</label>
                      <input type="text" id="assetManager" placeholder="Name">
                    </div>
                    <div class="form-group">
                      <label>Property Manager</label>
                      <input type="text" id="propertyManager" placeholder="Company Name">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" rows="3" placeholder="Additional notes..."></textarea>
                  </div>
                </div>
                
                <div class="tab-content" id="tab-preview">
                  <div class="empty-state" id="previewEmpty">
                    <div class="icon"><i class="fas fa-eye"></i></div>
                    <h3>Preview will appear here</h3>
                    <p>Fill in document details and click Generate Preview</p>
                  </div>
                  <div id="previewContent" style="display: none;">
                    <div class="preview-panel" id="documentPreview"></div>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                      <button class="btn btn-success" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                      </button>
                      <button class="btn btn-secondary" onclick="exportWord()">
                        <i class="fas fa-file-word"></i> Word
                      </button>
                      <button class="btn btn-ghost" onclick="exportHTML()">
                        <i class="fas fa-code"></i> HTML
                      </button>
                    </div>
                  </div>
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                  <button class="btn btn-primary" onclick="generatePreview()" id="previewBtn">
                    <i class="fas fa-eye"></i> Generate Preview
                  </button>
                  <button class="btn btn-secondary" onclick="saveDraft()">
                    <i class="fas fa-save"></i> Save Draft
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="js/sp-documents.js"></script>
  <script>
    SP.requireGP();
  </script>
  <script>
    let currentDocType = 'operating-agreement';
    let members = [];

    function loadSavedDeals() {
      const deals = SP.getDeals();
      const select = document.getElementById('dealSelect');
      select.innerHTML = '<option value="">Select a deal...</option>';
      deals.forEach(deal => {
        const option = document.createElement('option');
        option.value = deal.id;
        option.textContent = deal.name || 'Unnamed Deal';
        select.appendChild(option);
      });
      // Pre-select from URL
      const urlDeal = new URLSearchParams(window.location.search).get('deal');
      const urlType = new URLSearchParams(window.location.search).get('type');
      if (urlDeal) {
        select.value = urlDeal;
        importDealData();
        // Auto-select document type from URL param
        if (urlType) {
          currentDocType = urlType;
          document.querySelectorAll('.doc-type').forEach(t => {
            t.classList.toggle('selected', t.dataset.type === urlType);
          });
        }
        // Auto-generate preview after a short delay to let import settle
        setTimeout(() => {
          if (typeof generatePreview === 'function') generatePreview();
        }, 150);
      }
    }

    function importDealData() {
      const dealId = document.getElementById('dealSelect').value;
      if (!dealId) return;

      const deal = SP.getDealById(dealId);
      if (!deal) return;

      // Use wizard data if available (from new-deal.html), else fall back to sp-core fields
      const wd = deal.wizardData || {};

      const set = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined && val !== null && val !== '') el.value = val; };

      // Deal identity
      set('companyName', wd.companyName || deal.name || '');
      set('propertyName', deal.name);
      set('dealName', deal.name);
      set('llcName', wd.companyName || deal.companyName || '');
      set('propertyAddress', wd.propertyAddress || deal.location || '');
      set('address', wd.propertyAddress || deal.location || '');

      // Capital structure — prefer wizard data, fall back to sp-core fields
      set('totalEquity', wd.totalEquity || deal.totalEquity || deal.raise || '');
      set('minInvestment', wd.minInvestment || deal.minInvestment || 50000);
      set('prefReturn', wd.prefReturn || deal.prefReturn || 8);
      set('gpPromote', wd.gpPromote || deal.gpPromote || 20);
      set('gpEquity', wd.gpEquity || deal.gpEquity || 10);
      set('lpEquity', wd.lpEquity || deal.lpEquity || 90);
      set('acqFee', wd.acqFee || deal.acqFee || 3);
      set('assetMgmtFee', wd.assetMgmtFee || deal.assetMgmtFee || 2);

      // State
      const stateEl = document.getElementById('state');
      const stateVal = wd.state || deal.state || '';
      if (stateEl && stateVal) stateEl.value = stateVal;

      // GP rep from settings
      const settings = SP.load('settings', {});
      set('gpName', settings.firmName || wd.companyName || deal.companyName || '');
      set('gpRep', settings.gpFullName || SP.getSession()?.name || '');

      // Visual feedback
      const btn = document.getElementById('importBtn') || document.querySelector('button[onclick*="importDealData"]');
      if (btn) {
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Loaded!';
        btn.style.background = 'var(--success)';
        btn.style.color = 'white';
        setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; btn.style.color = ''; }, 2000);
      }

      // Trigger preview refresh if available
      if (typeof generateDocument === 'function') generateDocument();
    }
    
    document.querySelectorAll('.doc-type').forEach(type => {
      type.addEventListener('click', () => {
        document.querySelectorAll('.doc-type').forEach(t => t.classList.remove('selected'));
        type.classList.add('selected');
        currentDocType = type.dataset.type;
      });
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });
    
    document.getElementById('gpEquity').addEventListener('input', (e) => {
      const gp = parseFloat(e.target.value) || 0;
      document.getElementById('lpEquity').value = Math.max(0, 100 - gp);
    });
    
    // Pre-fill form from GP settings on load
    (function prefillFromSettings() {
      const s = SP.load('settings', {});
      if (!s.firmName && !s.gpFullName) return;
      const set = (id, val) => { const el = document.getElementById(id); if (el && !el.value && val) el.value = val; };
      set('companyName', s.firmName || '');
      set('gpName', s.firmName || '');
      set('gpRep', s.gpFullName || '');
      set('address', s.firmAddress || '');
      const stateEl = document.getElementById('state');
      if (stateEl && !stateEl.value && s.defState) stateEl.value = s.defState;
      else if (stateEl && !stateEl.value && s.firmState) stateEl.value = s.firmState;
      if (s.defPref) { const el = document.getElementById('prefReturn'); if (el && !el.value) el.value = s.defPref; }
      if (s.defPromote) { const el = document.getElementById('gpPromote'); if (el && !el.value) el.value = s.defPromote; }
      if (s.defGPEquity) { const el = document.getElementById('gpEquity'); if (el && !el.value) el.value = s.defGPEquity; }
    })();

    function getFormData() {
      return {
        companyName: document.getElementById('companyName').value,
        state: document.getElementById('state').value,
        address: document.getElementById('address').value,
        propertyAddress: document.getElementById('propertyAddress').value,
        totalEquity: document.getElementById('totalEquity').value,
        minInvestment: document.getElementById('minInvestment').value,
        prefReturn: document.getElementById('prefReturn').value,
        gpPromote: document.getElementById('gpPromote').value,
        gpEquity: document.getElementById('gpEquity').value,
        lpEquity: document.getElementById('lpEquity').value,
        acqFee: document.getElementById('acqFee').value,
        assetMgmtFee: document.getElementById('assetMgmtFee').value,
        gpName: document.getElementById('gpName').value,
        gpRep: document.getElementById('gpRep').value,
        members: members
      };
    }
    
    function generateOperatingAgreement(data) {
      // State-specific provisions — comprehensive RE syndication clauses
      const stateProvisions = {

        'DE': `<h3>Article IX — Delaware-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Delaware Limited Liability Company Act, 6 Del. C. § 18-101 et seq. (the "Act"), as amended from time to time. To the extent any provision of this Agreement conflicts with a non-waivable provision of the Act, the Act shall control.</p>
        <p><strong>9.2 Series LLC Authorization.</strong> Pursuant to 6 Del. C. § 18-215, the Managing Member may, by amendment to the Articles of Organization, establish one or more designated series with separate and distinct records, assets, obligations, and limited liability. Each series shall be treated as a separate entity for purposes of this Agreement unless otherwise specified.</p>
        <p><strong>9.3 Charging Order — Exclusive Remedy.</strong> Pursuant to 6 Del. C. § 18-703, a charging order against a Member's transferable interest is the exclusive remedy of a judgment creditor with respect to the Member's interest. No creditor may foreclose on, or otherwise acquire, a Member's interest through legal proceedings, and no court may order dissolution of the Company as a remedy for a creditor of a Member.</p>
        <p><strong>9.4 Limited Liability.</strong> Except as expressly required by the Act, no Member shall be personally liable for any debt, obligation, or liability of the Company, whether arising in contract, tort, or otherwise, solely by reason of being a Member. This protection shall not be affected by entry of a judgment or order against the Company.</p>
        <p><strong>9.5 Authority to Bind.</strong> Pursuant to 6 Del. C. § 18-402, no Member (other than the Managing Member acting in its capacity as Managing Member) shall have authority to act for or bind the Company. Any purported act by a non-managing Member shall be void and of no effect.</p>
        <p><strong>9.6 Securities Exemption.</strong> The offer and sale of interests in the Company to Members who are "accredited investors" as defined in Rule 501(a) of Regulation D under the Securities Act of 1933 is intended to qualify for the exemption provided by Rule 506(b) or 506(c) of Regulation D, as applicable. No interests shall be offered or sold except in compliance with applicable federal and Delaware securities laws.</p>
        <p><strong>9.7 Fiduciary Duties.</strong> Pursuant to 6 Del. C. § 18-1101(c), to the fullest extent permitted by law, the Managing Member's fiduciary duties to the Company and the Members are limited to the implied contractual covenant of good faith and fair dealing. All other fiduciary duties are hereby waived and eliminated to the maximum extent permitted by the Act.</p>
        <p><strong>9.8 RULLCA Opt-Out.</strong> The parties acknowledge that Delaware law permits significant modification of default rules by agreement. This Agreement shall govern member rights and obligations to the maximum extent permitted by the Act, and default statutory provisions are superseded by this Agreement where permitted.</p>`,

        'TX': `<h3>Article IX — Texas-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Texas Business Organizations Code ("TBOC"), Title 3, Chapter 101, as amended. All references to the "Act" herein mean the TBOC as applicable to limited liability companies.</p>
        <p><strong>9.2 Franchise Tax.</strong> The Company shall timely pay any Texas franchise (margin) tax imposed under Texas Tax Code Chapter 171. The Managing Member shall file the applicable Texas Franchise Tax Report and Public Information Report annually with the Texas Comptroller of Public Accounts. Failure to maintain the Company's right to do business in Texas may result in forfeiture of the right to sue or defend in Texas courts.</p>
        <p><strong>9.3 Community Property.</strong> If any Member is married and domiciled in Texas at the time of their admission, such Member represents that either: (a) the Member's interest is the Member's separate property, or (b) the Member's spouse has executed a spousal consent in the form attached hereto. Pursuant to Texas Family Code § 3.104, a spouse who does not sign this Agreement is bound by its terms to the extent required by applicable law. The Company shall not be required to recognize any community property claim to a Member's interest until the spouse has been admitted as a substituted Member in accordance with Article V.</p>
        <p><strong>9.4 Homestead Exclusion.</strong> No Member's interest in the Company shall constitute or be deemed a homestead under Article XVI of the Texas Constitution or Texas Property Code Chapter 41, and no Member may claim any homestead exemption with respect to the Company's assets or the Member's interest therein.</p>
        <p><strong>9.5 Charging Order — Exclusive Remedy.</strong> Pursuant to TBOC § 101.112, the exclusive remedy of a judgment creditor of a Member is a charging order against the Member's distributional interest. No court may foreclose on a Member's interest or order dissolution of the Company on account of a judgment against a Member, and no creditor shall have the rights of a Member by reason of a charging order.</p>
        <p><strong>9.6 Real Property — TREC Compliance.</strong> All real estate transactions on behalf of the Company shall comply with applicable Texas Real Estate Commission (TREC) regulations. Any broker or agent engaged by the Company shall be licensed under Texas Occupations Code Chapter 1101. Brokerage agreements shall comply with TREC-promulgated forms where required.</p>
        <p><strong>9.7 Securities Exemption.</strong> The offer and sale of interests are intended to qualify under the Texas Securities Act, Texas Government Code § 4001 et seq., pursuant to the exemption for sales to accredited investors under § 4005.025 and Rule 109.13 of the Texas State Securities Board. No interests shall be offered or sold in violation of applicable state or federal securities laws.</p>
        <p><strong>9.8 Landlord-Tenant Law.</strong> To the extent the Company acquires and leases real property in Texas, all lease agreements shall comply with Texas Property Code Chapters 91 and 92, including security deposit handling, habitability requirements, and required lease disclosures for residential property. For commercial property, the parties' respective rights and obligations shall be as set forth in each applicable lease.</p>
        <p><strong>9.9 Venue.</strong> Any legal action arising out of or relating to this Agreement shall be brought exclusively in the state or federal courts located in the county in which the Company's principal office is located, or if the subject property is located in Texas, in the county in which such property is located.</p>`,

        'CA': `<h3>Article IX — California-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the California Revised Uniform Limited Liability Company Act, California Corporations Code § 17701.01 et seq. ("RULLCA"). This Agreement is a "limited liability company agreement" within the meaning of § 17701.02(r).</p>
        <p><strong>9.2 Annual Franchise Tax.</strong> Pursuant to California Revenue and Taxation Code § 17941, the Company shall pay the $800 annual minimum franchise tax to the California Franchise Tax Board ("FTB") on or before the due date in each taxable year. The first installment is due by the 15th day of the 4th month after the date the LLC is organized or registers to do business in California, whichever occurs first. Failure to timely pay may result in suspension of the Company's powers, rights, and privileges.</p>
        <p><strong>9.3 Gross Receipts Fee.</strong> In addition to the minimum franchise tax, the Company shall pay the annual LLC fee based on total California-source gross receipts as required by Revenue and Taxation Code § 17942. The Managing Member shall ensure estimated payments are made to avoid underpayment penalties.</p>
        <p><strong>9.4 California Securities Law.</strong> The offer and sale of interests in the Company to California residents is intended to qualify for the limited offering exemption under California Corporations Code § 25102(f) and Rule 260.102.14 of the Commissioner of Financial Protection and Innovation ("DFPI"). The Company shall timely file a notice of the transaction with the DFPI (Form 260.102.14) within 15 days after the first sale to a California resident. No interests shall be offered or sold in California except in compliance with the California Corporate Securities Law of 1968.</p>
        <p><strong>9.5 Accredited Investor Verification.</strong> For offerings under Corporations Code § 25102(f), the Managing Member shall take reasonable steps to verify that all California-resident purchasers are "accredited investors" under Rule 501(a) of Regulation D, and shall retain records of such verification for a minimum of five years.</p>
        <p><strong>9.6 Registered Agent.</strong> The Company shall at all times maintain a registered agent and registered office in California as required by Corporations Code § 17701.13. The registered agent shall be the agent for service of process in all legal proceedings commenced in California.</p>
        <p><strong>9.7 Non-Manager Member Rights.</strong> Notwithstanding Article IV of this Agreement, non-managing Members retain the following non-waivable rights under RULLCA: (a) the right to inspect and copy the Company's records under § 17704.10; (b) the right to bring a derivative action under § 17709.02; (c) the right to receive information reasonably necessary to exercise any right under this Agreement or the Act; and (d) the right to seek judicial dissolution for oppressive conduct under § 17707.03.</p>
        <p><strong>9.8 Right of First Refusal — ROFR Compliance.</strong> Any proposed transfer of a Member's interest to a person who is not already a Member shall be subject to the right of first refusal set forth in Article V. The Company and remaining Members shall have 30 days following receipt of a bona fide written offer to elect to purchase the interest on the same terms. This provision is intended to comply with restrictions on transferability under California law.</p>
        <p><strong>9.9 Spousal Interest.</strong> If any Member is married, a Spousal Consent substantially in the form attached hereto as Exhibit B shall be obtained. To the extent a Member's interest constitutes community property under California Family Code § 760, the non-Member spouse's community property interest is subject to this Agreement, and any transfer of such interest requires compliance with Article V.</p>
        <p><strong>9.10 Real Property — CEQA and Land Use.</strong> To the extent the Company acquires or develops real property in California, the Managing Member shall ensure compliance with: (a) the California Environmental Quality Act (CEQA), Public Resources Code § 21000 et seq.; (b) applicable local zoning, general plan, and specific plan requirements; (c) the California Coastal Act where applicable; and (d) all applicable building codes and habitability standards, including Health and Safety Code § 17920.3.</p>
        <p><strong>9.11 AB 1482 — Rent Control.</strong> For residential rental property in California, the Company shall comply with the Tenant Protection Act of 2019 (AB 1482), Civil Code § 1946.2 et seq., including limitations on rent increases, just cause for eviction requirements, and relocation assistance obligations where applicable.</p>`,

        'NY': `<h3>Article IX — New York-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the New York Limited Liability Company Law ("NY LLC Law"), as amended. The rights and obligations of the Members are governed by this Agreement and, to the extent not covered herein, by the NY LLC Law.</p>
        <p><strong>9.2 Publication Requirement.</strong> Pursuant to NY LLC Law § 206, within 120 days after the articles of organization become effective, the Company shall publish a copy of the articles of organization or a notice related to its formation in two newspapers in the county of the Company's principal office, once per week for six consecutive weeks. The Company shall file an affidavit of publication with the New York Department of State within 130 days of formation. Failure to comply may result in suspension of the Company's authority to carry on business in New York.</p>
        <p><strong>9.3 Member Liability — Shield.</strong> No Member shall be personally liable for any debts, obligations, liabilities, or judgments of the Company solely by reason of being a Member, pursuant to NY LLC Law § 609. This limitation of liability shall not apply to any Member's own fraud, willful misconduct, or gross negligence.</p>
        <p><strong>9.4 Charging Order.</strong> Pursuant to NY LLC Law § 607, a charging order against a Member's membership interest is the exclusive remedy of a judgment creditor of a Member. No creditor may foreclose upon a Member's interest, and the Company shall not be subject to dissolution on account of a judgment against a Member.</p>
        <p><strong>9.5 New York Securities Exemption.</strong> The offer and sale of interests in the Company to New York residents is intended to qualify for an exemption from registration under the New York Martin Act (General Business Law § 352 et seq.), including the private placement exemption under 13 NYCRR § 10.3(b) for sales solely to accredited investors. No interests shall be offered or sold in New York except in compliance with applicable New York and federal securities laws.</p>
        <p><strong>9.6 Real Property — RPTT and Mortgage Recording Tax.</strong> The Company acknowledges that transfers of New York real property, including indirect transfers through transfers of interests in an LLC owning real property, may be subject to: (a) the New York State Real Property Transfer Tax (RPTT) under Tax Law § 1402; (b) the New York City Real Property Transfer Tax for property in New York City; and (c) the Mortgage Recording Tax under Tax Law § 253 on any new mortgage financing. The Managing Member shall consult with qualified New York tax counsel in connection with any acquisition or transfer of New York real property.</p>
        <p><strong>9.7 HDFC and Rent Regulation.</strong> For residential property in New York City, the Company shall comply with all applicable rent stabilization and rent control laws, including the Housing Stability and Tenant Protection Act of 2019, the New York City Rent Stabilization Law, and applicable DHCR regulations. The Company shall not engage in any tenant harassment or unlawful deregulation of rent-regulated units.</p>
        <p><strong>9.8 New York City Transfer Tax — 421-a Recapture.</strong> To the extent the Company's property benefits from any 421-a, 421-g, or J-51 tax exemption or abatement, the Managing Member shall ensure compliance with all conditions and covenants associated with such benefits, including affordability requirements, and shall notify Members of any event that could trigger recapture obligations.</p>
        <p><strong>9.9 Foreign LLC Qualification.</strong> If the Company is formed in a jurisdiction other than New York but transacts business in New York, the Company shall qualify as a foreign limited liability company with the New York Department of State pursuant to NY LLC Law § 802 and maintain a registered agent in New York at all times.</p>
        <p><strong>9.10 Books and Records.</strong> Pursuant to NY LLC Law § 1102, the Company shall maintain the following records at its principal office in New York: (a) a current list of each Member's name and address; (b) a copy of the articles of organization and all amendments; (c) copies of federal, state, and local tax returns; (d) copies of all financial statements; and (e) a copy of this Agreement. Members shall have the right to inspect such records upon reasonable notice during normal business hours.</p>`,

        'FL': `<h3>Article IX — Florida-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Florida Revised Limited Liability Company Act, Chapter 605, Florida Statutes ("FRLLCA"), as amended. All references herein to the "Act" mean Chapter 605 as applicable to limited liability companies.</p>
        <p><strong>9.2 Registered Agent and Registered Office.</strong> Pursuant to § 605.0113, Florida Statutes, the Company shall at all times maintain a registered agent and registered office in Florida. The registered agent shall be an individual resident of Florida or a business entity authorized to conduct business in Florida. Notice of any change in registered agent or registered office shall be filed with the Florida Division of Corporations within the time required by law.</p>
        <p><strong>9.3 Annual Report.</strong> Pursuant to § 605.0212, Florida Statutes, the Company shall file an annual report with the Florida Division of Corporations between January 1 and May 1 of each calendar year. The annual report shall contain the information required by statute and shall be accompanied by the applicable filing fee. Failure to file the annual report may result in administrative dissolution of the Company under § 605.0702.</p>
        <p><strong>9.4 Charging Order — Exclusive Remedy.</strong> Pursuant to § 605.0503, Florida Statutes, a charging order against a Member's transferable interest is the sole and exclusive remedy of a judgment creditor of a Member. No court shall have authority to foreclose upon or otherwise transfer a Member's interest to the judgment creditor, and no creditor shall have the right to receive the Member's share of distributions except through a charging order. The Company shall not be subject to dissolution as a remedy for a judgment against a Member.</p>
        <p><strong>9.5 Florida Securities Exemptions.</strong> The offer and sale of interests to Florida residents is intended to qualify under: (a) the federal private placement exemption of Regulation D, Rule 506(b) or 506(c); and (b) the Florida Securities and Investor Protection Act, Chapter 517, Florida Statutes, pursuant to the exemption under § 517.061 for sales to accredited investors or a limited number of sophisticated purchasers. No interests shall be offered or sold in Florida except in compliance with applicable Florida and federal securities laws.</p>
        <p><strong>9.6 Real Property — Documentary Stamp Tax.</strong> The Company acknowledges that transfers of Florida real property are subject to Florida documentary stamp tax under § 201.02, Florida Statutes, at a rate of $0.70 per $100 of consideration (or $0.60 per $100 in Miami-Dade County). Transfers of interests in the Company where Florida real property constitutes more than 50% of assets may also be subject to documentary stamp tax as indirect transfers. The Managing Member shall consult with Florida counsel prior to any acquisition or transfer of Florida real property.</p>
        <p><strong>9.7 Florida Homestead Exemption.</strong> The Company's real property shall not be used as a personal homestead by any Member, and no Member shall claim a homestead exemption under Article X, Section 4 of the Florida Constitution with respect to property owned by the Company. Each Member acknowledges that interests in the Company are not exempt from forced sale under any homestead provision.</p>
        <p><strong>9.8 Landlord-Tenant Law.</strong> For residential rental property in Florida, the Company shall comply with the Florida Residential Landlord and Tenant Act, Chapter 83, Part II, Florida Statutes, including: (a) security deposit handling requirements under § 83.49; (b) habitability and maintenance standards under § 83.51; (c) required notice periods for lease termination and rent increases; and (d) disclosure requirements for radon gas under § 404.056(5).</p>
        <p><strong>9.9 Foreign LLC Qualification.</strong> If the Company is formed outside Florida, the Company shall qualify as a foreign limited liability company pursuant to § 605.0902, Florida Statutes, prior to transacting business in Florida, and shall maintain a registered agent in Florida at all times. The certificate of authority shall be kept current and any changes shall be promptly filed.</p>
        <p><strong>9.10 Insurance.</strong> The Company shall maintain property and casualty insurance, general liability insurance, and such other insurance as is customary for properties of the type owned by the Company. For properties in Florida, coverage shall include windstorm and flood insurance as may be required by any applicable mortgage lender or as prudent given property location.</p>`,

        'NV': `<h3>Article IX — Nevada-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Nevada Revised Statutes ("NRS") Chapter 86 (Nevada Limited-Liability Company Act), as amended. The Company's rights and obligations are governed by this Agreement and NRS Chapter 86.</p>
        <p><strong>9.2 Charging Order — Exclusive and Sole Remedy.</strong> Pursuant to NRS 86.401, a charging order against a Member's distributional interest is the SOLE and EXCLUSIVE remedy of a judgment creditor of a Member or of any transferee of a Member's interest. No court may foreclose upon a Member's interest, convert a charging order into an ownership interest, or order the dissolution of the Company as a remedy for a judgment against a Member. This provision is intended to provide the maximum asset protection permitted under Nevada law.</p>
        <p><strong>9.3 Asset Protection.</strong> Nevada law affords strong asset protection to Members of a Nevada LLC. The following provisions apply: (a) no creditor of a Member may attach, levy upon, or execute against the Member's interest in the Company; (b) a judgment creditor may not acquire voting rights, management rights, or any rights of a Member; (c) the Company is not required to recognize any charging order holder as a Member; and (d) distributions may, at the Managing Member's sole discretion, be withheld from any Member whose interest is subject to a charging order.</p>
        <p><strong>9.4 Series LLC Authorization.</strong> Pursuant to NRS 86.296, the Managing Member may establish one or more "protected series" of the Company, each with its own members, managers, interests, assets, and liabilities. A protected series shall be treated as a separate series for liability purposes, and the debts and obligations of one series shall not be enforceable against the assets of another series or the Company generally. The formation of any series shall be accomplished by amendment to the Articles of Organization filed with the Nevada Secretary of State.</p>
        <p><strong>9.5 Privacy.</strong> Nevada law does not require the names of members or managers to appear in the publicly filed articles of organization. The Company may use a registered agent or nominee manager in filings with the Nevada Secretary of State to maintain Member privacy. Notwithstanding, the Company shall maintain accurate internal records identifying all Members and their respective interests.</p>
        <p><strong>9.6 Business License.</strong> Pursuant to NRS 76.100 et seq., the Company shall obtain and maintain a Nevada State Business License issued by the Nevada Secretary of State. The business license shall be renewed annually on or before the anniversary of the Company's formation. Failure to maintain the business license may affect the Company's good standing and ability to conduct business in Nevada.</p>
        <p><strong>9.7 Annual Report / Annual List.</strong> The Company shall file an annual list of managers and registered agent with the Nevada Secretary of State on or before the last day of the anniversary month of formation, together with the applicable filing fee. Failure to file the annual list may result in revocation of the Company's charter.</p>
        <p><strong>9.8 Nevada Securities Exemptions.</strong> The offer and sale of interests to Nevada residents is intended to qualify for exemption under the Nevada Securities Act, NRS Chapter 90, pursuant to the exemption for private placements under NRS 90.520(11) and applicable NASAA guidelines. No interests shall be offered or sold in Nevada except in compliance with applicable Nevada and federal securities laws. The Company shall file any required notice with the Nevada Secretary of State's Securities Division within the time required by law.</p>
        <p><strong>9.9 Real Property.</strong> The Company is authorized to acquire, hold, encumber, and dispose of real property located in Nevada or any other state. Any transfer of Nevada real property shall comply with applicable Nevada recording requirements (NRS Chapter 111) and any applicable transfer tax obligations. The Company shall obtain title insurance on all Nevada real property acquisitions.</p>
        <p><strong>9.10 Limitation on Liability of Managers.</strong> Pursuant to NRS 86.286, no manager of the Company shall be personally liable for any debt, obligation, or liability of the Company solely by reason of acting as manager. A manager's liability to the Company and its Members shall be limited to acts or omissions constituting intentional misconduct, fraud, or a knowing violation of law.</p>`,

        'WY': `<h3>Article IX — Wyoming-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Wyoming Limited Liability Company Act, W.S. § 17-29-101 et seq. ("Wyoming Act"), as amended. All rights and obligations of the Members are governed by this Agreement and, to the extent not inconsistent herewith, the Wyoming Act.</p>
        <p><strong>9.2 Charging Order — Exclusive Remedy.</strong> Pursuant to W.S. § 17-29-503, a charging order against a Member's transferable interest is the EXCLUSIVE remedy by which a judgment creditor of a Member or a Member's transferee may satisfy a judgment out of the Member's transferable interest. No court may foreclose upon a Member's interest, nor shall any such court order dissolution of the Company as a remedy for a creditor of a Member. A charging order constitutes a lien on a Member's transferable interest only; no holder of a charging order shall thereby acquire the rights of a Member.</p>
        <p><strong>9.3 Privacy of Members.</strong> Wyoming law does not require the names or addresses of Members to appear in any publicly filed document. The Company's articles of organization filed with the Wyoming Secretary of State shall identify only the registered agent and, if applicable, the organizer. Member identity and ownership information is confidential and shall be maintained in the Company's internal records, not disclosed to third parties except as required by law or court order.</p>
        <p><strong>9.4 Asset Protection.</strong> Wyoming provides among the strongest LLC asset protection in the United States. The following protections apply: (a) creditors of a Member may NOT foreclose on the Member's LLC interest; (b) a charging order does not entitle the creditor to exercise voting rights or management rights; (c) distributions may be suspended as to any Member whose interest is subject to a charging order; (d) no single-member LLC charging order exception applies — all Wyoming LLCs, including single-member LLCs, receive charging order protection under W.S. § 17-29-503.</p>
        <p><strong>9.5 Registered Office and Agent.</strong> Pursuant to W.S. § 17-29-108, the Company shall maintain a registered office and registered agent in Wyoming at all times. The registered agent shall be an individual Wyoming resident or a business entity authorized to do business in Wyoming. Notice of any change in registered agent or office shall be filed with the Wyoming Secretary of State.</p>
        <p><strong>9.6 Annual Report.</strong> The Company shall file an annual report with the Wyoming Secretary of State on or before the first day of the anniversary month of the Company's organization, together with the applicable fee. The annual report shall include information as required under W.S. § 17-29-209. Failure to file the annual report within 60 days after the due date may result in administrative dissolution.</p>
        <p><strong>9.7 Wyoming Securities Exemption.</strong> The offer and sale of interests to Wyoming residents is intended to qualify for the private placement exemption under the Wyoming Uniform Securities Act, W.S. § 17-4-102 et seq., specifically the exemption for transactions by an issuer not involving any public offering under W.S. § 17-4-203(b)(9) and applicable SEC Rule 506. No interests shall be offered or sold to Wyoming residents except in compliance with applicable Wyoming and federal securities laws.</p>
        <p><strong>9.8 Series LLC.</strong> Pursuant to W.S. § 17-29-211, the Company may, by amendment to its articles of organization, establish one or more series with separate and distinct assets, liabilities, and Members. Each series may have a separate operating agreement and may be managed separately. The assets of one series shall not be subject to the liabilities of any other series. The Managing Member may establish additional series by filing an appropriate amendment with the Wyoming Secretary of State.</p>
        <p><strong>9.9 Decanting.</strong> Pursuant to W.S. § 17-29-101 et seq., the Managing Member may, with the consent of all Members, merge the Company with another Wyoming LLC, domesticate the Company to another jurisdiction, or convert the Company to another form of entity, in each case in accordance with the Wyoming Act and applicable law.</p>
        <p><strong>9.10 Real Property.</strong> The Company is authorized to acquire, hold, encumber, lease, and dispose of real property in Wyoming and any other state. Conveyances of Wyoming real property shall comply with W.S. §§ 34-1-101 et seq. and shall be recorded in the county clerk's office of the county in which the property is located. The Company shall maintain title insurance on all real property acquisitions.</p>`,

        'AZ': `<h3>Article IX — Arizona-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Arizona Limited Liability Company Act, A.R.S. § 29-3101 et seq. ("Arizona Act"). Rights and obligations of the Members are governed by this Agreement and, where not inconsistent herewith, the Arizona Act.</p>
        <p><strong>9.2 Charging Order.</strong> Pursuant to A.R.S. § 29-3503, a charging order is the exclusive remedy of a judgment creditor of a Member. A charging order constitutes a lien on a Member's transferable interest only and does not entitle the creditor to any management rights or rights of a Member.</p>
        <p><strong>9.3 Community Property.</strong> Arizona is a community property state. If any Member is married, such Member represents that their interest is either separate property or that the Member's spouse has executed a written consent. Community property interests of non-Member spouses are subject to this Agreement to the extent required by A.R.S. § 25-211.</p>
        <p><strong>9.4 Arizona Securities.</strong> The offer and sale of interests to Arizona residents shall comply with the Arizona Securities Act, A.R.S. § 44-1801 et seq., including applicable exemptions from registration for private placements.</p>
        <p><strong>9.5 Real Property.</strong> For Arizona real property, the Company shall comply with deed of trust and foreclosure procedures under A.R.S. § 33-801 et seq. and all applicable county recording requirements.</p>`,

        'CO': `<h3>Article IX — Colorado-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Colorado Limited Liability Company Act, C.R.S. § 7-80-101 et seq. ("Colorado Act").</p>
        <p><strong>9.2 Charging Order.</strong> Pursuant to C.R.S. § 7-80-703, a charging order against a Member's transferable interest is the exclusive remedy of a judgment creditor of a Member. No court may foreclose on a Member's interest or order dissolution.</p>
        <p><strong>9.3 Colorado Securities.</strong> The offer and sale of interests to Colorado residents shall comply with the Colorado Securities Act, C.R.S. § 11-51-101 et seq., and any applicable exemptions for private offerings.</p>
        <p><strong>9.4 Real Property.</strong> For Colorado real property, all deeds, deeds of trust, and related instruments shall comply with C.R.S. § 38-35-101 et seq. The Company shall comply with the Colorado Common Interest Ownership Act if applicable.</p>`,

        'GA': `<h3>Article IX — Georgia-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the Georgia Limited Liability Company Act, O.C.G.A. § 14-11-100 et seq.</p>
        <p><strong>9.2 Charging Order.</strong> Pursuant to O.C.G.A. § 14-11-504, a charging order against a Member's transferable interest is the exclusive remedy of a judgment creditor of a Member.</p>
        <p><strong>9.3 Annual Registration.</strong> The Company shall file an annual registration with the Georgia Secretary of State and pay the applicable fee to maintain good standing.</p>
        <p><strong>9.4 Georgia Securities.</strong> The offer and sale of interests to Georgia residents shall comply with the Georgia Uniform Securities Act of 2008, O.C.G.A. § 10-5-1 et seq.</p>`,

      };

      // For states without full clauses, generate a sensible generic block
      const genericStateClause = (st) => `<h3>Article IX — ${st}-Specific Provisions</h3>
        <p><strong>9.1 Governing Statute.</strong> The Company is organized under the ${st} Limited Liability Company Act, as amended. The rights and obligations of the Members are governed by this Agreement and, to the extent not covered herein, by applicable ${st} law.</p>
        <p><strong>9.2 Charging Order.</strong> To the extent permitted by ${st} law, a charging order against a Member's transferable interest shall be the exclusive remedy of a judgment creditor of a Member. No creditor may foreclose on a Member's interest or compel dissolution of the Company on account of a judgment against a Member.</p>
        <p><strong>9.3 Securities Compliance.</strong> The offer and sale of interests shall comply with applicable ${st} securities laws and any required state notice filings in connection with the federal Regulation D exemption used for this offering.</p>
        <p><strong>9.4 Registered Agent.</strong> The Company shall maintain a registered agent and registered office in ${st} as required by applicable law, and shall timely file all required annual reports and renewal filings with the ${st} Secretary of State or equivalent authority.</p>
        <p><strong>9.5 Real Property.</strong> To the extent the Company acquires real property in ${st}, all transactions shall comply with applicable ${st} real property laws, recording requirements, transfer taxes, and title insurance requirements.</p>
        <p><strong>9.6 Governing Law.</strong> This Agreement shall be governed by and construed in accordance with the laws of the State of ${st}, without regard to conflicts of law principles.</p>`;

      const stateClause = stateProvisions[data.state] || genericStateClause(data.state || 'DE');
      
      const stateClause = stateProvisions[data.state] || stateProvisions['DE'];
      
      return `<h1>OPERATING AGREEMENT</h1>
      <p style="text-align: center; font-style: italic;">${data.companyName || '[COMPANY NAME]'}</p>
      <p style="text-align: center;">A ${data.state || '[STATE]'} Limited Liability Company</p>
      
      <div class="section">
        <p>THIS OPERATING AGREEMENT is entered into as of ${new Date().toLocaleDateString()}, by and among the Members listed on Schedule A.</p>
      </div>
      
      <h2>ARTICLE I - FORMATION</h2>
      <div class="section">
        <p><strong>1.1 Formation.</strong> The Members hereby form a limited liability company pursuant to the ${data.state || '[STATE]'} Limited Liability Company Act.</p>
        <p><strong>1.2 Name.</strong> The name of the Company shall be ${data.companyName || '[COMPANY NAME]'}.</p>
        <p><strong>1.3 Principal Office.</strong> The principal office shall be at ${data.address || '[ADDRESS]'}.</p>
        <p><strong>1.4 Purpose.</strong> To acquire, own, operate, and dispose of real property located at ${data.propertyAddress || '[PROPERTY ADDRESS]'}. The Company may engage in all activities necessary or incidental thereto.</p>
        <p><strong>1.5 Duration.</strong> The Company shall have perpetual existence unless dissolved in accordance with Article IX.</p>
        <p><strong>1.6 Registered Agent.</strong> The registered agent and office are as specified in the Articles of Organization, as may be changed from time to time.</p>
      </div>
      
      <h2>ARTICLE II - CAPITAL CONTRIBUTIONS</h2>
      <div class="section">
        <p><strong>2.1 Initial Capital.</strong> The total equity capitalization shall be $${parseFloat(data.totalEquity || 0).toLocaleString()}.</p>
        <p><strong>2.2 GP Contribution.</strong> The General Partner shall contribute ${data.gpEquity || '10'}% of total equity.</p>
        <p><strong>2.3 LP Contributions.</strong> Limited Partners shall contribute ${data.lpEquity || '90'}% of total equity.</p>
        <p><strong>2.4 Additional Capital.</strong> Members may be required to make additional capital contributions as set forth in Section 4.3.</p>
        <p><strong>2.5 Capital Accounts.</strong> A separate capital account shall be maintained for each Member.</p>
      </div>
      
      <h2>ARTICLE III - ALLOCATIONS AND DISTRIBUTIONS</h2>
      <div class="section">
        <p><strong>3.1 Allocations of Profits and Losses.</strong> Profits and losses shall be allocated in accordance with each Member's percentage interest.</p>
        <p><strong>3.2 Distributions.</strong> Distributable Cash shall be distributed in the following order of priority:</p>
        <p style="margin-left: 20px;">(a) <strong>First,</strong> to all Members pro-rata until they have received a return of their capital contributions;</p>
        <p style="margin-left: 20px;">(b) <strong>Second,</strong> to the Limited Partners until they have received the Preferred Return of ${data.prefReturn || '8'}% per annum, non-cumulative;</p>
        <p style="margin-left: 20px;">(c) <strong>Third,</strong> to the General Partner as a "catch-up" until the GP has received ${data.gpPromote || '20'}% of all distributions under (b) and (c) combined;</p>
        <p style="margin-left: 20px;">(d) <strong>Thereafter,</strong> ${data.gpPromote || '20'}% to the GP and ${100 - (data.gpPromote || 20)}% to the LPs.</p>
        <p><strong>3.3 Tax Distributions.</strong> Tax distributions may be made to Members to cover tax liabilities on allocated income.</p>
        <p><strong>3.4 Reinvestment.</strong> The GP may reinvest cash flow rather than distribute at its discretion.</p>
      </div>
      
      <h2>ARTICLE IV - MANAGEMENT</h2>
      <div class="section">
        <p><strong>4.1 General Partner Authority.</strong> ${data.gpName || '[GP NAME]'} shall serve as the Managing Member with full authority to manage the Company's business and affairs.</p>
        <p><strong>4.2 Limited Partner Rights.</strong> Limited Partners have no right to participate in management and shall have no authority to bind the Company.</p>
        <p><strong>4.3 Major Decisions.</strong> The following require LP consent: (a) sale of the Property; (b) refinancing; (c) material lease amendments; (d) bankruptcy filing.</p>
        <p><strong>4.4 GP Removal.</strong> The GP may be removed for cause (fraud, willful misconduct, material breach) by majority-in-interest of LPs.</p>
        <p><strong>4.5 Fees.</strong> The GP shall receive: (a) Acquisition Fee of ${data.acqFee || '3'}% of purchase price; (b) Asset Management Fee of ${data.assetMgmtFee || '2'}% of gross revenues.</p>
      </div>
      
      <h2>ARTICLE V - MEMBERS</h2>
      <div class="section">
        <p><strong>5.1 Admission.</strong> New Members may be admitted only with GP consent and amendment of this Agreement.</p>
        <p><strong>5.2 Transfers.</strong> No Member may transfer their interest without GP consent and right of first refusal to the Company.</p>
        <p><strong>5.3 Withdrawal.</strong> No Member has the right to withdraw or demand return of capital prior to liquidation.</p>
        <p><strong>5.4 Accredited Investors.</strong> All Members represent they are accredited investors under Regulation D.</p>
      </div>
      
      <h2>ARTICLE VI - ACCOUNTING AND REPORTS</h2>
      <div class="section">
        <p><strong>6.1 Fiscal Year.</strong> The fiscal year shall be the calendar year.</p>
        <p><strong>6.2 Books and Records.</strong> The GP shall maintain complete books and records at the principal office.</p>
        <p><strong>6.3 Financial Statements.</strong> The GP shall provide quarterly reports and annual audited financials to LPs.</p>
        <p><strong>6.4 Tax Returns.</strong> The Company shall file partnership tax returns and provide K-1s by March 15.</p>
      </div>
      
      <h2>ARTICLE VII - INDEMNIFICATION</h2>
      <div class="section">
        <p><strong>7.1 Indemnification.</strong> The Company shall indemnify the GP and its affiliates for actions taken in good faith on behalf of the Company.</p>
        <p><strong>7.2 Insurance.</strong> The GP may obtain liability insurance for the Company and its officers.</p>
      </div>
      
      <h2>ARTICLE VIII - DISSOLUTION</h2>
      <div class="section">
        <p><strong>8.1 Events of Dissolution.</strong> The Company shall dissolve upon: (a) sale of the Property; (b) unanimous consent; (c) judicial dissolution; (d) bankruptcy.</p>
        <p><strong>8.2 Liquidation.</strong> Upon dissolution, assets shall be liquidated and distributed: (a) to creditors; (b) to Members per Article III.</p>
      </div>
      
      <h2>ARTICLE IX - STATE-SPECIFIC PROVISIONS</h2>
      <div class="section">
        ${stateClause}
      </div>
      
      <h2>ARTICLE X - GENERAL PROVISIONS</h2>
      <div class="section">
        <p><strong>10.1 Amendments.</strong> This Agreement may be amended by the GP with consent of majority-in-interest of LPs.</p>
        <p><strong>10.2 Governing Law.</strong> This Agreement shall be governed by the laws of ${data.state || '[STATE]'}.</p>
        <p><strong>10.3 Severability.</strong> If any provision is invalid, the remainder shall continue in full force.</p>
        <p><strong>10.4 Entire Agreement.</strong> This Agreement constitutes the entire agreement among the Members.</p>
        <p><strong>10.5 Counterparts.</strong> This Agreement may be executed in counterparts.</p>
      </div>
      
      <h2>SIGNATURES</h2>
      <p>IN WITNESS WHEREOF, the Members have executed this Agreement as of ${new Date().toLocaleDateString()}.</p>
      <div style="margin-top: 40px;">
        <p><strong>GENERAL PARTNER:</strong></p>
        <p style="margin-top: 30px;">_________________________________</p>
        <p>${data.gpRep || '[GP REPRESENTATIVE]'}</p>
        <p>${data.gpName || '[GP ENTITY]'}</p>
        <p>Managing Member</p>
      </div>
      
      <div style="margin-top: 40px;">
        <p><strong>LIMITED PARTNERS:</strong></p>
        <p>(See Schedule A)</p>
      </div>`;
    }
    
    function generatePPM(data) {
      return `<h1>PRIVATE PLACEMENT MEMORANDUM</h1><p style="text-align: center; font-weight: bold; font-size: 1.2rem;">${data.companyName || '[COMPANY NAME]'}</p><p style="text-align: center;">$${parseFloat(data.totalEquity || 0).toLocaleString()} Limited Liability Company Interests</p><p style="text-align: center; color: #c00; font-weight: bold; border: 2px solid #c00; padding: 1rem; margin: 1rem 0;">THESE SECURITIES HAVE NOT BEEN REGISTERED UNDER THE SECURITIES ACT OF 1933</p><h2>SUMMARY</h2><table><tr><td><strong>Issuer:</strong></td><td>${data.companyName || '[COMPANY NAME]'}</td></tr><tr><td><strong>Offering Amount:</strong></td><td>$${parseFloat(data.totalEquity || 0).toLocaleString()}</td></tr><tr><td><strong>Minimum:</strong></td><td>$${parseFloat(data.minInvestment || 50000).toLocaleString()}</td></tr><tr><td><strong>Preferred Return:</strong></td><td>${data.prefReturn || '8'}%</td></tr><tr><td><strong>GP Promote:</strong></td><td>${data.gpPromote || '20'}%</td></tr></table><h2>RISK FACTORS</h2><p>An investment involves substantial risks including illiquidity, no public market, and complete loss of capital.</p><h2>USE OF PROCEEDS</h2><p>Net proceeds will be used for acquisition of ${data.propertyAddress || 'the Property'}, closing costs, and reserves.</p>`;
    }
    
    function generateSubscription(data) {
      return `<h1>SUBSCRIPTION AGREEMENT</h1><p style="text-align: center;">${data.companyName || '[COMPANY NAME]'}</p><p style="text-align: center;">$${parseFloat(data.minInvestment || 50000).toLocaleString()} Minimum Investment</p><p>This SUBSCRIPTION AGREEMENT is entered into as of ${new Date().toLocaleDateString()}, between ${data.companyName || '[COMPANY NAME]'} and the undersigned subscriber.</p><h2>1. SUBSCRIPTION</h2><p>The Subscriber hereby subscribes for Interests in the amount of $______________.</p><h2>2. ACCREDITED INVESTOR</h2><p>The Subscriber represents that they are an accredited investor by virtue of:</p><p>☐ Net worth exceeding $1,000,000 (excluding primary residence)</p><p>☐ Income exceeding $200,000 ($300,000 joint) in each of prior two years</p><p>☐ Entity with assets exceeding $5,000,000</p><h2>3. WIRE INSTRUCTIONS</h2><p>Wire to: ${data.companyName || '[COMPANY]'} Escrow Account</p><h2>SIGNATURES</h2><p>Subscriber: _________________________ Date: ___________</p><p>${data.gpRep || '[GP Rep]'}, Managing Member</p>`;
    }
    
    function generatePreview() {
      const data = getFormData();
      let content = '';
      
      const _sett = SP.load('settings', {});
      const _gpN = data.gpName || _sett.firmName || data.companyName || '[GP NAME]';
      const _gpR = data.gpRep || _sett.gpFullName || SP.getSession()?.name || 'Managing Member';
      const _st = data.state || _sett.defState || 'DE';
      const _addr = _sett.firmAddress || data.address || '';
      const _min = data.minInvestment || 50000;

      // Build a deal-like object from form data for SPDocs
      const _dealObj = {
        name: data.propertyAddress || data.companyName || '[DEAL]',
        location: data.propertyAddress || '',
        raise: parseFloat(data.totalEquity) || 0,
        totalEquity: parseFloat(data.totalEquity) || 0,
        gpEquity: parseFloat(data.gpEquity) || 10,
        lpEquity: parseFloat(data.lpEquity) || 90,
        prefReturn: parseFloat(data.prefReturn) || 8,
        gpPromote: parseFloat(data.gpPromote) || 20,
        acqFee: parseFloat(data.acqFee) || 3,
        assetMgmtFee: parseFloat(data.assetMgmtFee) || 2,
        companyName: data.companyName || _gpN,
        state: _st,
        minInvestment: parseFloat(_min),
      };

      switch(currentDocType) {
        case 'operating-agreement':
        case 'lp-agreement':
          content = (typeof SPDocs !== 'undefined')
            ? SPDocs.generateOA(_dealObj, _gpN, _gpR, _addr, _st, _min)
            : generateOperatingAgreement(data);
          break;
        case 'ppm':
          content = (typeof SPDocs !== 'undefined')
            ? SPDocs.generatePPM(_dealObj, _gpN, _gpR, _addr, _st, _min, _sett)
            : generatePPM(data);
          break;
        case 'subscription':
          // Build a dummy investor from form data for the sub doc
          const _inv = { firstName: '[INVESTOR', lastName: 'NAME]', email: '', address: '', phone: '', committed: parseFloat(data.minInvestment) || 50000 };
          content = (typeof SPDocs !== 'undefined')
            ? SPDocs.generateSubDoc(_dealObj, _inv, _gpN, _gpR)
            : generateSubscription(data);
          break;
      }
      
      document.getElementById('previewEmpty').style.display = 'none';
      document.getElementById('previewContent').style.display = 'block';
      document.getElementById('documentPreview').innerHTML = content;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-tab="preview"]').classList.add('active');
      document.getElementById('tab-preview').classList.add('active');
    }
    
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = getFormData();
      
      doc.setFontSize(10);
      doc.text('Generated by deeltrack', 10, 10);
      doc.setFontSize(18);
      doc.text('OPERATING AGREEMENT', 105, 30, { align: 'center' });
      doc.setFontSize(12);
      doc.text(data.companyName || '[COMPANY]', 105, 45, { align: 'center' });
      doc.text(`Total Equity: $${parseFloat(data.totalEquity || 0).toLocaleString()}`, 10, 70);
      doc.text(`GP Equity: ${data.gpEquity}%`, 10, 80);
      doc.text(`Preferred Return: ${data.prefReturn}%`, 10, 90);
      doc.text(`GP Promote: ${data.gpPromote}%`, 10, 100);
      doc.save(`${data.companyName || 'document'}_${currentDocType}.pdf`);
    }
    
    function exportWord() {
      const content = document.getElementById('documentPreview').innerHTML;
      const blob = new Blob(['<html><head><meta charset="UTF-8"></head><body>' + content + '</body></html>'], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentDocType}-${new Date().toISOString().split('T')[0]}.doc`;
      a.click();
    }
    
    function exportHTML() {
      const content = document.getElementById('documentPreview').innerHTML;
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentDocType}-${new Date().toISOString().split('T')[0]}.html`;
      a.click();
    }
    
    function saveDraft() {
      const data = getFormData();
      data.docType = currentDocType;
      data.savedAt = new Date().toISOString();

      const drafts = SP.load('documentDrafts', []);
      drafts.push(data);
      SP.save('documentDrafts', drafts);
      SP.logActivity('fa-file-contract', 'amber', `Draft saved: <strong>${currentDocType.replace(/-/g,' ')}</strong>`);
      
      const btn = document.querySelector('.btn-secondary');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Draft Saved!';
      setTimeout(() => btn.innerHTML = originalText, 1500);
    }
    
    loadSavedDeals();  // async — renders after Firebase sync
    window.addEventListener('spdata-ready', loadSavedDeals);
  </script>
</body>
</html>