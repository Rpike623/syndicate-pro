<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #0f172a; --primary-light: #1e293b; --secondary: #334155;
      --accent: #3b82f6; --accent-hover: #2563eb; --accent-light: #dbeafe;
      --success: #10b981; --success-light: #d1fae5;
      --warning: #f59e0b; --warning-light: #fef3c7;
      --danger: #ef4444; --danger-light: #fee2e2;
      --purple: #8b5cf6; --purple-light: #ede9fe;
      --text: #0f172a; --text-secondary: #64748b; --text-muted: #94a3b8;
      --border: #e2e8f0; --border-light: #f1f5f9;
      --bg: #f8fafc; --bg-card: #ffffff; --bg-sidebar: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --radius-sm: 6px; --radius: 8px; --radius-md: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 260px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 1.25rem; font-weight: 700; text-decoration: none; color: white; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #60a5fa); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
    .nav-section { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.4); padding: 16px 12px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius); color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: all 0.15s; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .sidebar-footer { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--success), #34d399); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; color: white; flex-shrink: 0; }
    .user-details { flex: 1; min-width: 0; }
    .user-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 0.75rem; color: rgba(255,255,255,0.5); }

    /* Main */
    .main { flex: 1; margin-left: 260px; min-height: 100vh; }
    .top-bar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .top-left { display: flex; align-items: center; gap: 16px; }
    .mobile-menu-btn { display: none; background: none; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 10px; cursor: pointer; align-items: center; justify-content: center; }
    .page-title-bar h1 { font-size: 1.25rem; font-weight: 700; }
    .page-title-bar p { font-size: 0.8rem; color: var(--text-secondary); }
    .top-actions { display: flex; gap: 12px; align-items: center; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; font-size: 0.875rem; font-weight: 600; border-radius: var(--radius); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border-light); }
    .btn-icon { width: 40px; height: 40px; border: 1px solid var(--border); background: var(--bg-card); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
    .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
    .notification-dot { position: relative; }
    .notification-dot::after { content: ''; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-card); }

    /* Content */
    .content { padding: 32px; }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 28px; }
    .kpi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 24px; display: flex; align-items: flex-start; gap: 16px; transition: all 0.2s; }
    .kpi-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .kpi-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .kpi-icon.blue { background: var(--accent-light); color: var(--accent); }
    .kpi-icon.green { background: var(--success-light); color: var(--success); }
    .kpi-icon.amber { background: var(--warning-light); color: var(--warning); }
    .kpi-icon.purple { background: var(--purple-light); color: var(--purple); }
    .kpi-body { flex: 1; min-width: 0; }
    .kpi-label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
    .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--text); line-height: 1.2; font-family: 'JetBrains Mono', monospace; }
    .kpi-change { font-size: 0.75rem; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .kpi-change.up { color: var(--success); }
    .kpi-change.down { color: var(--danger); }
    .kpi-change.neutral { color: var(--text-muted); }

    /* Charts row */
    .charts-row { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; margin-bottom: 28px; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); }
    .card-header { padding: 20px 24px 0; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1rem; font-weight: 700; }
    .card-subtitle { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
    .card-body { padding: 20px 24px 24px; }
    .chart-wrap { position: relative; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .donut-center .value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .donut-center .label { font-size: 0.7rem; color: var(--text-secondary); }
    .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

    /* Bottom grid */
    .bottom-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; margin-bottom: 28px; }

    /* Activity feed */
    .activity-list { display: flex; flex-direction: column; gap: 0; }
    .activity-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border-light); }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
    .activity-icon.blue { background: var(--accent-light); color: var(--accent); }
    .activity-icon.green { background: var(--success-light); color: var(--success); }
    .activity-icon.amber { background: var(--warning-light); color: var(--warning); }
    .activity-icon.purple { background: var(--purple-light); color: var(--purple); }
    .activity-icon.red { background: var(--danger-light); color: var(--danger); }
    .activity-body { flex: 1; }
    .activity-text { font-size: 0.875rem; color: var(--text); }
    .activity-text strong { font-weight: 600; }
    .activity-time { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    /* Deadlines */
    .deadline-list { display: flex; flex-direction: column; gap: 0; }
    .deadline-item { display: flex; align-items: center; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border-light); }
    .deadline-item:last-child { border-bottom: none; }
    .deadline-date { text-align: center; min-width: 44px; }
    .deadline-date .day { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
    .deadline-date .month { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .deadline-info { flex: 1; }
    .deadline-name { font-size: 0.875rem; font-weight: 600; }
    .deadline-type { font-size: 0.75rem; color: var(--text-secondary); }
    .deadline-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 20px; font-weight: 600; white-space: nowrap; }
    .badge-urgent { background: var(--danger-light); color: var(--danger); }
    .badge-soon { background: var(--warning-light); color: var(--warning); }
    .badge-ok { background: var(--success-light); color: var(--success); }

    /* Quick Actions */
    .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    .qa-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 12px; text-decoration: none; color: var(--text); transition: all 0.2s; cursor: pointer; }
    .qa-card:hover { box-shadow: var(--shadow-md); transform: translateY(-3px); border-color: var(--accent); }
    .qa-icon { width: 52px; height: 52px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
    .qa-icon.blue { background: var(--accent-light); color: var(--accent); }
    .qa-icon.green { background: var(--success-light); color: var(--success); }
    .qa-icon.amber { background: var(--warning-light); color: var(--warning); }
    .qa-icon.purple { background: var(--purple-light); color: var(--purple); }
    .qa-label { font-size: 0.9rem; font-weight: 600; }
    .qa-desc { font-size: 0.75rem; color: var(--text-secondary); }

    /* Deals Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); padding: 12px 16px; text-align: left; background: var(--border-light); }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border-light); font-size: 0.875rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--border-light); }
    .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .badge-mf { background: var(--accent-light); color: var(--accent); }
    .badge-ind { background: var(--success-light); color: var(--success); }
    .badge-ret { background: var(--warning-light); color: var(--warning); }
    .badge-off { background: var(--purple-light); color: var(--purple); }
    .badge-sourcing { background: var(--border-light); color: var(--text-secondary); }
    .badge-loi { background: var(--warning-light); color: var(--warning); }
    .badge-dd { background: var(--accent-light); color: var(--accent); }
    .badge-closed { background: var(--success-light); color: var(--success); }
    .badge-operating { background: var(--purple-light); color: var(--purple); }
    .irr-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--success); }
    .money-val { font-family: 'JetBrains Mono', monospace; }
    .action-btns { display: flex; gap: 6px; }
    .btn-xs { padding: 5px 10px; font-size: 0.75rem; font-weight: 600; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; text-decoration: none; transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px; }
    .btn-xs:hover { background: var(--accent); color: white; border-color: var(--accent); }

    /* Section header */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 1rem; font-weight: 700; }
    .view-all { font-size: 0.8rem; color: var(--accent); text-decoration: none; font-weight: 500; }
    .view-all:hover { text-decoration: underline; }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state i { font-size: 2rem; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 0.875rem; }

    /* Overlay */
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    .sidebar-overlay.visible { display: block; }

    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-row { grid-template-columns: 1fr; }
      .bottom-grid { grid-template-columns: 1fr; }
      .quick-actions { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.visible { display: block; }
      .main { margin-left: 0 !important; }
      .mobile-menu-btn { display: flex !important; }
      .top-bar { padding: 12px 16px; }
      .content { padding: 16px; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .quick-actions { grid-template-columns: repeat(2, 1fr); }
      .kpi-value { font-size: 1.4rem; }
    }
    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .quick-actions { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">◆</div><span>deeltrack</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item active"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="deals.html" class="nav-item"><i class="fas fa-building"></i><span>Deals</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="inbox.html" class="nav-item"><i class="fas fa-inbox"></i><span>Inbox</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name" id="userName">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <div class="page-title-bar">
          <h1>Dashboard</h1>
          <p id="greetingLine">Good morning — here's your portfolio overview</p>
        </div>
      </div>
      <div class="top-actions">
        <!-- Cloud sync indicator -->
        <div id="syncIndicator" title="Cloud sync status" style="display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--text-muted);padding:6px 10px;border-radius:var(--radius);background:var(--border-light);cursor:default;user-select:none;">
          <i class="fas fa-circle" id="syncDot" style="font-size:.55rem;color:var(--text-muted);"></i>
          <span id="syncLabel">Connecting…</span>
        </div>
        <button class="btn-icon notification-dot" title="Notifications"><i class="fas fa-bell"></i></button>
        <a href="new-deal.html" class="btn btn-primary"><i class="fas fa-plus"></i> New Deal</a>
      </div>
    </header>

    <div class="content">

      <!-- Alert banners (injected by JS) -->
      <div id="alertBanners"></div>

      <!-- Portfolio Map / View Toggle -->
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px;">
        <button class="btn btn-xs" id="listViewBtn" style="background:var(--accent);color:white;" onclick="togglePortfolioView('list')"><i class="fas fa-th-list"></i> List</button>
        <button class="btn btn-xs" id="mapViewBtn" onclick="togglePortfolioView('map')"><i class="fas fa-map-marked-alt"></i> Map</button>
      </div>

      <div id="portfolioListView">
        <!-- KPI Cards -->
        <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon blue"><i class="fas fa-building"></i></div>
          <div class="kpi-body">
            <div class="kpi-label">Total AUM</div>
            <div class="kpi-value" id="kpiAUM">$0</div>
            <div class="kpi-change up" id="kpiAUMChange"><i class="fas fa-arrow-up"></i> —</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon green"><i class="fas fa-stream"></i></div>
          <div class="kpi-body">
            <div class="kpi-label">Active Deals</div>
            <div class="kpi-value" id="kpiDeals">0</div>
            <div class="kpi-change neutral" id="kpiDealsChange"><i class="fas fa-minus"></i> —</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon amber"><i class="fas fa-users"></i></div>
          <div class="kpi-body">
            <div class="kpi-label">Total Investors</div>
            <div class="kpi-value" id="kpiInvestors">0</div>
            <div class="kpi-change up" id="kpiInvestorsChange"><i class="fas fa-arrow-up"></i> —</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon purple"><i class="fas fa-hand-holding-usd"></i></div>
          <div class="kpi-body">
            <div class="kpi-label">Distributions YTD</div>
            <div class="kpi-value" id="kpiDist">$0</div>
            <div class="kpi-change up" id="kpiDistChange"><i class="fas fa-arrow-up"></i> —</div>
          </div>
        </div>
      </div>

      </div> <!-- end portfolioListView -->

      <div id="portfolioMapView" style="display:none;margin-bottom:28px;">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <div class="card" style="padding:0;overflow:hidden;">
          <div id="map" style="height:460px;"></div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <a href="new-deal.html" class="qa-card">
          <div class="qa-icon blue"><i class="fas fa-plus-circle"></i></div>
          <div class="qa-label">New Deal</div>
          <div class="qa-desc">Start modeling a new acquisition</div>
        </a>
        <a href="investors.html" class="qa-card">
          <div class="qa-icon green"><i class="fas fa-user-plus"></i></div>
          <div class="qa-label">Add Investor</div>
          <div class="qa-desc">Onboard a new LP to your CRM</div>
        </a>
        <a href="documents.html" class="qa-card">
          <div class="qa-icon amber"><i class="fas fa-file-signature"></i></div>
          <div class="qa-label">Generate Document</div>
          <div class="qa-desc">OA, PPM, Subscription Agreement</div>
        </a>
        <a href="capital-calls.html" class="qa-card">
          <div class="qa-icon purple"><i class="fas fa-bell"></i></div>
          <div class="qa-label">Capital Call</div>
          <div class="qa-desc">Send notices to investors</div>
        </a>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Portfolio Mix</div>
              <div class="card-subtitle">By property type</div>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-wrap" style="height:200px; position:relative;">
              <canvas id="donutChart"></canvas>
              <div class="donut-center">
                <div class="value" id="donutTotal">—</div>
                <div class="label">Total Deals</div>
              </div>
            </div>
            <div class="chart-legend" id="donutLegend"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Deal Performance</div>
              <div class="card-subtitle">Projected IRR by deal</div>
            </div>
          </div>
          <div class="card-body">
            <div style="height:230px; position:relative;">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Grid: Activity + Deadlines -->
      <div class="bottom-grid">
        <!-- Deals Table -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Active Deals</div>
              <div class="card-subtitle">Recent deals in your portfolio</div>
            </div>
            <a href="pipeline.html" class="view-all">View Pipeline <i class="fas fa-arrow-right"></i></a>
          </div>
          <div class="card-body" style="padding-top:16px;">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Deal</th>
                    <th>Type</th>
                    <th>Raise</th>
                    <th>IRR</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="dealsTableBody">
                  <tr><td colspan="6"><div class="empty-state"><i class="fas fa-building"></i><p>No deals yet — <a href="new-deal.html" style="color:var(--accent);">add your first deal</a></p></div></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Right column: Activity + Deadlines -->
        <div style="display:flex; flex-direction:column; gap:20px;">
          <!-- Recent Activity -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Recent Activity</div>
              <a href="#" class="view-all" style="font-size:0.75rem;">Clear</a>
            </div>
            <div class="card-body" style="padding-top:8px;">
              <div class="activity-list" id="activityFeed">
                <div class="empty-state"><i class="fas fa-history"></i><p>No activity yet</p></div>
              </div>
            </div>
          </div>

          <!-- Upcoming Deadlines -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Upcoming Deadlines</div>
              <a href="pipeline.html" class="view-all" style="font-size:0.75rem;">See all</a>
            </div>
            <div class="card-body" style="padding-top:8px;">
              <div class="deadline-list" id="deadlineList">
                <div class="empty-state"><i class="fas fa-calendar-check"></i><p>No upcoming deadlines</p></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
// ── Mobile sidebar ──────────────────────────────────────────────
function togglePortfolioView(view) {
  const lv = document.getElementById('portfolioListView');
  const mv = document.getElementById('portfolioMapView');
  const lBtn = document.getElementById('listViewBtn');
  const mBtn = document.getElementById('mapViewBtn');
  if (view === 'map') {
    lv.style.display='none'; mv.style.display='block';
    mBtn.style.background='var(--accent)'; mBtn.style.color='white';
    lBtn.style.background=''; lBtn.style.color='';
    renderMap();
  } else {
    lv.style.display='block'; mv.style.display='none';
    lBtn.style.background='var(--accent)'; lBtn.style.color='white';
    mBtn.style.background=''; mBtn.style.color='';
  }
}

let _leafletMap = null;

async function renderMap() {
  const mapEl = document.getElementById('map');
  const deals = SP.getDeals().filter(d => d.location);

  if (!deals.length) {
    mapEl.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-muted);gap:12px;"><i class="fas fa-map-marked-alt" style="font-size:3rem;opacity:.3;"></i><p>Add deals with locations to see them on the map</p></div>';
    return;
  }

  // Wait for Leaflet to load
  if (typeof L === 'undefined') {
    await new Promise(resolve => {
      const check = setInterval(() => { if (typeof L !== 'undefined') { clearInterval(check); resolve(); } }, 100);
      setTimeout(() => { clearInterval(check); resolve(); }, 5000);
    });
  }
  if (typeof L === 'undefined') { mapEl.innerHTML = '<p style="padding:20px;">Map failed to load. Check your connection.</p>'; return; }

  // Destroy existing map instance if switching deals/views
  if (_leafletMap) { _leafletMap.remove(); _leafletMap = null; }

  // Init map centered on US
  _leafletMap = L.map('map', { zoomControl: true }).setView([37.8, -96], 4);

  // OpenStreetMap tiles — free, no API key
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19,
  }).addTo(_leafletMap);

  // Custom marker icon using SVG — blue pin
  function makeIcon(color) {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="36" viewBox="0 0 28 36">
      <path d="M14 0C6.27 0 0 6.27 0 14c0 9.63 14 22 14 22s14-12.37 14-22C28 6.27 21.73 0 14 0z" fill="${color}" stroke="white" stroke-width="2"/>
      <circle cx="14" cy="14" r="6" fill="white" opacity="0.9"/>
    </svg>`;
    return L.divIcon({
      html: svg,
      className: '',
      iconSize: [28, 36],
      iconAnchor: [14, 36],
      popupAnchor: [0, -36],
    });
  }

  const STATUS_COLORS = {
    operating: '#10b981', closed: '#8b5cf6', dd: '#3b82f6',
    loi: '#f59e0b', sourcing: '#94a3b8', archived: '#cbd5e1',
  };

  const geocodeCache = JSON.parse(localStorage.getItem('sp_geocache') || '{}');

  // Geocode each deal and place marker
  const markers = [];
  for (const deal of deals) {
    try {
      let coords = geocodeCache[deal.location];
      if (!coords) {
        const query = encodeURIComponent(deal.location);
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`, {
          headers: { 'Accept-Language': 'en', 'User-Agent': 'deeltrack/1.0' }
        });
        const data = await res.json();
        if (data[0]) {
          coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
          geocodeCache[deal.location] = coords;
          localStorage.setItem('sp_geocache', JSON.stringify(geocodeCache));
        }
      }
      if (!coords) continue;

      const color = STATUS_COLORS[deal.status] || '#64748b';
      const committed = (deal.investors || []).reduce((s, i) => s + (i.committed || 0), 0);
      const pct = deal.raise > 0 ? Math.round(committed / deal.raise * 100) : 0;
      const fmt$ = n => n >= 1e6 ? '$' + (n / 1e6).toFixed(1) + 'M' : n >= 1e3 ? '$' + (n / 1e3).toFixed(0) + 'K' : '$' + n;

      const marker = L.marker([coords.lat, coords.lon], { icon: makeIcon(color) }).addTo(_leafletMap);
      marker.bindPopup(`
        <div style="font-family:Inter,sans-serif;min-width:200px;">
          <div style="font-weight:700;font-size:.95rem;margin-bottom:4px;">${deal.name}</div>
          <div style="font-size:.78rem;color:#64748b;margin-bottom:10px;"><i class="fas fa-map-marker-alt" style="margin-right:4px;"></i>${deal.location}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
            <div style="background:#f8fafc;padding:8px;border-radius:6px;text-align:center;">
              <div style="font-size:.65rem;color:#94a3b8;text-transform:uppercase;font-weight:700;">Raise</div>
              <div style="font-weight:700;font-family:monospace;">${fmt$(deal.raise || 0)}</div>
            </div>
            <div style="background:#f8fafc;padding:8px;border-radius:6px;text-align:center;">
              <div style="font-size:.65rem;color:#94a3b8;text-transform:uppercase;font-weight:700;">IRR</div>
              <div style="font-weight:700;font-family:monospace;color:#10b981;">${deal.irr ? deal.irr.toFixed(1) + '%' : '—'}</div>
            </div>
          </div>
          <div style="background:#f1f5f9;border-radius:4px;height:6px;overflow:hidden;margin-bottom:6px;">
            <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;"></div>
          </div>
          <div style="font-size:.72rem;color:#64748b;">${pct}% raised · ${(deal.investors || []).length} investor${(deal.investors || []).length !== 1 ? 's' : ''}</div>
          <a href="deal-detail.html?id=${deal.id}" style="display:block;margin-top:10px;text-align:center;padding:6px;background:#3b82f6;color:white;border-radius:6px;text-decoration:none;font-size:.8rem;font-weight:600;">View Deal →</a>
        </div>
      `, { maxWidth: 240 });
      markers.push(marker);
    } catch(e) {
      console.warn('Geocode failed for', deal.location, e);
    }
  }

  // Fit map to markers if any placed
  if (markers.length > 1) {
    const group = L.featureGroup(markers);
    _leafletMap.fitBounds(group.getBounds().pad(0.15));
  } else if (markers.length === 1) {
    _leafletMap.setView(markers[0].getLatLng(), 10);
  }

  // Legend
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div');
    div.style.cssText = 'background:white;padding:10px 14px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.12);font-family:Inter,sans-serif;font-size:.72rem;';
    div.innerHTML = Object.entries(STATUS_COLORS).map(([s, c]) =>
      `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
        <div style="width:10px;height:10px;border-radius:50%;background:${c};"></div>
        <span style="text-transform:capitalize;">${s}</span>
      </div>`
    ).join('');
    return div;
  };
  legend.addTo(_leafletMap);
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('visible');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('visible');
}

// ── Greeting ────────────────────────────────────────────────────
function checkOnboarding() {
  const deals = SP.getDeals();
  const investors = SP.getInvestors();
  const settings = SP.load('settings', {});
  const realDeals = deals.filter(d => !['d1','d2','d3','d4','d5'].includes(d.id));
  const realInvestors = investors.filter(i => !['i1','i2','i3','i4','i5','i6'].includes(i.id));

  const steps = [
    { done: !!settings.firmName, label:'Set up your firm profile', link:'settings.html', icon:'fa-building' },
    { done: realDeals.length > 0, label:'Add your first real deal', link:'new-deal.html', icon:'fa-stream' },
    { done: realInvestors.length > 0, label:'Add your first investor', link:'investors.html', icon:'fa-user-plus' },
    { done: realDeals.some(d=>(d.investors||[]).length>0), label:'Link an investor to a deal', link:'investors.html', icon:'fa-link' },
  ];

  const incomplete = steps.filter(s => !s.done);
  if (!incomplete.length) return; // All done, no onboarding needed

  const container = document.getElementById('alertBanners');
  const banner = document.createElement('div');
  banner.style.cssText = 'background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:12px;padding:20px 24px;margin-bottom:16px;';
  banner.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div style="color:white;font-weight:700;font-size:1rem;"><i class="fas fa-rocket" style="color:#60a5fa;margin-right:8px;"></i>Getting Started — ${steps.filter(s=>s.done).length}/${steps.length} steps complete</div>
      <button onclick="this.closest('div[style]').remove()" style="background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:1rem;">✕</button>
    </div>
    <div style="height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin-bottom:16px;overflow:hidden;">
      <div style="height:100%;width:${Math.round(steps.filter(s=>s.done).length/steps.length*100)}%;background:linear-gradient(90deg,#3b82f6,#10b981);border-radius:4px;transition:width .6s;"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
      ${steps.map(s => `
        <a href="${s.link}" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${s.done?'rgba(16,185,129,.15)':'rgba(255,255,255,.07)'};border-radius:8px;text-decoration:none;transition:background .15s;">
          <div style="width:28px;height:28px;border-radius:50%;background:${s.done?'#10b981':'rgba(255,255,255,.15)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <i class="fas ${s.done?'fa-check':s.icon}" style="color:white;font-size:.75rem;"></i>
          </div>
          <span style="font-size:.82rem;color:${s.done?'#6ee7b7':'rgba(255,255,255,.7)'};font-weight:${s.done?'400':'600'};">${s.label}</span>
        </a>`).join('')}
    </div>`;
  if (container) container.insertBefore(banner, container.firstChild);
}

function renderAlerts() {
  const investors = SP.getInvestors();
  const today = new Date();
  const alerts = [];

  // Accreditation expiring in 30 days
  const expiring = investors.filter(inv => {
    if (!inv.accredExpiry || inv.accredStatus !== 'verified') return false;
    const days = Math.ceil((new Date(inv.accredExpiry) - today) / 86400000);
    return days >= 0 && days <= 30;
  });
  const expired = investors.filter(inv => {
    if (!inv.accredExpiry) return false;
    return new Date(inv.accredExpiry) < today && inv.accredStatus !== 'pending';
  });

  if (expired.length) alerts.push({
    type: 'danger', icon: 'fa-times-circle',
    msg: `<strong>${expired.length} investor accreditation${expired.length>1?'s':''} expired.</strong> Renewal required before new investments.`,
    link: 'investors.html', linkText: 'Review investors'
  });
  if (expiring.length) alerts.push({
    type: 'warning', icon: 'fa-exclamation-triangle',
    msg: `<strong>${expiring.length} accreditation${expiring.length>1?'s':''}</strong> expiring within 30 days: ${expiring.map(i=>`${i.firstName} ${i.lastName}`).join(', ')}.`,
    link: 'investors.html', linkText: 'Send renewal reminders'
  });

  // Form D filing reminder: check any deals that have investors but no Form D filed date
  const deals = SP.getDeals();
  deals.forEach(deal => {
    if (!deal.investors?.length) return;
    const firstLinked = deal.investors.reduce((earliest, inv) => {
      const t = inv.linkedAt ? new Date(inv.linkedAt) : null;
      return (!earliest || (t && t < earliest)) ? t : earliest;
    }, null);
    if (!firstLinked) return;
    const daysSinceFirst = Math.floor((today - firstLinked) / 86400000);
    if (daysSinceFirst >= 0 && !deal.formDFiled) {
      const key = `formd-${deal.id}`;
      if (daysSinceFirst >= 15 && !existing.find(n => n.id === key)) {
        alerts.push({
          type: 'warning', icon: 'fa-landmark',
          msg: `<strong>Form D reminder:</strong> ${deal.name} has had investors for ${daysSinceFirst} days. SEC Form D filing may be required within 15 days of first sale.`,
          link: 'https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&type=D&dateb=&owner=include&count=40', linkText: 'SEC EDGAR →'
        });
      }
    }
  });

  // Deals with upcoming LOI/close deadlines
  const urgentDeals = deals.filter(d => {
    if (!d.due) return false;
    const days = Math.ceil((new Date(d.due) - today) / 86400000);
    return days >= 0 && days <= 7;
  });
  if (urgentDeals.length) alerts.push({
    type: 'warning', icon: 'fa-clock',
    msg: `<strong>${urgentDeals.length} deal deadline${urgentDeals.length>1?'s':''}</strong> within 7 days: ${urgentDeals.map(d=>d.name).join(', ')}.`,
    link: 'pipeline.html', linkText: 'View pipeline'
  });

  const container = document.getElementById('alertBanners');
  if (!container || !alerts.length) return;
  const colors = { danger: '#fee2e2,#ef4444,#991b1b', warning: '#fef3c7,#f59e0b,#92400e' };
  container.innerHTML = alerts.map(a => {
    const [bg, border, text] = colors[a.type].split(',');
    return `<div style="background:${bg};border:1px solid ${border};border-radius:10px;padding:12px 18px;margin-bottom:12px;display:flex;align-items:center;gap:12px;font-size:.875rem;">
      <i class="fas ${a.icon}" style="color:${border};flex-shrink:0;"></i>
      <span style="color:${text};flex:1;">${a.msg}</span>
      <a href="${a.link}" style="color:${border};font-weight:600;text-decoration:none;white-space:nowrap;">${a.linkText} →</a>
    </div>`;
  }).join('');
}

function setGreeting() {
  const h = new Date().getHours();
  const greet = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  const session = JSON.parse(localStorage.getItem('sp_session') || '{}');
  const name = session.name ? `, ${session.name.split(' ')[0]}` : '';
  document.getElementById('greetingLine').textContent = `${greet}${name} — here's your portfolio overview`;
  if (session.name) document.getElementById('userName').textContent = session.name;
}

// ── Format helpers ──────────────────────────────────────────────
function fmt$(n) {
  if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
  return '$' + n.toFixed(0);
}
function fmtPct(n) { return n.toFixed(1) + '%'; }

// ── Demo data ───────────────────────────────────────────────────
const DEMO_DEALS = [
  { id:'d1', name:'Riverside Flats', type:'multifamily', raise:4200000, irr:18.5, equity:1.9, status:'operating', location:'Austin, TX', added:'2025-11-10', units:96, investors:[
    {investorId:'i1',committed:250000,status:'funded',ownership:5.95,date:'2025-11-15'},
    {investorId:'i2',committed:500000,status:'funded',ownership:11.9,date:'2025-11-20'},
    {investorId:'i4',committed:300000,status:'funded',ownership:7.14,date:'2025-12-01'},
    {investorId:'i7',committed:100000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d2', name:'Meridian Industrial', type:'industrial', raise:7500000, irr:21.2, equity:2.1, status:'closed', location:'Dallas, TX', added:'2025-12-01', units:0, investors:[
    {investorId:'i2',committed:750000,status:'funded',ownership:10,date:'2025-12-10'},
    {investorId:'i3',committed:250000,status:'funded',ownership:3.33,date:'2025-12-15'},
    {investorId:'i7',committed:150000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d3', name:'The Hudson Portfolio', type:'multifamily', raise:12000000, irr:16.8, equity:1.7, status:'operating', location:'Houston, TX', added:'2026-01-15', units:248, investors:[
    {investorId:'i1',committed:250000,status:'funded',ownership:2.08,date:'2026-01-20'},
    {investorId:'i2',committed:1000000,status:'funded',ownership:8.33,date:'2026-01-25'},
    {investorId:'i4',committed:700000,status:'funded',ownership:5.83,date:'2026-02-01'},
    {investorId:'i6',committed:350000,status:'funded',ownership:2.92,date:'2026-02-05'},
    {investorId:'i7',committed:200000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d4', name:'Parkview Commons', type:'multifamily', raise:3100000, irr:19.0, equity:1.95, status:'dd', location:'San Antonio, TX', added:'2026-02-01', units:72, investors:[
    {investorId:'i5',committed:150000,status:'committed',ownership:4.84,date:'2026-02-10'},
    {investorId:'i6',committed:200000,status:'committed',ownership:6.45,date:'2026-02-15'},
    {investorId:'i7',committed:75000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d5', name:'Westgate Retail Center', type:'retail', raise:5800000, irr:14.5, equity:1.6, status:'loi', location:'Fort Worth, TX', added:'2026-02-10', units:0, investors:[
    {investorId:'i7',committed:50000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d6', name:'Lone Star Self Storage', type:'self-storage', raise:2800000, irr:22.5, equity:2.4, status:'raising', location:'Corpus Christi, TX', added:'2026-02-20', units:450, investors:[
    {investorId:'i2',committed:400000,status:'committed',ownership:14.29,date:'2026-02-22'},
    {investorId:'i7',committed:125000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d7', name:'Brazos Hotel Group', type:'hospitality', raise:8500000, irr:17.2, equity:1.85, status:'loi', location:'Waco, TX', added:'2026-02-22', units:124, investors:[
    {investorId:'i3',committed:300000,status:'committed',ownership:3.53,date:'2026-02-24'},
    {investorId:'i4',committed:600000,status:'committed',ownership:7.06,date:'2026-02-24'},
    {investorId:'i7',committed:175000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
  { id:'d8', name:'Permian Basin Flex Industrial', type:'industrial', raise:5200000, irr:20.8, equity:2.0, status:'raising', location:'Midland, TX', added:'2026-02-24', units:0, investors:[
    {investorId:'i1',committed:350000,status:'committed',ownership:6.73,date:'2026-02-24'},
    {investorId:'i6',committed:275000,status:'committed',ownership:5.29,date:'2026-02-25'},
    {investorId:'i7',committed:200000,status:'committed',ownership:0,date:'2026-02-25'}
  ]},
];
const DEMO_INVESTORS = [
  { id:'i1', firstName:'James', lastName:'Hartwell', email:'j.hartwell@email.com', totalInvested:500000, deals:2, accredStatus:'verified', accredMethod:'cpa', status:'active' },
  { id:'i2', firstName:'Sarah', lastName:'Chen', email:'s.chen@capitalgroup.com', totalInvested:750000, deals:3, accredStatus:'verified', accredMethod:'entity', status:'active' },
  { id:'i3', firstName:'Marcus', lastName:'Williams', email:'mwilliams@invest.com', totalInvested:250000, deals:1, accredStatus:'verified', accredMethod:'attorney', status:'active' },
  { id:'i4', firstName:'Priya', lastName:'Patel', email:'ppatel@wealth.com', totalInvested:1000000, deals:2, accredStatus:'verified', accredMethod:'cpa', status:'active' },
  { id:'i5', firstName:'Robert', lastName:'Thompson', email:'r.thompson@gmail.com', totalInvested:150000, deals:1, accredStatus:'pending', accredMethod:'self', status:'active' },
  { id:'i6', firstName:'Elena', lastName:'Vasquez', email:'evasquez@invest.net', totalInvested:350000, deals:2, accredStatus:'verified', accredMethod:'broker', status:'active' },
  { id:'i7', firstName:'Phil', lastName:'Chapman', email:'philip@jchapmancpa.com', totalInvested:1075000, deals:8, accredStatus:'verified', accredMethod:'cpa', status:'active' },
];
const DEMO_ACTIVITY = [
  { icon:'fa-warehouse', color:'green', text:'<strong>Lone Star Self Storage</strong> opened for investment — $2.8M raise', time:'Just now' },
  { icon:'fa-hotel', color:'purple', text:'LOI signed for <strong>Brazos Hotel Group</strong> in Waco', time:'2 hours ago' },
  { icon:'fa-industry', color:'blue', text:'<strong>Permian Basin Flex Industrial</strong> launched — 22% target IRR', time:'4 hours ago' },
  { icon:'fa-building', color:'blue', text:'<strong>Parkview Commons</strong> moved to Due Diligence', time:'1 day ago' },
  { icon:'fa-user-plus', color:'green', text:'<strong>Phil Chapman</strong> added as new investor — 8 deals, $1.075M', time:'Yesterday at 3:14 PM' },
  { icon:'fa-file-contract', color:'amber', text:'PPM generated for <strong>Westgate Retail Center</strong>', time:'Yesterday at 11:02 AM' },
  { icon:'fa-wallet', color:'purple', text:'Q4 distribution of <strong>$84,200</strong> sent to 14 investors', time:'Feb 20, 2026' },
  { icon:'fa-file-invoice-dollar', color:'blue', text:'K-1s exported for <strong>Riverside Flats</strong> (12 investors)', time:'Feb 18, 2026' },
];
const DEMO_DEADLINES = [
  { day:'01', month:'MAR', name:'Lone Star Self Storage', type:'Raise Target Deadline', urgency:'urgent' },
  { day:'03', month:'MAR', name:'Permian Basin Industrial', type:'LOI Signing', urgency:'urgent' },
  { day:'28', month:'FEB', name:'Parkview Commons', type:'LOI Expiration', urgency:'urgent' },
  { day:'05', month:'MAR', name:'Westgate Retail', type:'Due Diligence Start', urgency:'soon' },
  { day:'10', month:'MAR', name:'Brazos Hotel Group', type:'Site Visit Scheduled', urgency:'soon' },
  { day:'15', month:'MAR', name:'Hudson Portfolio', type:'Q1 Distribution', urgency:'ok' },
  { day:'31', month:'MAR', name:'Meridian Industrial', type:'Investor Report Due', urgency:'ok' },
];

// ── Load data ───────────────────────────────────────────────────
function loadDeals() {
  const deals = SP.getDeals();
  if (deals && deals.length) return deals;
  // Only seed demo data for the demo GP account
  const session = SP.getSession();
  const isDemoAccount = ['gp@deeltrack.com','demo@deeltrack.com'].includes(session?.email?.toLowerCase());
  if (isDemoAccount) { SP.saveDeals(DEMO_DEALS); return DEMO_DEALS; }
  return [];
}
function loadInvestors() {
  const investors = SP.getInvestors();
  if (investors && investors.length) return investors;
  const session = SP.getSession();
  const isDemoAccount = ['gp@deeltrack.com','demo@deeltrack.com'].includes(session?.email?.toLowerCase());
  if (isDemoAccount) { SP.saveInvestors(DEMO_INVESTORS); return DEMO_INVESTORS; }
  return [];
}
function loadDistributionsYTD() {
  const dists = SP.getDistributions();
  if (dists && dists.length) {
    const year = new Date().getFullYear();
    return dists.filter(d => d.date && d.date.startsWith(year)).reduce((sum, d) => sum + (d.amount || 0), 0);
  }
  return 84200; // demo
}
function loadActivity() {
  const stored = SP.getActivity();
  if (stored && stored.length) return stored;
  return DEMO_ACTIVITY;
}

// ── Render KPIs ─────────────────────────────────────────────────
function renderKPIs(deals, investors, distYTD) {
  const aum = deals.reduce((s, d) => s + (d.raise || 0), 0);
  const activeDeals = deals.filter(d => ['sourcing','loi','dd','operating'].includes(d.status)).length;
  const totalCommitted = deals.reduce((s,d)=>(d.investors||[]).reduce((ss,i)=>ss+(i.committed||0),ss),0);
  const raisePct = aum > 0 ? Math.round(totalCommitted/aum*100) : 0;
  document.getElementById('kpiAUM').textContent = fmt$(aum);
  document.getElementById('kpiAUMChange').innerHTML = `<i class="fas fa-chart-line"></i> ${fmt$(totalCommitted)} raised (${raisePct}%)`;
  document.getElementById('kpiDeals').textContent = activeDeals;
  document.getElementById('kpiDealsChange').innerHTML = '<i class="fas fa-minus"></i> ' + deals.filter(d=>d.status==='closed').length + ' closed';
  document.getElementById('kpiDealsChange').className = 'kpi-change neutral';
  document.getElementById('kpiInvestors').textContent = investors.length;
  const accPct = Math.round(investors.filter(i=>i.accredStatus==='verified'||i.accredited===true).length / Math.max(investors.length,1) * 100);
  document.getElementById('kpiInvestorsChange').innerHTML = '<i class="fas fa-arrow-up"></i> ' + accPct + '% accredited';
  document.getElementById('kpiDist').textContent = fmt$(distYTD);
  document.getElementById('kpiDistChange').innerHTML = '<i class="fas fa-arrow-up"></i> YTD 2026';
}

// ── Donut Chart ─────────────────────────────────────────────────
function renderDonut(deals) {
  const types = { multifamily: 0, industrial: 0, retail: 0, office: 0, other: 0 };
  deals.forEach(d => { const k = types.hasOwnProperty(d.type) ? d.type : 'other'; types[k]++; });
  const labels = ['Multifamily','Industrial','Retail','Office','Other'];
  const keys = ['multifamily','industrial','retail','office','other'];
  const colors = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#94a3b8'];
  const data = keys.map(k => types[k]);
  const total = data.reduce((a,b)=>a+b,0);
  document.getElementById('donutTotal').textContent = total;

  const ctx = document.getElementById('donutChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets:[{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff', hoverBorderWidth: 3 }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '72%',
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.label}: ${c.parsed}` } } }
    }
  });

  const legend = document.getElementById('donutLegend');
  legend.innerHTML = keys.map((k,i) => types[k] > 0 ? `<div class="legend-item"><div class="legend-dot" style="background:${colors[i]}"></div>${labels[i]} (${types[k]})</div>` : '').join('');
}

// ── Bar Chart ───────────────────────────────────────────────────
function renderBar(deals) {
  const chartDeals = deals.filter(d => d.irr).slice(0, 8);
  const ctx = document.getElementById('barChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartDeals.map(d => d.name.length > 16 ? d.name.substring(0,14)+'…' : d.name),
      datasets: [{
        label: 'Projected IRR (%)',
        data: chartDeals.map(d => d.irr),
        backgroundColor: chartDeals.map(d => d.irr >= 20 ? '#10b981' : d.irr >= 15 ? '#3b82f6' : '#f59e0b'),
        borderRadius: 6, borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` IRR: ${c.parsed.y.toFixed(1)}%` } } },
      scales: {
        y: { beginAtZero: true, max: 30, grid: { color: '#f1f5f9' }, ticks: { callback: v => v+'%', font: { size: 11 }, color: '#94a3b8' } },
        x: { grid: { display: false }, ticks: { font: { size: 11 }, color: '#64748b' } }
      }
    }
  });
}

// ── Deals Table ─────────────────────────────────────────────────
function renderDealsTable(deals) {
  const tbody = document.getElementById('dealsTableBody');
  if (!deals.length) return;
  const statusMap = { sourcing:'badge-sourcing', loi:'badge-loi', dd:'badge-dd', closed:'badge-closed', operating:'badge-operating' };
  const statusLabel = { sourcing:'Sourcing', loi:'LOI', dd:'Due Diligence', closed:'Closed', operating:'Operating' };
  const typeMap = { multifamily:'badge-mf', industrial:'badge-ind', retail:'badge-ret', office:'badge-off' };
  const typeLabel = { multifamily:'Multifamily', industrial:'Industrial', retail:'Retail', office:'Office' };
  tbody.innerHTML = deals.slice(0,6).map(d => {
    const committed = (d.investors||[]).reduce((s,i)=>s+(i.committed||0),0);
    const pct = d.raise > 0 ? Math.min(100,Math.round(committed/d.raise*100)) : 0;
    const barColor = pct>=75?'var(--success)':pct>=40?'var(--accent)':'var(--warning)';
    return `<tr>
      <td><div style="font-weight:600;">${d.name}</div><div style="font-size:0.75rem;color:var(--text-muted);">${d.location||'—'}</div></td>
      <td><span class="badge ${typeMap[d.type]||'badge-sourcing'}">${typeLabel[d.type]||d.type||'—'}</span></td>
      <td>
        <div class="money-val">${fmt$(d.raise||0)}</div>
        <div style="margin-top:4px;height:4px;background:var(--border-light);border-radius:4px;overflow:hidden;width:80px;"><div style="height:100%;width:${pct}%;background:${barColor};border-radius:4px;"></div></div>
        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;">${fmt$(committed)} (${pct}%)</div>
      </td>
      <td class="irr-val">${d.irr ? fmtPct(d.irr) : '—'}</td>
      <td><span class="badge ${statusMap[d.status]||'badge-sourcing'}">${statusLabel[d.status]||d.status||'—'}</span></td>
      <td><div class="action-btns">
        <a href="deal-detail.html?id=${d.id}" class="btn-xs"><i class="fas fa-eye"></i></a>
        <a href="new-deal.html?id=${d.id}" class="btn-xs"><i class="fas fa-calculator"></i></a>
      </div></td>
    </tr>`;
  }).join('');
}

// ── Activity Feed ───────────────────────────────────────────────
function renderActivity(activity) {
  const el = document.getElementById('activityFeed');
  if (!activity.length) return;
  el.innerHTML = activity.slice(0,5).map(a => `
    <div class="activity-item">
      <div class="activity-icon ${a.color}"><i class="fas ${a.icon}"></i></div>
      <div class="activity-body">
        <div class="activity-text">${a.text}</div>
        <div class="activity-time">${a.time}</div>
      </div>
    </div>`).join('');
}

// ── Deadlines ───────────────────────────────────────────────────
function renderDeadlines() {
  const el = document.getElementById('deadlineList');
  const dl = DEMO_DEADLINES;
  if (!dl.length) return;
  const badgeMap = { urgent:'badge-urgent', soon:'badge-soon', ok:'badge-ok' };
  const badgeLabel = { urgent:'Urgent', soon:'Coming up', ok:'Scheduled' };
  el.innerHTML = dl.map(d => `
    <div class="deadline-item">
      <div class="deadline-date"><div class="day">${d.day}</div><div class="month">${d.month}</div></div>
      <div class="deadline-info">
        <div class="deadline-name">${d.name}</div>
        <div class="deadline-type">${d.type}</div>
      </div>
      <span class="deadline-badge ${badgeMap[d.urgency]}">${badgeLabel[d.urgency]}</span>
    </div>`).join('');
}

// ── Init ────────────────────────────────────────────────────────
(function init() {
  SP.requireGP();
  setGreeting();
  renderAlerts();
  checkOnboarding();

  // Show skeleton loading state on KPI values
  ['kpiAUM','kpiDeals','kpiInvestors','kpiDist'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.opacity = '0.3'; el.textContent = '…'; }
  });

  // Load data — if Firebase is ready pull fresh data first

  // SPData fires 'spdata-ready' when Firestore cache is warm — re-render with live data
  function _render() {
    const deals = SP.getDeals();
    const investors = SP.getInvestors();
    const distYTD = loadDistributionsYTD();
    const activity = loadActivity();
    ['kpiAUM','kpiDeals','kpiInvestors','kpiDist'].forEach(id => {
      const el = document.getElementById(id); if (el) el.style.opacity = '1';
    });
    renderKPIs(deals, investors, distYTD);
    renderDonut(deals); renderBar(deals); renderDealsTable(deals);
    renderActivity(activity); renderDeadlines();
  }

  // Show cached/demo data immediately, then re-render when Firestore ready
  _render();
  window.addEventListener('spdata-ready', _render);

  // Demo data already seeded via loadDeals/loadInvestors above

  // ── Cloud sync indicator ────────────────────────────────────────────────────
  function updateSyncIndicator() {
    const dot = document.getElementById('syncDot');
    const label = document.getElementById('syncLabel');
    if (!dot || !label) return;
    if (typeof SPFB === 'undefined') {
      dot.style.color = '#6b7280'; label.textContent = 'Local only';
    } else if (SPFB.isOffline()) {
      dot.style.color = '#ef4444'; label.textContent = 'Offline';
    } else if (SPFB.isReady()) {
      dot.style.color = '#10b981'; label.textContent = 'Cloud synced';
      // Patch SP.* once ready so all saves go to Firestore
      if (typeof SPFB.patchSPCore === 'function') SPFB.patchSPCore();
    } else {
      dot.style.color = '#f59e0b'; label.textContent = 'Syncing…';
      setTimeout(updateSyncIndicator, 1500);
    }
  }

  // Poll once immediately, then again when SPFB is ready
  updateSyncIndicator();
  window.addEventListener('spdata-ready', updateSyncIndicator);

  // ── Push demo data to Firebase ─────────────────────────────────────────────
  async function pushDemoDataToFirebase() {
    if (typeof SPFB === 'undefined' || !SPFB.isReady()) {
      alert('Firebase not ready. Please wait for the sync indicator to turn green.');
      return;
    }
    
    const btn = document.getElementById('pushDemoBtn');
    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pushing…'; }
    
    try {
      // Push all demo investors including Phil
      const investors = SP.getInvestors().length ? SP.getInvestors() : DEMO_INVESTORS.map(i => ({...i}));
      await SPFB.saveInvestors(investors);
      console.log('Pushed', investors.length, 'investors to Firebase');
      
      // Push all demo deals with investor links
      const deals = SP.getDeals().length ? SP.getDeals() : DEMO_DEALS.map(d => ({...d}));
      for (const deal of deals) {
        await SPFB.saveDeal(deal);
      }
      console.log('Pushed', deals.length, 'deals to Firebase');
      
      // Push demo distributions
      const dists = [
        { id: 'dist_1', dealId: 'd1', date: '2025-12-15', totalAmount: 42000, recipients: [{investorId: 'i1', amount: 10000}, {investorId: 'i2', amount: 20000}, {investorId: 'i4', amount: 12000}] },
        { id: 'dist_2', dealId: 'd1', date: '2026-03-15', totalAmount: 45000, recipients: [{investorId: 'i1', amount: 11000}, {investorId: 'i2', amount: 21000}, {investorId: 'i4', amount: 13000}] },
        { id: 'dist_3', dealId: 'd3', date: '2026-02-28', totalAmount: 85000, recipients: [{investorId: 'i1', amount: 8000}, {investorId: 'i2', amount: 32000}, {investorId: 'i4', amount: 22000}, {investorId: 'i6', amount: 11000}, {investorId: 'i7', amount: 12000}] },
      ];
      for (const dist of dists) {
        await SPFB.saveDistribution(dist);
      }
      console.log('Pushed', dists.length, 'distributions to Firebase');
      
      alert('✅ Demo data pushed to Firebase! All investors can now access their deals across devices.');
      SP.logActivity('fa-cloud-upload-alt', 'blue', 'Demo data synced to Firebase');
      
    } catch (err) {
      console.error('Push failed:', err);
      alert('❌ Failed to push: ' + err.message);
    }
    
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Sync Demo Data to Cloud'; }
  }

})();
</script>
</body>
</html>
