<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack â€” Investor Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-firebase.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1a2332;
      min-height: 100vh;
    }

    /* â”€â”€ Top Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topnav {
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 32px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .topnav-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #1a2332;
      text-decoration: none;
    }
    .topnav-brand .brand-dot {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, #6366f1, #818cf8);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 0.75rem; font-weight: 700;
    }
    .topnav-badge {
      background: #ede9fe;
      color: #6366f1;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 999px;
      letter-spacing: 0.05em;
    }
    .topnav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .topnav-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1a2332;
    }
    .topnav-avatar {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #6366f1, #818cf8);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 0.8rem; font-weight: 700;
      cursor: pointer;
    }
    .topnav-signout {
      font-size: 0.8rem;
      color: #94a3b8;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      background: none;
      font-family: inherit;
      transition: all 0.15s;
    }
    .topnav-signout:hover { background: #f8fafc; color: #475569; }

    /* â”€â”€ Tab Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabnav {
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 32px;
      display: flex;
      gap: 0;
    }
    .tabnav-item {
      padding: 14px 20px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 7px;
      white-space: nowrap;
    }
    .tabnav-item:hover { color: #1a2332; }
    .tabnav-item.active { color: #6366f1; border-bottom-color: #6366f1; font-weight: 600; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page { display: none; padding: 32px; max-width: 1200px; margin: 0 auto; }
    .page.active { display: block; }

    /* â”€â”€ Hero Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero {
      background: linear-gradient(135deg, #6366f1 0%, #818cf8 60%, #a5b4fc 100%);
      border-radius: 16px;
      padding: 36px 40px;
      color: white;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    .hero::after {
      content: '';
      position: absolute;
      right: -40px; top: -40px;
      width: 220px; height: 220px;
      background: rgba(255,255,255,0.07);
      border-radius: 50%;
    }
    .hero h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 6px; }
    .hero p { font-size: 0.95rem; opacity: 0.85; }
    .hero-stats {
      display: flex;
      gap: 40px;
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .hero-stat-label { font-size: 0.75rem; opacity: 0.75; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
    .hero-stat-value { font-size: 1.6rem; font-weight: 700; }
    .hero-stat-sub { font-size: 0.8rem; opacity: 0.75; margin-top: 2px; }

    /* â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      border: 1px solid #e2e8f0;
    }
    .stat-card-label { font-size: 0.78rem; font-weight: 500; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .stat-card-value { font-size: 1.5rem; font-weight: 700; color: #1a2332; }
    .stat-card-sub { font-size: 0.78rem; color: #94a3b8; margin-top: 4px; }
    .stat-card-badge {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 0.75rem; font-weight: 600;
      padding: 2px 8px; border-radius: 999px; margin-top: 6px;
    }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-blue  { background: #dbeafe; color: #2563eb; }
    .badge-amber { background: #fef3c7; color: #d97706; }
    .badge-purple{ background: #ede9fe; color: #7c3aed; }

    /* â”€â”€ Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #1a2332;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title i { color: #6366f1; }

    /* â”€â”€ Investment Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .investments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .inv-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .inv-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .inv-card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .inv-card-name { font-size: 1rem; font-weight: 700; color: #1a2332; margin-bottom: 4px; }
    .inv-card-type { font-size: 0.78rem; color: #94a3b8; }
    .inv-card-status {
      font-size: 0.72rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .status-operating { background: #dcfce7; color: #16a34a; }
    .status-closed    { background: #e0e7ff; color: #4338ca; }
    .status-raising   { background: #fef3c7; color: #d97706; }
    .status-dd        { background: #fee2e2; color: #dc2626; }
    .status-loi       { background: #f3f4f6; color: #6b7280; }
    .inv-card-body { padding: 20px 24px; }
    .inv-card-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .inv-metric-label { font-size: 0.72rem; color: #94a3b8; margin-bottom: 3px; }
    .inv-metric-value { font-size: 1rem; font-weight: 600; color: #1a2332; }
    .inv-metric-value.green { color: #16a34a; }
    .inv-card-footer {
      padding: 14px 24px;
      background: #f8fafc;
      border-top: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .inv-card-location { font-size: 0.78rem; color: #94a3b8; display: flex; align-items: center; gap: 5px; }

    /* â”€â”€ Distributions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dist-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    .dist-table th {
      padding: 12px 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #94a3b8;
      text-align: left;
      background: #f8fafc;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #e2e8f0;
    }
    .dist-table td {
      padding: 16px 20px;
      font-size: 0.875rem;
      color: #1a2332;
      border-bottom: 1px solid #f1f5f9;
    }
    .dist-table tr:last-child td { border-bottom: none; }
    .dist-amount { font-weight: 700; color: #16a34a; font-size: 1rem; }

    /* â”€â”€ Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .doc-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .doc-card:hover { border-color: #6366f1; box-shadow: 0 4px 12px rgba(99,102,241,0.1); }
    .doc-icon {
      width: 40px; height: 40px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
    }
    .doc-icon.pdf   { background: #fee2e2; color: #dc2626; }
    .doc-icon.word  { background: #dbeafe; color: #2563eb; }
    .doc-icon.other { background: #f3f4f6; color: #6b7280; }
    .doc-name { font-size: 0.875rem; font-weight: 600; color: #1a2332; line-height: 1.3; }
    .doc-meta { font-size: 0.75rem; color: #94a3b8; }

    /* â”€â”€ Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 32px;
      max-width: 560px;
    }
    .profile-avatar {
      width: 72px; height: 72px;
      background: linear-gradient(135deg, #6366f1, #818cf8);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.5rem; font-weight: 700;
      margin-bottom: 20px;
    }
    .profile-field { margin-bottom: 20px; }
    .profile-label { font-size: 0.78rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .profile-value { font-size: 0.95rem; color: #1a2332; font-weight: 500; }
    .accred-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: #dcfce7; color: #16a34a;
      padding: 5px 12px; border-radius: 999px;
      font-size: 0.8rem; font-weight: 600;
    }
    .accred-badge.pending { background: #fef3c7; color: #d97706; }

    /* â”€â”€ Empty States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }
    .empty i { font-size: 2.5rem; margin-bottom: 16px; display: block; opacity: 0.4; }
    .empty h3 { font-size: 1rem; font-weight: 600; color: #475569; margin-bottom: 8px; }
    .empty p { font-size: 0.875rem; }

    /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loadingOverlay {
      position: fixed; inset: 0;
      background: #f0f4f8;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 1000;
      gap: 16px;
    }
    #loadingOverlay .spin {
      width: 40px; height: 40px;
      border: 3px solid #e2e8f0;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loadingOverlay p { color: #94a3b8; font-size: 0.875rem; }

    /* â”€â”€ No-access screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #noAccessScreen {
      display: none;
      position: fixed; inset: 0;
      background: #f0f4f8;
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .noaccess-card {
      background: white;
      border-radius: 16px;
      padding: 48px;
      max-width: 440px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    .noaccess-icon { font-size: 2.5rem; margin-bottom: 20px; }
    .noaccess-card h2 { font-size: 1.25rem; font-weight: 700; color: #1a2332; margin-bottom: 10px; }
    .noaccess-card p { font-size: 0.875rem; color: #64748b; line-height: 1.6; margin-bottom: 16px; }
    .noaccess-email { font-size: 0.8rem; color: #94a3b8; margin-bottom: 24px; }
    .btn-signout {
      background: #6366f1; color: white;
      padding: 10px 24px; border-radius: 8px;
      border: none; cursor: pointer; font-family: inherit;
      font-weight: 600; font-size: 0.875rem;
      margin-right: 10px;
    }
    .btn-refresh {
      background: white; color: #475569;
      padding: 10px 24px; border-radius: 8px;
      border: 1px solid #e2e8f0; cursor: pointer;
      font-family: inherit; font-weight: 600; font-size: 0.875rem;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    /* â”€â”€ Capital Call Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .call-card { background:white; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:16px; overflow:hidden; }
    .call-card-header { padding:20px 24px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f1f5f9; }
    .call-card-title { font-size:1rem; font-weight:700; color:#1a2332; }
    .call-card-deal { font-size:0.8rem; color:#94a3b8; margin-top:3px; }
    .call-amount { font-size:1.4rem; font-weight:700; color:#d97706; }
    .call-due { font-size:0.78rem; color:#94a3b8; margin-top:3px; text-align:right; }
    .call-due.urgent { color:#dc2626; font-weight:600; }
    .call-card-body { padding:20px 24px; }
    .call-wire { background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:16px; font-size:0.8rem; color:#92400e; white-space:pre-line; line-height:1.7; margin-top:12px; }
    .call-badge-paid { background:#dcfce7; color:#16a34a; font-size:0.72rem; font-weight:600; padding:4px 10px; border-radius:999px; }
    .call-badge-due  { background:#fef3c7; color:#d97706; font-size:0.72rem; font-weight:600; padding:4px 10px; border-radius:999px; }
    .call-badge-overdue { background:#fee2e2; color:#dc2626; font-size:0.72rem; font-weight:600; padding:4px 10px; border-radius:999px; }

    /* â”€â”€ Tax Doc Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tax-table { width:100%; border-collapse:collapse; background:white; border-radius:12px; overflow:hidden; border:1px solid #e2e8f0; }
    .tax-table th { padding:12px 20px; font-size:0.75rem; font-weight:600; color:#94a3b8; text-align:left; background:#f8fafc; text-transform:uppercase; letter-spacing:0.05em; border-bottom:1px solid #e2e8f0; }
    .tax-table td { padding:16px 20px; font-size:0.875rem; border-bottom:1px solid #f1f5f9; }
    .tax-table tr:last-child td { border-bottom:none; }
    .tax-dl-btn { display:inline-flex; align-items:center; gap:6px; background:#ede9fe; color:#6366f1; padding:6px 14px; border-radius:6px; font-size:0.78rem; font-weight:600; border:none; cursor:pointer; font-family:inherit; text-decoration:none; }
    .tax-dl-btn:hover { background:#ddd6fe; }

    @media (max-width: 768px) {
      .topnav { padding: 0 16px; }
      .tabnav { padding: 0; overflow-x: auto; }
      .page { padding: 16px; }
      .stat-row { grid-template-columns: repeat(2, 1fr); }
      .hero-stats { flex-wrap: wrap; gap: 20px; }
      .investments-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="spin"></div>
  <p>Loading your portfolioâ€¦</p>
</div>

<!-- No access -->
<div id="noAccessScreen">
  <div class="noaccess-card">
    <div class="noaccess-icon">ğŸ”</div>
    <h2>Account not linked</h2>
    <p>Your account is set up but hasn't been linked to any investments yet. Your GP needs to add you to the investor CRM.</p>
    <p class="noaccess-email">Signed in as: <strong id="noAccessEmail">â€”</strong></p>
    <button class="btn-refresh" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Refresh</button>
    <button class="btn-signout" onclick="SP.logout()">Sign Out</button>
  </div>
</div>

<!-- Top Nav -->
<nav class="topnav">
  <a class="topnav-brand" href="#">
    <div class="brand-dot">d</div>
    deeltrack
    <span class="topnav-badge">INVESTOR PORTAL</span>
  </a>
  <div class="topnav-right">
    <span class="topnav-name" id="navName"></span>
    <div class="topnav-avatar" id="navAvatar" title="Your account"></div>
    <button class="topnav-signout" onclick="SP.logout()"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
  </div>
</nav>

<!-- Tab Nav -->
<div class="tabnav">
  <div class="tabnav-item active" onclick="showPage('overview', this)"><i class="fas fa-th-large"></i> Overview</div>
  <div class="tabnav-item" onclick="showPage('investments', this)"><i class="fas fa-building"></i> My Investments</div>
  <div class="tabnav-item" onclick="showPage('distributions', this)"><i class="fas fa-wallet"></i> Distributions</div>
  <div class="tabnav-item" onclick="showPage('capitalcalls', this)"><i class="fas fa-file-invoice-dollar"></i> Capital Calls</div>
  <div class="tabnav-item" onclick="showPage('taxdocs', this)"><i class="fas fa-receipt"></i> Tax Documents</div>
  <div class="tabnav-item" onclick="showPage('documents', this)"><i class="fas fa-file-alt"></i> Documents</div>
  <div class="tabnav-item" onclick="showPage('profile', this)"><i class="fas fa-user-circle"></i> My Profile</div>
</div>

<!-- â”€â”€ OVERVIEW PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page active" id="page-overview">
  <div class="hero">
    <h1 id="heroGreeting">Good morning</h1>
    <p id="heroSub">Here's your investment portfolio at a glance.</p>
    <div class="hero-stats">
      <div>
        <div class="hero-stat-label">Total Invested</div>
        <div class="hero-stat-value" id="heroTotal">â€”</div>
        <div class="hero-stat-sub" id="heroDealsCount">â€” active investments</div>
      </div>
      <div>
        <div class="hero-stat-label">Distributions Received</div>
        <div class="hero-stat-value" id="heroDists">â€”</div>
        <div class="hero-stat-sub" id="heroDistCount">â€” payments</div>
      </div>
      <div>
        <div class="hero-stat-label">Avg. Target IRR</div>
        <div class="hero-stat-value" id="heroIRR">â€”</div>
        <div class="hero-stat-sub">across your portfolio</div>
      </div>
      <div>
        <div class="hero-stat-label">Accreditation</div>
        <div class="hero-stat-value" id="heroAccred">â€”</div>
        <div class="hero-stat-sub" id="heroAccredSub">â€”</div>
      </div>
    </div>
  </div>

  <div class="stat-row">
    <div class="stat-card">
      <div class="stat-card-label">Active Deals</div>
      <div class="stat-card-value" id="statActive">â€”</div>
      <div class="stat-card-sub">Currently operating</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Pending / In Progress</div>
      <div class="stat-card-value" id="statPending">â€”</div>
      <div class="stat-card-sub">Raising or due diligence</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">YTD Distributions</div>
      <div class="stat-card-value" id="statYTD">â€”</div>
      <div class="stat-card-sub">This calendar year</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Avg. Equity Multiple</div>
      <div class="stat-card-value" id="statMultiple">â€”</div>
      <div class="stat-card-sub">Target across portfolio</div>
    </div>
  </div>

  <div class="section-title"><i class="fas fa-clock"></i> Recent Activity</div>
  <div id="recentActivity" style="background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden;"></div>
</div>

<!-- â”€â”€ INVESTMENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-investments">
  <div class="section-title" style="margin-bottom:20px;"><i class="fas fa-building"></i> My Investments</div>
  <div class="investments-grid" id="investmentsGrid"></div>
</div>

<!-- â”€â”€ DISTRIBUTIONS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-distributions">
  <div class="section-title" style="margin-bottom:20px;"><i class="fas fa-wallet"></i> Distribution History</div>
  <div id="distributionsContent"></div>
</div>

<!-- â”€â”€ CAPITAL CALLS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-capitalcalls">
  <div class="section-title" style="margin-bottom:8px;"><i class="fas fa-file-invoice-dollar"></i> Capital Calls</div>
  <p style="color:#64748b;font-size:0.875rem;margin-bottom:24px;">Funding requests from your GP. Wire instructions are included with each call.</p>
  <div id="capitalCallsContent"></div>
</div>

<!-- â”€â”€ TAX DOCUMENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-taxdocs">
  <div class="section-title" style="margin-bottom:8px;"><i class="fas fa-receipt"></i> Tax Documents</div>
  <p style="color:#64748b;font-size:0.875rem;margin-bottom:24px;">K-1s and other tax documents for your investments. Available after year-end processing.</p>
  <div id="taxDocsContent"></div>
</div>

<!-- â”€â”€ DOCUMENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-documents">
  <div class="section-title" style="margin-bottom:20px;"><i class="fas fa-file-alt"></i> My Documents</div>
  <div class="doc-grid" id="documentsGrid"></div>
</div>

<!-- â”€â”€ PROFILE PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-profile">
  <div class="section-title" style="margin-bottom:20px;"><i class="fas fa-user"></i> My Profile</div>
  <div class="profile-card" id="profileCard"></div>
</div>

<script>
  SP.requireInvestor();

  let session = SP.getSession(); // refreshed in init() after SPFB ready
  let investorRecord = null;
  let myDeals = [];
  let myDists = [];

  // â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tabnav-item').forEach(t => t.classList.remove('active'));
    document.getElementById('page-' + name)?.classList.add('active');
    if (el) el.classList.add('active');
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmt$(n) {
    if (!n && n !== 0) return 'â€”';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Number(n).toLocaleString();
  }
  function fmtFull$(n) { return '$' + Number(n||0).toLocaleString(); }

  function statusLabel(s) {
    return { operating:'Operating', closed:'Closed', raising:'Raising', dd:'Due Diligence', loi:'LOI', funded:'Funded', committed:'Committed' }[s] || s || 'â€”';
  }
  function statusClass(s) {
    return { operating:'status-operating', closed:'status-closed', raising:'status-raising', dd:'status-dd', loi:'status-loi', funded:'status-operating', committed:'status-raising' }[s] || 'status-loi';
  }

  // â”€â”€ Personalize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function personalize() {
    const name = session?.name || 'Investor';
    const first = name.split(' ')[0];
    const h = new Date().getHours();
    const greet = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('heroGreeting').textContent = greet + ', ' + first + '.';
    document.getElementById('navName').textContent = first;
    document.getElementById('navAvatar').textContent = name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    document.title = `deeltrack â€” ${first}'s Portal`;
  }

  // â”€â”€ Render Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderOverview() {
    const totalInvested = myDeals.reduce((s, {entry}) => s + (entry?.committed || 0), 0);
    const avgIRR = myDeals.length ? (myDeals.reduce((s, {deal}) => s + (deal.irr || 0), 0) / myDeals.length).toFixed(1) : 'â€”';
    const avgMult = myDeals.length ? (myDeals.reduce((s, {deal}) => s + (deal.equity || 0), 0) / myDeals.length).toFixed(2) : 'â€”';
    const active = myDeals.filter(({deal}) => ['operating','funded','active'].includes(deal.status)).length;
    const pending = myDeals.filter(({deal}) => ['raising','dd','loi','committed'].includes(deal.status)).length;
    const totalDist = myDists.reduce((s, d) => {
      const rec = (d.recipients||[]).find(r => r.investorId === investorRecord.id);
      return s + (rec?.amount || d.amount || 0);
    }, 0);
    const ytdDist = myDists.filter(d => new Date(d.date).getFullYear() === new Date().getFullYear())
      .reduce((s, d) => {
        const rec = (d.recipients||[]).find(r => r.investorId === investorRecord.id);
        return s + (rec?.amount || d.amount || 0);
      }, 0);

    // Hero
    document.getElementById('heroTotal').textContent = fmt$(totalInvested);
    document.getElementById('heroDealsCount').textContent = myDeals.length + ' active investment' + (myDeals.length !== 1 ? 's' : '');
    document.getElementById('heroDists').textContent = fmt$(totalDist);
    document.getElementById('heroDistCount').textContent = myDists.length + ' payment' + (myDists.length !== 1 ? 's' : '');
    document.getElementById('heroIRR').textContent = avgIRR !== 'â€”' ? avgIRR + '%' : 'â€”';

    const verified = investorRecord?.accredStatus === 'verified';
    document.getElementById('heroAccred').textContent = verified ? 'âœ“ Verified' : 'Pending';
    document.getElementById('heroAccredSub').textContent = verified ? 'Accredited investor' : 'Verification in progress';

    // Stats
    document.getElementById('statActive').textContent = active;
    document.getElementById('statPending').textContent = pending;
    document.getElementById('statYTD').textContent = fmt$(ytdDist);
    document.getElementById('statMultiple').textContent = avgMult !== 'â€”' ? avgMult + 'x' : 'â€”';

    // Recent activity (most recent 5 distributions + deals)
    const items = [];
    myDists.slice(0, 3).forEach(d => {
      const rec = (d.recipients||[]).find(r => r.investorId === investorRecord.id);
      const amount = rec?.amount || d.amount || 0;
      if (amount) items.push({ icon: 'fa-wallet', color: '#16a34a', bg: '#dcfce7', text: `Distribution received for <strong>${myDeals.find(m=>m.deal.id===d.dealId)?.deal.name || 'a deal'}</strong>`, amount: fmtFull$(amount), date: d.date });
    });
    myDeals.slice(0, 3).forEach(({deal, entry}) => {
      items.push({ icon: 'fa-building', color: '#6366f1', bg: '#ede9fe', text: `Committed <strong>${fmt$(entry?.committed||0)}</strong> to <strong>${deal.name}</strong>`, date: entry?.date || deal.added });
    });
    items.sort((a, b) => new Date(b.date) - new Date(a.date));

    document.getElementById('recentActivity').innerHTML = items.length ? items.slice(0, 6).map(item => `
      <div style="display:flex;align-items:center;gap:14px;padding:16px 20px;border-bottom:1px solid #f1f5f9;">
        <div style="width:36px;height:36px;border-radius:50%;background:${item.bg};color:${item.color};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <i class="fas ${item.icon}" style="font-size:0.875rem;"></i>
        </div>
        <div style="flex:1;font-size:0.875rem;color:#475569;">${item.text}</div>
        ${item.amount ? `<div style="font-weight:700;color:#16a34a;font-size:0.9rem;">${item.amount}</div>` : ''}
        <div style="font-size:0.75rem;color:#94a3b8;white-space:nowrap;">${item.date ? new Date(item.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''}</div>
      </div>
    `).join('') : '<div class="empty" style="padding:40px;"><i class="fas fa-clock" style="font-size:1.5rem;opacity:0.3;display:block;margin-bottom:10px;"></i><p style="color:#94a3b8;font-size:0.875rem;">No recent activity yet.</p></div>';
  }

  // â”€â”€ Render Investments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderInvestments() {
    const grid = document.getElementById('investmentsGrid');
    if (!myDeals.length) {
      grid.innerHTML = '<div class="empty" style="grid-column:1/-1;"><i class="fas fa-building"></i><h3>No investments yet</h3><p>Your GP will link you to deals shortly.</p></div>';
      return;
    }
    grid.innerHTML = myDeals.map(({deal, entry}) => `
      <div class="inv-card">
        <div class="inv-card-header">
          <div>
            <div class="inv-card-name">${deal.name}</div>
            <div class="inv-card-type">${(deal.type||'').replace('-',' ').replace(/\b\w/g,l=>l.toUpperCase())}</div>
          </div>
          <span class="inv-card-status ${statusClass(deal.status)}">${statusLabel(deal.status)}</span>
        </div>
        <div class="inv-card-body">
          <div class="inv-card-metrics">
            <div>
              <div class="inv-metric-label">My Commitment</div>
              <div class="inv-metric-value">${fmt$(entry?.committed)}</div>
            </div>
            <div>
              <div class="inv-metric-label">Target IRR</div>
              <div class="inv-metric-value green">${deal.irr ? deal.irr + '%' : 'â€”'}</div>
            </div>
            <div>
              <div class="inv-metric-label">Equity Multiple</div>
              <div class="inv-metric-value">${deal.equity ? deal.equity + 'x' : 'â€”'}</div>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span class="inv-metric-label">Status</span>
            <span style="font-size:0.8rem;font-weight:600;color:#475569;">${statusLabel(entry?.status || deal.status)}</span>
          </div>
        </div>
        <div class="inv-card-footer">
          <div class="inv-card-location"><i class="fas fa-map-marker-alt"></i> ${deal.location || 'â€”'}</div>
          <div style="font-size:0.75rem;color:#94a3b8;">${deal.raise ? fmt$(deal.raise) + ' total raise' : ''}</div>
        </div>
      </div>
    `).join('');
  }

  // â”€â”€ Render Distributions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDistributions() {
    const el = document.getElementById('distributionsContent');
    if (!myDists.length) {
      el.innerHTML = '<div class="empty"><i class="fas fa-wallet"></i><h3>No distributions yet</h3><p>Distributions will appear here when your GP processes them.</p></div>';
      return;
    }
    el.innerHTML = `<table class="dist-table">
      <thead><tr>
        <th>Deal</th><th>Date</th><th>Your Amount</th><th>Payment Total</th>
      </tr></thead>
      <tbody>${myDists.map(d => {
        const rec = (d.recipients||[]).find(r => r.investorId === investorRecord.id);
        const amount = rec?.amount || d.amount || 0;
        const dealName = myDeals.find(m=>m.deal.id===d.dealId)?.deal.name || 'â€”';
        return `<tr>
          <td><strong>${dealName}</strong></td>
          <td>${d.date ? new Date(d.date).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) : 'â€”'}</td>
          <td><span class="dist-amount">${fmtFull$(amount)}</span></td>
          <td style="color:#94a3b8;">${fmtFull$(d.totalAmount || 0)}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  // â”€â”€ Render Capital Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderCapitalCalls() {
    const el = document.getElementById('capitalCallsContent');
    const allCalls = (typeof SPData !== 'undefined' && SPData.isReady()) ? SPData.getCapitalCalls() : SP.load('capitalCalls', []);
    // Filter to calls for deals the investor is in
    const myCalls = allCalls.filter(call =>
      myDeals.some(({deal}) => deal.id === call.dealId)
    );

    if (!myCalls.length) {
      el.innerHTML = '<div class="empty"><i class="fas fa-file-invoice-dollar"></i><h3>No capital calls yet</h3><p>When your GP issues a capital call, you\'ll see wire instructions and due dates here.</p></div>';
      return;
    }

    const today = new Date();
    el.innerHTML = myCalls.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)).map(call => {
      const deal = myDeals.find(m => m.deal.id === call.dealId)?.deal;
      const entry = myDeals.find(m => m.deal.id === call.dealId)?.entry;
      const ownershipPct = entry?.ownership || 0;
      const myAmount = call.amount ? (ownershipPct > 0 ? (call.amount * ownershipPct / 100) : call.amount) : 0;
      const dueDate = call.dueDate ? new Date(call.dueDate) : null;
      const isOverdue = dueDate && dueDate < today && call.status !== 'funded';
      const isDueSoon = dueDate && !isOverdue && (dueDate - today) < 7 * 24 * 60 * 60 * 1000;
      const badgeClass = call.status === 'funded' ? 'call-badge-paid' : isOverdue ? 'call-badge-overdue' : 'call-badge-due';
      const badgeText = call.status === 'funded' ? 'âœ“ Funded' : isOverdue ? 'âš  Overdue' : 'Due';
      return `<div class="call-card">
        <div class="call-card-header">
          <div>
            <div class="call-card-title">${call.name || 'Capital Call'}</div>
            <div class="call-card-deal">${deal?.name || 'â€”'}</div>
          </div>
          <div style="text-align:right;">
            <div class="call-amount">${myAmount ? fmtFull$(myAmount) : fmtFull$(call.amount || 0)}</div>
            <div class="call-due ${isOverdue||isDueSoon?'urgent':''}">
              ${dueDate ? 'Due: ' + dueDate.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) : 'Due date TBD'}
            </div>
            <div style="margin-top:6px;"><span class="${badgeClass}">${badgeText}</span></div>
          </div>
        </div>
        <div class="call-card-body">
          ${call.notes ? `<p style="font-size:0.875rem;color:#475569;margin-bottom:12px;">${call.notes}</p>` : ''}
          ${call.wireInstructions ? `<div class="call-wire"><strong>Wire Instructions</strong>\n${call.wireInstructions}</div>` : '<div style="font-size:0.8rem;color:#94a3b8;">Contact your GP for wire instructions.</div>'}
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ Render Tax Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTaxDocs() {
    const el = document.getElementById('taxDocsContent');
    const currentYear = new Date().getFullYear();

    // Build K-1 rows from distributions â€” one per deal per year
    const k1Rows = [];
    const dealYears = {};
    myDists.forEach(d => {
      const year = d.date ? new Date(d.date).getFullYear() : null;
      if (!year) return;
      const key = `${d.dealId}-${year}`;
      if (!dealYears[key]) {
        const deal = myDeals.find(m => m.deal.id === d.dealId)?.deal;
        dealYears[key] = { dealId: d.dealId, dealName: deal?.name || 'â€”', year, total: 0 };
        k1Rows.push(dealYears[key]);
      }
      const rec = (d.recipients||[]).find(r => r.investorId === investorRecord.id);
      dealYears[key].total += (rec?.amount || d.amount || 0);
    });

    if (!k1Rows.length) {
      el.innerHTML = `<div class="empty">
        <i class="fas fa-receipt"></i>
        <h3>No tax documents yet</h3>
        <p>K-1s for tax year ${currentYear - 1} will be available after year-end processing, typically by March 15th.</p>
      </div>`;
      return;
    }

    k1Rows.sort((a, b) => b.year - a.year);
    el.innerHTML = `<table class="tax-table">
      <thead><tr>
        <th>Document</th><th>Investment</th><th>Tax Year</th><th>Your Share</th><th>Status</th><th></th>
      </tr></thead>
      <tbody>${k1Rows.map(row => {
        const isCurrentYear = row.year >= currentYear;
        const status = isCurrentYear ? '<span style="color:#d97706;font-size:0.78rem;font-weight:600;">â³ Pending</span>' : '<span style="color:#16a34a;font-size:0.78rem;font-weight:600;">âœ“ Available</span>';
        return `<tr>
          <td><strong>Schedule K-1</strong><br><span style="font-size:0.75rem;color:#94a3b8;">Form 1065</span></td>
          <td>${row.dealName}</td>
          <td>${row.year}</td>
          <td style="font-weight:600;">${fmtFull$(row.total)}</td>
          <td>${status}</td>
          <td>${isCurrentYear ? '' : `<button class="tax-dl-btn" onclick="generateK1('${row.dealId}','${row.year}','${row.dealName}')"><i class="fas fa-download"></i> Download</button>`}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  function generateK1(dealId, year, dealName) {
    const inv = investorRecord || {};
    const name = `${inv.firstName||''} ${inv.lastName||''}`.trim() || session?.name || '';
    const w = window.open('', '_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>K-1 ${year} â€” ${dealName}</title>
    <style>body{font-family:Arial,sans-serif;max-width:800px;margin:40px auto;padding:20px;color:#1a2332;}
    h1{font-size:1.2rem;border-bottom:2px solid #1a2332;padding-bottom:8px;margin-bottom:20px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
    .field label{font-size:0.7rem;font-weight:700;text-transform:uppercase;color:#64748b;display:block;margin-bottom:3px;}
    .field span{font-size:0.95rem;border-bottom:1px solid #e2e8f0;display:block;padding-bottom:4px;min-height:24px;}
    .notice{background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:12px;font-size:0.8rem;color:#92400e;margin-top:24px;}
    @media print{.notice{display:none;}}
    </style></head><body>
    <h1>Schedule K-1 (Form 1065) â€” Partner's Share of Income, Deductions, Credits</h1>
    <p style="font-size:0.85rem;color:#64748b;margin-bottom:20px;">Tax Year ${year} | ${dealName}</p>
    <div class="grid">
      <div class="field"><label>Partner Name</label><span>${name}</span></div>
      <div class="field"><label>Partner Email</label><span>${inv.email||''}</span></div>
      <div class="field"><label>Partner Address</label><span>${inv.address||''}</span></div>
      <div class="field"><label>Investment</label><span>${dealName}</span></div>
      <div class="field"><label>Tax Year</label><span>${year}</span></div>
      <div class="field"><label>Capital Contributed</label><span>$${(investorRecord?.totalInvested||0).toLocaleString()}</span></div>
    </div>
    <div class="notice">âš  This is a placeholder K-1. Your GP will provide the final certified Schedule K-1 by the applicable tax deadline. Please consult your CPA or tax advisor.</div>
    <p style="margin-top:24px;font-size:0.75rem;color:#94a3b8;text-align:center;">Generated by deeltrack Â· ${new Date().toLocaleDateString()}</p>
    <script>setTimeout(()=>window.print(),500);<\/script>
    </body></html>`);
    w.document.close();
  }

  // â”€â”€ Render Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function renderDocuments() {
    const grid = document.getElementById('documentsGrid');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#94a3b8;"><i class="fas fa-spinner fa-spin"></i> Loading documentsâ€¦</div>';

    let docs = [];
    if (typeof SPFB !== 'undefined' && SPFB.isReady()) {
      try { docs = await SPFB.getInvestorDocuments(session?.email || ''); } catch(e) {}
    }

    if (!docs.length) {
      grid.innerHTML = '<div class="empty" style="grid-column:1/-1;"><i class="fas fa-file-alt"></i><h3>No documents yet</h3><p>Documents shared by your GP will appear here.</p></div>';
      return;
    }
    grid.innerHTML = docs.map(doc => {
      const ext = (doc.name||'').split('.').pop().toLowerCase();
      const iconClass = ext === 'pdf' ? 'pdf' : (ext === 'doc' || ext === 'docx') ? 'word' : 'other';
      const iconName = ext === 'pdf' ? 'fa-file-pdf' : (ext === 'doc' || ext === 'docx') ? 'fa-file-word' : 'fa-file';
      return `<div class="doc-card" onclick="openDoc('${doc.id}','${doc.fileUrl||''}','${(doc.name||'').replace(/'/g,'\\\'')}')" >
        <div class="doc-icon ${iconClass}"><i class="fas ${iconName}"></i></div>
        <div class="doc-name">${doc.name || 'Document'}</div>
        <div class="doc-meta">${doc.uploadedAt ? new Date(doc.uploadedAt.toDate?.() || doc.uploadedAt).toLocaleDateString() : ''}</div>
      </div>`;
    }).join('');
  }

  function openDoc(id, fileUrl, name) {
    if (fileUrl) { window.open(fileUrl, '_blank'); return; }
    // Fetch htmlContent from Firestore
    if (typeof firebase === 'undefined' || !SPFB.isReady()) return;
    firebase.firestore().collection('orgs').doc(SPFB.getOrgId()).collection('documents').doc(id).get().then(snap => {
      if (!snap.exists) return;
      const doc = snap.data();
      if (doc.fileUrl) { window.open(doc.fileUrl, '_blank'); return; }
      if (doc.htmlContent) {
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html><html><head><title>${name}</title><style>body{font-family:Georgia,serif;max-width:820px;margin:40px auto;padding:20px;line-height:1.8;color:#1a2332;}h1,h2,h3{font-family:sans-serif;}</style></head><body>${doc.htmlContent}</body></html>`);
        w.document.close();
      }
    }).catch(() => {});
  }

  // â”€â”€ Render Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProfile() {
    const inv = investorRecord || {};
    const name = `${inv.firstName||''} ${inv.lastName||''}`.trim() || session?.name || 'â€”';
    const initials = name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const verified = inv.accredStatus === 'verified';

    document.getElementById('profileCard').innerHTML = `
      <div class="profile-avatar">${initials}</div>
      <div class="profile-field"><div class="profile-label">Full Name</div><div class="profile-value">${name}</div></div>
      <div class="profile-field"><div class="profile-label">Email</div><div class="profile-value">${inv.email || session?.email || 'â€”'}</div></div>
      <div class="profile-field"><div class="profile-label">Phone</div><div class="profile-value">${inv.phone || 'â€”'}</div></div>
      <div class="profile-field"><div class="profile-label">Address</div><div class="profile-value">${inv.address || 'â€”'}</div></div>
      <div class="profile-field">
        <div class="profile-label">Accreditation Status</div>
        <div class="profile-value" style="margin-top:6px;">
          <span class="accred-badge ${verified ? '' : 'pending'}">
            <i class="fas ${verified ? 'fa-check-circle' : 'fa-clock'}"></i>
            ${verified ? 'Verified Accredited Investor' : 'Pending Verification'}
          </span>
        </div>
      </div>
      <div class="profile-field"><div class="profile-label">Active Investments</div><div class="profile-value">${myDeals.length}</div></div>
    `;
  }

  // â”€â”€ No Access Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showNoAccess() {
    document.getElementById('loadingOverlay').style.display = 'none';
    const el = document.getElementById('noAccessScreen');
    el.style.display = 'flex';
    document.getElementById('noAccessEmail').textContent = session?.email || 'â€”';
  }

  // â”€â”€ Main Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    // Re-read session â€” it's been updated by SPFB._markReady since page load
    session = SP.getSession();
    const email = session?.email || (typeof SPFB !== 'undefined' && SPFB.getUser()?.email) || '';
    console.log('investor-portal init: email=' + email, 'SPData.isReady=' + (typeof SPData !== 'undefined' && SPData.isReady()));

    // Resolve investor record from SPData (Firestore)
    if (typeof SPData !== 'undefined' && SPData.isReady()) {
      investorRecord = SPData.getInvestorByEmail(email);
      console.log('investor-portal: SPData lookup result:', investorRecord?.id || 'null', 'cache size:', SPData.getInvestors?.()?.length);
    }
    if (!investorRecord && typeof SPFB !== 'undefined' && SPFB.isReady()) {
      try {
        const fbInvs = await SPFB.getInvestors();
        investorRecord = fbInvs.find(i => i.email?.toLowerCase() === email?.toLowerCase()) || null;
        console.log('investor-portal: SPFB fallback result:', investorRecord?.id || 'null');
      } catch(e) { console.warn('SPFB.getInvestors failed:', e.message); }
    }

    if (!investorRecord) { console.error('investor-portal: no investor record found for', email); showNoAccess(); return; }

    // Load deals and distributions
    const allDeals = (typeof SPData !== 'undefined' && SPData.isReady()) ? SPData.getDeals() : SP.getDeals();
    const allDists = (typeof SPData !== 'undefined' && SPData.isReady()) ? SPData.getDistributions() : SP.getDistributions();

    myDeals = allDeals
      .filter(d => (d.investors||[]).some(i => i.investorId === investorRecord.id))
      .map(deal => ({ deal, entry: deal.investors.find(i => i.investorId === investorRecord.id) }));

    myDists = allDists.filter(d =>
      (d.recipients||[]).some(r => r.investorId === investorRecord.id) || d.investorId === investorRecord.id
    );

    // Render everything
    personalize();
    renderOverview();
    renderInvestments();
    renderDistributions();
    renderCapitalCalls();
    renderTaxDocs();
    renderProfile();

    // Hide loader
    document.getElementById('loadingOverlay').style.display = 'none';

    // Load documents async (doesn't block)
    renderDocuments();
  }

  // Start: wait for SPData then init
  let _initCalled = false;
  function _safeInit() { if (_initCalled) return; _initCalled = true; init(); }
  window.addEventListener('spdata-ready', _safeInit);
  // Catch case where spdata-ready already fired before listener attached
  if (typeof SPData !== 'undefined' && SPData.isReady()) { _safeInit(); }
  // Fallback: if SPFB fires but SPData.init() never dispatches (e.g. offline), still init after 5s
  setTimeout(() => {
    if (!_initCalled && typeof SPFB !== 'undefined' && SPFB.isReady()) {
      console.warn('spdata-ready never fired â€” forcing init via SPFB fallback');
      _safeInit();
    }
  }, 5000);
  // Hard fallback: after 12s, hide loading and show error
  setTimeout(() => {
    if (!_initCalled) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Portal failed to initialize after 12s â€” check Firebase auth');
      // Show a user-friendly error
      const el = document.querySelector('.content-area') || document.body;
      const err = document.createElement('div');
      err.style.cssText = 'padding:40px;text-align:center;color:#64748b;';
      err.innerHTML = '<h2 style="margin-bottom:12px">Unable to load portal</h2><p>Please <a href="login.html">sign in again</a> or contact support.</p>';
      el.prepend(err);
    }
  }, 12000);
</script>
</body>
</html>
