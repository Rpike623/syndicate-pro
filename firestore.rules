rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helpers ───────────────────────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function userDocData() {
      return get(/databases/$(database)/documents/users/$(uid())).data;
    }

    function userOrgId() {
      return userDocData().orgId;
    }

    function ownsOrg(orgId) {
      return isSignedIn() && userOrgId() == orgId;
    }

    function isInvestorRole() {
      return isSignedIn() && userDocData().role == 'Investor';
    }

    // ── Users ─────────────────────────────────────────────────────────────────
    // Any signed-in user (including anonymous) can manage their own profile.

    match /users/{userId} {
      allow read, write: if isSignedIn() && uid() == userId;
    }

    // ── Org data ──────────────────────────────────────────────────────────────

    match /orgs/{orgId} {
      allow read, write: if ownsOrg(orgId);

      match /deals/{dealId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
        // Investors can read deals they're linked to
        allow read: if ownsOrg(orgId) && isInvestorRole();
      }

      match /investors/{investorId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
        allow read: if ownsOrg(orgId) && isInvestorRole() &&
          resource.data.email == request.auth.token.email;
      }

      match /documents/{docId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
        allow read: if ownsOrg(orgId) && isInvestorRole() && (
          resource.data.accessLevel == 'all_investors' ||
          resource.data.accessLevel == userDocData().investorId
        );
      }

      match /distributions/{distId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
        allow read: if ownsOrg(orgId) && isInvestorRole();
      }

      match /capitalCalls/{callId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
        // Investors can read capital calls for deals they are linked to
        allow read: if ownsOrg(orgId) && isInvestorRole();
      }

      match /activity/{actId} {
        allow read, write: if ownsOrg(orgId);
      }

      match /settings/{settingId} {
        allow read, write: if ownsOrg(orgId) && !isInvestorRole();
      }
    }
  }
}
