<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deeltrack - Deal Detail</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="js/sp-core.js"></script>
  <script src="js/sp-data.js"></script>
  <script src="js/sp-firebase.js"></script>
  <script src="js/sp-billing.js"></script>
  <script src="js/sp-documents.js"></script>
  <style>
    :root {
      --primary:#0f172a;--accent:#3b82f6;--accent-hover:#2563eb;--accent-light:#dbeafe;
      --success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;
      --danger:#ef4444;--danger-light:#fee2e2;--purple:#8b5cf6;--purple-light:#ede9fe;
      --text:#0f172a;--text-secondary:#64748b;--text-muted:#94a3b8;
      --border:#e2e8f0;--border-light:#f1f5f9;--bg:#f8fafc;--bg-card:#fff;--bg-sidebar:#0f172a;
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1);--shadow-lg:0 10px 15px -3px rgb(0 0 0/.1);
      --radius-sm:6px;--radius:8px;--radius-md:12px;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:var(--bg-sidebar);color:white;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s;}
    .sidebar-header{padding:24px;border-bottom:1px solid rgba(255,255,255,.1);}
    .logo{display:flex;align-items:center;gap:12px;font-size:1.25rem;font-weight:700;text-decoration:none;color:white;}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#60a5fa);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px;overflow-y:auto;}
    .nav-section{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:rgba(255,255,255,.4);padding:16px 12px 8px;}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--radius);color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;font-weight:500;transition:all .15s;}
    .nav-item:hover{background:rgba(255,255,255,.05);color:white;}
    .nav-item.active{background:var(--accent);color:white;}
    .nav-item i{width:20px;text-align:center;}
    .sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.1);}
    .user-info{display:flex;align-items:center;gap:12px;}
    .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--success),#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem;color:white;flex-shrink:0;}
    .user-details{flex:1;}.user-name{font-size:.9rem;font-weight:600;}.user-role{font-size:.75rem;color:rgba(255,255,255,.5);}
    .main{flex:1;margin-left:260px;min-height:100vh;}
    .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;}
    .top-left{display:flex;align-items:center;gap:16px;}
    .mobile-menu-btn{display:none;background:none;border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;cursor:pointer;}
    .breadcrumb{display:flex;align-items:center;gap:8px;font-size:.875rem;color:var(--text-secondary);}
    .breadcrumb a{color:var(--text-secondary);text-decoration:none;}.breadcrumb a:hover{color:var(--accent);}
    .breadcrumb-sep{color:var(--text-muted);}
    .breadcrumb-current{color:var(--text);font-weight:600;}
    .top-actions{display:flex;gap:10px;align-items:center;}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;font-size:.875rem;font-weight:600;border-radius:var(--radius);border:none;cursor:pointer;transition:all .15s;text-decoration:none;font-family:'Inter',sans-serif;}
    .btn-primary{background:var(--accent);color:white;}.btn-primary:hover{background:var(--accent-hover);}
    .btn-secondary{background:var(--bg-card);color:var(--text);border:1px solid var(--border);}.btn-secondary:hover{background:var(--border-light);}
    .btn-danger{background:var(--danger-light);color:var(--danger);border:1px solid var(--danger);}.btn-danger:hover{background:var(--danger);color:white;}
    .content{padding:32px;}
    /* Deal header */
    .deal-hero{background:linear-gradient(135deg,var(--primary),#1e293b);border-radius:var(--radius-md);padding:32px;color:white;margin-bottom:24px;position:relative;overflow:hidden;}
    .deal-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(59,130,246,.2),transparent 70%);border-radius:50%;}
    .deal-hero-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
    .deal-title-block h1{font-size:1.75rem;font-weight:700;margin-bottom:6px;}
    .deal-location{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.6);font-size:.9rem;}
    .deal-badges{display:flex;gap:8px;flex-wrap:wrap;}
    .deal-badge{padding:5px 14px;border-radius:20px;font-size:.75rem;font-weight:600;}
    .badge-type{background:rgba(59,130,246,.25);color:#93c5fd;}
    .badge-status-sourcing{background:rgba(148,163,184,.2);color:#94a3b8;}
    .badge-status-loi{background:rgba(245,158,11,.2);color:#fbbf24;}
    .badge-status-dd{background:rgba(59,130,246,.2);color:#93c5fd;}
    .badge-status-operating{background:rgba(16,185,129,.2);color:#6ee7b7;}
    .badge-status-closed{background:rgba(16,185,129,.3);color:#34d399;}
    .deal-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
    .deal-metric{background:rgba(255,255,255,.07);border-radius:var(--radius);padding:16px;}
    .deal-metric .val{font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
    .deal-metric .lbl{font-size:.72rem;color:rgba(255,255,255,.5);margin-top:4px;text-transform:uppercase;letter-spacing:.05em;}
    /* Tabs */
    .tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:24px;}
    .tab{padding:12px 20px;font-size:.9rem;font-weight:600;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Inter',sans-serif;}
    .tab:hover{color:var(--text);}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent);}
    .tab-panel{display:none;}.tab-panel.active{display:block;}
    /* Cards */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:20px;}
    .card-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:center;}
    .card-title{font-size:1rem;font-weight:700;}
    .card-body{padding:20px 24px 24px;}
    /* Investors table */
    .table-scroll{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;}
    thead{background:var(--border-light);}
    th{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);padding:10px 14px;text-align:left;white-space:nowrap;}
    td{padding:12px 14px;border-bottom:1px solid var(--border-light);font-size:.875rem;vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(59,130,246,.02);}
    .badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;}
    .badge-committed{background:var(--warning-light);color:var(--warning);}
    .badge-funded{background:var(--accent-light);color:var(--accent);}
    .badge-active{background:var(--success-light);color:var(--success);}
    .badge-exited{background:var(--border-light);color:var(--text-secondary);}
    .money{font-family:'JetBrains Mono',monospace;font-weight:600;}
    .pct{font-family:'JetBrains Mono',monospace;color:var(--accent);}
    .btn-xs{padding:5px 10px;font-size:.75rem;font-weight:600;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:4px;font-family:'Inter',sans-serif;}
    .btn-xs:hover{background:var(--accent);color:white;border-color:var(--accent);}
    .btn-xs.danger:hover{background:var(--danger);border-color:var(--danger);}
    /* Capital summary bar */
    .cap-bar{height:10px;border-radius:10px;background:var(--border-light);overflow:hidden;margin:8px 0;}
    .cap-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--success));transition:width .6s;}
    /* Distribution list */
    .dist-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-light);}
    .dist-item:last-child{border-bottom:none;}
    /* Document grid */
    .doc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}
    .doc-card{background:var(--border-light);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;transition:all .15s;}
    .doc-card:hover{border-color:var(--accent);background:var(--accent-light);}
    .doc-icon{font-size:1.5rem;color:var(--accent);margin-bottom:8px;}
    .doc-name{font-size:.8rem;font-weight:600;}
    .doc-sub{font-size:.7rem;color:var(--text-muted);margin-top:3px;}
    /* Edit form */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .form-group{margin-bottom:0;}
    .form-group label{display:block;font-size:.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:.9rem;color:var(--text);background:var(--bg-card);outline:none;transition:all .15s;font-family:'Inter',sans-serif;}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--bg-card);border-radius:var(--radius-md);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);}
    .modal-header{padding:24px 28px 0;display:flex;justify-content:space-between;align-items:center;}
    .modal-title{font-size:1.1rem;font-weight:700;}
    .modal-close{width:32px;height:32px;border:none;background:var(--border-light);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);}
    .modal-close:hover{background:var(--danger-light);color:var(--danger);}
    .modal-body{padding:20px 28px;}
    .modal-footer{padding:0 28px 24px;display:flex;justify-content:flex-end;gap:10px;}
    /* Investor av */
    .inv-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:white;flex-shrink:0;}
    .av-0{background:linear-gradient(135deg,#3b82f6,#60a5fa);}
    .av-1{background:linear-gradient(135deg,#10b981,#34d399);}
    .av-2{background:linear-gradient(135deg,#8b5cf6,#a78bfa);}
    .av-3{background:linear-gradient(135deg,#f59e0b,#fbbf24);}
    .av-4{background:linear-gradient(135deg,#ef4444,#f87171);}
    .av-5{background:linear-gradient(135deg,#06b6d4,#22d3ee);}
    .inv-cell{display:flex;align-items:center;gap:10px;}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted);}
    .empty-state i{font-size:2rem;opacity:.3;display:block;margin-bottom:12px;}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}
    .sidebar-overlay.visible{display:block;}
    @media(max-width:900px){.deal-metrics{grid-template-columns:repeat(2,1fr);}}.
    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);}
      .sidebar.open{transform:translateX(0);}
      .main{margin-left:0!important;}
      .mobile-menu-btn{display:flex!important;}
      .top-bar{padding:12px 16px;}
      .content{padding:16px;}
      .deal-metrics{grid-template-columns:repeat(2,1fr);}
      .form-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">‚óÜ</div><span>deeltrack</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item active"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="inbox.html" class="nav-item"><i class="fas fa-inbox"></i><span>Inbox</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
      <a href="pipeline.html" class="nav-item"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="deal-room.html" class="nav-item"><i class="fas fa-folder-open"></i><span>Deal Room</span></a>
      <a href="teaser-generator.html" class="nav-item"><i class="fas fa-file-image"></i><span>Teaser</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name" id="gpName">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <nav class="breadcrumb">
          <a href="dashboard.html">Home</a><span class="breadcrumb-sep">/</span>
          <a href="pipeline.html">Pipeline</a><span class="breadcrumb-sep">/</span>
          <span class="breadcrumb-current" id="breadcrumbDealName">Deal Detail</span>
        </nav>
      </div>
      <div class="top-actions" id="topActions">
        <a href="pipeline.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
      </div>
    </header>

    <div class="content" id="mainContent">
      <!-- Populated by JS -->
    </div>
  </main>
</div>

<!-- Add Investor to Deal Modal -->
<div class="modal-overlay" id="addInvModal" onclick="handleAddInvOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title"><i class="fas fa-user-plus" style="color:var(--accent);margin-right:6px;"></i>Add Investor to Deal</h2>
      <button class="modal-close" onclick="closeAddInvModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:16px;">
        <label>Select Investor *</label>
        <select id="aiInvestorSel" onchange="aiAutoFill()">
          <option value="">‚Äî Choose investor ‚Äî</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group">
          <label>Committed ($) *</label>
          <input type="number" id="aiCommitted" placeholder="250000" oninput="aiCalcOwnership()">
        </div>
        <div class="form-group">
          <label>Ownership %</label>
          <input type="text" id="aiOwnership" readonly style="background:var(--border-light);">
        </div>
      </div>
      <div class="form-group" style="margin-top:12px;">
        <label>Status</label>
        <select id="aiStatus">
          <option value="committed">Committed</option>
          <option value="funded">Funded</option>
          <option value="active">Active</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddInvModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveAddInv()"><i class="fas fa-link"></i> Link Investor</button>
    </div>
  </div>
</div>

<script>
SP.requireGP();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('visible');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('visible');}

const session = SP.getSession();
if(session?.name) document.getElementById('gpName').textContent = session.name;

const urlParams = new URLSearchParams(window.location.search);
const dealId = urlParams.get('id');

let deal = null;

function fmt$(n){if(!n)return'$0';if(n>=1e6)return'$'+(n/1e6).toFixed(2)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(0)+'K';return'$'+Number(n).toLocaleString();}
function fmtFull$(n){return'$'+Number(n||0).toLocaleString();}

const STATUS_BADGE = {sourcing:'badge-status-sourcing',loi:'badge-status-loi',dd:'badge-status-dd',operating:'badge-status-operating',closed:'badge-status-closed'};
const STATUS_LABEL = {sourcing:'Sourcing',loi:'LOI',dd:'Due Diligence',operating:'Operating',closed:'Closed'};
const TYPE_LABEL = {multifamily:'Multifamily',industrial:'Industrial',retail:'Retail',office:'Office',other:'Other'};

function render() {
  deal = SP.getDealById(dealId);
  if(!deal) {
    document.getElementById('mainContent').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Deal not found</h3><p><a href="pipeline.html">Back to pipeline</a></p></div>`;
    return;
  }
  document.getElementById('breadcrumbDealName').textContent = deal.name;
  document.getElementById('topActions').innerHTML = `
    <a href="pipeline.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Pipeline</a>
    <a href="new-deal.html?id=${deal.id}" class="btn btn-secondary"><i class="fas fa-calculator"></i> Model</a>
    <button class="btn btn-secondary" onclick="duplicateDeal('${deal.id}')" title="Duplicate Deal"><i class="fas fa-copy"></i> Duplicate</button>
    <button class="btn btn-secondary" onclick="shareTeaserLink('${deal.id}')" title="Share public teaser"><i class="fas fa-share-alt"></i> Share</button>
    <button class="btn btn-primary" onclick="openAddInvModal()"><i class="fas fa-user-plus"></i> Add Investor</button>
    <button class="btn btn-danger" onclick="confirmDelete()"><i class="fas fa-trash"></i></button>`;

  const linked = deal.investors || [];
  const totalCommitted = linked.reduce((s,i)=>s+(i.committed||0),0);
  const raise = deal.raise || 0;
  const pctRaised = raise > 0 ? Math.min(100,(totalCommitted/raise*100)).toFixed(1) : 0;
  const dists = SP.getDistributions().filter(d=>d.dealId===deal.id);
  const totalDist = dists.reduce((s,d)=>s+(d.totalAmount||0),0);

  document.getElementById('mainContent').innerHTML = `
    <!-- Hero -->
    <div class="deal-hero">
      <div class="deal-hero-top">
        <div class="deal-title-block">
          <h1>${deal.name}</h1>
          <div class="deal-location"><i class="fas fa-map-marker-alt"></i> ${deal.location||'Location not set'}</div>
        </div>
        <div class="deal-badges">
          <span class="deal-badge badge-type">${TYPE_LABEL[deal.type]||deal.type||'‚Äî'}</span>
          <span class="deal-badge ${STATUS_BADGE[deal.status]||''}">${STATUS_LABEL[deal.status]||deal.status||'‚Äî'}</span>
          <span class="deal-badge" style="background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);">Added ${deal.added||'‚Äî'}</span>
        </div>
      </div>
      <div class="deal-metrics">
        <div class="deal-metric"><div class="val">${fmt$(raise)}</div><div class="lbl">Target Raise</div></div>
        <div class="deal-metric"><div class="val">${deal.irr?deal.irr.toFixed(1)+'%':'‚Äî'}</div><div class="lbl">Target IRR</div></div>
        <div class="deal-metric"><div class="val">${deal.equity?deal.equity.toFixed(2)+'x':'‚Äî'}</div><div class="lbl">Equity Multiple</div></div>
        <div class="deal-metric"><div class="val">${linked.length}</div><div class="lbl">Investors</div></div>
      </div>
    </div>

    <!-- Capital progress -->
    <div class="card">
      <div class="card-header"><div class="card-title">Capital Raise Progress</div><span style="font-size:.875rem;color:var(--text-secondary);">${fmtFull$(totalCommitted)} / ${fmtFull$(raise)}</span></div>
      <div class="card-body">
        <div class="cap-bar"><div class="cap-fill" style="width:${pctRaised}%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-secondary);margin-top:6px;">
          <span><strong style="color:var(--text);">${pctRaised}%</strong> raised</span>
          <span>${fmtFull$(Math.max(0,raise-totalCommitted))} remaining</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('investors',this)"><i class="fas fa-users"></i> Investors (${linked.length})</button>
      <button class="tab" onclick="switchTab('distributions',this)"><i class="fas fa-wallet"></i> Distributions (${dists.length})</button>
      <button class="tab" onclick="switchTab('documents',this)"><i class="fas fa-file-contract"></i> Documents</button>
      <button class="tab" onclick="switchTab('subscriptions',this)"><i class="fas fa-file-signature"></i> Sub Docs</button>
      <button class="tab" onclick="switchTab('edit',this)"><i class="fas fa-edit"></i> Edit Deal</button>
    </div>

    <!-- Investors Tab -->
    <div class="tab-panel active" id="tab-investors">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Linked Investors</div>
          <button class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;" onclick="openAddInvModal()"><i class="fas fa-plus"></i> Add Investor</button>
        </div>
        <div class="card-body" style="padding-top:0;">
          ${renderInvestorsTable(linked)}
        </div>
      </div>
    </div>

    <!-- Distributions Tab -->
    <div class="tab-panel" id="tab-distributions">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Distribution History</div>
          <a href="distributions.html?deal=${deal.id}" class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;"><i class="fas fa-plus"></i> Record Distribution</a>
        </div>
        <div class="card-body">
          ${renderDistributions(dists)}
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-panel" id="tab-documents">
      ${renderDocumentsTab()}</div>

    <!-- Subscriptions Tab -->
    <div class="tab-panel" id="tab-subscriptions">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Subscription Agreement Tracker</div>
          <button class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;" onclick="openAddInvModal()"><i class="fas fa-plus"></i> Add Investor</button>
        </div>
        <div class="card-body" style="padding-top:0;">
          ${renderSubTracker()}
        </div>
      </div>
    </div>

    <!-- Edit Tab -->
    <div class="tab-panel" id="tab-edit">
      <div class="card">
        <div class="card-header"><div class="card-title">Edit Deal</div></div>
        <div class="card-body">
          <div class="form-grid" style="gap:16px;">
            <div class="form-group" style="grid-column:1/-1;"><label>Deal Name</label><input id="eName" value="${deal.name||''}"></div>
            <div class="form-group"><label>Property Type</label>
              <select id="eType">
                <option value="multifamily" ${deal.type==='multifamily'?'selected':''}>Multifamily</option>
                <option value="industrial" ${deal.type==='industrial'?'selected':''}>Industrial</option>
                <option value="retail" ${deal.type==='retail'?'selected':''}>Retail</option>
                <option value="office" ${deal.type==='office'?'selected':''}>Office</option>
                <option value="other" ${deal.type==='other'?'selected':''}>Other</option>
              </select>
            </div>
            <div class="form-group"><label>Status</label>
              <select id="eStatus">
                <option value="sourcing" ${deal.status==='sourcing'?'selected':''}>Sourcing</option>
                <option value="loi" ${deal.status==='loi'?'selected':''}>LOI</option>
                <option value="dd" ${deal.status==='dd'?'selected':''}>Due Diligence</option>
                <option value="operating" ${deal.status==='operating'?'selected':''}>Operating</option>
                <option value="closed" ${deal.status==='closed'?'selected':''}>Closed</option>
              </select>
            </div>
            <div class="form-group" style="grid-column:1/-1;"><label>Location</label><input id="eLocation" value="${deal.location||''}"></div>
            <div class="form-group"><label>Raise Amount ($)</label><input type="number" id="eRaise" value="${deal.raise||0}"></div>
            <div class="form-group"><label>Target IRR (%)</label><input type="number" id="eIRR" value="${deal.irr||0}" step="0.1"></div>
            <div class="form-group"><label>Equity Multiple</label><input type="number" id="eEM" value="${deal.equity||0}" step="0.01"></div>
            <div class="form-group"><label>Units</label><input type="number" id="eUnits" value="${deal.units||0}"></div>
            <div class="form-group" style="grid-column:1/-1;"><label>Notes</label><textarea id="eNotes" rows="3">${deal.notes||''}</textarea></div>
          </div>
          <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="saveEdit()"><i class="fas fa-save"></i> Save Changes</button>
            <button class="btn btn-secondary" onclick="render()">Cancel</button>
            ${deal.investors?.length && !deal.formDFiled ? `
              <button class="btn btn-secondary" onclick="markFormDFiled('${deal.id}')" style="color:var(--warning);border-color:var(--warning);">
                <i class="fas fa-landmark"></i> Mark Form D Filed
              </button>` : ''}
            ${deal.formDFiled ? `<div style="padding:10px 14px;background:var(--success-light);color:var(--success);border-radius:var(--radius);font-size:.82rem;font-weight:600;"><i class="fas fa-check-circle"></i> Form D filed ${new Date(deal.formDFiled).toLocaleDateString()}</div>` : ''}
          </div>
        </div>
      </div>
    </div>`;
}

function renderDocumentsTab() {
  const hasOA = !!(deal.generatedOA);
  const oaDate = deal.oaGeneratedAt ? new Date(deal.oaGeneratedAt).toLocaleDateString() : null;

  return `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-header">
        <div>
          <div class="card-title">Operating Agreement</div>
          <div style="font-size:.8rem;color:var(--text-secondary);">${hasOA ? `Auto-generated ${oaDate} ¬∑ ${deal.state || 'DE'} LLC` : 'Not yet generated'}</div>
        </div>
        <div style="display:flex;gap:8px;">
          ${hasOA ? `
            <button class="btn btn-secondary" style="padding:8px 12px;font-size:.8rem;" onclick="viewOA()"><i class="fas fa-eye"></i> View</button>
            <button class="btn btn-secondary" style="padding:8px 12px;font-size:.8rem;" onclick="printOA()"><i class="fas fa-print"></i> Print / PDF</button>
            <button class="btn btn-secondary" style="padding:8px 12px;font-size:.8rem;" onclick="downloadOAWord()"><i class="fas fa-file-word"></i> Download</button>
          ` : `
            <button class="btn btn-primary" style="padding:8px 12px;font-size:.8rem;" onclick="generateOANow()"><i class="fas fa-file-contract"></i> Generate OA</button>
          `}
        </div>
      </div>
      ${hasOA ? `
        <div id="oaPreview" style="display:none;border-top:1px solid var(--border);padding:32px;background:#fafafa;">
          ${deal.generatedOA}
        </div>` : ''}
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      <div class="doc-card" onclick="window.location.href='documents.html?deal=${deal.id}&type=ppm'">
        <div class="doc-icon"><i class="fas fa-file-alt"></i></div>
        <div class="doc-name">PPM</div>
        <div class="doc-sub">Generate ‚Üí</div>
      </div>
      <div class="doc-card" onclick="window.location.href='k1-generator.html?deal=${deal.id}'">
        <div class="doc-icon"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="doc-name">K-1 Reports</div>
        <div class="doc-sub">Generate ‚Üí</div>
      </div>
      <div class="doc-card" onclick="window.location.href='deal-room.html?deal=${deal.id}'">
        <div class="doc-icon"><i class="fas fa-folder-open"></i></div>
        <div class="doc-name">Deal Room</div>
        <div class="doc-sub">Upload files ‚Üí</div>
      </div>
    </div>`;
}

function viewOA() {
  const preview = document.getElementById('oaPreview');
  if (!preview) return;
  const isVisible = preview.style.display !== 'none';
  preview.style.display = isVisible ? 'none' : 'block';
  // Update button text
  const btn = document.querySelector('button[onclick="viewOA()"]');
  if (btn) btn.innerHTML = isVisible ? '<i class="fas fa-eye"></i> View' : '<i class="fas fa-eye-slash"></i> Hide';
}

function printOA() {
  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>${deal.name} ‚Äî Operating Agreement</title>
    <style>body{font-family:Georgia,serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8;}
    h1,h2,h3{font-family:sans-serif;}@media print{@page{margin:1in}}</style></head>
    <body>${deal.generatedOA}</body></html>`);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

function downloadOAWord() {
  const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'></head><body>${deal.generatedOA}</body></html>`;
  const blob = new Blob([html], {type:'application/msword'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${deal.name.replace(/\s+/g,'-')}-Operating-Agreement.doc`;
  a.click();
}

function generateOANow() {
  const settings = SP.load('settings', {});
  const gpName = settings.firmName || deal.companyName || deal.name + ' GP, LLC';
  const gpRep = settings.gpFullName || SP.getSession()?.name || 'Managing Member';
  const state = deal.state || settings.defState || settings.firmState || 'DE';
  const minInv = deal.minInvestment || settings.defMin || 50000;

  // Build linked investors list for Schedule A
  const linkedInvestors = (deal.investors || []).map(entry => {
    const inv = SP.getInvestorById(entry.investorId) || {};
    return { ...inv, _committed: entry.committed || 0, _ownership: entry.ownership || 0 };
  });

  let oa;
  if (typeof SPDocs !== 'undefined') {
    oa = SPDocs.generateOA(deal, gpName, gpRep, settings.firmAddress || '', state, minInv, linkedInvestors);
  } else {
    oa = '<p>sp-documents.js not loaded.</p>';
  }

  const allDeals = SP.getDeals();
  const idx = allDeals.findIndex(d => d.id === dealId);
  if (idx >= 0) {
    allDeals[idx].generatedOA = oa;
    allDeals[idx].oaGeneratedAt = new Date().toISOString();
    if (typeof SPData !== "undefined" && SPData.isReady()) SPData.saveDeal(allDeals[idx]); else SP.saveDeals(allDeals);
  }
  SP.logActivity('fa-file-contract', 'green', `Operating Agreement generated for <strong>${deal.name}</strong>`);
  if (window._spNotif) window._spNotif.addNotification('doc', 'fa-file-contract', 'green', 'OA Ready', `Operating Agreement generated for ${deal.name}`, `deal-detail.html?id=${dealId}`);
  render();
  // Switch to docs tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const docTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes('Documents'));
  if (docTabBtn) docTabBtn.classList.add('active');
  document.getElementById('tab-documents')?.classList.add('active');
}

function renderSubTracker() {
  const linked = deal.investors || [];
  if (!linked.length) return `<div class="empty-state"><i class="fas fa-file-signature"></i><p>No investors linked yet. Add investors to track their subscription status.</p></div>`;
  const STATUS_STEPS = ['sent','viewed','signed','funded'];
  const STATUS_COLORS = {sent:'#dbeafe,#3b82f6',viewed:'#fef3c7,#f59e0b',signed:'#ede9fe,#8b5cf6',funded:'#d1fae5,#10b981'};
  const STATUS_LABELS = {sent:'Sent',viewed:'Viewed',signed:'Signed',funded:'Funded'};

  return `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;">
    <thead style="background:var(--border-light);"><tr>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Investor</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Committed</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Sub Doc Status</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Actions</th>
    </tr></thead>
    <tbody>${linked.map((entry,i)=>{
      const inv = SP.getInvestorById(entry.investorId)||{firstName:'Unknown',lastName:'',email:''};
      const initials=(inv.firstName[0]||'')+(inv.lastName[0]||'');
      const subStatus = entry.subStatus || 'pending';
      const [bg,clr] = (STATUS_COLORS[subStatus]||'#f1f5f9,#64748b').split(',');
      const stepIdx = STATUS_STEPS.indexOf(subStatus);
      return `<tr style="border-bottom:1px solid var(--border-light);">
        <td style="padding:12px 14px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:white;flex-shrink:0;">${initials}</div>
            <div><div style="font-weight:600;font-size:.875rem;">${inv.firstName} ${inv.lastName}</div><div style="font-size:.75rem;color:var(--text-muted);">${inv.email}</div></div>
          </div>
        </td>
        <td style="padding:12px 14px;font-family:'JetBrains Mono',monospace;font-weight:600;">$${Number(entry.committed||0).toLocaleString()}</td>
        <td style="padding:12px 14px;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
            ${STATUS_STEPS.map((s,si)=>`
              <div style="display:flex;align-items:center;gap:4px;">
                <div style="width:22px;height:22px;border-radius:50%;background:${si<=stepIdx?'var(--success)':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:.65rem;color:white;font-weight:700;">${si<stepIdx?'‚úì':si===stepIdx?'‚Üí':''}</div>
                <span style="font-size:.7rem;color:${si<=stepIdx?'var(--text)':'var(--text-muted)'};">${STATUS_LABELS[s]}</span>
                ${si<STATUS_STEPS.length-1?'<div style="width:16px;height:2px;background:var(--border);margin:0 2px;"></div>':''}
              </div>`).join('')}
          </div>
        </td>
        <td style="padding:12px 14px;">
          <div style="display:flex;gap:6px;">
            ${STATUS_STEPS.map(s=>s!==subStatus?`<button onclick="updateSubStatus('${entry.investorId}','${s}')" style="padding:4px 8px;background:${STATUS_COLORS[s]?.split(',')[0]||'#f1f5f9'};color:${STATUS_COLORS[s]?.split(',')[1]||'#64748b'};border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;">${STATUS_LABELS[s]}</button>`:null).filter(Boolean).join('')}
            <button onclick="viewSubDoc('${entry.investorId}')" title="View subscription agreement" style="padding:4px 8px;background:var(--purple-light);color:var(--purple);border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;"><i class="fas fa-file-signature"></i></button>
            <button onclick="sendSubDoc('${entry.investorId}')" title="Email sub doc to investor" style="padding:4px 8px;background:var(--accent-light);color:var(--accent);border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;"><i class="fas fa-paper-plane"></i></button>
          </div>
        </td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

function updateSubStatus(investorId, status) {
  const deals = SP.getDeals();
  const d = deals.find(x=>x.id===dealId);
  if (!d) return;
  const inv = (d.investors||[]).find(i=>i.investorId===investorId);
  if (inv) { inv.subStatus = status; inv.subUpdatedAt = new Date().toISOString(); }
  SP.saveDeals(deals);
  const invRecord = SP.getInvestorById(investorId);
  SP.logActivity('fa-file-signature','purple',`Sub docs <strong>${status}</strong> for <strong>${invRecord?.firstName} ${invRecord?.lastName}</strong> on <strong>${d.name}</strong>`);
  render();
  // Re-activate subscriptions tab
  document.querySelector('.tab.active')?.classList.remove('active');
  document.querySelectorAll('.tab')[3]?.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-subscriptions')?.classList.add('active');
}

function viewSubDoc(investorId) {
  const inv = SP.getInvestorById(investorId) || {};
  const settings = SP.load('settings', {});
  const gpName = settings.firmName || SP.getSession()?.name || 'Managing Member';
  const gpRep = settings.gpFullName || SP.getSession()?.name || 'Managing Member';

  let html;
  if (typeof SPDocs !== 'undefined') {
    const invEntry = (deal.investors || []).find(i => i.investorId === investorId) || {};
    const invWithAmount = { ...inv, committed: invEntry.committed || 0 };
    html = SPDocs.generateSubDoc(deal, invWithAmount, gpName, gpRep);
  } else {
    html = `<p style="padding:20px;">Install sp-documents.js to generate subscription agreements.</p>`;
  }

  // Show in a full-screen modal
  let modal = document.getElementById('subDocModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'subDocModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;';
    modal.onclick = e => { if(e.target===modal) modal.remove(); };
    document.body.appendChild(modal);
  }
  const invName = inv.firstName ? `${inv.firstName} ${inv.lastName}` : 'Investor';
  modal.innerHTML = `
    <div style="background:white;border-radius:12px;width:100%;max-width:860px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 32px 64px rgba(0,0,0,.5);">
      <div style="background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
        <div>
          <div style="color:white;font-weight:700;font-family:'Sora',sans-serif;">Subscription Agreement</div>
          <div style="color:rgba(255,255,255,.5);font-size:.8rem;">${invName} ¬∑ ${deal.name}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="printSubDoc('subDocBody')" style="padding:7px 14px;background:rgba(255,255,255,.1);color:white;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;"><i class="fas fa-print"></i> Print</button>
          <button onclick="downloadSubDoc('${investorId}')" style="padding:7px 14px;background:rgba(255,255,255,.1);color:white;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;"><i class="fas fa-download"></i> Word</button>
          <button onclick="sendSubDoc('${investorId}')" style="padding:7px 14px;background:#6366f1;color:white;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;font-weight:600;"><i class="fas fa-paper-plane"></i> Email to LP</button>
          <button onclick="document.getElementById('subDocModal').remove()" style="padding:7px 12px;background:rgba(239,68,68,.2);color:#f87171;border:none;border-radius:6px;cursor:pointer;font-size:.9rem;">‚úï</button>
        </div>
      </div>
      <div id="subDocBody" style="overflow-y:auto;flex:1;">${html}</div>
    </div>`;
}

function printSubDoc(contentId) {
  const content = document.getElementById(contentId)?.innerHTML;
  if (!content) return;
  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html><html><head><style>body{font-family:Georgia,serif;margin:0;} @media print{@page{margin:1in}}</style></head><body>${content}</body></html>`);
  w.document.close(); setTimeout(() => w.print(), 400);
}

function downloadSubDoc(investorId) {
  const inv = SP.getInvestorById(investorId) || {};
  const settings = SP.load('settings', {});
  const gpName = settings.firmName || SP.getSession()?.name || 'GP';
  const gpRep = settings.gpFullName || SP.getSession()?.name || 'GP';
  if (typeof SPDocs === 'undefined') return;
  const invEntry = (deal.investors||[]).find(i=>i.investorId===investorId)||{};
  const html = SPDocs.generateSubDoc(deal, {...inv, committed: invEntry.committed||0}, gpName, gpRep);
  const blob = new Blob([`<html><body>${html}</body></html>`], {type:'application/msword'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${inv.firstName||'Investor'}-${inv.lastName||''}-SubDoc.doc`;
  a.click();
}

function sendSubDoc(investorId) {
  const inv = SP.getInvestorById(investorId);
  if (!inv?.email) return;
  const settings = SP.load('settings',{});
  const gpName = settings.gpFullName || SP.getSession()?.name || 'Your Sponsor';
  const firmName = settings.firmName || gpName;

  // Generate printable sub doc
  const subDocHtml = `<!DOCTYPE html><html><head><style>
    body{font-family:Georgia,serif;max-width:720px;margin:40px auto;padding:40px;line-height:1.7;}
    h1{font-size:1.4rem;text-align:center;text-transform:uppercase;margin-bottom:4px;}
    .subtitle{text-align:center;color:#666;margin-bottom:40px;}
    h2{font-size:1rem;margin:28px 0 12px;border-bottom:1px solid #e2e8f0;padding-bottom:4px;}
    .field{border-bottom:1px solid #333;display:inline-block;min-width:200px;margin:0 8px;}
    .sig-block{margin-top:60px;display:grid;grid-template-columns:1fr 1fr;gap:60px;}
    .sig-line{border-top:1px solid #333;margin-top:40px;padding-top:8px;font-size:.85rem;}
    .watermark{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);font-size:5rem;color:rgba(0,0,0,.04);font-weight:700;pointer-events:none;}
    @media print{.no-print{display:none;}}
  </style></head><body>
    <div class="watermark">DRAFT</div>
    <div class="no-print" style="background:#fef3c7;padding:12px 20px;margin-bottom:24px;border-radius:8px;font-family:sans-serif;font-size:.9rem;">
      ‚ö†Ô∏è <strong>Draft Document</strong> ‚Äî This is a placeholder template. Have your attorney review before use.
      <button onclick="window.print()" style="float:right;padding:6px 14px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;">üñ® Print / PDF</button>
    </div>
    <h1>Subscription Agreement</h1>
    <div class="subtitle">${firmName} | ${deal.name}</div>
    <p>This Subscription Agreement ("Agreement") is entered into as of <span class="field"></span>, 2026, by and between <strong>${firmName}</strong> (the "Company") and the undersigned subscriber ("Subscriber").</p>
    <h2>1. Subscription</h2>
    <p>The Subscriber hereby subscribes for membership interests in ${deal.name} in the amount of $<span class="field"></span>, representing approximately <span class="field"></span>% of total equity.</p>
    <h2>2. Investor Information</h2>
    <p><strong>Name:</strong> ${inv.firstName} ${inv.lastName}<br>
    <strong>Email:</strong> ${inv.email}<br>
    <strong>Address:</strong> ${inv.address||'_________________________'}</p>
    <h2>3. Accredited Investor Representation</h2>
    <p>Subscriber represents and warrants that they are an "accredited investor" as defined in Rule 501 of Regulation D by virtue of:</p>
    <p>‚òê Net worth exceeding $1,000,000 (excluding primary residence)<br>
    ‚òê Individual income exceeding $200,000 in each of the prior two years<br>
    ‚òê Joint income with spouse exceeding $300,000<br>
    ‚òê Entity with assets exceeding $5,000,000</p>
    <h2>4. Risk Acknowledgment</h2>
    <p>Subscriber acknowledges that investment involves significant risks including potential loss of the entire investment, illiquidity, and reliance on the expertise of the Managing Member.</p>
    <h2>5. Wire Instructions</h2>
    <p>Upon execution, please wire funds to: <strong>${settings.firmName||'[COMPANY]'}</strong> Escrow Account (contact GP for wire details).</p>
    <div class="sig-block">
      <div>
        <div class="sig-line">Subscriber Signature</div>
        <div class="sig-line">Printed Name</div>
        <div class="sig-line">Date</div>
      </div>
      <div>
        <div class="sig-line">Managing Member, ${gpName}</div>
        <div class="sig-line">${firmName}</div>
        <div class="sig-line">Date</div>
      </div>
    </div>
  </body></html>`;

  // Open in new window for printing
  const w = window.open('', '_blank');
  w.document.write(subDocHtml);
  w.document.close();

  // Send mailto
  const subj = `Subscription Agreement ‚Äî ${deal.name}`;
  const body = `Hi ${inv.firstName},\n\nPlease find your Subscription Agreement for ${deal.name} attached.\n\nPlease review, sign, and return.\n\nBest,\n${gpName}`;
  setTimeout(() => window.open(`mailto:${inv.email}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, '_blank'), 300);

  updateSubStatus(investorId, 'sent');
}

function renderInvestorsTable(linked) {
  if(!linked.length) return `<div class="empty-state"><i class="fas fa-users"></i><p>No investors linked yet. <button onclick="openAddInvModal()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Add one now</button></p></div>`;
  const BADGE = {committed:'badge-committed',funded:'badge-funded',active:'badge-active',exited:'badge-exited'};
  return `<div class="table-scroll"><table>
    <thead><tr><th>Investor</th><th>Committed</th><th>Ownership</th><th>Status</th><th></th></tr></thead>
    <tbody>${linked.map((entry,i)=>{
      const inv = SP.getInvestorById(entry.investorId) || {firstName:'Unknown',lastName:'',email:''};
      const initials = (inv.firstName[0]||'')+(inv.lastName[0]||'');
      return `<tr>
        <td><div class="inv-cell"><div class="inv-av av-${i%6}">${initials}</div><div><div style="font-weight:600;">${inv.firstName} ${inv.lastName}</div><div style="font-size:.78rem;color:var(--text-muted);">${inv.email}</div></div></div></td>
        <td class="money">${fmtFull$(entry.committed||0)}</td>
        <td class="pct">${entry.ownership?entry.ownership.toFixed(2)+'%':'‚Äî'}</td>
        <td><span class="badge ${BADGE[entry.status]||'badge-committed'}">${entry.status||'committed'}</span></td>
        <td><div style="display:flex;gap:6px;">
          ${!SP.getInvestorById(entry.investorId)?`<button class="btn-xs" onclick="importInvestorToCRM('${entry.investorId}')" title="Add to CRM" style="color:var(--success);"><i class="fas fa-user-plus"></i></button>`:''}
          <button class="btn-xs danger" onclick="removeInvestor('${entry.investorId}')"><i class="fas fa-unlink"></i></button>
        </div></td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

function renderDistributions(dists) {
  if(!dists.length) return `<div class="empty-state"><i class="fas fa-wallet"></i><p>No distributions recorded yet. <a href="distributions.html" style="color:var(--accent);">Record one</a></p></div>`;
  return dists.map(d=>`
    <div class="dist-item">
      <div><div style="font-weight:600;">${d.description||'Distribution'}</div><div style="font-size:.78rem;color:var(--text-muted);">${d.date||'‚Äî'} ¬∑ ${d.period||''}</div></div>
      <div style="text-align:right;"><div class="money" style="color:var(--success);">${fmtFull$(d.totalAmount||0)}</div><div style="font-size:.75rem;color:var(--text-muted);">${d.recipients?.length||0} investors</div></div>
    </div>`).join('');
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.getElementById('tab-'+name)?.classList.add('active');
}

function saveEdit() {
  const deals = SP.getDeals();
  const idx = deals.findIndex(d=>d.id===dealId);
  if(idx<0) return;
  deals[idx] = {...deals[idx],
    name: document.getElementById('eName').value.trim(),
    type: document.getElementById('eType').value,
    status: document.getElementById('eStatus').value,
    location: document.getElementById('eLocation').value.trim(),
    raise: parseFloat(document.getElementById('eRaise').value)||0,
    irr: parseFloat(document.getElementById('eIRR').value)||0,
    equity: parseFloat(document.getElementById('eEM').value)||0,
    units: parseInt(document.getElementById('eUnits').value)||0,
    notes: document.getElementById('eNotes').value.trim(),
  };
  SP.saveDeals(deals);
  SP.logActivity('fa-edit','amber',`<strong>${deals[idx].name}</strong> deal details updated`);
  render();
}

function importInvestorToCRM(invId) {
  const name = prompt('Add this investor to CRM. Enter their full name:');
  if (!name) return;
  const email = prompt('Email address:');
  if (!email) return;
  const parts = name.trim().split(' ');
  const inv = {
    id: invId, firstName: parts[0]||'', lastName: parts.slice(1).join(' ')||'',
    email, phone:'', address:'', accredMethod:'', accredStatus:'pending',
    totalInvested:0, deals:1, status:'active', notes:`Imported from deal: ${deal.name}`
  };
  const investors = SP.getInvestors();
  if (!investors.find(i=>i.id===invId)) { investors.unshift(inv); SP.saveInvestors(investors); }
  SP.logActivity('fa-user-plus','green',`<strong>${name}</strong> added to CRM from deal`);
  render();
}

function removeInvestor(invId) {
  if(!confirm('Remove this investor from the deal?')) return;
  SP.removeInvestorFromDeal(dealId, invId);
  render();
}

function confirmDelete() {
  if(!confirm(`Delete "${deal.name}"? This cannot be undone.`)) return;
  const deals = SP.getDeals().filter(d=>d.id!==dealId);
  SP.saveDeals(deals);
  window.location.href = 'pipeline.html';
}

// Add investor modal
function openAddInvModal() {
  const investors = SP.getInvestors();
  const linked = (SP.getDealById(dealId)?.investors||[]).map(i=>i.investorId);
  const sel = document.getElementById('aiInvestorSel');
  sel.innerHTML = '<option value="">‚Äî Choose investor ‚Äî</option>' +
    investors.map(inv=>`<option value="${inv.id}" ${linked.includes(inv.id)?'disabled':''} data-name="${inv.firstName} ${inv.lastName}">${inv.firstName} ${inv.lastName}${linked.includes(inv.id)?' (already linked)':''}</option>`).join('');
  document.getElementById('aiCommitted').value='';
  document.getElementById('aiOwnership').value='';
  document.getElementById('addInvModal').classList.add('open');
}
function closeAddInvModal(){document.getElementById('addInvModal').classList.remove('open');}
function handleAddInvOverlay(e){if(e.target===document.getElementById('addInvModal'))closeAddInvModal();}

function aiAutoFill() {}
function aiCalcOwnership() {
  const raise = SP.getDealById(dealId)?.raise || 0;
  const committed = parseFloat(document.getElementById('aiCommitted').value)||0;
  document.getElementById('aiOwnership').value = raise&&committed ? (committed/raise*100).toFixed(2)+'%' : '';
}

function saveAddInv() {
  const invId = document.getElementById('aiInvestorSel').value;
  const committed = parseFloat(document.getElementById('aiCommitted').value)||0;
  const status = document.getElementById('aiStatus').value;
  if(!invId){alert('Select an investor.');return;}
  if(!committed){alert('Enter committed amount.');return;}
  const raise = SP.getDealById(dealId)?.raise||0;
  const ownership = raise?parseFloat((committed/raise*100).toFixed(4)):0;
  SP.addInvestorToDeal(dealId,{investorId:invId,committed,ownership,status,linkedAt:new Date().toISOString()});
  const inv = SP.getInvestorById(invId);
  SP.logActivity('fa-link','blue',`<strong>${inv?.firstName} ${inv?.lastName}</strong> linked to <strong>${deal?.name}</strong>`);
  closeAddInvModal();
  render();
}

function markFormDFiled(dealId) {
  const allDeals = SP.getDeals();
  const d = allDeals.find(x=>x.id===dealId);
  if(!d) return;
  d.formDFiled = new Date().toISOString();
  SP.saveDeals(allDeals);
  SP.logActivity('fa-landmark','green',`Form D marked as filed for <strong>${d.name}</strong>`);
  render();
}

function duplicateDeal(id) {
  const allDeals = SP.getDeals();
  const d = allDeals.find(x=>x.id===id);
  if(!d) return;
  const copy = {...d, id:'d'+Date.now(), name:d.name + ' (Copy)', investors:[], added:new Date().toISOString().split('T')[0]};
  allDeals.unshift(copy);
  SP.saveDeals(allDeals);
  SP.logActivity('fa-copy','blue',`<strong>${copy.name}</strong> duplicated from ${d.name}`);
  window.location.href = `deal-detail.html?id=${copy.id}`;
}

function shareTeaserLink(dId) {
  const orgId = SP.getOrgId();
  const token = btoa(`${orgId}|${dId}`).replace(/=/g,'');
  const base = window.location.href.replace(/deal-detail\.html.*/, '');
  const url = `${base}deal-teaser.html?t=${token}`;
  navigator.clipboard.writeText(url).then(() => {
    // Show toast
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:.875rem;font-weight:600;background:#10b981;color:white;box-shadow:0 8px 24px rgba(0,0,0,.15);display:flex;align-items:center;gap:8px;';
    t.innerHTML = '<i class="fas fa-check-circle"></i> Teaser link copied to clipboard!';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }).catch(() => { prompt('Copy this teaser link:', url); });
}

if(!dealId) {
  window.location.href='pipeline.html';
} else {
  // Wait for Firestore data before first render
  function _initialRender() {
    if (SP.getDealById(dealId)) render();
  }
  window.addEventListener('spdata-ready', _initialRender);
  if (typeof SPData !== 'undefined' && SPData.isReady()) _initialRender();
}
</script>
</body>
</html>
