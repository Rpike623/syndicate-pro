<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyndicatePro - Deal Detail</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="js/sp-core.js"></script>
  <style>
    :root {
      --primary:#0f172a;--accent:#3b82f6;--accent-hover:#2563eb;--accent-light:#dbeafe;
      --success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;
      --danger:#ef4444;--danger-light:#fee2e2;--purple:#8b5cf6;--purple-light:#ede9fe;
      --text:#0f172a;--text-secondary:#64748b;--text-muted:#94a3b8;
      --border:#e2e8f0;--border-light:#f1f5f9;--bg:#f8fafc;--bg-card:#fff;--bg-sidebar:#0f172a;
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1);--shadow-lg:0 10px 15px -3px rgb(0 0 0/.1);
      --radius-sm:6px;--radius:8px;--radius-md:12px;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:var(--bg-sidebar);color:white;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s;}
    .sidebar-header{padding:24px;border-bottom:1px solid rgba(255,255,255,.1);}
    .logo{display:flex;align-items:center;gap:12px;font-size:1.25rem;font-weight:700;text-decoration:none;color:white;}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#60a5fa);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px;overflow-y:auto;}
    .nav-section{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:rgba(255,255,255,.4);padding:16px 12px 8px;}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--radius);color:rgba(255,255,255,.7);text-decoration:none;font-size:.9rem;font-weight:500;transition:all .15s;}
    .nav-item:hover{background:rgba(255,255,255,.05);color:white;}
    .nav-item.active{background:var(--accent);color:white;}
    .nav-item i{width:20px;text-align:center;}
    .sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.1);}
    .user-info{display:flex;align-items:center;gap:12px;}
    .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--success),#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem;color:white;flex-shrink:0;}
    .user-details{flex:1;}.user-name{font-size:.9rem;font-weight:600;}.user-role{font-size:.75rem;color:rgba(255,255,255,.5);}
    .main{flex:1;margin-left:260px;min-height:100vh;}
    .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;}
    .top-left{display:flex;align-items:center;gap:16px;}
    .mobile-menu-btn{display:none;background:none;border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;cursor:pointer;}
    .breadcrumb{display:flex;align-items:center;gap:8px;font-size:.875rem;color:var(--text-secondary);}
    .breadcrumb a{color:var(--text-secondary);text-decoration:none;}.breadcrumb a:hover{color:var(--accent);}
    .breadcrumb-sep{color:var(--text-muted);}
    .breadcrumb-current{color:var(--text);font-weight:600;}
    .top-actions{display:flex;gap:10px;align-items:center;}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;font-size:.875rem;font-weight:600;border-radius:var(--radius);border:none;cursor:pointer;transition:all .15s;text-decoration:none;font-family:'Inter',sans-serif;}
    .btn-primary{background:var(--accent);color:white;}.btn-primary:hover{background:var(--accent-hover);}
    .btn-secondary{background:var(--bg-card);color:var(--text);border:1px solid var(--border);}.btn-secondary:hover{background:var(--border-light);}
    .btn-danger{background:var(--danger-light);color:var(--danger);border:1px solid var(--danger);}.btn-danger:hover{background:var(--danger);color:white;}
    .content{padding:32px;}
    /* Deal header */
    .deal-hero{background:linear-gradient(135deg,var(--primary),#1e293b);border-radius:var(--radius-md);padding:32px;color:white;margin-bottom:24px;position:relative;overflow:hidden;}
    .deal-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(59,130,246,.2),transparent 70%);border-radius:50%;}
    .deal-hero-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
    .deal-title-block h1{font-size:1.75rem;font-weight:700;margin-bottom:6px;}
    .deal-location{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.6);font-size:.9rem;}
    .deal-badges{display:flex;gap:8px;flex-wrap:wrap;}
    .deal-badge{padding:5px 14px;border-radius:20px;font-size:.75rem;font-weight:600;}
    .badge-type{background:rgba(59,130,246,.25);color:#93c5fd;}
    .badge-status-sourcing{background:rgba(148,163,184,.2);color:#94a3b8;}
    .badge-status-loi{background:rgba(245,158,11,.2);color:#fbbf24;}
    .badge-status-dd{background:rgba(59,130,246,.2);color:#93c5fd;}
    .badge-status-operating{background:rgba(16,185,129,.2);color:#6ee7b7;}
    .badge-status-closed{background:rgba(16,185,129,.3);color:#34d399;}
    .deal-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
    .deal-metric{background:rgba(255,255,255,.07);border-radius:var(--radius);padding:16px;}
    .deal-metric .val{font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
    .deal-metric .lbl{font-size:.72rem;color:rgba(255,255,255,.5);margin-top:4px;text-transform:uppercase;letter-spacing:.05em;}
    /* Tabs */
    .tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:24px;}
    .tab{padding:12px 20px;font-size:.9rem;font-weight:600;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Inter',sans-serif;}
    .tab:hover{color:var(--text);}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent);}
    .tab-panel{display:none;}.tab-panel.active{display:block;}
    /* Cards */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:20px;}
    .card-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:center;}
    .card-title{font-size:1rem;font-weight:700;}
    .card-body{padding:20px 24px 24px;}
    /* Investors table */
    .table-scroll{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;}
    thead{background:var(--border-light);}
    th{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);padding:10px 14px;text-align:left;white-space:nowrap;}
    td{padding:12px 14px;border-bottom:1px solid var(--border-light);font-size:.875rem;vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(59,130,246,.02);}
    .badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;}
    .badge-committed{background:var(--warning-light);color:var(--warning);}
    .badge-funded{background:var(--accent-light);color:var(--accent);}
    .badge-active{background:var(--success-light);color:var(--success);}
    .badge-exited{background:var(--border-light);color:var(--text-secondary);}
    .money{font-family:'JetBrains Mono',monospace;font-weight:600;}
    .pct{font-family:'JetBrains Mono',monospace;color:var(--accent);}
    .btn-xs{padding:5px 10px;font-size:.75rem;font-weight:600;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:4px;font-family:'Inter',sans-serif;}
    .btn-xs:hover{background:var(--accent);color:white;border-color:var(--accent);}
    .btn-xs.danger:hover{background:var(--danger);border-color:var(--danger);}
    /* Capital summary bar */
    .cap-bar{height:10px;border-radius:10px;background:var(--border-light);overflow:hidden;margin:8px 0;}
    .cap-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--success));transition:width .6s;}
    /* Distribution list */
    .dist-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-light);}
    .dist-item:last-child{border-bottom:none;}
    /* Document grid */
    .doc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}
    .doc-card{background:var(--border-light);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;transition:all .15s;}
    .doc-card:hover{border-color:var(--accent);background:var(--accent-light);}
    .doc-icon{font-size:1.5rem;color:var(--accent);margin-bottom:8px;}
    .doc-name{font-size:.8rem;font-weight:600;}
    .doc-sub{font-size:.7rem;color:var(--text-muted);margin-top:3px;}
    /* Edit form */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .form-group{margin-bottom:0;}
    .form-group label{display:block;font-size:.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:.9rem;color:var(--text);background:var(--bg-card);outline:none;transition:all .15s;font-family:'Inter',sans-serif;}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--bg-card);border-radius:var(--radius-md);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);}
    .modal-header{padding:24px 28px 0;display:flex;justify-content:space-between;align-items:center;}
    .modal-title{font-size:1.1rem;font-weight:700;}
    .modal-close{width:32px;height:32px;border:none;background:var(--border-light);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);}
    .modal-close:hover{background:var(--danger-light);color:var(--danger);}
    .modal-body{padding:20px 28px;}
    .modal-footer{padding:0 28px 24px;display:flex;justify-content:flex-end;gap:10px;}
    /* Investor av */
    .inv-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:white;flex-shrink:0;}
    .av-0{background:linear-gradient(135deg,#3b82f6,#60a5fa);}
    .av-1{background:linear-gradient(135deg,#10b981,#34d399);}
    .av-2{background:linear-gradient(135deg,#8b5cf6,#a78bfa);}
    .av-3{background:linear-gradient(135deg,#f59e0b,#fbbf24);}
    .av-4{background:linear-gradient(135deg,#ef4444,#f87171);}
    .av-5{background:linear-gradient(135deg,#06b6d4,#22d3ee);}
    .inv-cell{display:flex;align-items:center;gap:10px;}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted);}
    .empty-state i{font-size:2rem;opacity:.3;display:block;margin-bottom:12px;}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}
    .sidebar-overlay.visible{display:block;}
    @media(max-width:900px){.deal-metrics{grid-template-columns:repeat(2,1fr);}}.
    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);}
      .sidebar.open{transform:translateX(0);}
      .main{margin-left:0!important;}
      .mobile-menu-btn{display:flex!important;}
      .top-bar{padding:12px 16px;}
      .content{padding:16px;}
      .deal-metrics{grid-template-columns:repeat(2,1fr);}
      .form-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo"><div class="logo-icon">◆</div><span>SyndicatePro</span></a>
    </div>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="pipeline.html" class="nav-item active"><i class="fas fa-stream"></i><span>Deal Pipeline</span></a>
      <a href="new-deal.html" class="nav-item"><i class="fas fa-calculator"></i><span>Deal Modeling</span></a>
      <a href="investors.html" class="nav-item"><i class="fas fa-users"></i><span>Investors</span></a>
      <a href="documents.html" class="nav-item"><i class="fas fa-file-contract"></i><span>Documents</span></a>
      <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <div class="nav-section">Tools</div>
      <a href="proforma.html" class="nav-item"><i class="fas fa-table"></i><span>Pro Forma</span></a>
      <a href="distributions.html" class="nav-item"><i class="fas fa-wallet"></i><span>Distributions</span></a>
      <a href="capital-calls.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i><span>Capital Calls</span></a>
      <a href="k1-generator.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>K-1 Generator</span></a>
      <a href="email-templates.html" class="nav-item"><i class="fas fa-envelope"></i><span>Email Templates</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">GP</div>
        <div class="user-details"><div class="user-name" id="gpName">General Partner</div><div class="user-role">Administrator</div></div>
      </div>
    </div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars" style="color:var(--text-secondary);"></i></button>
        <nav class="breadcrumb">
          <a href="dashboard.html">Home</a><span class="breadcrumb-sep">/</span>
          <a href="pipeline.html">Pipeline</a><span class="breadcrumb-sep">/</span>
          <span class="breadcrumb-current" id="breadcrumbDealName">Deal Detail</span>
        </nav>
      </div>
      <div class="top-actions" id="topActions">
        <a href="pipeline.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
      </div>
    </header>

    <div class="content" id="mainContent">
      <!-- Populated by JS -->
    </div>
  </main>
</div>

<!-- Add Investor to Deal Modal -->
<div class="modal-overlay" id="addInvModal" onclick="handleAddInvOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title"><i class="fas fa-user-plus" style="color:var(--accent);margin-right:6px;"></i>Add Investor to Deal</h2>
      <button class="modal-close" onclick="closeAddInvModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:16px;">
        <label>Select Investor *</label>
        <select id="aiInvestorSel" onchange="aiAutoFill()">
          <option value="">— Choose investor —</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group">
          <label>Committed ($) *</label>
          <input type="number" id="aiCommitted" placeholder="250000" oninput="aiCalcOwnership()">
        </div>
        <div class="form-group">
          <label>Ownership %</label>
          <input type="text" id="aiOwnership" readonly style="background:var(--border-light);">
        </div>
      </div>
      <div class="form-group" style="margin-top:12px;">
        <label>Status</label>
        <select id="aiStatus">
          <option value="committed">Committed</option>
          <option value="funded">Funded</option>
          <option value="active">Active</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddInvModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveAddInv()"><i class="fas fa-link"></i> Link Investor</button>
    </div>
  </div>
</div>

<script>
SP.requireGP();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('visible');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('visible');}

const session = SP.getSession();
if(session?.name) document.getElementById('gpName').textContent = session.name;

const urlParams = new URLSearchParams(window.location.search);
const dealId = urlParams.get('id');

let deal = null;

function fmt$(n){if(!n)return'$0';if(n>=1e6)return'$'+(n/1e6).toFixed(2)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(0)+'K';return'$'+Number(n).toLocaleString();}
function fmtFull$(n){return'$'+Number(n||0).toLocaleString();}

const STATUS_BADGE = {sourcing:'badge-status-sourcing',loi:'badge-status-loi',dd:'badge-status-dd',operating:'badge-status-operating',closed:'badge-status-closed'};
const STATUS_LABEL = {sourcing:'Sourcing',loi:'LOI',dd:'Due Diligence',operating:'Operating',closed:'Closed'};
const TYPE_LABEL = {multifamily:'Multifamily',industrial:'Industrial',retail:'Retail',office:'Office',other:'Other'};

function render() {
  deal = SP.getDealById(dealId);
  if(!deal) {
    document.getElementById('mainContent').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Deal not found</h3><p><a href="pipeline.html">Back to pipeline</a></p></div>`;
    return;
  }
  document.getElementById('breadcrumbDealName').textContent = deal.name;
  document.getElementById('topActions').innerHTML = `
    <a href="pipeline.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Pipeline</a>
    <a href="new-deal.html?id=${deal.id}" class="btn btn-secondary"><i class="fas fa-calculator"></i> Model</a>
    <button class="btn btn-secondary" onclick="duplicateDeal('${deal.id}')" title="Duplicate Deal"><i class="fas fa-copy"></i> Duplicate</button>
    <button class="btn btn-secondary" onclick="shareTeaserLink('${deal.id}')" title="Share public teaser"><i class="fas fa-share-alt"></i> Share</button>
    <button class="btn btn-primary" onclick="openAddInvModal()"><i class="fas fa-user-plus"></i> Add Investor</button>
    <button class="btn btn-danger" onclick="confirmDelete()"><i class="fas fa-trash"></i></button>`;

  const linked = deal.investors || [];
  const totalCommitted = linked.reduce((s,i)=>s+(i.committed||0),0);
  const raise = deal.raise || 0;
  const pctRaised = raise > 0 ? Math.min(100,(totalCommitted/raise*100)).toFixed(1) : 0;
  const dists = SP.getDistributions().filter(d=>d.dealId===deal.id);
  const totalDist = dists.reduce((s,d)=>s+(d.totalAmount||0),0);

  document.getElementById('mainContent').innerHTML = `
    <!-- Hero -->
    <div class="deal-hero">
      <div class="deal-hero-top">
        <div class="deal-title-block">
          <h1>${deal.name}</h1>
          <div class="deal-location"><i class="fas fa-map-marker-alt"></i> ${deal.location||'Location not set'}</div>
        </div>
        <div class="deal-badges">
          <span class="deal-badge badge-type">${TYPE_LABEL[deal.type]||deal.type||'—'}</span>
          <span class="deal-badge ${STATUS_BADGE[deal.status]||''}">${STATUS_LABEL[deal.status]||deal.status||'—'}</span>
          <span class="deal-badge" style="background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);">Added ${deal.added||'—'}</span>
        </div>
      </div>
      <div class="deal-metrics">
        <div class="deal-metric"><div class="val">${fmt$(raise)}</div><div class="lbl">Target Raise</div></div>
        <div class="deal-metric"><div class="val">${deal.irr?deal.irr.toFixed(1)+'%':'—'}</div><div class="lbl">Target IRR</div></div>
        <div class="deal-metric"><div class="val">${deal.equity?deal.equity.toFixed(2)+'x':'—'}</div><div class="lbl">Equity Multiple</div></div>
        <div class="deal-metric"><div class="val">${linked.length}</div><div class="lbl">Investors</div></div>
      </div>
    </div>

    <!-- Capital progress -->
    <div class="card">
      <div class="card-header"><div class="card-title">Capital Raise Progress</div><span style="font-size:.875rem;color:var(--text-secondary);">${fmtFull$(totalCommitted)} / ${fmtFull$(raise)}</span></div>
      <div class="card-body">
        <div class="cap-bar"><div class="cap-fill" style="width:${pctRaised}%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-secondary);margin-top:6px;">
          <span><strong style="color:var(--text);">${pctRaised}%</strong> raised</span>
          <span>${fmtFull$(Math.max(0,raise-totalCommitted))} remaining</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('investors',this)"><i class="fas fa-users"></i> Investors (${linked.length})</button>
      <button class="tab" onclick="switchTab('distributions',this)"><i class="fas fa-wallet"></i> Distributions (${dists.length})</button>
      <button class="tab" onclick="switchTab('documents',this)"><i class="fas fa-file-contract"></i> Documents</button>
      <button class="tab" onclick="switchTab('subscriptions',this)"><i class="fas fa-file-signature"></i> Sub Docs</button>
      <button class="tab" onclick="switchTab('edit',this)"><i class="fas fa-edit"></i> Edit Deal</button>
    </div>

    <!-- Investors Tab -->
    <div class="tab-panel active" id="tab-investors">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Linked Investors</div>
          <button class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;" onclick="openAddInvModal()"><i class="fas fa-plus"></i> Add Investor</button>
        </div>
        <div class="card-body" style="padding-top:0;">
          ${renderInvestorsTable(linked)}
        </div>
      </div>
    </div>

    <!-- Distributions Tab -->
    <div class="tab-panel" id="tab-distributions">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Distribution History</div>
          <a href="distributions.html?deal=${deal.id}" class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;"><i class="fas fa-plus"></i> Record Distribution</a>
        </div>
        <div class="card-body">
          ${renderDistributions(dists)}
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-panel" id="tab-documents">
      <div class="card">
        <div class="card-header"><div class="card-title">Deal Documents</div><a href="documents.html?deal=${deal.id}" class="btn btn-secondary" style="padding:8px 14px;font-size:.8rem;"><i class="fas fa-plus"></i> Generate Doc</a></div>
        <div class="card-body">
          <div class="doc-grid">
            <div class="doc-card" onclick="alert('Generate from Documents page')"><div class="doc-icon"><i class="fas fa-file-contract"></i></div><div class="doc-name">Operating Agreement</div><div class="doc-sub">LLC OA</div></div>
            <div class="doc-card" onclick="alert('Generate from Documents page')"><div class="doc-icon"><i class="fas fa-file-alt"></i></div><div class="doc-name">PPM</div><div class="doc-sub">Private Placement</div></div>
            <div class="doc-card" onclick="alert('Generate from Documents page')"><div class="doc-icon"><i class="fas fa-file-signature"></i></div><div class="doc-name">Subscription Agmt</div><div class="doc-sub">Investor signup</div></div>
            <div class="doc-card" onclick="alert('Generate from Documents page')"><div class="doc-icon"><i class="fas fa-file-invoice-dollar"></i></div><div class="doc-name">K-1 Report</div><div class="doc-sub">Tax document</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscriptions Tab -->
    <div class="tab-panel" id="tab-subscriptions">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Subscription Agreement Tracker</div>
          <button class="btn btn-primary" style="padding:8px 14px;font-size:.8rem;" onclick="openAddInvModal()"><i class="fas fa-plus"></i> Add Investor</button>
        </div>
        <div class="card-body" style="padding-top:0;">
          ${renderSubTracker()}
        </div>
      </div>
    </div>

    <!-- Edit Tab -->
    <div class="tab-panel" id="tab-edit">
      <div class="card">
        <div class="card-header"><div class="card-title">Edit Deal</div></div>
        <div class="card-body">
          <div class="form-grid" style="gap:16px;">
            <div class="form-group" style="grid-column:1/-1;"><label>Deal Name</label><input id="eName" value="${deal.name||''}"></div>
            <div class="form-group"><label>Property Type</label>
              <select id="eType">
                <option value="multifamily" ${deal.type==='multifamily'?'selected':''}>Multifamily</option>
                <option value="industrial" ${deal.type==='industrial'?'selected':''}>Industrial</option>
                <option value="retail" ${deal.type==='retail'?'selected':''}>Retail</option>
                <option value="office" ${deal.type==='office'?'selected':''}>Office</option>
                <option value="other" ${deal.type==='other'?'selected':''}>Other</option>
              </select>
            </div>
            <div class="form-group"><label>Status</label>
              <select id="eStatus">
                <option value="sourcing" ${deal.status==='sourcing'?'selected':''}>Sourcing</option>
                <option value="loi" ${deal.status==='loi'?'selected':''}>LOI</option>
                <option value="dd" ${deal.status==='dd'?'selected':''}>Due Diligence</option>
                <option value="operating" ${deal.status==='operating'?'selected':''}>Operating</option>
                <option value="closed" ${deal.status==='closed'?'selected':''}>Closed</option>
              </select>
            </div>
            <div class="form-group" style="grid-column:1/-1;"><label>Location</label><input id="eLocation" value="${deal.location||''}"></div>
            <div class="form-group"><label>Raise Amount ($)</label><input type="number" id="eRaise" value="${deal.raise||0}"></div>
            <div class="form-group"><label>Target IRR (%)</label><input type="number" id="eIRR" value="${deal.irr||0}" step="0.1"></div>
            <div class="form-group"><label>Equity Multiple</label><input type="number" id="eEM" value="${deal.equity||0}" step="0.01"></div>
            <div class="form-group"><label>Units</label><input type="number" id="eUnits" value="${deal.units||0}"></div>
            <div class="form-group" style="grid-column:1/-1;"><label>Notes</label><textarea id="eNotes" rows="3">${deal.notes||''}</textarea></div>
          </div>
          <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="saveEdit()"><i class="fas fa-save"></i> Save Changes</button>
            <button class="btn btn-secondary" onclick="render()">Cancel</button>
            ${deal.investors?.length && !deal.formDFiled ? `
              <button class="btn btn-secondary" onclick="markFormDFiled('${deal.id}')" style="color:var(--warning);border-color:var(--warning);">
                <i class="fas fa-landmark"></i> Mark Form D Filed
              </button>` : ''}
            ${deal.formDFiled ? `<div style="padding:10px 14px;background:var(--success-light);color:var(--success);border-radius:var(--radius);font-size:.82rem;font-weight:600;"><i class="fas fa-check-circle"></i> Form D filed ${new Date(deal.formDFiled).toLocaleDateString()}</div>` : ''}
          </div>
        </div>
      </div>
    </div>`;
}

function renderSubTracker() {
  const linked = deal.investors || [];
  if (!linked.length) return `<div class="empty-state"><i class="fas fa-file-signature"></i><p>No investors linked yet. Add investors to track their subscription status.</p></div>`;
  const STATUS_STEPS = ['sent','viewed','signed','funded'];
  const STATUS_COLORS = {sent:'#dbeafe,#3b82f6',viewed:'#fef3c7,#f59e0b',signed:'#ede9fe,#8b5cf6',funded:'#d1fae5,#10b981'};
  const STATUS_LABELS = {sent:'Sent',viewed:'Viewed',signed:'Signed',funded:'Funded'};

  return `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;">
    <thead style="background:var(--border-light);"><tr>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Investor</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Committed</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Sub Doc Status</th>
      <th style="padding:10px 14px;text-align:left;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);">Actions</th>
    </tr></thead>
    <tbody>${linked.map((entry,i)=>{
      const inv = SP.getInvestorById(entry.investorId)||{firstName:'Unknown',lastName:'',email:''};
      const initials=(inv.firstName[0]||'')+(inv.lastName[0]||'');
      const subStatus = entry.subStatus || 'pending';
      const [bg,clr] = (STATUS_COLORS[subStatus]||'#f1f5f9,#64748b').split(',');
      const stepIdx = STATUS_STEPS.indexOf(subStatus);
      return `<tr style="border-bottom:1px solid var(--border-light);">
        <td style="padding:12px 14px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:white;flex-shrink:0;">${initials}</div>
            <div><div style="font-weight:600;font-size:.875rem;">${inv.firstName} ${inv.lastName}</div><div style="font-size:.75rem;color:var(--text-muted);">${inv.email}</div></div>
          </div>
        </td>
        <td style="padding:12px 14px;font-family:'JetBrains Mono',monospace;font-weight:600;">$${Number(entry.committed||0).toLocaleString()}</td>
        <td style="padding:12px 14px;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
            ${STATUS_STEPS.map((s,si)=>`
              <div style="display:flex;align-items:center;gap:4px;">
                <div style="width:22px;height:22px;border-radius:50%;background:${si<=stepIdx?'var(--success)':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:.65rem;color:white;font-weight:700;">${si<stepIdx?'✓':si===stepIdx?'→':''}</div>
                <span style="font-size:.7rem;color:${si<=stepIdx?'var(--text)':'var(--text-muted)'};">${STATUS_LABELS[s]}</span>
                ${si<STATUS_STEPS.length-1?'<div style="width:16px;height:2px;background:var(--border);margin:0 2px;"></div>':''}
              </div>`).join('')}
          </div>
        </td>
        <td style="padding:12px 14px;">
          <div style="display:flex;gap:6px;">
            ${STATUS_STEPS.map(s=>s!==subStatus?`<button onclick="updateSubStatus('${entry.investorId}','${s}')" style="padding:4px 8px;background:${STATUS_COLORS[s]?.split(',')[0]||'#f1f5f9'};color:${STATUS_COLORS[s]?.split(',')[1]||'#64748b'};border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;">${STATUS_LABELS[s]}</button>`:null).filter(Boolean).join('')}
            <button onclick="sendSubDoc('${entry.investorId}')" style="padding:4px 8px;background:var(--accent-light);color:var(--accent);border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;"><i class="fas fa-paper-plane"></i></button>
          </div>
        </td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

function updateSubStatus(investorId, status) {
  const deals = SP.getDeals();
  const d = deals.find(x=>x.id===dealId);
  if (!d) return;
  const inv = (d.investors||[]).find(i=>i.investorId===investorId);
  if (inv) { inv.subStatus = status; inv.subUpdatedAt = new Date().toISOString(); }
  SP.saveDeals(deals);
  const invRecord = SP.getInvestorById(investorId);
  SP.logActivity('fa-file-signature','purple',`Sub docs <strong>${status}</strong> for <strong>${invRecord?.firstName} ${invRecord?.lastName}</strong> on <strong>${d.name}</strong>`);
  render();
  // Re-activate subscriptions tab
  document.querySelector('.tab.active')?.classList.remove('active');
  document.querySelectorAll('.tab')[3]?.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-subscriptions')?.classList.add('active');
}

function sendSubDoc(investorId) {
  const inv = SP.getInvestorById(investorId);
  if (!inv?.email) return;
  const settings = SP.load('settings',{});
  const gpName = settings.gpFullName || SP.getSession()?.name || 'Your Sponsor';
  const subj = `Subscription Agreement — ${deal.name}`;
  const body = `Hi ${inv.firstName},\n\nPlease find attached your Subscription Agreement for ${deal.name}.\n\nPlease review, sign, and return at your earliest convenience.\n\nBest,\n${gpName}`;
  window.open(`mailto:${inv.email}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, '_blank');
  updateSubStatus(investorId, 'sent');
}

function renderInvestorsTable(linked) {
  if(!linked.length) return `<div class="empty-state"><i class="fas fa-users"></i><p>No investors linked yet. <button onclick="openAddInvModal()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Add one now</button></p></div>`;
  const BADGE = {committed:'badge-committed',funded:'badge-funded',active:'badge-active',exited:'badge-exited'};
  return `<div class="table-scroll"><table>
    <thead><tr><th>Investor</th><th>Committed</th><th>Ownership</th><th>Status</th><th></th></tr></thead>
    <tbody>${linked.map((entry,i)=>{
      const inv = SP.getInvestorById(entry.investorId) || {firstName:'Unknown',lastName:'',email:''};
      const initials = (inv.firstName[0]||'')+(inv.lastName[0]||'');
      return `<tr>
        <td><div class="inv-cell"><div class="inv-av av-${i%6}">${initials}</div><div><div style="font-weight:600;">${inv.firstName} ${inv.lastName}</div><div style="font-size:.78rem;color:var(--text-muted);">${inv.email}</div></div></div></td>
        <td class="money">${fmtFull$(entry.committed||0)}</td>
        <td class="pct">${entry.ownership?entry.ownership.toFixed(2)+'%':'—'}</td>
        <td><span class="badge ${BADGE[entry.status]||'badge-committed'}">${entry.status||'committed'}</span></td>
        <td><button class="btn-xs danger" onclick="removeInvestor('${entry.investorId}')"><i class="fas fa-unlink"></i></button></td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

function renderDistributions(dists) {
  if(!dists.length) return `<div class="empty-state"><i class="fas fa-wallet"></i><p>No distributions recorded yet. <a href="distributions.html" style="color:var(--accent);">Record one</a></p></div>`;
  return dists.map(d=>`
    <div class="dist-item">
      <div><div style="font-weight:600;">${d.description||'Distribution'}</div><div style="font-size:.78rem;color:var(--text-muted);">${d.date||'—'} · ${d.period||''}</div></div>
      <div style="text-align:right;"><div class="money" style="color:var(--success);">${fmtFull$(d.totalAmount||0)}</div><div style="font-size:.75rem;color:var(--text-muted);">${d.recipients?.length||0} investors</div></div>
    </div>`).join('');
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.getElementById('tab-'+name)?.classList.add('active');
}

function saveEdit() {
  const deals = SP.getDeals();
  const idx = deals.findIndex(d=>d.id===dealId);
  if(idx<0) return;
  deals[idx] = {...deals[idx],
    name: document.getElementById('eName').value.trim(),
    type: document.getElementById('eType').value,
    status: document.getElementById('eStatus').value,
    location: document.getElementById('eLocation').value.trim(),
    raise: parseFloat(document.getElementById('eRaise').value)||0,
    irr: parseFloat(document.getElementById('eIRR').value)||0,
    equity: parseFloat(document.getElementById('eEM').value)||0,
    units: parseInt(document.getElementById('eUnits').value)||0,
    notes: document.getElementById('eNotes').value.trim(),
  };
  SP.saveDeals(deals);
  SP.logActivity('fa-edit','amber',`<strong>${deals[idx].name}</strong> deal details updated`);
  render();
}

function removeInvestor(invId) {
  if(!confirm('Remove this investor from the deal?')) return;
  SP.removeInvestorFromDeal(dealId, invId);
  render();
}

function confirmDelete() {
  if(!confirm(`Delete "${deal.name}"? This cannot be undone.`)) return;
  const deals = SP.getDeals().filter(d=>d.id!==dealId);
  SP.saveDeals(deals);
  window.location.href = 'pipeline.html';
}

// Add investor modal
function openAddInvModal() {
  const investors = SP.getInvestors();
  const linked = (SP.getDealById(dealId)?.investors||[]).map(i=>i.investorId);
  const sel = document.getElementById('aiInvestorSel');
  sel.innerHTML = '<option value="">— Choose investor —</option>' +
    investors.map(inv=>`<option value="${inv.id}" ${linked.includes(inv.id)?'disabled':''} data-name="${inv.firstName} ${inv.lastName}">${inv.firstName} ${inv.lastName}${linked.includes(inv.id)?' (already linked)':''}</option>`).join('');
  document.getElementById('aiCommitted').value='';
  document.getElementById('aiOwnership').value='';
  document.getElementById('addInvModal').classList.add('open');
}
function closeAddInvModal(){document.getElementById('addInvModal').classList.remove('open');}
function handleAddInvOverlay(e){if(e.target===document.getElementById('addInvModal'))closeAddInvModal();}

function aiAutoFill() {}
function aiCalcOwnership() {
  const raise = SP.getDealById(dealId)?.raise || 0;
  const committed = parseFloat(document.getElementById('aiCommitted').value)||0;
  document.getElementById('aiOwnership').value = raise&&committed ? (committed/raise*100).toFixed(2)+'%' : '';
}

function saveAddInv() {
  const invId = document.getElementById('aiInvestorSel').value;
  const committed = parseFloat(document.getElementById('aiCommitted').value)||0;
  const status = document.getElementById('aiStatus').value;
  if(!invId){alert('Select an investor.');return;}
  if(!committed){alert('Enter committed amount.');return;}
  const raise = SP.getDealById(dealId)?.raise||0;
  const ownership = raise?parseFloat((committed/raise*100).toFixed(4)):0;
  SP.addInvestorToDeal(dealId,{investorId:invId,committed,ownership,status,linkedAt:new Date().toISOString()});
  const inv = SP.getInvestorById(invId);
  SP.logActivity('fa-link','blue',`<strong>${inv?.firstName} ${inv?.lastName}</strong> linked to <strong>${deal?.name}</strong>`);
  closeAddInvModal();
  render();
}

function markFormDFiled(dealId) {
  const allDeals = SP.getDeals();
  const d = allDeals.find(x=>x.id===dealId);
  if(!d) return;
  d.formDFiled = new Date().toISOString();
  SP.saveDeals(allDeals);
  SP.logActivity('fa-landmark','green',`Form D marked as filed for <strong>${d.name}</strong>`);
  render();
}

function duplicateDeal(id) {
  const allDeals = SP.getDeals();
  const d = allDeals.find(x=>x.id===id);
  if(!d) return;
  const copy = {...d, id:'d'+Date.now(), name:d.name + ' (Copy)', investors:[], added:new Date().toISOString().split('T')[0]};
  allDeals.unshift(copy);
  SP.saveDeals(allDeals);
  SP.logActivity('fa-copy','blue',`<strong>${copy.name}</strong> duplicated from ${d.name}`);
  window.location.href = `deal-detail.html?id=${copy.id}`;
}

function shareTeaserLink(dId) {
  const orgId = SP.getOrgId();
  const token = btoa(`${orgId}|${dId}`).replace(/=/g,'');
  const base = window.location.href.replace(/deal-detail\.html.*/, '');
  const url = `${base}deal-teaser.html?t=${token}`;
  navigator.clipboard.writeText(url).then(() => {
    // Show toast
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:.875rem;font-weight:600;background:#10b981;color:white;box-shadow:0 8px 24px rgba(0,0,0,.15);display:flex;align-items:center;gap:8px;';
    t.innerHTML = '<i class="fas fa-check-circle"></i> Teaser link copied to clipboard!';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }).catch(() => { prompt('Copy this teaser link:', url); });
}

if(!dealId) { window.location.href='pipeline.html'; } else { render(); }
</script>
</body>
</html>
